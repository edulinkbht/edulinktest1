<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Newton AI Â· modern glass edition</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.2/marked.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:opsz,wght@14..32,300..700&family=JetBrains+Mono:wght@400..600&family=Merriweather:wght@300;400;700;900&display=swap" rel="stylesheet">

<!-- Leaflet for Maps -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<!-- PDF.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>

<!-- PrismJS -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-typescript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-jsx.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-tsx.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-css.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markup.min.js"></script>

<!-- TradingView -->
<script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>

<!-- KaTeX -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" crossorigin="anonymous"></script>

<script>
    tailwind.config = {
        theme: {
            extend: {
                colors: {
                    bgLight: '#F8FAFC',
                    glassBorder: 'rgba(255,255,255,0.2)',
                    glassDarkBorder: 'rgba(0,0,0,0.05)',
                    accentSoft: '#D97757',
                    accentBlueSoft: '#3B82F6',
                    accentGreenSoft: '#10B981',
                },
                fontFamily: {
                    sans: ['Inter', 'system-ui', 'sans-serif'],
                    serif: ['Merriweather', 'serif'],
                    mono: ['JetBrains Mono', 'monospace'],
                },
                backdropBlur: {
                    xs: '2px',
                    glass: '12px',
                },
                boxShadow: {
                    'glass': '0 8px 32px rgba(0,0,0,0.04)',
                    'glass-lg': '0 20px 48px -12px rgba(0,0,0,0.1)',
                    'soft': '0 2px 12px rgba(0,0,0,0.02)',
                }
            }
        }
    }
</script>

<style>
    /* ----- MODERN GLASS BASE ----- */
    * { scrollbar-width: thin; scrollbar-color: #CBD5E0 #F1F5F9; }
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: #F1F5F9; border-radius: 20px; }
    ::-webkit-scrollbar-thumb { background: #CBD5E0; border-radius: 20px; }
    ::-webkit-scrollbar-thumb:hover { background: #94A3B8; }

    body {
        background: #F0F4F8;
        font-family: 'Inter', sans-serif;
        -webkit-font-smoothing: antialiased;
        color: #1E293B;
    }

    .glass-panel {
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(12px) saturate(180%);
        -webkit-backdrop-filter: blur(12px) saturate(180%);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 28px;
        box-shadow: 0 12px 40px -12px rgba(0,0,0,0.1), 0 0 0 1px rgba(0,0,0,0.02) inset;
    }

    .glass-panel-solid {
        background: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255,255,255,0.4);
        border-radius: 24px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.02);
    }

    #sidebar {
        background: rgba(255, 255, 255, 0.65);
        backdrop-filter: blur(16px) saturate(180%);
        -webkit-backdrop-filter: blur(16px) saturate(180%);
        border-right: 1px solid rgba(255, 255, 255, 0.3);
        box-shadow: 4px 0 20px -12px rgba(0,0,0,0.08);
    }

    header {
        background: rgba(255,255,255,0.5) !important;
        backdrop-filter: blur(12px) !important;
        -webkit-backdrop-filter: blur(12px) !important;
        border-bottom: 1px solid rgba(255,255,255,0.4) !important;
        box-shadow: 0 4px 20px -8px rgba(0,0,0,0.02);
    }

    #main-input-container {
        background: rgba(255,255,255,0.75);
        backdrop-filter: blur(16px) saturate(180%);
        -webkit-backdrop-filter: blur(16px) saturate(180%);
        border: 1px solid rgba(255,255,255,0.5);
        border-radius: 32px;
        box-shadow: 0 20px 48px -20px rgba(0,0,0,0.15), 0 0 0 1px rgba(255,255,255,0.5) inset;
        transition: all 0.2s ease;
    }
    #main-input-container:focus-within {
        background: rgba(255,255,255,0.85);
        border-color: rgba(217, 119, 87, 0.3);
        box-shadow: 0 24px 56px -20px #D9775730, 0 0 0 2px rgba(217,119,87,0.2);
    }

    .message-inner .prose-content {
        background: rgba(255,255,255,0.5);
        backdrop-filter: blur(4px);
        -webkit-backdrop-filter: blur(4px);
        border-radius: 24px;
        padding: 20px 24px;
        border: 1px solid rgba(255,255,255,0.6);
        box-shadow: 0 4px 16px rgba(0,0,0,0.02);
    }

    .message-row:has(.avatar-container.bg-\\[\\#D97757\\]) .prose-content {
        background: rgba(247, 241, 237, 0.6);
        border-color: rgba(217, 119, 87, 0.2);
    }

    .thread-line {
        background: linear-gradient(to bottom, rgba(203,213,225,0.3), rgba(203,213,225,0.6), rgba(203,213,225,0.3));
        width: 2px;
    }

    .scholar-card, .location-card, .web-card, .code-plan-card {
        background: rgba(255,255,255,0.55);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        border: 1px solid rgba(255,255,255,0.4);
        border-radius: 20px;
        box-shadow: 0 8px 20px -12px rgba(0,0,0,0.08);
        transition: all 0.2s;
    }
    .scholar-card:hover, .location-card:hover, .web-card:hover {
        background: rgba(255,255,255,0.75);
        border-color: rgba(255,255,255,0.7);
        box-shadow: 0 16px 32px -16px rgba(0,0,0,0.1);
        transform: translateY(-1px);
    }

    .web-card-visual {
        background: #F8FAFC;
        border-bottom: 1px solid rgba(255,255,255,0.6);
    }

    .map-wrapper {
        background: rgba(255,255,255,0.4);
        backdrop-filter: blur(8px);
        border: 1px solid rgba(255,255,255,0.3);
        border-radius: 28px;
        overflow: hidden;
        box-shadow: 0 12px 28px -12px rgba(0,0,0,0.1);
    }
    .map-header {
        background: rgba(255,255,255,0.5);
        border-bottom: 1px solid rgba(255,255,255,0.4);
        padding: 12px 20px;
    }

    .tradingview-widget-container {
        border-radius: 28px;
        overflow: hidden;
        border: 1px solid rgba(255,255,255,0.3);
        box-shadow: 0 12px 28px -12px rgba(0,0,0,0.1);
    }

    .code-block-wrapper {
        border-radius: 20px;
        overflow: hidden;
        border: 1px solid rgba(255,255,255,0.2);
        box-shadow: 0 20px 40px -20px #00000020;
        margin: 24px 0;
    }
    .code-header {
        background: rgba(30,30,30,0.8);
        backdrop-filter: blur(8px);
        color: #E4E4E7;
        border-bottom: 1px solid rgba(255,255,255,0.1);
        padding: 8px 20px;
    }

    .follow-up-btn {
        background: rgba(255,255,255,0.5);
        backdrop-filter: blur(4px);
        border: 1px solid rgba(255,255,255,0.5);
        border-radius: 40px;
        padding: 12px 20px;
        font-weight: 500;
        box-shadow: 0 2px 6px rgba(0,0,0,0.02);
    }
    .follow-up-btn:hover {
        background: white;
        border-color: rgba(217,119,87,0.3);
        box-shadow: 0 12px 24px -16px #D97757;
    }

    .attachment-card {
        background: rgba(255,255,255,0.7);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.6);
        border-radius: 40px;
        box-shadow: 0 4px 16px rgba(0,0,0,0.02);
        padding: 6px 12px 6px 8px;
    }

    .landing-mode #main-input-container {
        background: rgba(255,255,255,0.8);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255,255,255,0.6);
        box-shadow: 0 30px 70px -30px rgba(0,0,0,0.2);
    }

    #media-modal, #preview-modal, #url-modal {
        backdrop-filter: blur(20px) saturate(180%);
        background: rgba(0,0,0,0.3);
    }
    #url-modal-content {
        background: rgba(255,255,255,0.85);
        backdrop-filter: blur(24px);
        border: 1px solid rgba(255,255,255,0.5);
        border-radius: 40px;
        box-shadow: 0 40px 80px -20px black;
    }

    .mode-badge {
        background: rgba(255,247,237,0.7);
        backdrop-filter: blur(4px);
        border: 1px solid rgba(253,186,116,0.3);
        border-radius: 40px;
        padding: 4px 14px;
        font-weight: 500;
    }

    .location-cards-container {
        background: rgba(249,250,251,0.3);
        border-top: 1px solid rgba(255,255,255,0.5);
    }

    .study-step-content {
        background: rgba(255,255,255,0.4);
        backdrop-filter: blur(4px);
        border: 1px solid rgba(255,255,255,0.5);
        border-radius: 20px;
    }

    button, .loc-btn, .focus-menu-item {
        transition: all 0.2s ease;
    }

    @media (max-width: 768px) {
        .message-inner .prose-content {
            padding: 16px 20px;
        }
        #sidebar {
            background: rgba(255,255,255,0.85);
        }
    }

    .shimmer { background: linear-gradient(90deg, #f0f0f025 25%, #f8f8f880 50%, #f0f0f025 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; }
    @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    .msg-enter { animation: fadeIn 0.4s ease forwards; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
    .spinner { animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>
</head>
<body class="h-screen flex overflow-hidden bg-bgLight">

<!-- Overlay Modal -->
<div id="media-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center bg-black/30 backdrop-blur-xl opacity-0 transition-opacity duration-300" onclick="closeModal()">
    <div class="relative w-full h-full flex flex-col items-center justify-center p-0" onclick="event.stopPropagation()">
        <button class="absolute top-4 right-4 z-50 w-12 h-12 flex items-center justify-center rounded-full bg-white/30 hover:bg-white/50 text-white backdrop-blur-md border border-white/30 shadow-lg" onclick="closeModal()">
            <i class="fa-solid fa-xmark text-2xl"></i>
        </button>
        <img id="modal-img" class="max-h-[90vh] max-w-[90vw] h-auto w-auto rounded-3xl shadow-2xl object-contain hidden border border-white/30">
        <p id="modal-caption" class="absolute bottom-6 left-1/2 -translate-x-1/2 text-white/95 text-center font-medium text-lg max-w-2xl bg-black/40 px-6 py-3 rounded-full backdrop-blur-md border border-white/20"></p>
    </div>
</div>

<!-- Preview Modal -->
<div id="preview-modal" class="fixed inset-0 z-[120] hidden flex items-center justify-center bg-black/40 backdrop-blur-xl transition-opacity duration-200">
    <div class="bg-white/80 backdrop-blur-xl rounded-3xl shadow-2xl w-[90vw] h-[85vh] relative flex flex-col overflow-hidden border border-white/40">
        <div class="h-12 bg-white/40 backdrop-blur-sm border-b border-white/30 flex items-center justify-between px-5">
            <span class="text-sm font-semibold text-gray-700 flex items-center gap-2"><i class="fa-solid fa-eye"></i> Live Preview</span>
            <button onclick="closePreviewModal()" class="w-8 h-8 rounded-full hover:bg-white/30 flex items-center justify-center text-gray-600"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <iframe id="preview-frame" class="w-full h-full bg-white/90"></iframe>
    </div>
</div>

<!-- URL Modal -->
<div id="url-modal" class="fixed inset-0 z-[110] hidden flex items-center justify-center bg-black/20 backdrop-blur-sm transition-opacity duration-200">
    <div class="bg-white/70 backdrop-blur-xl rounded-3xl shadow-2xl w-full max-w-md p-6 transform transition-all scale-95 opacity-0 border border-white/50" id="url-modal-content">
        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2"><i class="fa-solid fa-link text-gray-500"></i> Add Link</h3>
        <input type="text" id="url-input-field" class="w-full border border-white/50 bg-white/60 rounded-2xl px-5 py-3 text-base focus:outline-none focus:border-accentSoft/50 focus:ring-2 focus:ring-accentSoft/20 transition-all mb-2" placeholder="https://example.com" onkeydown="if(event.key === 'Enter') confirmUrlInput()">
        <p class="text-xs text-gray-500 mb-6 ml-1">Paste a URL for the AI to analyze.</p>
        <div class="flex justify-end gap-3">
            <button onclick="closeUrlModal()" class="px-5 py-2 rounded-full text-gray-600 hover:bg-white/50 font-medium transition-colors">Cancel</button>
            <button onclick="confirmUrlInput()" class="px-5 py-2 rounded-full bg-gray-800/80 hover:bg-gray-900 text-white font-medium shadow-md backdrop-blur-sm border border-white/20">Add Link</button>
        </div>
    </div>
</div>

<!-- Sidebar Overlay -->
<div id="sidebar-overlay" onclick="toggleSidebar()" class="fixed inset-0 sidebar-overlay z-40 hidden md:hidden bg-black/10 backdrop-blur-sm"></div>

<!-- Sidebar -->
<aside id="sidebar" class="fixed md:relative w-[280px] h-full flex flex-col transform -translate-x-full md:translate-x-0 transition-transform duration-300 z-50">
    <div class="p-5 flex items-center justify-between">
        <div class="flex items-center gap-3">
            <div class="w-9 h-9 bg-gray-800/80 rounded-xl flex items-center justify-center text-white backdrop-blur-sm shadow-sm border border-white/30">
                <i class="fa-solid fa-cube text-sm"></i>
            </div>
            <span class="font-serif font-bold text-lg tracking-tight text-gray-800">Newton</span>
        </div>
        <button class="md:hidden text-gray-500" onclick="toggleSidebar()"><i class="fa-solid fa-xmark"></i></button>
    </div>

    <div class="px-4 mb-4">
        <button onclick="startNewChat()" class="w-full bg-white/50 hover:bg-white/80 backdrop-blur-sm border border-white/40 text-gray-800 font-medium py-3 px-4 rounded-2xl shadow-soft transition-all flex items-center justify-center gap-2 group">
            <i class="fa-solid fa-plus text-accentSoft group-hover:scale-110 transition-transform"></i>
            <span>New Thread</span>
        </button>
    </div>

    <div class="flex-1 overflow-y-auto px-4 py-2 space-y-1 no-scrollbar" id="history-list"></div>

    <div class="p-4 border-t border-white/30 bg-white/30 backdrop-blur-sm">
        <div class="flex items-center gap-3 p-2 rounded-xl hover:bg-white/40 cursor-pointer transition-colors group">
            <img src="https://ui-avatars.com/api/?name=User&background=374151&color=fff" class="w-8 h-8 rounded-full shadow-sm ring-2 ring-white/50">
            <div class="flex-1 min-w-0">
                <p class="text-sm font-medium text-gray-800 truncate">Professional Plan</p>
                <p class="text-xs text-gray-500 truncate">user@example.com</p>
            </div>
            <i class="fa-solid fa-gear text-gray-400 hover:text-gray-600 text-xs"></i>
        </div>
    </div>
</aside>

<!-- Main Content -->
<main id="main-container" class="flex-1 flex flex-col h-full relative w-full">
    <header class="h-16 flex items-center justify-between px-4 md:px-8 sticky top-0 z-30">
        <div class="flex items-center gap-4">
            <button onclick="toggleSidebar()" class="md:hidden text-gray-500 hover:text-gray-800">
                <i class="fa-solid fa-bars text-lg"></i>
            </button>
            <div class="flex items-center gap-2 cursor-pointer hover:bg-white/30 px-3 py-1.5 rounded-full transition-colors border border-transparent hover:border-white/30 bg-white/20 backdrop-blur-sm" id="model-selector">
                <span class="text-sm font-medium text-gray-500">Model:</span>
                <span class="text-sm font-bold text-gray-800">Newton (OpenAI)</span>
                <i class="fa-solid fa-chevron-down text-xs text-gray-400"></i>
            </div>
        </div>
        <div class="flex items-center gap-4">
             <button onclick="toggleScholarMode()" id="header-scholar-btn" class="text-gray-400 hover:text-accentSoft transition-colors text-sm font-medium flex items-center gap-2 bg-white/20 backdrop-blur-sm px-3 py-1.5 rounded-full">
                <i class="fa-solid fa-graduation-cap"></i> <span class="hidden sm:inline">Scholar</span>
            </button>
            <button class="text-gray-400 hover:text-gray-700 bg-white/20 backdrop-blur-sm w-8 h-8 rounded-full flex items-center justify-center">
                <i class="fa-regular fa-star"></i>
            </button>
        </div>
    </header>

    <div id="chat-container" class="flex-1 overflow-y-auto p-4 md:p-8 scroll-smooth no-scrollbar">
        <div id="messages-list" class="max-w-4xl mx-auto pb-12 hidden"></div>
        <div id="scroll-anchor" class="h-8"></div>
    </div>

    <div id="input-area-wrapper" class="w-full pt-2 pb-6 px-4 z-20">
        <div class="max-w-3xl mx-auto relative">
            
            <div id="landing-logo" class="hidden flex-col items-center justify-center mb-8 gap-4">
                <div class="w-20 h-20 bg-white/40 backdrop-blur-xl rounded-3xl flex items-center justify-center shadow-xl border border-white/50">
                    <i class="fa-solid fa-cube text-4xl text-gray-800"></i>
                </div>
                <h1 class="text-4xl font-serif font-bold text-gray-800 tracking-tight drop-shadow-sm">Newton AI</h1>
            </div>

            <button id="scroll-btn" onclick="scrollToBottom()" class="absolute -top-12 left-1/2 -translate-x-1/2 bg-white/70 backdrop-blur-md border border-white/50 shadow-lg rounded-full w-9 h-9 flex items-center justify-center text-gray-500 hover:text-gray-800 hidden z-10">
                <i class="fa-solid fa-arrow-down"></i>
            </button>

            <div id="web-search-menu" class="absolute bottom-16 left-32 bg-white/70 backdrop-blur-xl border border-white/40 shadow-xl rounded-2xl p-2 min-w-[180px] hidden z-50 flex flex-col gap-1 origin-bottom-left">
                <div onclick="setWebFocus('all')" class="focus-menu-item active" data-focus="all"><i class="fa-solid fa-globe text-gray-500"></i> Websites (All)</div>
                <div onclick="setWebFocus('social')" class="focus-menu-item" data-focus="social"><i class="fa-solid fa-hashtag text-gray-500"></i> Social Media</div>
                <div onclick="setWebFocus('finance')" class="focus-menu-item" data-focus="finance"><i class="fa-solid fa-chart-line text-gray-500"></i> Finance</div>
                <div onclick="setWebFocus('academic')" class="focus-menu-item" data-focus="academic"><i class="fa-solid fa-graduation-cap text-gray-500"></i> Academic</div>
            </div>

            <div id="attachment-menu" class="absolute bottom-16 left-4 bg-white/70 backdrop-blur-xl border border-white/40 shadow-xl rounded-2xl p-2 min-w-[160px] hidden z-50 flex flex-col gap-1 origin-bottom-left">
                <div onclick="selectAttachment('device')" class="focus-menu-item"><i class="fa-regular fa-folder-open text-gray-500"></i> Upload Files</div>
                <div onclick="selectAttachment('link')" class="focus-menu-item"><i class="fa-solid fa-link text-gray-500"></i> Add Link</div>
            </div>

            <div class="transition-all duration-200" id="main-input-container">
                <div id="active-mode-badge" class="hidden px-5 pt-4 pb-0 flex flex-wrap gap-2"></div>
                
                <div id="attachment-preview" class="hidden attachment-preview-container px-4 pt-2"></div>

                <textarea id="user-input" rows="1" class="w-full p-5 max-h-[200px] outline-none text-gray-800 placeholder-gray-400 resize-none bg-transparent font-sans text-base" placeholder="Ask anything..." oninput="autoResize(this)" onkeydown="handleKeydown(event)"></textarea>
                
                <div class="flex items-center justify-between px-4 pb-4">
                    <div class="flex items-center gap-1">
                        <button onclick="toggleAttachmentMenu()" id="btn-attach" class="w-9 h-9 flex items-center justify-center rounded-full text-gray-400 hover:text-gray-700 hover:bg-white/60 transition-colors" title="Attach"><i class="fa-solid fa-paperclip"></i></button>
                        <input type="file" id="file-upload" class="hidden" accept="image/*,application/pdf" multiple onchange="handleFileUpload(this)">
                        <div class="h-5 w-[1px] bg-white/50 mx-1"></div>
                        <button onclick="toggleWebSearch()" id="toolbar-web-btn" class="w-9 h-9 flex items-center justify-center rounded-full text-gray-400 hover:text-gray-700 hover:bg-white/60 transition-colors relative" title="Web Search"><i class="fa-solid fa-globe"></i></button>
                        <button onclick="toggleScholarMode()" id="toolbar-scholar-btn" class="w-9 h-9 flex items-center justify-center rounded-full text-gray-400 hover:text-gray-700 hover:bg-white/60 transition-colors" title="Scholar Mode"><i class="fa-solid fa-graduation-cap"></i></button>
                        <button onclick="toggleIdeaMode()" id="toolbar-idea-btn" class="w-9 h-9 flex items-center justify-center rounded-full text-gray-400 hover:text-gray-700 hover:bg-white/60 transition-colors" title="Idea Mode"><i class="fa-regular fa-lightbulb"></i></button>
                        <button onclick="toggleStudyMode()" id="toolbar-study-btn" class="w-9 h-9 flex items-center justify-center rounded-full text-gray-400 hover:text-gray-700 hover:bg-white/60 transition-colors" title="Study Mode"><i class="fa-solid fa-microscope"></i></button>
                        <button onclick="toggleCodeMode()" id="toolbar-code-btn" class="w-9 h-9 flex items-center justify-center rounded-full text-gray-400 hover:text-gray-700 hover:bg-white/60 transition-colors" title="Code Canvas"><i class="fa-solid fa-code"></i></button>
                    </div>
                    <div class="flex items-center gap-2">
                         <span id="char-count" class="text-xs text-gray-400 font-mono hidden sm:inline">0</span>
                         <button onclick="checkLocationAndSend()" id="send-btn" class="bg-accentSoft/90 hover:bg-accentSoft text-white rounded-full px-5 py-2 transition-colors disabled:opacity-50 shadow-sm flex items-center justify-center gap-2 backdrop-blur-sm border border-white/30">
                            <span class="text-sm font-semibold">Run</span>
                            <i class="fa-solid fa-arrow-up text-xs"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- ========== ORIGINAL FULL JAVASCRIPT (EXACT, UNCHANGED) ========== -->
<script>
    // State
    let chats = JSON.parse(localStorage.getItem('newton_chats')) || [];
    let currentChatId = null;
    let isScholarMode = false;
    let isWebSearchMode = false;
    let isIdeaMode = false;
    let isStudyMode = false;
    let isCodeMode = false;
    let webSearchFocus = 'all'; 
    
    let attachments = []; 

    const mapsStore = {}; 
    const mapMarkersStore = {};
    const previewStore = {};

    // --- Modal Logic ---
    function openImageModal(src, caption) {
        const modal = document.getElementById('media-modal');
        const img = document.getElementById('modal-img');
        const cap = document.getElementById('modal-caption');
        
        img.src = src;
        img.classList.remove('hidden');
        if(caption) {
            cap.innerText = caption;
            cap.classList.remove('hidden');
        } else {
            cap.innerText = '';
            cap.classList.add('hidden');
        }
        
        modal.classList.remove('hidden');
        requestAnimationFrame(() => {
            modal.classList.remove('opacity-0');
        });
    }

    function closeModal() {
        const modal = document.getElementById('media-modal');
        modal.classList.add('opacity-0');
        setTimeout(() => {
            modal.classList.add('hidden');
            document.getElementById('modal-img').src = '';
        }, 300);
    }

    function openPreviewModal(previewId) {
        const modal = document.getElementById('preview-modal');
        const frame = document.getElementById('preview-frame');
        
        const htmlContent = previewStore[previewId];
        if (!htmlContent) return;

        const doc = frame.contentDocument || frame.contentWindow.document;
        doc.open();
        doc.write(htmlContent);
        doc.close();

        modal.classList.remove('hidden');
        setTimeout(() => modal.classList.remove('opacity-0'), 10);
    }

    function closePreviewModal() {
        const modal = document.getElementById('preview-modal');
        modal.classList.add('opacity-0');
        setTimeout(() => {
            modal.classList.add('hidden');
            const frame = document.getElementById('preview-frame');
            frame.src = 'about:blank';
        }, 200);
    }

    function openUrlModal() {
        const modal = document.getElementById('url-modal');
        const content = document.getElementById('url-modal-content');
        const input = document.getElementById('url-input-field');
        
        input.value = '';
        modal.classList.remove('hidden');
        requestAnimationFrame(() => {
            content.classList.remove('scale-95', 'opacity-0');
            content.classList.add('scale-100', 'opacity-100');
            input.focus();
        });
    }

    function closeUrlModal() {
        const modal = document.getElementById('url-modal');
        const content = document.getElementById('url-modal-content');
        
        content.classList.remove('scale-100', 'opacity-100');
        content.classList.add('scale-95', 'opacity-0');
        
        setTimeout(() => {
            modal.classList.add('hidden');
        }, 200);
    }

    function confirmUrlInput() {
        const input = document.getElementById('url-input-field');
        const url = input.value.trim();
        
        if (url && url.length > 0) {
            let validUrl = url;
            if (!validUrl.startsWith('http')) {
                validUrl = 'https://' + validUrl;
            }
            attachments.push({
                id: Date.now().toString() + Math.random(),
                type: 'link',
                data: validUrl,
                name: (new URL(validUrl)).hostname
            });
            renderAttachmentPreview();
            closeUrlModal();
        }
    }

    function toggleSidebar() {
        const sb = document.getElementById('sidebar');
        const ov = document.getElementById('sidebar-overlay');
        if (sb.classList.contains('-translate-x-full')) {
            sb.classList.remove('-translate-x-full');
            ov.classList.remove('hidden');
        } else {
            sb.classList.add('-translate-x-full');
            ov.classList.add('hidden');
        }
    }

    function autoResize(el) {
        el.style.height = 'auto';
        el.style.height = el.scrollHeight + 'px';
        document.getElementById('char-count').innerText = el.value.length;
    }

    function handleKeydown(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            checkLocationAndSend();
        }
    }

    function setInput(text) {
        const el = document.getElementById('user-input');
        el.value = text;
        autoResize(el);
        el.focus();
    }

    function useFollowUp(text) {
        const input = document.getElementById('user-input');
        input.value = text;
        checkLocationAndSend();
    }

    function updateModeUI() {
        const badge = document.getElementById('active-mode-badge');
        const scholarBtn = document.getElementById('toolbar-scholar-btn');
        const webBtn = document.getElementById('toolbar-web-btn');
        const ideaBtn = document.getElementById('toolbar-idea-btn');
        const studyBtn = document.getElementById('toolbar-study-btn');
        const codeBtn = document.getElementById('toolbar-code-btn');
        const headScholarBtn = document.getElementById('header-scholar-btn');
        const input = document.getElementById('user-input');

        const defaultClass = "w-9 h-9 flex items-center justify-center rounded-full text-gray-400 hover:text-gray-700 hover:bg-white/60 transition-colors";
        scholarBtn.className = defaultClass;
        webBtn.className = defaultClass + " relative";
        ideaBtn.className = defaultClass;
        studyBtn.className = defaultClass;
        codeBtn.className = defaultClass;

        headScholarBtn.classList.remove('text-[#D97757]');
        
        badge.innerHTML = '';
        badge.classList.add('hidden');
        input.placeholder = "Ask anything...";

        if (isScholarMode) {
            isWebSearchMode = false; isIdeaMode = false; isStudyMode = false; isCodeMode = false;
            badge.innerHTML += `<span class="mode-badge bg-[#FFF4F0]/70 text-[#D97757] border border-[#FED7AA]/50"><i class="fa-solid fa-graduation-cap"></i> Scholar Mode</span>`;
            badge.classList.remove('hidden');
            scholarBtn.className = "w-9 h-9 flex items-center justify-center rounded-full text-gray-900 bg-white/80 transition-colors";
            headScholarBtn.classList.add('text-[#D97757]');
            input.placeholder = "Ask a research question...";
        }

        if (isWebSearchMode) {
            isScholarMode = false; isIdeaMode = false; isStudyMode = false; isCodeMode = false;
            let focusIcon = 'fa-globe';
            let focusColor = 'text-gray-900';
            let focusText = 'Web Search';
            
            if(webSearchFocus === 'social') { focusIcon = 'fa-hashtag'; focusColor = 'text-gray-900'; focusText = 'Social Search'; }
            if(webSearchFocus === 'finance') { focusIcon = 'fa-chart-line'; focusColor = 'text-gray-900'; focusText = 'Finance Search'; }
            if(webSearchFocus === 'academic') { focusIcon = 'fa-graduation-cap'; focusColor = 'text-gray-900'; focusText = 'Academic Search'; }

            badge.innerHTML += `<span class="mode-badge bg-gray-50/70 ${focusColor} border border-gray-200/60"><i class="fa-solid ${focusIcon}"></i> ${focusText}</span>`;
            badge.classList.remove('hidden');
            webBtn.className = "w-9 h-9 flex items-center justify-center rounded-full text-gray-900 bg-white/80 transition-colors relative";
            input.placeholder = "Search the web...";
        }
        
        if (isIdeaMode) {
            isScholarMode = false; isWebSearchMode = false; isStudyMode = false; isCodeMode = false;
            badge.innerHTML += `<span class="mode-badge bg-[#FFF4F0]/70 text-[#D97757] border border-[#FED7AA]/50"><i class="fa-regular fa-lightbulb"></i> Startup Blueprint</span>`;
            badge.classList.remove('hidden');
            ideaBtn.className = "w-9 h-9 flex items-center justify-center rounded-full text-gray-900 bg-white/80 transition-colors";
            input.placeholder = "Describe your startup idea...";
        }

        if (isStudyMode) {
            isScholarMode = false; isWebSearchMode = false; isIdeaMode = false; isCodeMode = false;
            badge.innerHTML += `<span class="mode-badge bg-[#ECFDF5]/70 text-[#059669] border border-[#A7F3D0]/50"><i class="fa-solid fa-microscope"></i> Study Mode</span>`;
            badge.classList.remove('hidden');
            studyBtn.className = "w-9 h-9 flex items-center justify-center rounded-full text-gray-900 bg-white/80 transition-colors";
            input.placeholder = "Enter a complex math problem or science topic...";
        }

        if (isCodeMode) {
            isScholarMode = false; isWebSearchMode = false; isIdeaMode = false; isStudyMode = false;
            badge.innerHTML += `<span class="mode-badge bg-[#312e81]/70 text-indigo-100 border border-indigo-500/50"><i class="fa-solid fa-code"></i> Code Canvas</span>`;
            badge.classList.remove('hidden');
            codeBtn.className = "w-9 h-9 flex items-center justify-center rounded-full text-gray-900 bg-white/80 transition-colors";
            input.placeholder = "Describe the app or script you want to build...";
        }
    }

    function toggleScholarMode() { isScholarMode = !isScholarMode; if(isScholarMode) resetOtherModes('scholar'); updateModeUI(); closeWebMenu(); }
    function toggleIdeaMode() { isIdeaMode = !isIdeaMode; if(isIdeaMode) resetOtherModes('idea'); updateModeUI(); closeWebMenu(); }
    function toggleStudyMode() { isStudyMode = !isStudyMode; if(isStudyMode) resetOtherModes('study'); updateModeUI(); closeWebMenu(); }
    function toggleCodeMode() { isCodeMode = !isCodeMode; if(isCodeMode) resetOtherModes('code'); updateModeUI(); closeWebMenu(); }

    function resetOtherModes(current) {
        if(current !== 'scholar') isScholarMode = false;
        if(current !== 'web') isWebSearchMode = false;
        if(current !== 'idea') isIdeaMode = false;
        if(current !== 'study') isStudyMode = false;
        if(current !== 'code') isCodeMode = false;
    }
    
    function toggleWebSearch() {
        const menu = document.getElementById('web-search-menu');
        
        if (isWebSearchMode) {
            isWebSearchMode = false;
            updateModeUI();
            closeWebMenu();
            return;
        }

        if (menu.classList.contains('hidden')) {
            menu.classList.remove('hidden');
            document.querySelectorAll('.focus-menu-item').forEach(el => {
                if(el.dataset.focus === 'all') el.classList.add('active');
                else el.classList.remove('active');
            });
        } else {
            menu.classList.add('hidden');
        }
    }
    
    function setWebFocus(focus) {
        webSearchFocus = focus;
        isWebSearchMode = true;
        resetOtherModes('web');
        
        document.querySelectorAll('.focus-menu-item').forEach(el => {
            if(el.dataset.focus === focus) el.classList.add('active');
            else el.classList.remove('active');
        });

        updateModeUI();
        closeWebMenu();
    }

    function closeWebMenu() {
        document.getElementById('web-search-menu').classList.add('hidden');
    }
    
    function toggleAttachmentMenu() {
        const menu = document.getElementById('attachment-menu');
        if (menu.classList.contains('hidden')) {
            menu.classList.remove('hidden');
        } else {
            menu.classList.add('hidden');
        }
    }

    function selectAttachment(type) {
        const menu = document.getElementById('attachment-menu');
        menu.classList.add('hidden');
        
        if (type === 'device') {
            document.getElementById('file-upload').click();
        } else if (type === 'link') {
            openUrlModal();
        }
    }

    document.addEventListener('click', function(event) {
        const webMenu = document.getElementById('web-search-menu');
        const webBtn = document.getElementById('toolbar-web-btn');
        if (!webMenu.contains(event.target) && !webBtn.contains(event.target)) {
            webMenu.classList.add('hidden');
        }

        const attachMenu = document.getElementById('attachment-menu');
        const attachBtn = document.getElementById('btn-attach');
        if (!attachMenu.contains(event.target) && !attachBtn.contains(event.target)) {
            attachMenu.classList.add('hidden');
        }
        
        const urlModal = document.getElementById('url-modal');
        const urlContent = document.getElementById('url-modal-content');
        if(urlModal.contains(event.target) && !urlContent.contains(event.target) && !urlModal.classList.contains('hidden')) {
            closeUrlModal();
        }
        
        const previewModal = document.getElementById('preview-modal');
        if(previewModal.contains(event.target) && !previewModal.children[0].contains(event.target) && !previewModal.classList.contains('hidden')) {
            closePreviewModal();
        }
    });

    function setLandingMode(enabled) {
        const main = document.getElementById('main-container');
        if (enabled) {
            main.classList.add('landing-mode');
            document.getElementById('messages-list').classList.add('hidden');
        } else {
            main.classList.remove('landing-mode');
            document.getElementById('messages-list').classList.remove('hidden');
        }
    }

    function renderHistory() {
        const list = document.getElementById('history-list');
        list.innerHTML = '';
        
        const now = new Date();
        const todayChats = [];
        const oldChats = [];

        chats.forEach(chat => {
            const date = new Date(parseInt(chat.id));
            if (date.toDateString() === now.toDateString()) {
                todayChats.push(chat);
            } else {
                oldChats.push(chat);
            }
        });

        const createGroup = (label, items) => {
            if(items.length === 0) return;
            const header = document.createElement('div');
            header.className = "text-xs font-semibold text-gray-400 uppercase tracking-wider mt-4 mb-2 px-2";
            header.innerText = label;
            list.appendChild(header);
            items.forEach(c => createItem(c));
        };

        const createItem = (chat) => {
            const btn = document.createElement('button');
            const isActive = chat.id === currentChatId;
            btn.className = `w-full text-left py-2 px-3 rounded-lg text-sm truncate transition-colors flex items-center gap-2 group relative ${isActive ? 'bg-white/50 text-gray-800 font-medium' : 'text-gray-600 hover:bg-white/40'}`;
            btn.onclick = () => loadChat(chat.id);
            btn.innerHTML = `
                <span class="truncate flex-1">${chat.title}</span>
                <i class="fa-solid fa-trash text-gray-400 opacity-0 group-hover:opacity-100 hover:text-red-500 transition-all text-xs z-10 p-1" onclick="deleteChat(event, '${chat.id}')"></i>
            `;
            list.appendChild(btn);
        };

        createGroup('Today', todayChats.reverse());
        createGroup('Previous', oldChats.reverse());
    }

    function startNewChat() {
        currentChatId = Date.now().toString();
        const newChat = { id: currentChatId, title: 'New Conversation', messages: [] };
        chats.push(newChat);
        localStorage.setItem('newton_chats', JSON.stringify(chats));
        renderHistory();
        setLandingMode(true);
        document.getElementById('messages-list').innerHTML = '';
        document.getElementById('user-input').value = '';
        document.getElementById('user-input').focus();
        isWebSearchMode = false;
        isScholarMode = false;
        isIdeaMode = false;
        isStudyMode = false;
        isCodeMode = false;
        webSearchFocus = 'all';
        clearAttachments();
        updateModeUI();
    }

    function loadChat(id) {
        currentChatId = id;
        const chat = chats.find(c => c.id === id);
        if (!chat) return;
        setLandingMode(false);
        document.getElementById('messages-list').innerHTML = '';
        chat.messages.forEach(msg => renderMessage(msg));
        renderHistory();
        if(window.innerWidth < 768) {
            document.getElementById('sidebar').classList.add('-translate-x-full');
            document.getElementById('sidebar-overlay').classList.add('hidden');
        }
        clearAttachments();
        scrollToBottom();
    }

    function deleteChat(e, id) {
        e.stopPropagation();
        chats = chats.filter(c => c.id !== id);
        localStorage.setItem('newton_chats', JSON.stringify(chats));
        if (currentChatId === id) startNewChat();
        else renderHistory();
    }

    function scrollToBottom() {
        setTimeout(() => {
            const anchor = document.getElementById('scroll-anchor');
            anchor.scrollIntoView({ behavior: 'smooth' });
        }, 100);
    }

    function findNearMe(mapId, originalQuery) {
        if (!navigator.geolocation) {
            alert("Geolocation is not supported by your browser.");
            return;
        }

        const map = mapsStore[mapId];
        if(!map) return;

        navigator.geolocation.getCurrentPosition((position) => {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            const userLatLng = L.latLng(lat, lon);

            L.circleMarker([lat, lon], {
                radius: 8,
                fillColor: "#3b82f6",
                color: "#fff",
                weight: 2,
                opacity: 1,
                fillOpacity: 1
            }).addTo(map).bindPopup("You are here").openPopup();

            const markers = mapMarkersStore[mapId] || [];
            let closestDistance = Infinity;
            let closestMarker = null;

            markers.forEach(m => {
                const dist = userLatLng.distanceTo(m.getLatLng()); 
                if(dist < closestDistance) {
                    closestDistance = dist;
                    closestMarker = m;
                }
            });

            if (closestDistance > 20000) {
                 document.getElementById('user-input').value = originalQuery; 
                 checkLocationAndSend(); 
            } else if (closestMarker) {
                const bounds = L.latLngBounds([userLatLng, closestMarker.getLatLng()]);
                map.fitBounds(bounds, { padding: [100, 100], maxZoom: 16 });
            } else {
                 map.setView([lat, lon], 14);
            }
        }, 
        () => alert("Unable to retrieve your location. Check browser permissions."),
        {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
        });
    }
    
    function measureDistance(mapId) {
         if (!navigator.geolocation) {
            alert("Geolocation is not supported.");
            return;
        }
        const map = mapsStore[mapId];
        if(!map) return;
        
        navigator.geolocation.getCurrentPosition((position) => {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            const userLatLng = L.latLng(lat, lon);
            
            L.circleMarker([lat, lon], {
                radius: 6, fillColor: "#10b981", color: "#fff", weight: 2, opacity: 1, fillOpacity: 1
            }).addTo(map).bindPopup("You").openPopup();

            const markers = mapMarkersStore[mapId] || [];
            if(markers.length > 0) {
                const target = markers[0].getLatLng();
                const dist = (userLatLng.distanceTo(target) / 1000).toFixed(2);
                
                L.polyline([userLatLng, target], {color: '#10b981', dashArray: '5, 10'}).addTo(map)
                 .bindPopup(`Distance: ${dist} km`).openPopup();
                 
                const bounds = L.latLngBounds([userLatLng, target]);
                map.fitBounds(bounds, { padding: [50, 50] });
            }
        },
        () => alert("Unable to get high accuracy location."),
        {
            enableHighAccuracy: true,
            timeout: 10000
        });
    }

    function cleanSearchQuery(text) {
        let clean = text.toLowerCase();
        const removePhrases = [
            "i want to visit", "i want to go to", "i'm looking for", "i am looking for", "find me", "show me", "where is", "where's", 
            "nearest", "nearby", "near me", "near", "closest", "in my location", "my location", "location", "please", 
            "is there a", "are there any", "can you find", "search for", "the"
        ];
        removePhrases.forEach(phrase => { clean = clean.replace(new RegExp(phrase, 'g'), ''); });
        clean = clean.replace(/[?.!,]/g, '');
        return clean.trim();
    }

    async function searchRealPlaces(query, lat, lon) {
        try {
            let keyword = cleanSearchQuery(query);
            if (!keyword || keyword.length < 3 || keyword === 'it') {
                if (keyword === 'it') return [];
            }
            if (!keyword) keyword = "places";

            let url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(keyword)}&format=json&limit=5&addressdetails=1`;
            if (lat && lon) {
                const delta = 0.05; 
                url += `&viewbox=${lon-delta},${lat+delta},${lon+delta},${lat-delta}&bounded=1`;
            }
            const res = await fetch(url, { headers: { 'User-Agent': 'NewtonAI/1.0' } });
            const data = await res.json();
            
            if (data && data.length > 0) {
                return data.map(place => ({
                    name: place.name || place.display_name.split(',')[0],
                    lat: parseFloat(place.lat),
                    lon: parseFloat(place.lon),
                    desc: place.display_name,
                    city: place.address ? (place.address.city || place.address.town || place.address.village) : ''
                }));
            }
            return null;
        } catch(e) {
            return null;
        }
    }

    function tryParseJSONBlock(str) {
        const start = str.indexOf('{');
        if (start === -1) return null;
        let depth = 0;
        for (let i = start; i < str.length; i++) {
            if (str[i] === '{') depth++;
            else if (str[i] === '}') {
                depth--;
                if (depth === 0) {
                    try {
                        const jsonStr = str.substring(start, i + 1);
                        const parsed = JSON.parse(jsonStr);
                        if(parsed && (parsed.title || parsed.roadmap || parsed.goals || parsed.subject)) {
                            return { data: parsed, fullMatch: jsonStr };
                        }
                    } catch (e) { }
                    return null; 
                }
            }
        }
        return null;
    }

    function renderMessage(msg, animate = false) {
        const container = document.getElementById('messages-list');
        const div = document.createElement('div');
        
        div.className = `message-row ${animate ? 'msg-enter' : ''}`;
        
        const isAI = msg.role === 'ai';
        const avatarIcon = isAI 
            ? `<i class="fa-solid fa-cube text-xs text-white"></i>` 
            : `<i class="fa-regular fa-user text-xs text-white"></i>`;
        
        const avatar = `
            <div class="avatar-container rounded-full ${isAI ? 'bg-gray-800' : 'bg-[#D97757]'} flex items-center justify-center shadow-sm flex-shrink-0 border-2 border-white">
                ${avatarIcon}
            </div>`;
        
        const name = isAI ? 'Newton' : 'You';
        const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        
        let contentHtml = "";
        let mapData = null;

        if (isAI) {
            const mapRegex = /<<<LOCATIONS_START>>>([\s\S]*?)<<<LOCATIONS_END>>>/;
            const webRegex = /<<<WEB_START>>>([\s\S]*?)<<<WEB_END>>>/g;
            const scholarRegex = /<<<PAPER_START>>>([\s\S]*?)<<<PAPER_END>>>/g;
            const ideaRegex = /<<<IDEA_START>>>([\s\S]*?)<<<IDEA_END>>>/;
            const studyRegex = /<<<STUDY_START>>>([\s\S]*?)<<<STUDY_END>>>/;
            const mediaRegex = /<<<MEDIA_START>>>([\s\S]*?)<<<MEDIA_END>>>/;
            const followUpRegex = /<<<FOLLOWUP_START>>>([\s\S]*?)<<<FOLLOWUP_END>>>/;
            const chartRegex = /<<<CHART_START>>>([\s\S]*?)<<<CHART_END>>>/;
            const thoughtRegex = /<<<THOUGHT_START>>>([\s\S]*?)<<<THOUGHT_END>>>/;
            const codePlanRegex = /<<<PLAN_START>>>([\s\S]*?)<<<PLAN_END>>>/;
            
            let processedContent = msg.content;
            let ideaData = null;
            let studyData = null;
            let mediaData = null;
            let followUpData = null;
            let chartSymbol = null;
            let thoughtProcess = null;
            let codePlan = null;

            const thoughtMatch = processedContent.match(thoughtRegex);
            if (thoughtMatch) {
                thoughtProcess = thoughtMatch[1].trim();
                processedContent = processedContent.replace(thoughtMatch[0], '');
            }

            const planMatch = processedContent.match(codePlanRegex);
            if (planMatch) {
                codePlan = planMatch[1].trim();
                processedContent = processedContent.replace(planMatch[0], '');
            }
            
            const ideaMatch = processedContent.match(ideaRegex);
            if (ideaMatch) {
                try {
                    ideaData = JSON.parse(ideaMatch[1]);
                    processedContent = processedContent.replace(ideaMatch[0], '');
                } catch(e) {}
            }
            
            const jsonBlockRegex = /```json\s*([\s\S]*?)\s*```/;
            const jsonMatch = processedContent.match(jsonBlockRegex);
            if (jsonMatch) {
                try {
                    const parsed = JSON.parse(jsonMatch[1]);
                    if(parsed.subject || parsed.steps) {
                        studyData = parsed;
                        processedContent = processedContent.replace(jsonMatch[0], '');
                    }
                } catch(e) {}
            }

            const mediaMatch = processedContent.match(mediaRegex);
            if (mediaMatch) {
                try {
                    mediaData = JSON.parse(mediaMatch[1]);
                    processedContent = processedContent.replace(mediaMatch[0], '');
                } catch(e) {}
            }
            
            const followUpMatch = processedContent.match(followUpRegex);
            if (followUpMatch) {
                try {
                    followUpData = JSON.parse(followUpMatch[1]);
                    processedContent = processedContent.replace(followUpMatch[0], '');
                } catch(e) {}
            }

            const chartMatch = processedContent.match(chartRegex);
            if (chartMatch) {
                chartSymbol = chartMatch[1].trim();
                processedContent = processedContent.replace(chartMatch[0], '');
            }

            if (!ideaData && msg.mode === 'idea') {
                const extracted = tryParseJSONBlock(processedContent);
                if (extracted && extracted.data.roadmap) { 
                    ideaData = extracted.data;
                    processedContent = processedContent.replace(extracted.fullMatch, '');
                }
            }
            if (!studyData && msg.mode === 'study') {
                const extracted = tryParseJSONBlock(processedContent);
                if (extracted && extracted.data.subject) { 
                    studyData = extracted.data;
                    processedContent = processedContent.replace(extracted.fullMatch, '');
                }
            }

            const mapMatch = processedContent.match(mapRegex);

            if (mapMatch) {
                try {
                    mapData = JSON.parse(mapMatch[1]);
                    processedContent = processedContent.replace(mapMatch[0], ''); 
                } catch(e) { 
                     const fallbackMatch = msg.content.match(/\[\s*\{.*?"lat":.*?\}\s*\]/s);
                     if(fallbackMatch) {
                         try {
                            mapData = JSON.parse(fallbackMatch[0]);
                            processedContent = processedContent.replace(fallbackMatch[0], '');
                         } catch(e2) {}
                     }
                }
            }
            
            const paperMatches = [...processedContent.matchAll(scholarRegex)];
            if (paperMatches.length > 0) {
                let papersHtml = `<div class="scholar-feed">`;
                paperMatches.forEach(match => {
                    const block = match[1];
                    const title = (block.match(/Title:\s*(.*)/) || [])[1] || "Untitled Paper";
                    const authors = (block.match(/Authors:\s*(.*)/) || [])[1] || "Unknown Authors";
                    const journal = (block.match(/Journal:\s*(.*)/) || [])[1] || "Academic Source";
                    let link = (block.match(/Link:\s*(.*)/) || [])[1] || "";
                    if(!link || link.length < 5 || link.toLowerCase().includes('example') || link.toLowerCase().includes('n/a')) {
                        link = `https://scholar.google.com/scholar?q=${encodeURIComponent(title)}`;
                    }

                    let domain = 'scholar.google.com';
                    try {
                        const urlObj = new URL(link);
                        domain = urlObj.hostname;
                    } catch(e) {}

                    const summary = (block.match(/Summary:\s*(.*)/) || [])[1] || "";
                    
                    papersHtml += `
                    <div class="scholar-card">
                        <div class="scholar-type"><i class="fa-solid fa-graduation-cap"></i> Academic Paper</div>
                        <div class="scholar-title">
                            <img src="https://www.google.com/s2/favicons?domain=${domain}&sz=32" class="scholar-favicon" onerror="this.style.display='none'">
                            <a href="${link}" target="_blank">${title}</a>
                        </div>
                        <div class="scholar-authors">${authors}</div>
                        <div class="scholar-journal">${journal}</div>
                        ${summary ? `<div class="scholar-abstract">${summary}</div>` : ''}
                    </div>`;
                    
                    processedContent = processedContent.replace(match[0], '');
                });
                papersHtml += `</div>`;
                processedContent = papersHtml + processedContent;
            }

            const webMatches = [...processedContent.matchAll(webRegex)];
            if (webMatches.length > 0) {
                let webHtml = `<div class="web-grid-wrapper"><div class="web-grid-header"><i class="fa-solid fa-layer-group text-blue-500"></i> Sources</div><div class="web-grid">`;
                
                webMatches.forEach(match => {
                    const block = match[1];
                    const source = (block.match(/Source:\s*(.*)/) || [])[1] || "Web";
                    const title = (block.match(/Title:\s*(.*)/) || [])[1] || "Result";
                    const link = (block.match(/Link:\s*(.*)/) || [])[1] || "#";
                    
                    const imgUrl = `https://tse2.mm.bing.net/th?q=${encodeURIComponent(title)}&w=320&h=180&c=7&rs=1`;
                    
                    let domain = "google.com";
                    try { domain = new URL(link).hostname; } catch(e){}

                    webHtml += `
                    <a href="${link}" target="_blank" class="web-card">
                        <img src="${imgUrl}" class="web-card-visual" loading="lazy" onerror="this.src='https://www.google.com/s2/favicons?domain=${domain}&sz=64'; this.style.objectFit='contain'; this.style.padding='20px';">
                        <div class="web-card-content">
                            <div class="web-card-top">
                                <img src="https://www.google.com/s2/favicons?domain=${domain}&sz=32" class="web-card-favicon">
                                <div class="web-card-source">${source}</div>
                            </div>
                            <div class="web-card-title">${title}</div>
                        </div>
                    </a>`;
                    
                    processedContent = processedContent.replace(match[0], '');
                });
                webHtml += `</div></div>`;
                processedContent = webHtml + processedContent;
            }

            processedContent = processedContent.replace(/\n\s*\n/g, '\n\n').trim();
            
            contentHtml = marked.parse(processedContent);

            if (chartSymbol) {
                const chartId = 'chart-' + Date.now();
                const chartHtml = `
                <div class="tradingview-widget-container" id="${chartId}">
                    <div class="tradingview-widget-container__widget" style="height: 100%; width: 100%;"></div>
                </div>`;
                
                contentHtml = chartHtml + contentHtml;

                setTimeout(() => {
                    const container = document.getElementById(chartId).querySelector('.tradingview-widget-container__widget');
                    if (window.TradingView && container) {
                        new TradingView.widget({
                            "autosize": true,
                            "symbol": chartSymbol,
                            "interval": "D",
                            "timezone": "Etc/UTC",
                            "theme": "light",
                            "style": "1",
                            "locale": "en",
                            "enable_publishing": false,
                            "allow_symbol_change": true,
                            "container_id": container.id || container.parentElement.id
                        });
                        container.id = 'tv-' + Math.random().toString(36).substring(7);
                        new TradingView.widget({
                            "autosize": true,
                            "symbol": chartSymbol,
                            "interval": "D",
                            "timezone": "Etc/UTC",
                            "theme": "light",
                            "style": "1",
                            "locale": "en",
                            "enable_publishing": false,
                            "allow_symbol_change": true,
                            "container_id": container.id
                        });
                    }
                }, 500);
            }

            if (mediaData && ((mediaData.visuals && mediaData.visuals.length > 0) || (mediaData.videos && mediaData.videos.length > 0))) {
                let mediaHtml = `<div class="media-scroll-container no-scrollbar">`;
                
                if (mediaData.videos) {
                    mediaData.videos.forEach(v => {
                        const query = encodeURIComponent(v.query || v.title);
                        const thumbUrl = `https://tse2.mm.bing.net/th?q=${query}+youtube+thumbnail&w=320&h=180&c=7&rs=1`;
                        const ytUrl = `https://www.youtube.com/results?search_query=${query}`;
                        mediaHtml += `
                        <a href="${ytUrl}" target="_blank" class="video-card">
                            <div class="video-thumbnail-container">
                                <img src="${thumbUrl}" class="video-thumbnail">
                                <div class="video-play-btn"><i class="fa-solid fa-play"></i></div>
                            </div>
                            <div class="video-title">${v.title}</div>
                        </a>`;
                    });
                }

                if (mediaData.visuals) {
                    mediaData.visuals.forEach(visual => {
                         const imgUrl = `https://tse2.mm.bing.net/th?q=${encodeURIComponent(visual)}&w=320&h=200&c=7&rs=1`;
                         const safeVisual = visual.replace(/'/g, "\\'");
                         mediaHtml += `
                         <div class="study-img-card" onclick="openImageModal('${imgUrl}', '${safeVisual}')">
                            <img src="${imgUrl}" class="study-img" loading="lazy">
                            <div class="study-img-caption">${visual}</div>
                         </div>`;
                    });
                }
                mediaHtml += `</div>`;
                contentHtml = mediaHtml + contentHtml;
            }

            if (followUpData && followUpData.length > 0) {
                let followUpHtml = `<div class="follow-up-section"><div class="follow-up-header"><i class="fa-solid fa-layer-group"></i> Related</div>`;
                followUpData.forEach(q => {
                    followUpHtml += `<button onclick="useFollowUp('${q.replace(/'/g, "\\'")}')" class="follow-up-btn"><span>${q}</span> <i class="fa-solid fa-plus"></i></button>`;
                });
                followUpHtml += `</div>`;
                contentHtml += followUpHtml;
            }

            if (codePlan) {
                const planHtml = `
                <div class="code-plan-card">
                    <div class="code-plan-title"><i class="fa-solid fa-compass-drafting"></i> Implementation Plan</div>
                    <div class="code-plan-content">
                        ${marked.parse(codePlan)}
                    </div>
                </div>`;
                contentHtml = planHtml + contentHtml;
            }

            if (ideaData) {
                let blueprintHtml = '';
                blueprintHtml += `
                <div class="scholar-card">
                    <div class="scholar-type"><i class="fa-regular fa-lightbulb"></i> Startup Concept</div>
                    <div class="scholar-title">${ideaData.title || 'Startup Concept'}</div>
                    <div class="scholar-authors" style="font-style: italic;">${ideaData.tagline || ''}</div>
                    <div class="scholar-abstract" style="margin-top: 8px;">${ideaData.ideology || ''}</div>
                </div>`;

                if (ideaData.goals && ideaData.goals.length > 0) {
                    blueprintHtml += `
                    <div class="scholar-card">
                        <div class="scholar-type"><i class="fa-solid fa-bullseye"></i> Strategic Goals</div>
                        <div class="scholar-abstract">
                            <ul style="list-style: none; padding: 0; margin: 0;">
                                ${ideaData.goals.map(g => `<li style="margin-bottom: 6px; display: flex; gap: 8px;"><i class="fa-solid fa-check text-green-500 mt-1 text-xs"></i> <span>${g}</span></li>`).join('')}
                            </ul>
                        </div>
                    </div>`;
                }

                if (ideaData.roadmap && ideaData.roadmap.length > 0) {
                    blueprintHtml += `
                    <div class="scholar-card">
                        <div class="scholar-type"><i class="fa-solid fa-route"></i> Execution Roadmap</div>
                        <div class="scholar-abstract">
                             ${ideaData.roadmap.map(step => `
                                <div style="margin-bottom: 12px;">
                                    <div style="font-weight: 600; color: #334155; font-size: 0.9rem;">${step.step}</div>
                                    <div style="color: #64748B; font-size: 0.85rem;">${step.detail}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>`;
                }

                if (ideaData.resources && ideaData.resources.length > 0) {
                     blueprintHtml += `
                    <div class="scholar-card">
                        <div class="scholar-type"><i class="fa-solid fa-link"></i> Market Resources</div>
                        <div style="margin-top: 10px;">
                            <div class="web-grid">
                                ${ideaData.resources.map(res => {
                                    let domain = 'google.com';
                                    try { domain = new URL(res.link).hostname; } catch(e){}
                                    const imgUrl = `https://tse2.mm.bing.net/th?q=${encodeURIComponent(res.title + " logo")}&w=320&h=180&c=7&rs=1`;
                                    return `
                                    <a href="${res.link}" target="_blank" class="web-card">
                                        <img src="${imgUrl}" class="web-card-visual" loading="lazy" onerror="this.src='https://www.google.com/s2/favicons?domain=${domain}&sz=64'; this.style.objectFit='contain'; this.style.padding='20px';">
                                        <div class="web-card-content">
                                            <div class="web-card-top">
                                                <img src="https://www.google.com/s2/favicons?domain=${domain}&sz=32" class="web-card-favicon">
                                                <div class="web-card-source">${res.title}</div>
                                            </div>
                                            <div class="web-card-title text-xs text-gray-600">${res.desc || res.title}</div>
                                        </div>
                                    </a>`;
                                }).join('')}
                            </div>
                        </div>
                    </div>`;
                }
                
                contentHtml = blueprintHtml + contentHtml;
            }

            if (studyData) {
                let studyHtml = '';

                studyHtml += `
                <div class="scholar-card" style="border-left: 3px solid #10B981;">
                    <div class="scholar-type" style="color: #059669;"><i class="fa-solid fa-book-open"></i> ${studyData.level || 'Study Topic'}</div>
                    <div class="scholar-title">${studyData.subject || 'General'}</div>
                    <div class="scholar-abstract" style="margin-top:10px;">
                        ${studyData.explanation ? marked.parse(studyData.explanation) : ''}
                    </div>
                </div>`;

                if ((studyData.visuals && studyData.visuals.length > 0) || (studyData.videos && studyData.videos.length > 0)) {
                    studyHtml += `
                    <div class="scholar-card" style="border-left: 3px solid #10B981;">
                        <div class="scholar-type" style="color: #059669;"><i class="fa-regular fa-image"></i> Visual & Video Aids</div>
                        <div class="media-scroll-container no-scrollbar" style="margin-top: 10px;">`;
                    
                    if (studyData.videos) {
                        studyData.videos.forEach(v => {
                            const query = encodeURIComponent(v.query || v.title);
                            const thumbUrl = `https://tse2.mm.bing.net/th?q=${query}+youtube+thumbnail&w=320&h=180&c=7&rs=1`;
                            const ytUrl = `https://www.youtube.com/results?search_query=${query}`;
                            studyHtml += `
                            <a href="${ytUrl}" target="_blank" class="video-card">
                                <div class="video-thumbnail-container">
                                    <img src="${thumbUrl}" class="video-thumbnail">
                                    <div class="video-play-btn"><i class="fa-solid fa-play"></i></div>
                                </div>
                                <div class="video-title">${v.title}</div>
                            </a>`;
                        });
                    }

                    if (studyData.visuals) {
                        studyData.visuals.forEach(visual => {
                             const imgUrl = `https://tse2.mm.bing.net/th?q=${encodeURIComponent(visual)}&w=320&h=200&c=7&rs=1`;
                             const safeVisual = visual.replace(/'/g, "\\'");
                             studyHtml += `
                             <div class="study-img-card" onclick="openImageModal('${imgUrl}', '${safeVisual}')">
                                <img src="${imgUrl}" class="study-img" loading="lazy">
                                <div class="study-img-caption">${visual}</div>
                             </div>`;
                        });
                    }
                    studyHtml += `</div></div>`;
                }

                if (studyData.steps && studyData.steps.length > 0) {
                    studyHtml += `
                    <div class="scholar-card" style="border-left: 3px solid #10B981;">
                        <div class="scholar-type" style="color: #059669;"><i class="fa-solid fa-list-ol"></i> Solution Steps</div>
                        <div class="study-steps-container">`;
                    studyData.steps.forEach((step, index) => {
                        studyHtml += `
                        <div class="study-step-item">
                            <div class="study-step-number">${index + 1}</div>
                            <div class="study-step-content">
                                <span class="study-step-title">${step.label || 'Step ' + (index+1)}</span>
                                <div class="study-step-text">${marked.parse(step.text || '')}</div>
                            </div>
                        </div>`;
                    });
                    studyHtml += `</div></div>`;
                }

                if (studyData.final_answer) {
                    studyHtml += `
                    <div class="scholar-card" style="background: #F0FDF4; border: 1px solid #86EFAC;">
                        <div class="scholar-type" style="color: #15803D;"><i class="fa-solid fa-calculator"></i> Final Answer</div>
                        <div style="font-size: 1.1rem; font-weight: 600; color: #14532D; margin-top: 8px;">
                            ${studyData.final_answer}
                        </div>
                    </div>`;
                }

                if (studyData.resources && studyData.resources.length > 0) {
                     studyHtml += `
                    <div class="scholar-card" style="border-left: 3px solid #10B981;">
                        <div class="scholar-type" style="color: #059669;"><i class="fa-solid fa-link"></i> Learning Resources</div>
                        <div style="margin-top: 10px;">
                            <div class="web-grid">`;
                     studyData.resources.forEach(res => {
                         let domain = 'google.com';
                         try { domain = new URL(res.link).hostname; } catch(e){}
                         const imgUrl = `https://tse2.mm.bing.net/th?q=${encodeURIComponent(res.title + " logo")}&w=320&h=180&c=7&rs=1`;
                         studyHtml += `
                            <a href="${res.link}" target="_blank" class="web-card">
                                <img src="${imgUrl}" class="web-card-visual" loading="lazy" onerror="this.src='https://www.google.com/s2/favicons?domain=${domain}&sz=64'; this.style.objectFit='contain'; this.style.padding='20px';">
                                <div class="web-card-content">
                                    <div class="web-card-top">
                                        <img src="https://www.google.com/s2/favicons?domain=${domain}&sz=32" class="web-card-favicon">
                                        <div class="web-card-source">${res.title}</div>
                                    </div>
                                    <div class="web-card-title text-xs text-gray-600">${res.desc || res.title}</div>
                                </div>
                            </a>`;
                     });
                     studyHtml += `</div></div></div>`;
                }
                
                if (studyData.follow_up && studyData.follow_up.length > 0) {
                    studyHtml += `<div class="follow-up-section"><div class="follow-up-header"><i class="fa-solid fa-layer-group"></i> Related</div>`;
                    studyData.follow_up.forEach(q => {
                        studyHtml += `<button onclick="useFollowUp('${q.replace(/'/g, "\\'")}')" class="follow-up-btn"><span>${q}</span> <i class="fa-solid fa-plus"></i></button>`;
                    });
                    studyHtml += `</div>`;
                }

                contentHtml = studyHtml + contentHtml;
            }

            if (thoughtProcess) {
                const thoughtHtml = `
                <details class="thinking-accordion">
                    <summary class="thinking-summary">Thinking Process</summary>
                    <div class="thinking-content">
                        ${marked.parse(thoughtProcess)}
                    </div>
                </details>`;
                contentHtml = thoughtHtml + contentHtml;
            }

        } else {
            contentHtml = msg.content.replace(/\n/g, '<br>');
        }
        
        if (msg.role === 'user' && msg.attachments && msg.attachments.length > 0) {
            let attachmentsHtml = '<div class="flex flex-wrap gap-2 mb-3 mt-1">';
            msg.attachments.forEach(att => {
                if (att.type === 'image') {
                    attachmentsHtml += `
                    <img src="${att.data}" class="rounded-xl h-auto w-auto max-h-[300px] max-w-full border border-white/50 shadow-sm object-contain bg-white/30 cursor-pointer hover:shadow-md transition-shadow" onclick="openImageModal('${att.data}')">`;
                } else if (att.type === 'pdf') {
                    attachmentsHtml += `
                    <div class="h-24 w-20 bg-white/30 rounded-lg flex flex-col items-center justify-center border border-white/50 p-2 text-center backdrop-blur-sm" title="${att.name}">
                        <i class="fa-regular fa-file-pdf text-red-500 text-2xl mb-1"></i>
                        <span class="text-[10px] text-gray-600 overflow-hidden line-clamp-2 w-full leading-tight">${att.name}</span>
                    </div>`;
                } else if (att.type === 'link') {
                     let domain = att.name;
                     attachmentsHtml += `
                    <a href="${att.data}" target="_blank" class="attachment-link-card h-10 px-3 bg-white/40 rounded-lg flex items-center border border-white/50 gap-2 no-underline hover:bg-white/60 transition-colors backdrop-blur-sm">
                        <div class="w-6 h-6 rounded-full bg-white/80 flex items-center justify-center text-blue-500 text-xs shadow-sm border border-white/60"><i class="fa-solid fa-link"></i></div>
                        <span class="text-xs text-gray-700 font-medium truncate max-w-[120px] no-underline">${domain}</span>
                    </a>`;
                }
            });
            attachmentsHtml += '</div>';
            contentHtml = attachmentsHtml + contentHtml;
        } 
        else if (msg.role === 'user') {
            if (msg.image) {
                contentHtml = `<div class="mb-3 mt-1"><img src="${msg.image}" class="rounded-xl h-auto w-auto max-h-[300px] max-w-full border border-white/50 shadow-sm object-contain bg-white/30 cursor-pointer hover:shadow-md transition-shadow" onclick="openImageModal('${msg.image}')"></div>` + contentHtml;
            }
        }

        const uniqueMapId = 'map-' + Date.now() + Math.floor(Math.random() * 1000);
        
        let locationsHtml = '';
        if (mapData && mapData.length > 0) {
            const originalQuery = chats.find(c => c.id === currentChatId)?.messages.slice().reverse().find(m => m.role === 'user')?.content || '';
            const safeQuery = originalQuery.replace(/'/g, "\\'"); 

            locationsHtml += `
            <div class="map-wrapper">
                <div class="map-header">
                    <div class="map-title"><i class="fa-solid fa-map-location-dot text-accentBlueSoft"></i> Locations Found</div>
                    <div class="flex gap-2">
                         <button onclick="measureDistance('${uniqueMapId}')" class="text-xs bg-white/50 text-gray-700 px-3 py-1.5 rounded-full font-medium hover:bg-white/80 transition-colors flex items-center gap-1 backdrop-blur-sm border border-white/30"><i class="fa-solid fa-ruler-combined"></i> Measure</button>
                         <button onclick="findNearMe('${uniqueMapId}', '${safeQuery}')" class="text-xs bg-blue-50/70 text-blue-600 px-3 py-1.5 rounded-full font-medium hover:bg-blue-100/80 transition-colors flex items-center gap-1 backdrop-blur-sm border border-white/30"><i class="fa-solid fa-location-crosshairs"></i> Near Me</button>
                    </div>
                </div>
                <div id="${uniqueMapId}" class="interactive-map"></div>
            </div>`;
            
            locationsHtml += `<div class="location-cards-container no-scrollbar">`;
            mapData.forEach((loc) => {
                const city = loc.city || "";
                const searchQuery = encodeURIComponent(loc.name + " " + city + " storefront exterior");
                const imgUrl = `https://tse2.mm.bing.net/th?q=${searchQuery}&w=400&h=300&c=7&rs=1&pid=1.7`;
                const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(loc.name + ' ' + (loc.lat ? loc.lat+','+loc.lon : ''))}`;
                
                locationsHtml += `
                <div class="location-card">
                    <div class="loc-img-wrapper group">
                         <img src="${imgUrl}" class="loc-img transition-transform group-hover:scale-105" loading="lazy" onerror="this.onerror=null;this.parentElement.innerHTML='<div class=\'loc-no-img\'><i class=\'fa-regular fa-image text-xl mb-1\'></i><span>No Image</span></div>'">
                    </div>
                    <div class="loc-info">
                        <div class="loc-name" title="${loc.name}">${loc.name}</div>
                        <div class="loc-desc" title="${loc.desc}">${loc.desc || 'No description available'}</div>
                        <div class="loc-actions">
                            <a href="${mapsUrl}" target="_blank" class="loc-btn btn-maps"><i class="fa-solid fa-diamond-turn-right"></i> Directions</a>
                        </div>
                    </div>
                </div>`;
            });
            locationsHtml += `</div>`;
        }

        div.innerHTML = `
            <div class="message-inner">
                <div class="thread-line"></div>
                <div class="avatar-container">
                    ${avatar}
                </div>
                <div class="flex-1 min-w-0 pt-1">
                    <div class="flex items-center gap-2 mb-1">
                        <span class="font-semibold text-sm text-gray-800">${name}</span>
                        <span class="text-xs text-gray-400">${time}</span>
                        ${msg.mode === 'scholar' ? '<span class="text-[10px] bg-white/40 text-gray-700 px-2 rounded-full font-bold border border-white/40">SCHOLAR</span>' : ''}
                        ${msg.mode === 'web' ? '<span class="text-[10px] bg-blue-50/70 text-accentBlueSoft px-2 rounded-full font-bold">WEB</span>' : ''}
                        ${msg.mode === 'idea' ? '<span class="text-[10px] bg-[#FFF4F0]/70 text-[#D97757] px-2 rounded-full font-bold border border-[#FED7AA]/50">STARTUP BLUEPRINT</span>' : ''}
                        ${msg.mode === 'study' ? '<span class="text-[10px] bg-[#ECFDF5]/70 text-[#059669] px-2 rounded-full font-bold border border-[#A7F3D0]/50">STUDY MODE</span>' : ''}
                        ${msg.mode === 'code' ? '<span class="text-[10px] bg-[#312e81]/70 text-indigo-100 px-2 rounded-full font-bold border border-indigo-500/50">CODE CANVAS</span>' : ''}
                    </div>
                    ${locationsHtml}
                    <div class="prose-content text-gray-700 leading-7 message-content-box">
                        ${contentHtml}
                    </div>
                    ${isAI ? `<div class="flex gap-4 mb-2"><button onclick="copyToClipboard(this)" class="text-xs text-gray-400 hover:text-gray-700 flex items-center gap-1 transition-colors"><i class="fa-regular fa-copy"></i> Copy</button></div>` : ''}
                </div>
            </div>
        `;
        
        container.appendChild(div);

        if (window.renderMathInElement) {
            renderMathInElement(div, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false},
                    {left: '\\(', right: '\\)', display: false},
                    {left: '\\[', right: '\\]', display: true}
                ],
                throwOnError : false
            });
        }
        
        if(isAI) {
            div.querySelectorAll('pre code').forEach((block) => {
                const parent = block.parentElement;
                
                const lang = block.className.replace('language-', '') || 'txt';
                block.className = `language-${lang}`;
                
                const wrapper = document.createElement('div');
                wrapper.className = 'code-block-wrapper';
                
                let previewBtn = '';
                if (lang === 'html' || lang === 'xml' || lang === 'svg') {
                    const previewId = 'prev-' + Date.now() + Math.random().toString(36).substr(2, 9);
                    previewStore[previewId] = block.innerText;
                    previewBtn = `<button onclick="openPreviewModal('${previewId}')" class="code-action-btn"><i class="fa-solid fa-eye"></i> Preview</button>`;
                }

                wrapper.innerHTML = `
                <div class="code-header">
                    <span class="flex items-center gap-2"><i class="fa-solid fa-code text-xs"></i> ${lang.toUpperCase()}</span>
                    <div class="code-header-actions">
                        ${previewBtn}
                        <button onclick="navigator.clipboard.writeText(this.closest('.code-block-wrapper').querySelector('code').innerText)" class="code-action-btn"><i class="fa-regular fa-copy"></i> Copy</button>
                    </div>
                </div>`;
                
                parent.parentNode.insertBefore(wrapper, parent);
                wrapper.appendChild(parent);
                
                if(window.Prism) Prism.highlightElement(block);
            });

            if (mapData && mapData.length > 0) {
                setTimeout(() => {
                    const map = L.map(uniqueMapId);
                    
                    map.setView([mapData[0].lat, mapData[0].lon], 13);
                    
                    L.tileLayer('http://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}',{
                        maxZoom: 20,
                        subdomains:['mt0','mt1','mt2','mt3']
                    }).addTo(map);

                    const bounds = L.latLngBounds();
                    const markers = [];
                    mapData.forEach(loc => {
                        const marker = L.marker([loc.lat, loc.lon]).addTo(map);
                        marker.bindPopup(`<b>${loc.name}</b><br>${loc.desc || ''}`);
                        bounds.extend([loc.lat, loc.lon]);
                        markers.push(marker);
                    });
                    
                    if (mapData.length === 1) {
                         map.setView([mapData[0].lat, mapData[0].lon], 16); 
                    } else {
                         map.fitBounds(bounds, { padding: [50, 50] });
                    }
                    
                    mapsStore[uniqueMapId] = map;
                    mapMarkersStore[uniqueMapId] = markers;
                }, 500); 
            }
        }
    }
    
    function resizeImage(file, maxWidth, maxHeight, callback) {
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                let width = img.width;
                let height = img.height;
                if (width > height) {
                    if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; }
                } else {
                    if (height > maxHeight) { width *= maxHeight / height; height = maxHeight; }
                }
                const canvas = document.createElement('canvas');
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                callback(canvas.toDataURL(file.type));
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }
    
    async function extractPdfText(file) {
        try {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            let fullText = "";
            
            const maxPages = Math.min(pdf.numPages, 5);
            
            for (let i = 1; i <= maxPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                const pageText = textContent.items.map(item => item.str).join(' ');
                fullText += `--- Page ${i} ---\n${pageText}\n\n`;
            }
            
            if (pdf.numPages > 5) {
                fullText += `\n[...PDF truncated. Total pages: ${pdf.numPages}]`;
            }
            
            return fullText;
        } catch (error) {
            console.error("PDF Parsing Error:", error);
            return null;
        }
    }
    
    function renderAttachmentPreview() {
        const preview = document.getElementById('attachment-preview');
        preview.innerHTML = '';
        preview.style.display = 'none';

        if (attachments.length === 0) {
            const btn = document.getElementById('btn-attach');
            btn.classList.remove('text-gray-900', 'bg-white/80');
            btn.classList.add('hover:bg-white/60', 'text-gray-400');
            return;
        }

        preview.style.display = 'flex';
        
        attachments.forEach(att => {
            let html = '';
            if (att.type === 'image') {
                html = `
                <div class="attachment-card">
                    <img src="${att.data}" class="attachment-thumb">
                    <div class="attachment-info">
                        <span class="attachment-name">Image</span>
                        <span class="attachment-type">Upload</span>
                    </div>
                    <i class="fa-solid fa-xmark attachment-remove-btn" onclick="removeAttachment('${att.id}')"></i>
                </div>`;
            } else if (att.type === 'pdf') {
                html = `
                <div class="attachment-card">
                    <div class="attachment-icon-placeholder">
                        <i class="fa-regular fa-file-pdf"></i>
                    </div>
                    <div class="attachment-info">
                        <span class="attachment-name" title="${att.name}">${att.name}</span>
                        <span class="attachment-type">PDF</span>
                    </div>
                    <i class="fa-solid fa-xmark attachment-remove-btn" onclick="removeAttachment('${att.id}')"></i>
                </div>`;
            } else if (att.type === 'link') {
                html = `
                <div class="attachment-card">
                    <div class="attachment-icon-placeholder">
                        <i class="fa-solid fa-link"></i>
                    </div>
                    <div class="attachment-info">
                        <span class="attachment-name" title="${att.name}">${att.name}</span>
                        <span class="attachment-type">Link</span>
                    </div>
                    <i class="fa-solid fa-xmark attachment-remove-btn" onclick="removeAttachment('${att.id}')"></i>
                </div>`;
            }
            preview.innerHTML += html;
        });

        const btn = document.getElementById('btn-attach');
        btn.classList.add('text-gray-900', 'bg-white/80');
        btn.classList.remove('hover:bg-white/60', 'text-gray-400');
    }

    function removeAttachment(id) {
        attachments = attachments.filter(a => a.id !== id);
        renderAttachmentPreview();
        if(attachments.length === 0) document.getElementById('file-upload').value = '';
    }

    async function checkLocationAndSend() {
        const inputEl = document.getElementById('user-input');
        const text = inputEl.value.trim();
        if(!text && attachments.length === 0) return;
        
        const lowerText = text.toLowerCase();
        const explicitMapRequest = lowerText.includes('map') || lowerText.includes('show me') || lowerText.includes('location');
        const locationKeywords = /(nearest|nearby|near|location|where|closest|find|show)/;
        const placeKeywords = /(shop|store|publish|print|place|restaurant|cafe|library|book|gym|hotel|museum|park|hospital|school|university|agency|center)/;
        
        let isLocationIntent = explicitMapRequest || (lowerText.match(locationKeywords) && lowerText.match(placeKeywords)) || (lowerText.includes("where is") && lowerText.match(placeKeywords));

        if (!isLocationIntent && (lowerText === 'location?' || lowerText === 'where is it?' || lowerText.includes('give the map'))) {
            isLocationIntent = true;
        }

        if (isLocationIntent) {
            const cleaned = cleanSearchQuery(text);
            const isVague = !cleaned || cleaned.length < 3 || cleaned === 'it';
            
            if (isVague) {
                sendMessage(null, null, true);
                return;
            }

            if (navigator.geolocation) {
                const btn = document.getElementById('send-btn');
                const originalHtml = btn.innerHTML;
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
                btn.disabled = true;

                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        btn.innerHTML = originalHtml;
                        btn.disabled = false;
                        const { latitude, longitude } = position.coords;
                        
                        let addressContext = `Lat: ${latitude}, Lon: ${longitude}`;
                        try {
                            const resp = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`, { headers: { 'User-Agent': 'NewtonAI/1.0' } });
                            const data = await resp.json();
                            if(data && data.address) {
                                const city = data.address.city || data.address.town || data.address.village || '';
                                addressContext = `${city}, ${data.address.country || ''} (Lat: ${latitude}, Lon: ${longitude})`;
                            }
                        } catch(e) {}
                        
                        const realPlaces = await searchRealPlaces(text, latitude, longitude);
                        sendMessage(addressContext, realPlaces, true);
                    },
                    (error) => {
                        btn.innerHTML = originalHtml;
                        btn.disabled = false;
                        console.warn("Location fetch failed, proceeding without location.");
                        sendMessage(null, null, true); 
                    },
                    { 
                        enableHighAccuracy: true, 
                        timeout: 15000, 
                        maximumAge: 0 
                    }
                );
            } else {
                sendMessage(null, null, true);
            }
        } else {
            sendMessage(null, null, false);
        }
    }

    async function sendMessage(locationContext, realPlacesData, isLocationIntent) {
        const inputEl = document.getElementById('user-input');
        const text = inputEl.value.trim();
        
        if (!text && attachments.length === 0) return;

        if (!currentChatId) startNewChat();
        setLandingMode(false);

        inputEl.value = '';
        inputEl.style.height = 'auto';
        document.getElementById('char-count').innerText = '0';

        const currentMode = isStudyMode ? 'study' : (isIdeaMode ? 'idea' : (isScholarMode ? 'scholar' : (isWebSearchMode ? 'web' : (isCodeMode ? 'code' : 'normal'))));
        
        const sentAttachments = [...attachments];
        clearAttachments();
        
        const userMsg = { 
            role: 'user', 
            content: text, 
            mode: currentMode,
            attachments: sentAttachments
        };
        
        const firstImage = sentAttachments.find(a => a.type === 'image');
        if(firstImage) userMsg.image = firstImage.data;

        const chat = chats.find(c => c.id === currentChatId);
        if(chat) {
            chat.messages.push(userMsg);
            if (chat.messages.length === 1) {
                let title = "New Conversation";
                if(text) title = text.substring(0, 30) + '...';
                else if(sentAttachments.length > 0) title = 'File Analysis';
                chat.title = title;
                renderHistory();
            }
            localStorage.setItem('newton_chats', JSON.stringify(chats));
        }
        renderMessage(userMsg, true);
        scrollToBottom();

        let websiteContext = "";
        const links = sentAttachments.filter(a => a.type === 'link');
        if (links.length > 0) {
            const loadingMsgId = 'reading-' + Date.now();
            try {
                document.getElementById('messages-list').insertAdjacentHTML('beforeend', 
                    `<div id="${loadingMsgId}" class="text-xs text-center text-gray-400 my-2 flex justify-center items-center gap-2"><i class="fa-solid fa-circle-notch fa-spin"></i> Reading website content...</div>`);
                scrollToBottom();

                for (const link of links) {
                    const res = await fetch(`https://r.jina.ai/${link.data}`);
                    if(res.ok) {
                        let content = await res.text();
                        if(content.length > 15000) content = content.substring(0, 15000) + "\n... [Truncated]";
                        websiteContext += `\n\n### WEBPAGE CONTENT (${link.data}) ###\n${content}\n\n`;
                    }
                }
                
                document.getElementById(loadingMsgId)?.remove();
            } catch(e) {
                console.warn("Failed to fetch website content", e);
                document.getElementById(loadingMsgId)?.remove();
            }
        }

        const loadingId = 'loading-' + Date.now();
        const loadingHtml = `<div id="${loadingId}" class="message-row pl-4 pr-2"><div class="message-inner"><div class="thread-line"></div><div class="avatar-container rounded-full bg-gray-800 flex items-center justify-center shadow-sm border-2 border-white"><i class="fa-solid fa-cube text-xs text-white"></i></div><div class="flex-1 space-y-3 py-2"><div class="h-4 bg-white/50 rounded w-1/4 shimmer"></div><div class="h-4 bg-white/50 rounded w-3/4 shimmer"></div></div></div></div>`;
        document.getElementById('messages-list').insertAdjacentHTML('beforeend', loadingHtml);
        scrollToBottom();

        let historyString = "";
        const MAX_CONTEXT_CHARS = 1500;
        
        if(chat) {
            for (let i = chat.messages.length - 1; i >= 0; i--) {
                const m = chat.messages[i];
                let cleanContent = m.content.replace(/<<<.*?>>>/g, '[Data Block]'); 
                const attTags = (m.attachments || []).map(a => `[User attached ${a.type}: ${a.name}]`).join(' ');
                const msgString = `### ${m.role === 'user' ? 'USER' : 'ASSISTANT'} (${m.mode || 'normal'} mode):\n${attTags} ${cleanContent}\n\n`;
                
                if ((historyString.length + msgString.length) < MAX_CONTEXT_CHARS) {
                    historyString = msgString + historyString;
                } else {
                    break;
                }
            }
        }

        const thinkingInstruction = `
        CRITICAL: Begin your response with a hidden "Thinking Block" that outlines your plan.
        Format: <<<THOUGHT_START>>> [Your brief step-by-step analysis plan, search strategy, or reasoning here] <<<THOUGHT_END>>>.
        This block will be parsed and shown as a collapsible "Thinking Process" to the user.
        `;

        let prompt = "";
        if (isLocationIntent) {
             const locInfo = locationContext ? `User Accurate Location: ${locationContext}` : "User location is unavailable.";
             
             if (!realPlacesData || realPlacesData.length === 0) {
                 prompt = `Role: Helpful Local Guide & Map Generator. 
                 Query: "${text}". 
                 ${locInfo}
                 ${thinkingInstruction}

                 INSTRUCTIONS:
                 1. If the user asks for ONE specific place (e.g. "The Eiffel Tower"), generate coordinates for ONLY that place.
                 2. If general (e.g. "restaurants"), generate 3 plausible locations.
                 3. WRAP MAP DATA IN: <<<LOCATIONS_START>>> [JSON] <<<LOCATIONS_END>>>. 
                 
                 REQUIRED JSON FORMAT:
                 [
                    {"name": "Place Name", "lat": 27.5983, "lon": 89.8766, "desc": "Contextual description", "city": "City"}
                 ]
                 
                 (Keep text response brief)`;
             } else {
                 prompt = `Role: Helpful Local Guide. Query: "${text}". ${locInfo}
                I found real places. JSON: ${JSON.stringify(realPlacesData)}
                ${thinkingInstruction}

                INSTRUCTIONS:
                1. Use the real place data provided.
                2. If the user asked for a SINGLE specific place, only return that one in the JSON.
                3. WRAP MAP DATA IN: <<<LOCATIONS_START>>> [JSON] <<<LOCATIONS_END>>>.

                REQUIRED JSON FORMAT:
                [
                    {"name": "Place Name", "lat": 12.34, "lon": 56.78, "desc": "Brief description", "city": "City"}
                ]`;
             }

        } else if (isScholarMode) {
            prompt = `Role: Academic Research Assistant. 
            Task: Provide critical analysis and findings for the user query.
            ${thinkingInstruction}
            
            IMPORTANT:
            1. You MUST include AT LEAST 3 (ideally 4-5) REAL academic references.
            2. Do not use 'example.com' or placeholder links. 
            3. If you don't have a direct link, use a Google Scholar search URL: https://scholar.google.com/scholar?q=Title
            
            FORMAT EACH PAPER EXACTLY LIKE THIS:
            <<<PAPER_START>>>
            Title: [Paper Title]
            Authors: [Author Names]
            Journal: [Journal Name, Year]
            Link: [Real URL or Google Scholar Search]
            Summary: [One sentence key finding]
            <<<PAPER_END>>>

            Repeat the block for each paper. Then provide your analysis.
            
            Finally, provide 3 follow-up questions wrapped in <<<FOLLOWUP_START>>> ["Q1", "Q2", "Q3"] <<<FOLLOWUP_END>>>.

            ### CONVERSATION HISTORY (Truncated) ###
            ${historyString}
            
            Current Query: ${text}`;

        } else if (isIdeaMode) {
            prompt = `Role: Startup Incubator / Product Manager.
            Task: Analyze the user's idea and generate a structured Blueprint.
            ${thinkingInstruction}

            IMPORTANT: You MUST include AT LEAST 3 distinct resources (competitors, tools, or inspiration websites) in the 'resources' array.

            REQUIRED JSON FORMAT (Must be valid JSON):
            <<<IDEA_START>>>
            {
              "title": "Startup Name",
              "tagline": "A catchy slogan",
              "ideology": "Core mission statement and ideology.",
              "goals": ["Goal 1", "Goal 2", "Goal 3"],
              "roadmap": [
                {"step": "Phase 1", "detail": "Actionable step 1"},
                {"step": "Phase 2", "detail": "Actionable step 2"}
              ],
              "resources": [
                {"title": "Competitor/Tool Name", "link": "https://full-url.com", "desc": "Why it is relevant"},
                {"title": "Resource 2", "link": "https://example.com", "desc": "Relevance"},
                {"title": "Resource 3", "link": "https://another.com", "desc": "Relevance"}
              ]
            }
            <<<IDEA_END>>>

            After the JSON, provide a brief, encouraging summary and feedback text.
            Also, provide 3 follow-up questions wrapped in <<<FOLLOWUP_START>>> ["Q1", "Q2", "Q3"] <<<FOLLOWUP_END>>>.

            ### CONVERSATION HISTORY (Truncated) ###
            ${historyString}
            
            Current Idea: ${text}`;
            
        } else if (isStudyMode) {
            prompt = `Role: Expert AI Tutor (Newton).
            Task: Teach the user about "${text}".
            ${thinkingInstruction}

            CRITICAL: Return strictly a VALID JSON object. Do not wrap it in markdown ticks if possible, or use standard markdown code blocks.
            
            MATH RULES:
            1. Use LaTeX for math. 
            2. Enclose inline math with single '$' (e.g., $E=mc^2$).
            3. Enclose block math with double '$$'.
            4. ESCAPE backslashes in JSON strings (e.g., "\\frac{a}{b}" becomes "\\\\frac{a}{b}").
            
            JSON FORMAT:
            \`\`\`json
            {
               "subject": "Subject",
               "level": "Grade Level",
               "explanation": "Detailed explanation using standard LaTeX math.",
               "steps": [
                  {"label": "Step 1", "text": "Details using LaTeX math."}
               ],
               "visuals": ["keyword1", "keyword2"],
               "videos": [{"title": "Video Topic", "query": "search query for youtube"}],
               "resources": [{"title": "Name", "link": "url", "desc": "info"}],
               "final_answer": "Final result in LaTeX.",
               "follow_up": ["Question 1?", "Question 2?", "Question 3?"]
            }
            \`\`\`
            
            IMPORTANT:
            - Provide 3 smart "follow_up" questions.
            - Provide 2-3 visual keywords.
            - Provide 2-3 video search queries for YouTube.
            - NO conversational text outside the JSON.

            ### CONVERSATION HISTORY (Truncated) ###
            ${historyString}
            
            Current Topic: ${text}`;

        } else if (isCodeMode) {
            prompt = `Role: Senior Staff Software Engineer (Newton Code Canvas).
            Task: 
            1. Analyze the user's coding request.
            2. Refine the requirements and create a brief technical specification.
            3. Generate clean, modern, efficient, and complete code (single file if web app).
            
            ${thinkingInstruction}

            OUTPUT FORMAT:
            
            First, output the Refined Plan in this specific format:
            <<<PLAN_START>>>
            **Goal:** [Brief statement of what will be built]
            **Tech Stack:** [e.g., HTML5, Tailwind, JS, React, etc.]
            **Architecture:** [Brief explanation of the approach]
            <<<PLAN_END>>>

            Then, provide the explanation and the code blocks.
            Use standard Markdown code blocks for code (e.g. \`\`\`html ... \`\`\`).
            
            IMPORTANT:
            - Output the FULL COMPLETE CODE. Do not skip sections.
            - If it's a web application, keep it in a single file (HTML + embedded CSS/JS).
            - Do not output raw JSON. Output standard Markdown.

            ### CONVERSATION HISTORY (Truncated) ###
            ${historyString}
            
            Current Request: ${text}`;

        } else if (isWebSearchMode) {
            let focusInstruction = "";
            let roleInstruction = "Role: Web Search Engine.";
            
            if (webSearchFocus === 'social') {
                roleInstruction = "Role: Social Media Researcher & Trend Analyst.";
                focusInstruction = "Focus on discussions from Reddit, Twitter (X), Quora, and forums. Analyze public sentiment, common opinions, and viral trends.";
            } else if (webSearchFocus === 'finance') {
                roleInstruction = "Role: Financial Analyst & Market Researcher.";
                focusInstruction = "Focus on stock market data, economic news, company reports, crypto trends, and investment analysis.";
                focusInstruction += `\nCRITICAL: If the user asks for the price or a chart of a specific asset (stock, crypto, pair), specifically output the TradingView symbol using this exact format:
                <<<CHART_START>>>EXCHANGE:SYMBOL<<<CHART_END>>>
                Examples: <<<CHART_START>>>NASDAQ:AAPL<<<CHART_END>>>, <<<CHART_START>>>BINANCE:BTCUSDT<<<CHART_END>>>, <<<CHART_START>>>NYSE:GME<<<CHART_END>>>.`;
            } else if (webSearchFocus === 'academic') {
                roleInstruction = "Role: Academic Researcher.";
                focusInstruction = "Focus on research papers, university publications, scientific journals, and educational resources. Use formal citation style where possible.";
            } else {
                roleInstruction = "Role: Advanced Web Search Engine.";
                focusInstruction = "Provide comprehensive, high-quality search results from diverse and trusted sources.";
            }

            prompt = `${roleInstruction}
            Task: Simulate a focused search for "${text}".
            ${focusInstruction}
            ${thinkingInstruction}
            
            FORMAT RESULTS EXACTLY LIKE THIS:

            <<<WEB_START>>>
            Source: [Source Name]
            Title: [Page Title]
            Link: [Full URL]
            Image: [URL to a relevant image, or 'null' if none]
            Summary: [Brief context]
            <<<WEB_END>>>

            Provide at least 3 distinct results. If you know a relevant image URL for the article, include it. Otherwise use 'null'.
            Then provide a summary text synthesizing the information found.
            
            If relevant, provide 1-2 search queries for YouTube videos or image keywords. Wrap them in <<<MEDIA_START>>> { "visuals": ["keyword"], "videos": [{"title": "...", "query": "..."}] } <<<MEDIA_END>>>.
            Also provide 3 follow-up questions wrapped in <<<FOLLOWUP_START>>> ["Q1", "Q2", "Q3"] <<<FOLLOWUP_END>>>.

            ### CONVERSATION HISTORY (Truncated) ###
            ${historyString}
            `;
        } else {
            let attachmentContext = "";
            sentAttachments.forEach(a => {
                if(a.type === 'pdf') attachmentContext += `\n\n### PDF CONTENT (${a.name}) ###\n${a.data}\n\n`;
                if(a.type === 'link') {} 
                if(a.type === 'image') attachmentContext += `\n\n[User attached an image]`;
            });

            const chartInstruction = `\nCRITICAL: If the user asks for the price or a chart of a specific asset (stock, crypto, etc.), output the TradingView symbol like: <<<CHART_START>>>NASDAQ:TSLA<<<CHART_END>>> or <<<CHART_START>>>BINANCE:ETHUSDT<<<CHART_END>>>.`;

            prompt = `Role: Newton AI (Helpful, Professional Assistant, powered by Gemini).
            
            ### CONVERSATION HISTORY (Truncated) ###
            ${historyString}
            
            ${websiteContext}
            ${attachmentContext}

            ### CURRENT USER INPUT ###
            ${text}
            
            Answer the user based on the context provided above (website text, PDF text, images).
            ${chartInstruction}
            ${thinkingInstruction}
            
            If the answer would benefit from visuals (like "show me a dog" or "explain an engine"), provide 1-2 search queries for YouTube videos or image keywords. 
            Wrap them in <<<MEDIA_START>>> { "visuals": ["keyword"], "videos": [{"title": "...", "query": "..."}] } <<<MEDIA_END>>>.
            
            Always provide 3 follow-up questions wrapped in <<<FOLLOWUP_START>>> ["Q1", "Q2", "Q3"] <<<FOLLOWUP_END>>>.
            `;
        }

        const finalSystemPrompt = "You are Newton AI, a helpful assistant. Use Markdown for formatting.";
        const fullPrompt = `${finalSystemPrompt}\n\n${prompt}`;

        try {
            const seed = Math.floor(Math.random() * 1000000);
            const model = 'openai'; 
            let response;

            const images = sentAttachments.filter(a => a.type === 'image');
            
            const encodedPrompt = encodeURIComponent(fullPrompt);
            const getUrl = `https://text.pollinations.ai/${encodedPrompt}?model=${model}&seed=${seed}`;
            
            if (images.length > 0 || getUrl.length > 1600) {
                const messages = [
                    { role: 'user', content: [] }
                ];
                
                messages[0].content.push({ type: "text", text: fullPrompt });

                images.forEach(img => {
                    messages[0].content.push({ type: "image_url", image_url: { url: img.data } });
                });

                if (images.length === 0) {
                     messages[0].content = fullPrompt;
                }

                response = await fetch('https://text.pollinations.ai/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ messages, model, seed }),
                    mode: 'cors',
                    referrerPolicy: 'no-referrer'
                });

            } else {
                response = await fetch(getUrl, {
                    method: 'GET',
                    mode: 'cors',
                    referrerPolicy: 'no-referrer'
                });
            }
            
            if (!response.ok) {
                 const errorText = await response.text();
                 throw new Error(`Pollinations API Error: ${response.status} ${response.statusText} - ${errorText}`);
            }
            
            const aiText = await response.text();
            let finalContent = aiText;
            
            if (aiText.trim().startsWith('{')) {
                try {
                    const parsed = JSON.parse(aiText);
                    if (parsed.content) finalContent = parsed.content;
                    else if (parsed.choices && parsed.choices[0] && parsed.choices[0].message) finalContent = parsed.choices[0].message.content;
                    else if (parsed.reasoning_content && !parsed.content) {
                         finalContent = "Thinking process:\n" + parsed.reasoning_content + "\n\n(No final output provided)";
                    }
                } catch (e) {}
            }

            document.getElementById(loadingId).remove();

            const aiMsg = { role: 'ai', content: finalContent, mode: currentMode };
            if(chat) {
                chat.messages.push(aiMsg);
                localStorage.setItem('newton_chats', JSON.stringify(chats));
            }
            renderMessage(aiMsg, true);
            scrollToBottom();
        } catch (e) {
            document.getElementById(loadingId).remove();
            console.error(e);
            
            const errorAlertId = 'err-' + Date.now();
            const errorHtml = `
            <div id="${errorAlertId}" class="message-row pl-4 pr-2">
                <div class="message-inner">
                    <div class="thread-line"></div>
                     <div class="avatar-container rounded-full bg-red-500 flex items-center justify-center shadow-sm border-2 border-white">
                        <i class="fa-solid fa-triangle-exclamation text-xs text-white"></i>
                    </div>
                    <div class="flex-1 py-2">
                        <div class="p-3 bg-red-50/70 text-red-700 rounded-lg text-sm border border-red-100/50 backdrop-blur-sm">
                            <strong>Error:</strong> Could not connect to the AI service.<br>
                            <span class="text-xs opacity-75">Details: ${e.message}</span>
                        </div>
                    </div>
                </div>
            </div>`;
            document.getElementById('messages-list').insertAdjacentHTML('beforeend', errorHtml);
            scrollToBottom();
        }
    }

    function copyToClipboard(btn) {
        const text = btn.closest('.flex-1').querySelector('.prose-content').innerText;
        navigator.clipboard.writeText(text);
    }

    function triggerFileUpload() { document.getElementById('file-upload').click(); }
    
    async function handleFileUpload(input) { 
        if(input.files && input.files.length > 0) {
            
            for (let i = 0; i < input.files.length; i++) {
                const file = input.files[i];
                
                if (file.type === 'application/pdf') {
                    const text = await extractPdfText(file);
                    if(text) {
                        attachments.push({
                            id: Date.now() + Math.random(),
                            type: 'pdf',
                            data: text,
                            name: file.name
                        });
                    }
                } else if (file.type.startsWith('image/')) {
                    await new Promise((resolve) => {
                        resizeImage(file, 800, 800, (base64) => {
                            attachments.push({
                                id: Date.now() + Math.random(),
                                type: 'image',
                                data: base64,
                                name: file.name
                            });
                            resolve();
                        });
                    });
                }
            }
            renderAttachmentPreview();
        }
    }
    
    function clearAttachments() {
        attachments = [];
        renderAttachmentPreview();
        document.getElementById('file-upload').value = '';
    }

    if (!currentChatId || chats.length === 0) setLandingMode(true);
    renderHistory();

</script>

<!-- ensure KaTeX rendering after dynamic content -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        if (window.renderMathInElement) {
            renderMathInElement(document.body, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false},
                    {left: '\\(', right: '\\)', display: false},
                    {left: '\\[', right: '\\]', display: true}
                ],
                throwOnError: false
            });
        }
    });
</script>
</body>
</html>
