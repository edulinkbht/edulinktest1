<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Newton AI â€” Scholar & Code</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.2/marked.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <!-- Core Libraries -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        apple: {
                            bg: '#FBFBFD',
                            text: '#1D1D1F',
                            blue: '#0071E3',
                            gray: '#86868B',
                            border: 'rgba(0,0,0,0.08)'
                        }
                    },
                    boxShadow: {
                        'glass': '0 8px 32px 0 rgba(31, 38, 135, 0.07)',
                        'input': '0 4px 24px rgba(0,0,0,0.06)',
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #FBFBFD; color: #1D1D1F; overflow: hidden; }
        
        /* Hide scrollbars but allow scrolling */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Apple-style Typography */
        .prose-content { font-size: 17px; line-height: 1.6; letter-spacing: -0.01em; }
        .prose-content h1, .prose-content h2 { font-weight: 700; color: #1D1D1F; margin-top: 1.5em; margin-bottom: 0.5em; }
        .prose-content p { margin-bottom: 1.25em; }
        
        /* Message Styling */
        .message-ai { background: transparent; }
        .message-user { background: #F5F5F7; border-radius: 20px; padding: 12px 20px; display: inline-block; max-width: 85%; align-self: flex-end; }
        
        /* Modern Code Blocks */
        .code-block-wrapper {
            background: #1D1D1F; border-radius: 14px; margin: 1.5rem 0; overflow: hidden;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        .code-header { background: #2D2D2F; padding: 10px 16px; display: flex; justify-content: space-between; align-items: center; color: #A1A1A6; font-size: 12px; font-weight: 500; }
        
        /* Modern Glass Sidebar */
        #sidebar { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(20px); border-right: 1px solid rgba(0,0,0,0.05); }

        /* Floating Input Container */
        #input-area-wrapper { position: relative; z-index: 50; padding-bottom: 30px; }
        .input-pill {
            background: white; border: 1px solid rgba(0,0,0,0.1); border-radius: 28px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 12px rgba(0,0,0,0.04);
        }
        .input-pill:focus-within { border-color: rgba(0,0,0,0.2); box-shadow: 0 8px 30px rgba(0,0,0,0.08); transform: translateY(-2px); }

        /* Animations */
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-slide-up { animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

        /* Mode Badges */
        .mode-tag {
            font-size: 11px; font-weight: 600; padding: 4px 10px; border-radius: 100px;
            display: flex; align-items: center; gap: 4px; transition: all 0.2s;
        }

        /* Map & Cards */
        .apple-card { background: white; border: 1px solid rgba(0,0,0,0.05); border-radius: 18px; padding: 20px; margin-bottom: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.02); }
        .interactive-map { height: 350px; border-radius: 18px; margin: 1rem 0; z-index: 1; }
    </style>
</head>
<body class="h-screen flex">

<!-- Sidebar -->
<aside id="sidebar" class="fixed inset-y-0 left-0 w-72 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out z-50 flex flex-col">
    <div class="p-6">
        <div class="flex items-center gap-3 mb-8">
            <div class="w-9 h-9 bg-black rounded-xl flex items-center justify-center text-white shadow-lg">
                <i class="fa-solid fa-bolt-lightning text-lg"></i>
            </div>
            <span class="font-bold text-xl tracking-tight">Newton</span>
        </div>
        
        <button onclick="startNewChat()" class="w-full bg-white hover:bg-gray-50 border border-apple-border text-apple-text font-medium py-3 px-4 rounded-2xl shadow-sm transition-all flex items-center gap-3 group">
            <i class="fa-solid fa-plus text-apple-blue group-hover:rotate-90 transition-transform"></i>
            <span>New Thread</span>
        </button>
    </div>

    <div class="flex-1 overflow-y-auto px-4 space-y-1 no-scrollbar" id="history-list">
        <!-- History Items -->
    </div>

    <div class="p-4 mt-auto">
        <div class="flex items-center gap-3 p-3 rounded-2xl bg-white/50 border border-apple-border">
            <div class="w-10 h-10 rounded-full bg-gradient-to-tr from-gray-200 to-gray-300"></div>
            <div class="flex-1 min-w-0">
                <p class="text-sm font-semibold truncate">Pro User</p>
                <p class="text-xs text-apple-gray">OpenAI Model</p>
            </div>
            <i class="fa-solid fa-ellipsis text-apple-gray"></i>
        </div>
    </div>
</aside>

<!-- Main Content -->
<main class="flex-1 flex flex-col relative h-full lg:ml-72 bg-apple-bg">
    
    <!-- Top Header -->
    <header class="h-16 flex items-center justify-between px-6 bg-apple-bg/80 backdrop-blur-md sticky top-0 z-40">
        <div class="flex items-center gap-4">
            <button onclick="toggleSidebar()" class="lg:hidden p-2 text-apple-text"><i class="fa-solid fa-bars"></i></button>
            <div class="px-3 py-1.5 bg-white border border-apple-border rounded-full text-xs font-semibold text-apple-gray flex items-center gap-2">
                <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                Newton v4.2
            </div>
        </div>
        <div class="flex items-center gap-3">
            <button onclick="toggleScholarMode()" class="text-apple-gray hover:text-apple-text transition-colors p-2"><i class="fa-solid fa-graduation-cap"></i></button>
            <button class="text-apple-gray hover:text-apple-text transition-colors p-2"><i class="fa-solid fa-share-nodes"></i></button>
        </div>
    </header>

    <!-- Chat Interface -->
    <div id="chat-container" class="flex-1 overflow-y-auto no-scrollbar">
        <!-- Landing State -->
        <div id="landing-screen" class="max-w-2xl mx-auto h-full flex flex-col items-center justify-center text-center p-6 space-y-8">
            <div class="w-20 h-20 bg-white rounded-[2rem] shadow-glass flex items-center justify-center mb-4">
                <i class="fa-solid fa-cube text-4xl text-apple-blue"></i>
            </div>
            <h1 class="text-4xl md:text-5xl font-bold tracking-tight text-apple-text">What can I help you<br><span class="text-apple-gray">create today?</span></h1>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 w-full">
                <button onclick="setInput('Build a clean landing page for a coffee brand using Tailwind')" class="p-4 bg-white border border-apple-border rounded-2xl text-left hover:border-apple-blue transition-all group">
                    <i class="fa-solid fa-code mb-2 text-apple-blue opacity-50"></i>
                    <p class="font-medium text-sm">Code Canvas</p>
                    <p class="text-xs text-apple-gray mt-1">Design a landing page with HTML/CSS</p>
                </button>
                <button onclick="setInput('Research recent breakthroughs in fusion energy')" class="p-4 bg-white border border-apple-border rounded-2xl text-left hover:border-apple-blue transition-all group">
                    <i class="fa-solid fa-graduation-cap mb-2 text-orange-500 opacity-50"></i>
                    <p class="font-medium text-sm">Scholar Mode</p>
                    <p class="text-xs text-apple-gray mt-1">Synthesize academic papers and citations</p>
                </button>
            </div>
        </div>

        <!-- Message List -->
        <div id="messages-list" class="max-w-3xl mx-auto py-12 px-6 hidden space-y-12"></div>
        <div id="scroll-anchor" class="h-32"></div>
    </div>

    <!-- Input Area -->
    <div id="input-area-wrapper" class="px-6">
        <div class="max-w-3xl mx-auto">
            <div class="input-pill p-2">
                <!-- Modes / File Previews -->
                <div id="active-mode-indicators" class="flex flex-wrap gap-2 px-3 pt-2"></div>
                
                <div class="flex items-end gap-2 p-2">
                    <button onclick="triggerFileUpload()" class="p-3 text-apple-gray hover:text-apple-text transition-colors"><i class="fa-solid fa-paperclip"></i></button>
                    <input type="file" id="file-upload" class="hidden" multiple onchange="handleFileUpload(this)">
                    
                    <textarea id="user-input" rows="1" placeholder="Type a message..." class="flex-1 bg-transparent border-none focus:ring-0 text-[17px] py-3 resize-none no-scrollbar max-h-60" oninput="autoResize(this)" onkeydown="handleKeydown(event)"></textarea>
                    
                    <button onclick="processAndSend()" id="send-btn" class="w-11 h-11 bg-apple-text text-white rounded-full flex items-center justify-center hover:bg-black transition-all shadow-md">
                        <i class="fa-solid fa-arrow-up"></i>
                    </button>
                </div>
                
                <!-- Tool Buttons -->
                <div class="flex items-center gap-4 px-4 pb-2 border-t border-gray-50 pt-2">
                    <button onclick="toggleMode('web')" id="btn-web" class="text-xs font-semibold text-apple-gray flex items-center gap-1.5 hover:text-apple-blue"><i class="fa-solid fa-globe"></i> Search</button>
                    <button onclick="toggleMode('scholar')" id="btn-scholar" class="text-xs font-semibold text-apple-gray flex items-center gap-1.5 hover:text-orange-500"><i class="fa-solid fa-graduation-cap"></i> Scholar</button>
                    <button onclick="toggleMode('code')" id="btn-code" class="text-xs font-semibold text-apple-gray flex items-center gap-1.5 hover:text-indigo-500"><i class="fa-solid fa-code"></i> Code</button>
                    <button onclick="toggleMode('study')" id="btn-study" class="text-xs font-semibold text-apple-gray flex items-center gap-1.5 hover:text-green-600"><i class="fa-solid fa-microscope"></i> Study</button>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- Preview Modal -->
<div id="preview-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center bg-black/20 backdrop-blur-sm p-4">
    <div class="bg-white w-full max-w-5xl h-[90vh] rounded-[24px] shadow-2xl overflow-hidden flex flex-col">
        <div class="h-14 border-b px-6 flex items-center justify-between bg-white">
            <span class="font-bold">Live Canvas</span>
            <button onclick="closePreviewModal()" class="w-8 h-8 rounded-full hover:bg-gray-100 flex items-center justify-center transition-colors"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <iframe id="preview-frame" class="w-full flex-1"></iframe>
    </div>
</div>

<script>
    /* --- State Management --- */
    let currentMode = 'normal';
    let attachments = [];
    let chats = JSON.parse(localStorage.getItem('newton_modern_chats')) || [];
    let currentChatId = null;
    const previewStore = {};

    /* --- Core UI Functions --- */
    function toggleSidebar() {
        const sb = document.getElementById('sidebar');
        sb.classList.toggle('-translate-x-full');
    }

    function autoResize(el) {
        el.style.height = 'auto';
        el.style.height = el.scrollHeight + 'px';
    }

    function handleKeydown(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            processAndSend();
        }
    }

    function toggleMode(mode) {
        currentMode = (currentMode === mode) ? 'normal' : mode;
        updateModeUI();
    }

    function updateModeUI() {
        const bar = document.getElementById('active-mode-indicators');
        bar.innerHTML = '';
        
        const btnWeb = document.getElementById('btn-web');
        const btnScholar = document.getElementById('btn-scholar');
        const btnCode = document.getElementById('btn-code');
        const btnStudy = document.getElementById('btn-study');

        [btnWeb, btnScholar, btnCode, btnStudy].forEach(b => b.classList.remove('text-apple-blue', 'text-orange-500', 'text-indigo-500', 'text-green-600'));

        if (currentMode !== 'normal') {
            let color = 'bg-gray-100 text-gray-700';
            let icon = '';
            if (currentMode === 'web') { color = 'bg-blue-50 text-apple-blue'; icon = 'fa-globe'; btnWeb.classList.add('text-apple-blue'); }
            if (currentMode === 'scholar') { color = 'bg-orange-50 text-orange-600'; icon = 'fa-graduation-cap'; btnScholar.classList.add('text-orange-600'); }
            if (currentMode === 'code') { color = 'bg-indigo-50 text-indigo-600'; icon = 'fa-code'; btnCode.classList.add('text-indigo-600'); }
            if (currentMode === 'study') { color = 'bg-green-50 text-green-700'; icon = 'fa-microscope'; btnStudy.classList.add('text-green-700'); }

            bar.innerHTML = `<span class="mode-tag ${color}"><i class="fa-solid ${icon}"></i> ${currentMode.toUpperCase()} MODE</span>`;
        }
    }

    function setInput(text) {
        const input = document.getElementById('user-input');
        input.value = text;
        autoResize(input);
        input.focus();
    }

    /* --- File Handling --- */
    function triggerFileUpload() { document.getElementById('file-upload').click(); }
    
    async function handleFileUpload(input) {
        const bar = document.getElementById('active-mode-indicators');
        for (let file of input.files) {
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    attachments.push({ type: 'image', data: e.target.result, name: file.name });
                    renderAttachments();
                };
                reader.readAsDataURL(file);
            } else if (file.type === 'application/pdf') {
                // PDF Parsing placeholder (requires pdf.js logic similar to original)
                attachments.push({ type: 'pdf', data: '[PDF Content]', name: file.name });
                renderAttachments();
            }
        }
    }

    function renderAttachments() {
        const bar = document.getElementById('active-mode-indicators');
        // Clear non-mode tags
        const existingTags = bar.querySelectorAll('.attachment-tag');
        existingTags.forEach(t => t.remove());

        attachments.forEach((att, idx) => {
            const span = document.createElement('span');
            span.className = 'attachment-tag text-[10px] bg-white border border-apple-border px-2 py-1 rounded-lg flex items-center gap-2';
            span.innerHTML = `<i class="fa-solid ${att.type === 'image' ? 'fa-image' : 'fa-file-pdf'}"></i> ${att.name} <i class="fa-solid fa-xmark cursor-pointer" onclick="removeAttachment(${idx})"></i>`;
            bar.appendChild(span);
        });
    }

    function removeAttachment(idx) {
        attachments.splice(idx, 1);
        renderAttachments();
    }

    /* --- Messaging Logic --- */
    function startNewChat() {
        currentChatId = Date.now().toString();
        document.getElementById('messages-list').innerHTML = '';
        document.getElementById('messages-list').classList.add('hidden');
        document.getElementById('landing-screen').classList.remove('hidden');
        attachments = [];
        currentMode = 'normal';
        updateModeUI();
    }

    async function processAndSend() {
        const input = document.getElementById('user-input');
        const text = input.value.trim();
        if (!text && attachments.length === 0) return;

        if (document.getElementById('messages-list').classList.contains('hidden')) {
            document.getElementById('landing-screen').classList.add('hidden');
            document.getElementById('messages-list').classList.remove('hidden');
        }

        const userMsg = { role: 'user', content: text, attachments: [...attachments], mode: currentMode };
        renderMessage(userMsg);
        
        input.value = '';
        input.style.height = 'auto';
        const activeAttachments = [...attachments];
        attachments = [];
        renderAttachments();

        // AI Request
        showLoading();
        try {
            const aiResponse = await fetchAIResponse(text, activeAttachments, currentMode);
            hideLoading();
            renderMessage({ role: 'ai', content: aiResponse, mode: currentMode });
        } catch (e) {
            hideLoading();
            renderMessage({ role: 'ai', content: "I'm sorry, I encountered an error connecting to the service." });
        }
    }

    function renderMessage(msg) {
        const list = document.getElementById('messages-list');
        const div = document.createElement('div');
        div.className = `animate-slide-up flex flex-col ${msg.role === 'user' ? 'items-end' : 'items-start'}`;

        let contentHtml = '';
        if (msg.role === 'user') {
            contentHtml = `<div class="message-user font-medium">${msg.content}</div>`;
            if (msg.attachments && msg.attachments.length > 0) {
                let atts = '<div class="flex gap-2 mb-2">';
                msg.attachments.forEach(a => {
                    if (a.type === 'image') atts += `<img src="${a.data}" class="h-20 w-20 object-cover rounded-xl border border-white">`;
                });
                atts += '</div>';
                contentHtml = atts + contentHtml;
            }
        } else {
            // Processing blocks (Thinking, Planning, Code)
            let processed = msg.content;
            
            // Extract Thinking
            const thoughtMatch = processed.match(/<<<THOUGHT_START>>>([\s\S]*?)<<<THOUGHT_END>>>/);
            if (thoughtMatch) {
                contentHtml += `<details class="w-full mb-4 text-xs text-apple-gray"><summary class="cursor-pointer hover:text-apple-text transition-colors">Thinking Process</summary><div class="p-3 bg-gray-50 rounded-xl mt-2">${marked.parse(thoughtMatch[1])}</div></details>`;
                processed = processed.replace(thoughtMatch[0], '');
            }

            contentHtml += `<div class="prose-content w-full">${marked.parse(processed)}</div>`;
        }

        div.innerHTML = contentHtml;
        list.appendChild(div);
        
        // Post-processing for Code Blocks
        if (msg.role === 'ai') {
            div.querySelectorAll('pre code').forEach((block) => {
                highlightCode(block);
            });
        }

        scrollToBottom();
    }

    function highlightCode(block) {
        const parent = block.parentElement;
        const lang = block.className.replace('language-', '') || 'txt';
        const wrapper = document.createElement('div');
        wrapper.className = 'code-block-wrapper';
        
        let previewBtn = '';
        if (lang === 'html') {
            const id = 'p-' + Math.random().toString(36).substr(2, 9);
            previewStore[id] = block.innerText;
            previewBtn = `<button onclick="openPreview('${id}')" class="hover:text-white transition-colors"><i class="fa-solid fa-eye"></i> Preview</button>`;
        }

        wrapper.innerHTML = `
            <div class="code-header">
                <span>${lang.toUpperCase()}</span>
                <div class="flex gap-4">
                    ${previewBtn}
                    <button onclick="copyCode(this)" class="hover:text-white transition-colors"><i class="fa-regular fa-copy"></i> Copy</button>
                </div>
            </div>
        `;
        parent.parentNode.insertBefore(wrapper, parent);
        wrapper.appendChild(parent);
        Prism.highlightElement(block);
    }

    async function fetchAIResponse(text, atts, mode) {
        // Pollinations AI Integration
        const systemPrompt = `You are Newton AI. High-end modern assistant. 
        Current Mode: ${mode}.
        If mode is CODE: always provide a full runnable HTML/Tailwind solution.
        If mode is SCHOLAR: act as a researcher with citations.
        Always start with <<<THOUGHT_START>>> reasoning <<<THOUGHT_END>>>.`;
        
        const response = await fetch('https://text.pollinations.ai/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                messages: [{ role: 'user', content: systemPrompt + "\n\nUser: " + text }],
                model: 'openai'
            })
        });
        return await response.text();
    }

    /* --- Helpers --- */
    function showLoading() {
        const list = document.getElementById('messages-list');
        const loader = document.createElement('div');
        loader.id = 'ai-loader';
        loader.className = 'flex gap-2 p-4 items-center text-apple-gray animate-pulse';
        loader.innerHTML = `<div class="w-2 h-2 bg-apple-gray rounded-full"></div><div class="w-2 h-2 bg-apple-gray rounded-full"></div><div class="w-2 h-2 bg-apple-gray rounded-full"></div>`;
        list.appendChild(loader);
        scrollToBottom();
    }

    function hideLoading() {
        const loader = document.getElementById('ai-loader');
        if (loader) loader.remove();
    }

    function scrollToBottom() {
        const container = document.getElementById('chat-container');
        container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' });
    }

    function openPreview(id) {
        const modal = document.getElementById('preview-modal');
        const frame = document.getElementById('preview-frame');
        modal.classList.remove('hidden');
        const doc = frame.contentDocument || frame.contentWindow.document;
        doc.open();
        doc.write(previewStore[id]);
        doc.close();
    }

    function closePreviewModal() {
        document.getElementById('preview-modal').classList.add('hidden');
    }

    function copyCode(btn) {
        const code = btn.closest('.code-block-wrapper').querySelector('code').innerText;
        navigator.clipboard.writeText(code);
        btn.innerHTML = '<i class="fa-solid fa-check"></i> Copied';
        setTimeout(() => btn.innerHTML = '<i class="fa-regular fa-copy"></i> Copy', 2000);
    }

    // Init
    startNewChat();
</script>
</body>
</html>
