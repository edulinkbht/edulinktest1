<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
    <title>EduLink</title>
    <link rel="icon" type="image/png" href="https://i.imghippo.com/files/vgr8207c.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Google+Sans:wght@400;500;700&display=swap');

        :root {
            --surface: #ffffff;
            --background: #ffffff;
            --on-surface: #0f0f0f;
            --text-secondary: #374151;
            --outline: #e5e7eb;
            --hover-bg: #f2f2f2;
            --primary: #065fd4
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background);
            color: var(--on-surface);
            overflow: hidden;
            overscroll-behavior-x: none
        }

        h1,
        h2,
        h3,
        .google-font {
            font-family: 'Google Sans', 'Inter', sans-serif
        }

        * {
            scrollbar-width: none;
            -ms-overflow-style: none
        }

        *::-webkit-scrollbar {
            width: 0;
            background: transparent;
            display: none
        }

        i[data-lucide],
        svg {
            flex-shrink: 0
        }

        /* Custom Instagram-style Icons */
        .custom-icon {
            flex-shrink: 0;
            stroke-linecap: round;
            stroke-linejoin: round;
            transition: all 0.2s ease;
        }

        .custom-icon-outline {
            fill: none;
            stroke: currentColor;
            stroke-width: 2;
        }

        .custom-icon-bold {
            fill: none;
            stroke: currentColor;
            stroke-width: 2.8;
        }

        .custom-icon-filled {
            fill: currentColor;
            stroke: currentColor;
            stroke-width: 0.5;
        }

        .fade-in {
            opacity: 1;
            transform: none;
        }

        .app-panel {
            background: var(--surface);
            border-radius: 0;
            border: none;
            height: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: all .3s cubic-bezier(.2, 0, 0, 1)
        }

        @media (min-width:768px) {
            .app-panel {
                border-radius: 20px;
                border: 1px solid var(--outline);
                box-shadow: 0 1px 2px rgba(0, 0, 0, .03)
            }
        }

        @media (max-width:768px) {
            body {
                padding: 0 !important
            }

            #workspace-layout {
                gap: 0 !important
            }
        }

        #main-sidebar {
            width: 88px;
            flex-shrink: 0;
            padding: 24px 12px;
            transition: width .3s cubic-bezier(.2, 0, 0, 1), padding .3s ease
        }

        @media (min-width:1024px) {
            #main-sidebar {
                width: 260px;
                padding: 24px 20px
            }
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 12px;
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 15px;
            border-radius: 12px;
            transition: all .2s ease;
            cursor: pointer;
            text-decoration: none;
            margin-bottom: 4px;
            justify-content: center;
            position: relative
        }

        .nav-item:hover {
            color: var(--on-surface);
            background-color: var(--hover-bg)
        }

        .nav-item.active {
            color: var(--primary);
            background-color: #eff4ff;
            font-weight: 600
        }

        .nav-badge {
            position: absolute;
            top: 10px;
            right: 12px;
            background-color: #c00;
            color: #fff;
            font-size: 10px;
            font-weight: 700;
            height: 16px;
            min-width: 16px;
            padding: 0 4px;
            border-radius: 10px;
            display: none;
            align-items: center;
            justify-content: center;
            border: 2px solid #fff;
            z-index: 10
        }

        .mobile-footer-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            background-color: #c00;
            color: #fff;
            font-size: 10px;
            font-weight: 700;
            height: 16px;
            min-width: 16px;
            padding: 0 4px;
            border-radius: 10px;
            display: none;
            align-items: center;
            justify-content: center;
            border: 2px solid #fff;
            z-index: 20
        }

        @media (min-width:1024px) {
            .nav-item {
                justify-content: flex-start;
                padding: 10px 16px
            }

            .nav-badge {
                right: auto;
                left: 28px;
                top: 8px
            }
        }

        .sidebar-user {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px;
            border-radius: 12px;
            cursor: pointer;
            transition: background-color .2s;
            justify-content: center
        }

        .sidebar-user:hover {
            background-color: var(--hover-bg)
        }

        @media (min-width:1024px) {
            .sidebar-user {
                justify-content: flex-start;
                padding: 8px 12px
            }
        }

        .create-btn {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 12px;
            background: #1f1f1f;
            color: #fff;
            padding: 12px 20px;
            border-radius: 12px;
            font-weight: 500;
            font-size: 14px;
            transition: all .2s ease;
            width: 100%;
            margin-bottom: 24px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, .1);
            line-height: 1;
            min-width: 0;
            white-space: nowrap
        }

        .create-btn:hover {
            background: #000;
            transform: translateY(-1px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, .1)
        }

        .post-card {
            background: var(--surface);
            border-bottom: 1px solid var(--outline);
            border-radius: 0;
            transition: background-color .2s ease;
            margin-bottom: 0;
            box-shadow: none;
            overflow: visible
        }

        .post-card:hover {
            background-color: var(--surface);
            cursor: pointer;
            transform: none
        }

        .post-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px
        }

        .post-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--hover-bg);
            object-fit: cover;
            cursor: pointer;
        }

        .post-author-name {
            font-weight: 600;
            font-size: 15px;
            color: var(--on-surface);
            line-height: 1.2
        }

        .post-author-name:hover {
            text-decoration: underline;
            color: var(--primary)
        }

        .post-meta {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 2px;
            font-weight: 400
        }

        .post-body {
            font-size: 15px;
            line-height: 1.6;
            color: var(--on-surface);
            margin-bottom: 12px;
            white-space: pre-wrap
        }

        .post-actions {
            display: flex;
            align-items: center;
            gap: 8px;
            padding-top: 12px;
            padding-bottom: 4px
        }

        .action-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 9999px;
            border: 1px solid var(--outline);
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 600;
            transition: all .2s;
            background: transparent;
            cursor: pointer;
            height: 34px;
            white-space: nowrap
        }

        .action-btn:hover {
            background-color: var(--hover-bg);
            border-color: #d1d5db
        }

        .action-btn.active {
            background-color: transparent;
            border-color: var(--outline)
        }

        .action-btn.like.active {
            color: var(--text-secondary);
            background-color: transparent;
            border-color: var(--outline)
        }

        .action-btn.like.active svg {
            fill: #ef4444;
            stroke: none;
            color: #ef4444
        }

        .action-btn.bookmark.active {
            color: var(--text-secondary);
            background-color: transparent;
            border-color: var(--outline)
        }

        .action-btn.bookmark.active svg {
            fill: #eab308;
            stroke: none;
            color: #eab308
        }

        .action-btn i,
        .action-btn svg {
            width: 18px;
            height: 18px
        }

        #compose-modal,
        #create-menu-modal,
        #edit-profile-modal,
        #user-list-modal,
        #settings-modal,
        #likes-overlay,
        #username-modal,
        #promo-modal,
        #upload-options-modal,
        #share-modal,
        #post-options-modal,
        #notif-options-modal,
        #qr-overlay,
        #scanner-overlay,
        #feed-filter-modal,
        #privacy-overlay,
        #profile-filter-modal,
        #download-select-modal,
        #comment-options-modal,
        #announcement-overlay-modal,
        #profile-preview-card,
        #comment-filter-modal,
        #claim-link-overlay {
            box-shadow: 0 20px 60px rgba(0, 0, 0, .15);
            border: 1px solid var(--outline)
        }

        #profile-preview-card {
            border: none !important
        }

        .compose-textarea {
            width: 100%;
            min-height: 120px;
            font-size: 17px;
            line-height: 1.6;
            color: var(--on-surface);
            border: none;
            outline: none;
            resize: none;
            background: 0 0
        }

        .tool-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            transition: background .2s;
            cursor: pointer
        }

        .tool-btn:hover {
            background-color: var(--hover-bg);
            color: var(--on-surface)
        }

        .create-option-card {
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: flex-start;
            padding: 16px;
            border-radius: 0;
            border: none;
            border-bottom: 1px solid var(--outline);
            background: var(--surface);
            cursor: pointer;
            transition: all .2s;
            gap: 16px;
            height: auto
        }

        .create-option-card:last-child {
            border-bottom: none
        }

        .create-option-card:hover {
            background: #f9fafb
        }

        .create-icon-bg {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #f3f4f6;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #1f1f1f;
            margin-bottom: 0;
            flex-shrink: 0
        }

        .trending-panel {
            width: 100%;
            flex-shrink: 0;
            order: 2;
            border-left: 1px solid var(--outline)
        }

        @media (min-width:1280px) {
            .trending-panel {
                width: 380px
            }
        }

        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(20px);
            background: #0f0f0f;
            color: #f2f2f2;
            padding: 14px 28px;
            border-radius: 48px;
            font-size: 15px;
            opacity: 0;
            pointer-events: none;
            transition: all .3s;
            z-index: 200;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, .15)
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0)
        }

        .icon-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background .2s;
            cursor: pointer;
            color: var(--on-surface)
        }

        .icon-btn:hover {
            background-color: var(--hover-bg)
        }

        .post-option-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            font-size: 14px;
            color: var(--on-surface);
            cursor: pointer;
            border-radius: 8px;
            transition: background .1s;
            font-weight: 500
        }

        .post-option-item:hover {
            background: var(--hover-bg);
            color: var(--on-surface)
        }

        .tab-group {
            display: flex;
            width: 100%;
            background: 0 0;
            padding: 0;
            border: none;
            border-bottom: 1px solid var(--outline);
            border-radius: 0
        }

        .tab-btn {
            flex: 1;
            padding: 14px 0;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            border-radius: 0;
            transition: all .2s ease;
            cursor: pointer;
            background: 0 0;
            text-align: center;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px
        }

        .tab-btn:hover {
            color: var(--on-surface);
            background-color: var(--hover-bg)
        }

        .tab-btn.active {
            color: var(--on-surface);
            background: 0 0;
            box-shadow: none
        }

        .tab-btn.active i {
            stroke-width: 3px
        }

        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 4px;
            background-color: var(--on-surface);
            border-radius: 4px 4px 0 0
        }

        .grid-post-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 4px
        }

        @media (min-width:768px) {
            .grid-post-container {
                gap: 16px
            }
        }

        .grid-post-item {
            position: relative;
            aspect-ratio: 4/5;
            overflow: hidden;
            cursor: pointer;
            background-color: #f3f4f6;
            border-radius: 12px
        }

        .grid-post-item:hover .grid-post-overlay {
            opacity: 1
        }

        .grid-post-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, .3);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity .2s;
            color: #fff;
            font-weight: 700;
            gap: 16px
        }

        .grid-post-text-preview {
            width: 100%;
            height: 100%;
            padding: 12px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            color: #4b5563;
            background: #f9fafb;
            overflow: hidden
        }

        .mobile-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            flex: 1;
            gap: 4px;
            color: #000;
            transition: all .2s;
            cursor: pointer;
            position: relative
        }

        .mobile-nav-item i {
            width: 36px;
            height: 36px;
            transition: all .2s
        }

        .mobile-nav-item.active {
            color: #000000
        }

        .mobile-nav-item.active i {
            transform: scale(1.05);
            fill: black;
            stroke-width: 2.5px
        }

        .mobile-nav-item.active i[data-lucide="search"] {
            fill: none;
            stroke-width: 3px
        }

        .official-badge {
            fill: #3b82f6;
            color: white;
            stroke-width: 2.5px
        }

        .scale-in {
            animation: scaleIn .3s cubic-bezier(.2, 0, 0, 1) forwards
        }

        @keyframes scaleIn {
            from {
                transform: scale(.95);
                opacity: 0
            }

            to {
                transform: scale(1);
                opacity: 1
            }
        }

        #app-loader {
            position: fixed;
            inset: 0;
            background: var(--surface);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: opacity .5s ease
        }

        .loader-logo {
            width: 80px;
            height: 80px;
            object-fit: contain
        }

        .profile-banner-container {
            height: 140px;
            width: 100%;
            background-color: #e5e7eb;
            position: relative;
            overflow: hidden;
            cursor: default
        }

        .profile-banner-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            pointer-events: none
        }

        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
            background-color: #e5e7eb;
            border-radius: 9999px;
            transition: background-color .2s;
            cursor: pointer
        }

        .toggle-switch.active {
            background-color: #0b57d0
        }

        .toggle-dot {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background-color: #fff;
            border-radius: 50%;
            transition: transform .2s
        }

        .toggle-switch.active .toggle-dot {
            transform: translateX(20px)
        }

        .collab-chip {
            display: inline-flex;
            align-items: center;
            background-color: #f3f4f6;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 13px;
            margin-right: 6px;
            margin-bottom: 6px;
            color: #1f1f1f;
            border: 1px solid #e5e7eb
        }

        .post-modal-layout {
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
            overflow: hidden;
            gap: 0;
            background: #fff
        }

        body.reel-mode #mobile-bottom-nav {
            display: none !important
        }

        .link-preview-card {
            display: block;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            overflow: hidden;
            margin-top: 10px;
            text-decoration: none !important;
            color: inherit !important;
            background: #fff;
            transition: all 0.2s ease;
            position: relative;
            min-height: 100px;
        }

        .link-preview-card:hover {
            border-color: #cbd5e1;
            background: #f8fafc;
        }

        .link-preview-skeleton {
            animation: pulse 1.5s infinite ease-in-out;
            background: #f1f5f9;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.6;
            }

            100% {
                opacity: 1;
            }
        }

        .link-preview-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            background: #f1f5f9;
        }

        .link-preview-content {
            padding: 12px;
        }

        .link-preview-title {
            font-weight: 700;
            font-size: 14px;
            color: #1a1a1b;
            margin-bottom: 4px;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .link-preview-desc {
            font-size: 12px;
            color: #4b5563;
            line-height: 1.5;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .link-preview-domain {
            font-size: 11px;
            color: #9ca3af;
            display: flex;
            align-items: center;
            gap: 4px;
            text-transform: lowercase;
        }



        .link-preview-image {
            width: 100%;
            height: 180px;
            object-fit: cover;
            background: #f3f4f6;
            border-bottom: 1px solid #e5e7eb;
        }

        .link-preview-content {
            padding: 12px;
        }

        .link-preview-title {
            font-weight: 700;
            font-size: 14px;
            color: #1f1f1f;
            line-height: 1.4;
            margin-bottom: 4px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .link-preview-desc {
            font-size: 12px;
            color: #6b7280;
            line-height: 1.5;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .link-preview-domain {
            font-size: 11px;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 0.025em;
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        @media (min-width:768px) {
            .post-modal-layout {
                flex-direction: row;
                width: 90vw;
                max-width: 1200px;
                height: 85vh;
                gap: 0;
                background: #fff;
                border-radius: 24px;
                overflow: hidden
            }

            .desktop-split-view {
                display: flex;
                width: 100%;
                height: 100%
            }

            .desktop-post-container {
                flex: 1.2;
                display: flex;
                flex-direction: column;
                overflow-y: auto;
                border-right: 1px solid var(--outline);
                position: relative
            }

            .desktop-comments-container {
                flex: 1;
                display: flex;
                flex-direction: column;
                height: 100%;
                background: #fff
            }

            .stage-content {
                width: 100%;
                height: auto;
                object-fit: contain;
                border-radius: 8px
            }
        }

        @media (max-width:767px) {
            .post-modal-layout {
                width: 100vw;
                height: 100%;
                background: #fff
            }

            .mobile-overlay-layout {
                display: flex;
                flex-direction: column;
                height: 100%
            }

            .mobile-fixed-header {
                height: 56px;
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 0 16px;
                border-bottom: 1px solid var(--outline);
                background: #fff;
                flex-shrink: 0;
                z-index: 20
            }

            .mobile-scroll-content {
                flex: 1;
                overflow-y: auto;
                display: flex;
                flex-direction: column;
                padding-bottom: 0
            }

            .mobile-fixed-footer {
                height: auto;
                padding: 6px 16px;
                border-top: 1px solid var(--outline);
                background: #fff;
                flex-shrink: 0;
                padding-bottom: calc(6px + env(safe-area-inset-bottom));
                z-index: 20
            }

            .discussion-panel {
                display: none
            }
        }

        .discussion-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--outline);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #fff;
            z-index: 10
        }

        .discussion-scroll {
            flex: 1;
            overflow-y: auto;
            padding: 0;
            background: #fff
        }

        .replies-line-container {
            margin-left: 0;
            padding-left: 0;
            border-left: none;
            margin-top: 0;
            display: flex;
            flex-direction: column;
            gap: 0
        }

        .chat-input-wrapper {
            display: flex;
            align-items: center;
            background: 0 0;
            padding: 8px 0;
            gap: 12px;
            border-top: 1px solid transparent
        }

        .read-more-btn {
            color: #606060;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            margin-left: 4px
        }

        .read-more-btn:hover {
            color: #000;
            text-decoration: underline
        }

        .post-carousel {
            position: relative;
            width: 100%;
            overflow: hidden;
            background-color: #f6f7f8;
            aspect-ratio: 4/5;
            touch-action: pan-y pinch-zoom
        }

        .post-carousel-inner {
            display: flex;
            transition: transform .3s ease-out;
            height: 100%;
            width: 100%
        }

        .post-carousel-item {
            min-width: 100%;
            flex: 0 0 100%;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #f6f7f8
        }

        .post-carousel-item img,
        .post-carousel-item video {
            width: 100%;
            height: 100%;
            object-fit: cover
        }

        .carousel-dots-outside {
            display: flex;
            justify-content: center;
            gap: 6px;
            margin-top: 10px
        }

        .carousel-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #d1d5db;
            transition: background .2s
        }

        .carousel-dot.active {
            background: #3b82f6
        }

        .carousel-nav-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, .5);
            color: #fff;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 50;
            border: none;
            pointer-events: auto;
            transition: background .2s
        }

        .carousel-nav-btn.prev {
            left: 10px
        }

        .carousel-nav-btn.next {
            right: 10px
        }

        #thread-overlay {
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, .15)
        }

        #ptr-spinner {
            position: absolute;
            top: 70px;
            left: 50%;
            transform: translateX(-50%) translateY(-20px);
            width: 40px;
            height: 40px;
            background: #fff;
            border-radius: 50%;
            box-shadow: 0 3px 10px rgba(0, 0, 0, .1);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 15;
            opacity: 0;
            pointer-events: none;
            transition: transform .2s, opacity .2s;
            color: #0b57d0
        }

        @media(max-width:768px) {
            #thread-overlay .discussion-panel {
                height: 75vh;
                width: 100%;
                position: absolute;
                bottom: 0
            }

            .thread-mobile-container {
                height: 75vh;
                background: #fff;
                width: 100%;
                display: flex;
                flex-direction: column;
                border-radius: 20px 20px 0 0
            }
        }

        .share-icon-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            width: 100%;
            padding: 12px 4px;
            border-radius: 12px;
            transition: background-color .2s;
            cursor: pointer
        }

        .share-icon-btn:hover {
            background-color: var(--hover-bg)
        }

        .share-icon-circle {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: #fff;
            transition: transform .2s
        }

        .share-icon-btn:hover .share-icon-circle {
            transform: scale(1.05)
        }

        body.modal-open #mobile-bottom-nav {
            display: none !important
        }

        .view-replies-btn {
            font-size: 12px;
            font-weight: 600;
            color: #065fd4;
            cursor: pointer;
            margin-top: 0;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 0px;
            border-radius: 6px;
            width: fit-content;
            background-color: transparent;
            transition: background 0.2s
        }

        .view-replies-btn:hover {
            text-decoration: underline
        }

        #settings-modal .post-option-item,
        #feed-filter-modal .group {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            border-radius: 12px;
            transition: background .2s;
            cursor: pointer;
            text-align: left
        }

        #settings-modal .post-option-item:hover,
        #feed-filter-modal .group:hover {
            background: var(--hover-bg)
        }

        #settings-modal .icon-circle,
        #feed-filter-modal .icon-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #f3f4f6;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #1f1f1f;
            flex-shrink: 0
        }

        .toggle-setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            border-bottom: 1px solid #f0f0f0
        }

        .toggle-setting-row:last-child {
            border-bottom: none
        }

        .discussion-footer {
            padding: 12px 16px;
            border-top: 1px solid var(--outline);
            background: #fff;
            z-index: 20
        }

        .img-placeholder {
            background: #f6f7f8;
            background-image: linear-gradient(to right, #f6f7f8 0%, #edeef1 20%, #f6f7f8 40%, #f6f7f8 100%);
            background-repeat: no-repeat;
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite linear;
            position: relative;
            overflow: hidden
        }

        @keyframes shimmer {
            0% {
                background-position: -150% 0
            }

            100% {
                background-position: 150% 0
            }
        }


        img {
            transition: none
        }

        .comment-actions-float {
            float: right;
            margin-left: 8px;
            margin-bottom: 2px
        }

        .clearfix::after {
            content: "";
            clear: both;
            display: table
        }

        .slide-in-right {
            animation: slideInRight .25s cubic-bezier(0.2, 0, 0, 1) forwards
        }

        .slide-in-left {
            animation: slideInLeft .25s cubic-bezier(0.2, 0, 0, 1) forwards
        }

        @keyframes slideInRight {
            from {
                transform: translateX(20px);
                opacity: 0.8
            }

            to {
                transform: translateX(0);
                opacity: 1
            }
        }

        @keyframes slideInLeft {
            from {
                transform: translateX(-20px);
                opacity: 0.8
            }

            to {
                transform: translateX(0);
                opacity: 1
            }
        }

        .comment-item {
            border-bottom: 1px solid var(--outline)
        }

        .mention-suggestions {
            position: absolute;
            bottom: 100%;
            left: 0;
            right: 0;
            margin-bottom: 8px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);
            max-height: 240px;
            overflow-y: auto;
            z-index: 999;
            border: 1px solid #e5e7eb
        }

        .mention-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
            cursor: pointer;
            transition: background 0.15s;
            border-bottom: 1px solid #f3f4f6
        }

        .mention-item:last-child {
            border-bottom: none
        }

        .mention-item:hover,
        .mention-item.highlighted {
            background: #f9fafb
        }

        .mention-item img {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0
        }

        .mention-item-name {
            font-weight: 600;
            font-size: 14px;
            color: #1f1f1f;
            line-height: 1.2
        }

        .mention-item-username {
            font-size: 13px;
            color: #6b7280;
            line-height: 1.2
        }
    </style>
</head>

<body class="h-screen flex overflow-hidden p-0 md:p-3 gap-4 bg-white">
    <div id="app-loader"><img src="https://i.imghippo.com/files/fRGt5603uII.png" class="loader-logo"></div>
    <div id="action-progress-overlay"
        class="fixed inset-0 z-[200] bg-white/90 backdrop-blur-sm hidden flex flex-col items-center justify-center">
        <div class="w-64 h-2 bg-gray-200 rounded-full overflow-hidden mb-4">
            <div id="action-progress-bar" class="h-full bg-[#0b57d0] transition-all duration-300 w-0"></div>
        </div>
        <p id="action-progress-text" class="font-bold text-gray-900 animate-pulse">Saving changes...</p>
    </div>
    <div id="banned-overlay" class="fixed inset-0 z-[99999] flex items-center justify-center bg-white hidden">
        <div class="text-center p-8">
            <div class="w-20 h-20 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4"><i
                    data-lucide="ban" class="w-10 h-10 text-red-600"></i></div>
            <h2 class="text-2xl font-bold text-gray-900 mb-2">Account Banned</h2>
            <p class="text-gray-600 mb-6">Your access to EduLink has been restricted due to a violation of our terms.
            </p><button onclick="doLogout()"
                class="bg-gray-900 text-white px-6 py-3 rounded-xl font-bold hover:bg-black transition-colors">Log
                Out</button>
        </div>
    </div>
    <div id="custom-alert"
        class="fixed inset-0 z-[80] flex items-center justify-center bg-black/40 backdrop-blur-sm hidden opacity-0 transition-opacity duration-200">
        <div class="bg-white rounded-2xl p-6 shadow-2xl max-w-sm w-[90%] transform scale-95 transition-transform duration-200"
            id="custom-alert-box">
            <h3 class="text-lg font-bold text-[#1f1f1f] mb-2" id="alert-title">Confirm</h3>
            <p class="text-gray-600 mb-6 text-sm" id="alert-msg">Are you sure?</p>
            <div class="flex justify-end gap-3"><button
                    class="px-4 py-2 text-gray-600 font-bold text-sm hover:bg-gray-100 rounded-lg transition-colors"
                    onclick="closeAlert(false)">Cancel</button><button
                    class="px-4 py-2 bg-[#0b57d0] text-white font-bold text-sm rounded-lg hover:bg-blue-700 transition-colors"
                    id="alert-confirm-btn">Confirm</button></div>
        </div>
    </div>
    <div id="username-modal"
        class="fixed inset-0 z-[90] flex items-center justify-center bg-black/60 backdrop-blur-sm hidden">
        <div class="bg-white w-[90%] max-w-[400px] rounded-[24px] shadow-2xl p-8 relative flex flex-col items-center">
            <h2 class="text-2xl font-bold text-[#1f1f1f] mb-2 google-font">Create Username</h2>
            <p class="text-sm text-gray-500 mb-6 text-center">Choose a unique username.</p>
            <div class="w-full relative mb-4"><span class="absolute left-4 top-3 text-gray-400 font-bold">@</span><input
                    type="text" id="new-username-input"
                    class="w-full bg-gray-100 rounded-xl py-3 pl-8 pr-4 outline-none focus:ring-2 focus:ring-blue-500 font-medium"
                    placeholder="username" maxlength="20"></div><button onclick="saveUsername()"
                class="w-full bg-[#0b57d0] text-white py-3 rounded-xl font-bold hover:bg-blue-700 transition-all">Start
                Exploring</button>
        </div>
    </div>
    <div id="promo-modal"
        class="fixed inset-0 z-[80] flex items-center justify-center bg-black/60 backdrop-blur-sm hidden">
        <div class="bg-white w-[90%] max-w-[400px] rounded-2xl shadow-2xl p-6 relative">
            <h3 class="text-lg font-bold text-gray-900 mb-4">Edit Promo</h3>
            <div class="space-y-4 mb-6">
                <div><label class="text-xs font-bold text-gray-500 uppercase">Image URL</label>
                    <div class="flex gap-2"><input type="text" id="promo-img-url"
                            class="w-full border-b border-gray-200 py-2 outline-none focus:border-blue-500 font-medium text-gray-900"><button
                            onclick="document.getElementById('promo-file-input').click()"
                            class="icon-btn bg-gray-100 hover:bg-gray-200"><i data-lucide="upload"
                                class="w-4 h-4"></i></button></div><input type="file" id="promo-file-input"
                        class="hidden" accept="image/*" onchange="handlePromoFile(event)">
                </div>
                <div><label class="text-xs font-bold text-gray-500 uppercase">Target Link</label><input type="url"
                        id="promo-target-url"
                        class="w-full border-b border-gray-200 py-2 outline-none focus:border-blue-500 font-medium text-gray-900">
                </div>
            </div>
            <div class="flex justify-end gap-3"><button
                    onclick="document.getElementById('promo-modal').classList.add('hidden')"
                    class="px-4 py-2 text-gray-600 font-bold text-sm hover:bg-gray-100 rounded-lg">Cancel</button><button
                    onclick="savePromo()"
                    class="px-4 py-2 bg-[#0b57d0] text-white font-bold text-sm rounded-lg hover:bg-blue-700">Save</button>
            </div>
        </div>
    </div>
    <div id="post-options-overlay"
        class="fixed inset-0 z-[75] flex items-end md:items-center justify-center bg-black/40 backdrop-blur-sm hidden opacity-0 transition-opacity duration-200"
        onclick="hidePostMenu()">
        <div id="post-options-modal"
            class="bg-white w-full md:w-[400px] md:rounded-[24px] rounded-t-[24px] shadow-2xl relative transform translate-y-full md:translate-y-0 md:scale-95 transition-transform duration-200 flex flex-col overflow-hidden"
            onclick="event.stopPropagation()">
            <div class="h-16 border-b border-gray-100 flex items-center justify-between px-4 shrink-0"><button
                    onclick="hidePostMenu()"
                    class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center hover:bg-gray-200 transition-colors"><i
                        data-lucide="arrow-left" class="w-6 h-6 text-gray-700"></i></button><span
                    class="font-bold text-gray-900 text-lg">Options</span>
                <div class="w-10"></div>
            </div>
            <div class="p-4 flex flex-col gap-2" id="post-options-content"></div>
        </div>
    </div>
    <div id="comment-options-overlay"
        class="fixed inset-0 z-[80] flex items-end md:items-center justify-center bg-black/40 backdrop-blur-sm hidden opacity-0 transition-opacity duration-200"
        onclick="closeCommentOptions()">
        <div id="comment-options-modal"
            class="bg-white w-full md:w-[400px] md:rounded-[24px] rounded-t-[24px] shadow-2xl relative transform translate-y-full md:translate-y-0 md:scale-95 transition-transform duration-200 flex flex-col overflow-hidden"
            onclick="event.stopPropagation()">
            <div class="h-16 border-b border-gray-100 flex items-center justify-between px-4 shrink-0"><button
                    onclick="closeCommentOptions()"
                    class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center hover:bg-gray-200 transition-colors"><i
                        data-lucide="arrow-left" class="w-6 h-6 text-gray-700"></i></button><span
                    class="font-bold text-gray-900 text-lg">Details</span>
                <div class="w-10"></div>
            </div>
            <div class="p-4 flex flex-col gap-2" id="comment-options-content"></div>
        </div>
    </div>
    <div id="share-overlay"
        class="fixed inset-0 z-[80] flex items-end md:items-center justify-center bg-black/40 backdrop-blur-sm hidden opacity-0 transition-opacity duration-200"
        onclick="closeShareMenu()">
        <div id="share-modal"
            class="bg-white w-full md:w-[400px] md:rounded-[24px] rounded-t-[24px] shadow-2xl relative transform translate-y-full md:translate-y-0 md:scale-95 transition-transform duration-200 flex flex-col overflow-hidden"
            onclick="event.stopPropagation()">
            <div class="h-16 border-b border-gray-100 flex items-center justify-between px-4 shrink-0"><button
                    onclick="closeShareMenu()"
                    class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center hover:bg-gray-200 transition-colors"><i
                        data-lucide="arrow-left" class="w-6 h-6 text-gray-700"></i></button><span
                    class="font-bold text-gray-900 text-lg">Share</span>
                <div class="w-10"></div>
            </div>
            <div class="p-6 overflow-y-auto">
                <div id="share-post-preview" class="hidden"></div>
                <div class="flex items-center justify-between gap-3 mb-6 p-3 bg-gray-50 rounded-xl border border-gray-200 w-full cursor-pointer hover:bg-gray-100 transition-colors"
                    onclick="triggerShare('copy')">
                    <div class="flex items-center gap-3 overflow-hidden"><img id="share-owner-avatar" src=""
                            class="w-10 h-10 rounded-full border border-gray-200 object-cover shrink-0 bg-gray-200">
                        <div class="flex flex-col min-w-0"><span
                                class="text-xs text-gray-500 font-medium">Link</span><span id="share-link-text"
                                class="font-bold text-gray-900 truncate text-sm">...</span></div>
                    </div>
                    <div class="bg-white p-2 rounded-lg border border-gray-200 shadow-sm"><i data-lucide="copy"
                            class="w-4 h-4 text-gray-600"></i></div>
                </div><input type="hidden" id="share-link-input">
                <div class="grid grid-cols-4 gap-2 mb-2" id="share-grid-options">
                    <div class="share-icon-btn" onclick="triggerShare('copy')">
                        <div class="share-icon-circle bg-gray-100 text-gray-800 border border-gray-200"><i
                                data-lucide="link" class="w-6 h-6"></i></div><span
                            class="text-xs font-medium text-gray-700">Copy Link</span>
                    </div>
                    <div class="share-icon-btn" onclick="triggerShare('whatsapp')">
                        <div class="share-icon-circle bg-[#25D366] text-white"><svg xmlns="http://www.w3.org/2000/svg"
                                width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M3 21l1.65 -3.8a9 9 0 1 1 3.4 2.9l-5.05 .9" />
                                <path
                                    d="M9 10a.5 .5 0 0 0 1 0v-1a.5 .5 0 0 0 -1 0v1a5 5 0 0 0 5 5h1a.5 .5 0 0 0 0 -1h-1a.5 .5 0 0 0 0 1" />
                            </svg></div><span class="text-xs font-medium text-gray-700">WhatsApp</span>
                    </div>
                    <div class="share-icon-btn" onclick="triggerShare('email')">
                        <div class="share-icon-circle bg-blue-500 text-white"><i data-lucide="mail" class="w-6 h-6"></i>
                        </div><span class="text-xs font-medium text-gray-700">Email</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="download-select-overlay"
        class="fixed inset-0 z-[85] flex items-end md:items-center justify-center bg-black/40 backdrop-blur-sm hidden opacity-0 transition-opacity duration-200"
        onclick="closeDownloadSelect()">
        <div id="download-select-modal"
            class="bg-white w-full h-[70vh] md:h-auto md:w-[450px] md:max-h-[80vh] md:rounded-[24px] rounded-t-[24px] shadow-2xl relative transform translate-y-full md:translate-y-0 md:scale-95 transition-transform duration-200 flex flex-col overflow-hidden"
            onclick="event.stopPropagation()">
            <div class="h-16 border-b border-gray-100 flex items-center justify-between px-4 shrink-0"><button
                    onclick="closeDownloadSelect()"
                    class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center hover:bg-gray-200 transition-colors"><i
                        data-lucide="arrow-left" class="w-6 h-6 text-gray-700"></i></button><span
                    class="font-bold text-gray-900 text-lg">Select Images</span>
                <div class="w-10"></div>
            </div>
            <div id="download-select-content" class="flex-1 overflow-y-auto p-4 grid grid-cols-2 gap-4"></div>
            <div class="p-4 border-t border-gray-100"><button id="download-action-btn"
                    onclick="downloadSelectedImages()"
                    class="w-full bg-[#0b57d0] text-white py-3 rounded-xl font-bold hover:bg-blue-700 transition-all disabled:opacity-50 disabled:cursor-not-allowed">Download
                    (0)</button></div>
        </div>
    </div>
    <div id="qr-overlay"
        class="fixed inset-0 z-[80] flex items-end md:items-center justify-center bg-black/40 backdrop-blur-sm hidden opacity-0 transition-opacity duration-200"
        onclick="closeQR()">
        <div id="qr-modal"
            class="bg-white w-full md:w-[400px] md:rounded-[24px] rounded-t-[24px] shadow-2xl p-6 relative transform translate-y-full md:translate-y-0 md:scale-95 transition-transform duration-200 flex flex-col items-center"
            onclick="event.stopPropagation()">
            <div class="w-12 h-1.5 bg-gray-300 rounded-full mx-auto mb-6 md:hidden"></div>
            <h3 class="text-lg font-bold text-gray-900 mb-2 text-center">My QR Code</h3>
            <div class="p-4 bg-white rounded-xl border border-gray-200 shadow-sm mb-4"><img id="qr-image" src=""
                    class="w-48 h-48 object-contain"></div>
            <div class="flex items-center justify-between gap-3 mb-2 p-3 bg-gray-50 rounded-xl border border-gray-200 w-full cursor-pointer hover:bg-gray-100 transition-colors"
                onclick="copyQRLink()">
                <div class="flex items-center gap-3 overflow-hidden"><img id="qr-owner-avatar" src=""
                        class="w-10 h-10 rounded-full border border-gray-200 object-cover shrink-0 bg-gray-200">
                    <div class="flex flex-col min-w-0"><span class="text-xs text-gray-500 font-medium">Profile
                            Link</span><span id="qr-display-name"
                            class="font-bold text-gray-900 truncate text-sm">@username</span></div>
                </div>
                <div class="bg-white p-2 rounded-lg border border-gray-200 shadow-sm"><i data-lucide="copy"
                        class="w-4 h-4 text-gray-600"></i></div>
            </div>
            <div class="flex items-center justify-between gap-3 mb-4 p-3 bg-gray-50 rounded-xl border border-gray-200 w-full cursor-pointer hover:bg-gray-100 transition-colors"
                onclick="openScanner(); closeQR()">
                <div class="flex items-center gap-3 overflow-hidden">
                    <div
                        class="w-10 h-10 rounded-full bg-white flex items-center justify-center border border-gray-200 text-black shrink-0">
                        <i data-lucide="camera" class="w-5 h-5"></i>
                    </div>
                    <div class="flex flex-col min-w-0"><span class="text-xs text-gray-500 font-medium">Scan</span><span
                            class="font-bold text-gray-900 truncate text-sm">Scan QR Code</span></div>
                </div>
                <div class="bg-white p-2 rounded-lg border border-gray-200 shadow-sm"><i data-lucide="chevron-right"
                        class="w-4 h-4 text-gray-600"></i></div>
            </div><input type="hidden" id="qr-hidden-url">
        </div>
    </div>
    <div id="scanner-overlay" class="fixed inset-0 z-[100] bg-black hidden flex-col">
        <div class="flex justify-between items-center p-4"><button onclick="closeScanner()"
                class="icon-btn bg-white/10 text-white hover:bg-white/20"><i data-lucide="x"
                    class="w-6 h-6"></i></button><span class="text-white font-bold text-lg">Scan QR Code</span>
            <div class="w-10"></div>
        </div>
        <div class="flex-1 flex flex-col items-center justify-center relative">
            <div id="qr-reader" class="w-full max-w-sm rounded-xl overflow-hidden shadow-2xl"></div>
            <p class="text-gray-400 mt-6 text-sm px-4 text-center">Point your camera at an EduLink QR code to visit
                their profile.</p>
        </div>
    </div>
    <div id="upload-options-modal"
        class="fixed inset-0 z-[80] flex items-center justify-center bg-black/60 backdrop-blur-sm hidden"
        onclick="document.getElementById('upload-options-modal').classList.add('hidden')">
        <div class="bg-white w-[90%] max-w-[300px] rounded-2xl shadow-xl p-4 transform scale-100 transition-transform"
            onclick="event.stopPropagation()">
            <h3 class="text-center font-bold text-gray-900 mb-4 text-lg">Select Upload Type</h3>
            <div class="flex flex-col gap-3"><button onclick="triggerUpload('single')"
                    class="flex items-center gap-3 p-3 hover:bg-gray-50 rounded-xl border border-gray-100 transition-colors">
                    <div class="w-10 h-10 rounded-full bg-blue-50 flex items-center justify-center text-blue-600"><i
                            data-lucide="image" class="w-5 h-5"></i></div><span
                        class="font-bold text-gray-700">Single</span>
                </button><button onclick="triggerUpload('multiple')"
                    class="flex items-center gap-3 p-3 hover:bg-gray-50 rounded-xl border border-gray-100 transition-colors">
                    <div class="w-10 h-10 rounded-full bg-purple-50 flex items-center justify-center text-purple-600"><i
                            data-lucide="layers" class="w-5 h-5"></i></div><span
                        class="font-bold text-gray-700">Multiple (Carousel)</span>
                </button></div>
        </div>
    </div>
    <div id="mobile-notifications-header"
        class="md:hidden fixed top-0 left-0 w-full bg-white z-30 flex-col hidden border-b border-gray-100 pb-0">
        <div class="h-16 flex items-center justify-between px-4 shrink-0 relative">
            <!-- Default Header Content -->
            <div id="notif-header-default" class="flex items-center justify-between w-full">
                <span class="font-bold text-lg text-[#1f1f1f]">Activity</span>
                <div class="flex items-center gap-3">
                    <button onclick="toggleNotifSearchMobile()"
                        class="flex items-center gap-2 bg-white border border-gray-200 hover:bg-gray-50 px-4 py-2 rounded-full transition-colors">
                        <i data-lucide="search" class="w-4 h-4 text-[#1f1f1f]"></i>
                        <span class="text-sm font-bold text-[#1f1f1f]">Search</span>
                    </button>
                    <button onclick="toggleNotifMenu()" class="icon-btn">
                        <i data-lucide="layout-grid" class="w-5 h-5 text-[#1f1f1f]"></i>
                    </button>
                </div>
            </div>

            <!-- Search Mode Header Content -->
            <div id="notif-header-search" class="hidden flex items-center gap-3 w-full">
                <div class="relative flex-1">
                    <i data-lucide="search" class="absolute left-3 top-2.5 w-4 h-4 text-gray-400"></i>
                    <input type="text" id="notif-search" placeholder="Search..." oninput="handleNotifSearch(this.value)"
                        class="w-full bg-gray-100 rounded-xl py-2 pl-9 pr-4 text-sm outline-none focus:ring-1 focus:ring-blue-500 transition-all">
                </div>
                <button onclick="toggleNotifSearchMobile()"
                    class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center hover:bg-gray-200 transition-colors">
                    <i data-lucide="x" class="w-5 h-5 text-gray-600"></i>
                </button>
            </div>
        </div>
    </div>
    <div id="notif-options-overlay"
        class="fixed inset-0 z-[80] flex items-end justify-center bg-black/40 backdrop-blur-sm hidden opacity-0 transition-opacity duration-200"
        onclick="closeNotifOptions()">
        <div id="notif-options-modal"
            class="bg-white w-full rounded-t-[24px] shadow-2xl relative transform translate-y-full transition-transform duration-200 flex flex-col overflow-hidden"
            onclick="event.stopPropagation()">
            <div class="h-16 border-b border-gray-100 flex items-center justify-between px-4 shrink-0"><button
                    onclick="closeNotifOptions()"
                    class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center hover:bg-gray-200 transition-colors"><i
                        data-lucide="arrow-left" class="w-6 h-6 text-gray-700"></i></button><span
                    class="font-bold text-gray-900 text-lg">Options</span>
                <div class="w-10"></div>
            </div>
            <div class="p-6 flex flex-col gap-2"><button onclick="toggleNotifSelection(); closeNotifOptions()"
                    class="flex items-center gap-3 w-full p-4 hover:bg-gray-50 rounded-xl transition-colors font-bold text-gray-800 text-left"><i
                        data-lucide="check-square" class="w-5 h-5"></i> Select</button><button
                    onclick="deleteSelectedNotifs(); closeNotifOptions()"
                    class="flex items-center gap-3 w-full p-4 hover:bg-red-50 rounded-xl transition-colors font-bold text-red-600 text-left"><i
                        data-lucide="trash-2" class="w-5 h-5"></i> Delete Selected</button><button
                    onclick="clearAllNotifications(); closeNotifOptions()"
                    class="flex items-center gap-3 w-full p-4 hover:bg-red-50 rounded-xl transition-colors font-bold text-red-600 text-left"><i
                        data-lucide="trash" class="w-5 h-5"></i> Delete All</button></div>
        </div>
    </div>
    <div id="thread-overlay" class="fixed inset-0 z-[65] hidden flex justify-center items-end md:items-center">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm transition-opacity" onclick="closeThread()"></div>
        <div
            class="bg-white w-full md:w-[450px] h-[75vh] md:h-[85vh] md:rounded-[24px] rounded-t-[20px] shadow-2xl relative flex flex-col transform transition-transform duration-300 scale-100 opacity-100 overflow-hidden scale-in thread-mobile-container">
            <div class="discussion-header">
                <div class="flex items-center gap-3"><button onclick="closeThread()"
                        class="icon-btn hover:bg-gray-100 md:hidden"><i data-lucide="chevron-down"
                            class="w-6 h-6 text-gray-600"></i></button><span
                        class="font-bold text-lg text-[#1f1f1f]">Thread</span></div><button onclick="closeThread()"
                    class="icon-btn hover:bg-gray-100 hidden md:flex"><i data-lucide="x"
                        class="w-5 h-5 text-gray-600"></i></button>
            </div>
            <div id="thread-content" class="discussion-scroll bg-white"></div>
            <div class="discussion-footer">
                <div class="flex items-center gap-2"><img id="thread-input-avatar" src=""
                        class="w-8 h-8 rounded-full bg-gray-200 object-cover shrink-0"><input type="text"
                        id="thread-input" placeholder="Add a reply..."
                        class="flex-1 bg-[#f2f2f2] rounded-[24px] px-4 py-2.5 text-sm outline-none text-gray-900 placeholder-gray-500"
                        onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();submitThreadReply();}"><button
                        onclick="submitThreadReply()"
                        class="w-10 h-10 bg-[#065fd4] rounded-full flex items-center justify-center text-white shrink-0 hover:bg-blue-700 transition-colors shadow-sm"><i
                            data-lucide="arrow-up" class="w-5 h-5"></i></button></div>
            </div>
        </div>
    </div>
    <div id="post-view-overlay" class="fixed inset-0 z-[60] hidden flex justify-center items-center">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-md transition-opacity" onclick="closePostView()"></div>
        <div id="post-view-container" class="post-modal-layout scale-in relative z-10"></div>
    </div>
    <div id="feed-filter-overlay"
        class="fixed inset-0 z-[70] flex items-end md:items-center justify-center bg-black/40 backdrop-blur-sm hidden opacity-0 transition-opacity duration-200"
        onclick="closeFeedFilter()">
        <div id="feed-filter-modal"
            class="bg-white w-full h-auto md:w-[400px] md:max-h-[80vh] md:rounded-[24px] rounded-t-[24px] shadow-2xl relative transform translate-y-full md:translate-y-0 md:scale-95 transition-transform duration-200 flex flex-col overflow-hidden"
            onclick="event.stopPropagation()">
            <div class="h-16 border-b border-gray-100 flex items-center justify-between px-4 shrink-0"><button
                    onclick="closeFeedFilter()"
                    class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center hover:bg-gray-200 transition-colors"><i
                        data-lucide="arrow-left" class="w-6 h-6 text-gray-700"></i></button><span
                    class="font-bold text-gray-900 text-lg">Feed Filter</span>
                <div class="w-10"></div>
            </div>
            <div class="p-4 flex flex-col gap-2"><button onclick="switchFeedFilter('all')" class="group">
                    <div class="icon-circle text-[#606060] bg-gray-100"><i data-lucide="globe" class="w-5 h-5"></i>
                    </div>
                    <div class="flex-1">
                        <div class="font-bold text-gray-900">All Posts</div>
                        <div class="text-xs text-gray-500">Show posts from everyone</div>
                    </div>
                </button><button onclick="switchFeedFilter('following')" class="group">
                    <div class="icon-circle text-[#606060] bg-gray-100"><i data-lucide="users" class="w-5 h-5"></i>
                    </div>
                    <div class="flex-1">
                        <div class="font-bold text-gray-900">Following</div>
                        <div class="text-xs text-gray-500">Posts from people you follow</div>
                    </div>
                </button><button onclick="switchFeedFilter('friends')" class="group">
                    <div class="icon-circle text-[#606060] bg-gray-100"><i data-lucide="heart-handshake"
                            class="w-5 h-5"></i></div>
                    <div class="flex-1">
                        <div class="font-bold text-gray-900">Friends</div>
                        <div class="text-xs text-gray-500">Mutual follows only</div>
                    </div>
                </button></div>
        </div>
    </div>
    <div id="lightbox"
        class="fixed inset-0 bg-black/95 z-[9999] flex justify-center items-center opacity-0 pointer-events-none transition-opacity duration-300"
        onclick="closeLightbox()"><button
            class="absolute top-8 right-8 text-white/70 hover:text-white bg-white/10 rounded-full p-3 hover:bg-white/20"><i
                data-lucide="x" class="w-8 h-8"></i></button>
        <div id="lightbox-wrapper" class="w-full h-full flex justify-center items-center p-6"></div>
    </div>
    <div id="toast" class="toast"><i id="toast-icon" data-lucide="check-circle-2"
            class="w-5 h-5 text-[#c4eed0]"></i><span id="toast-msg">Action Completed</span></div>
    <div id="likes-overlay"
        class="fixed inset-0 z-[70] flex items-end md:items-center justify-center bg-black/40 backdrop-blur-sm hidden opacity-0 transition-opacity duration-200"
        onclick="closeLikes()">
        <div id="likes-modal"
            class="bg-white w-full h-[70vh] md:h-auto md:w-[400px] md:max-h-[80vh] md:rounded-[24px] rounded-t-[24px] shadow-2xl relative transform translate-y-full md:translate-y-0 md:scale-95 transition-transform duration-200 flex flex-col overflow-hidden"
            onclick="event.stopPropagation()">
            <div class="h-16 border-b border-gray-100 flex items-center justify-between px-4 shrink-0"><button
                    onclick="closeLikes()"
                    class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center hover:bg-gray-200 transition-colors"><i
                        data-lucide="arrow-left" class="w-6 h-6 text-gray-700"></i></button><span
                    class="font-bold text-gray-900 text-lg">Likes</span>
                <div class="w-10"></div>
            </div>
            <div class="p-2 border-b border-gray-100"><input type="text" id="likes-search-input"
                    placeholder="Search users..."
                    class="w-full bg-gray-100 border-none rounded-xl px-4 py-2 text-sm outline-none focus:ring-1 focus:ring-blue-500">
            </div>
            <div id="likes-list-content" class="flex-1 overflow-y-auto p-2"></div>
        </div>
    </div>
    <div id="comment-filter-overlay"
        class="fixed inset-0 z-[80] flex items-end md:items-center justify-center bg-black/40 backdrop-blur-sm hidden opacity-0 transition-opacity duration-200"
        onclick="closeCommentFilter()">
        <div id="comment-filter-modal"
            class="bg-white w-full h-auto md:w-[400px] md:rounded-[24px] rounded-t-[24px] shadow-2xl relative transform translate-y-full md:translate-y-0 md:scale-95 transition-transform duration-200 flex flex-col overflow-hidden"
            onclick="event.stopPropagation()">
            <div class="h-16 border-b border-gray-100 flex items-center justify-between px-4 shrink-0"><button
                    onclick="closeCommentFilter()"
                    class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center hover:bg-gray-200 transition-colors"><i
                        data-lucide="arrow-left" class="w-6 h-6 text-gray-700"></i></button><span
                    class="font-bold text-gray-900 text-lg">Filter Comments</span>
                <div class="w-10"></div>
            </div>
            <div class="p-4 flex flex-col gap-2"><button onclick="setCommentFilter('top')"
                    class="flex items-center justify-between p-3 rounded-xl hover:bg-gray-50 transition-colors group">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center"><i
                                data-lucide="trending-up" class="w-5 h-5 text-gray-700"></i></div><span
                            class="font-bold text-gray-900">Top</span>
                    </div><i id="cfilter-check-top" data-lucide="check" class="w-5 h-5 text-blue-600 hidden"></i>
                </button><button onclick="setCommentFilter('latest')"
                    class="flex items-center justify-between p-3 rounded-xl hover:bg-gray-50 transition-colors group">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center"><i
                                data-lucide="clock" class="w-5 h-5 text-gray-700"></i></div><span
                            class="font-bold text-gray-900">Latest</span>
                    </div><i id="cfilter-check-latest" data-lucide="check" class="w-5 h-5 text-blue-600 hidden"></i>
                </button><button onclick="setCommentFilter('oldest')"
                    class="flex items-center justify-between p-3 rounded-xl hover:bg-gray-50 transition-colors group">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center"><i
                                data-lucide="history" class="w-5 h-5 text-gray-700"></i></div><span
                            class="font-bold text-gray-900">Oldest</span>
                    </div><i id="cfilter-check-oldest" data-lucide="check" class="w-5 h-5 text-blue-600 hidden"></i>
                </button><button onclick="setCommentFilter('verified')"
                    class="flex items-center justify-between p-3 rounded-xl hover:bg-gray-50 transition-colors group">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center"><i
                                data-lucide="badge-check" class="w-5 h-5 text-gray-700"></i></div><span
                            class="font-bold text-gray-900">Verified</span>
                    </div><i id="cfilter-check-verified" data-lucide="check" class="w-5 h-5 text-blue-600 hidden"></i>
                </button><button onclick="setCommentFilter('creator')"
                    class="flex items-center justify-between p-3 rounded-xl hover:bg-gray-50 transition-colors group">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center"><i
                                data-lucide="user-check" class="w-5 h-5 text-gray-700"></i></div><span
                            class="font-bold text-gray-900">Creator</span>
                    </div><i id="cfilter-check-creator" data-lucide="check" class="w-5 h-5 text-blue-600 hidden"></i>
                </button></div>
        </div>
    </div>
    <div id="announcement-overlay"
        class="fixed inset-0 z-[75] flex items-end md:items-center justify-center bg-black/40 backdrop-blur-sm hidden opacity-0 transition-opacity duration-200"
        onclick="closeAnnouncement()">
        <div id="announcement-overlay-modal"
            class="bg-white w-full h-[70vh] md:h-auto md:w-[500px] md:max-h-[80vh] md:rounded-[24px] rounded-t-[24px] shadow-2xl relative transform translate-y-full md:translate-y-0 md:scale-95 transition-transform duration-200 flex flex-col overflow-hidden"
            onclick="event.stopPropagation()">
            <div class="h-16 border-b border-gray-100 flex items-center justify-between px-4 shrink-0"><button
                    onclick="closeAnnouncement()"
                    class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center hover:bg-gray-200 transition-colors"><i
                        data-lucide="arrow-left" class="w-6 h-6 text-gray-700"></i></button><span
                    class="font-bold text-gray-900 text-lg">Broadcast</span>
                <div class="w-10"></div>
            </div>
            <div class="p-6 overflow-y-auto"><label class="block text-sm font-bold text-gray-700 mb-2">Message to All
                    Users</label><textarea id="announcement-text"
                    class="w-full h-32 border border-gray-300 rounded-lg p-3 outline-none focus:border-blue-500 mb-4"
                    placeholder="Type official announcement here..."></textarea><button onclick="sendAnnouncement()"
                    class="w-full bg-blue-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-blue-700 transition-colors">Send
                    Broadcast</button></div>
        </div>
    </div>
    <div id="settings-overlay"
        class="fixed inset-0 z-[70] flex items-end md:items-center justify-center bg-black/40 backdrop-blur-sm hidden opacity-0 transition-opacity duration-200"
        onclick="closeSettings()">
        <div id="settings-modal"
            class="bg-white w-full h-auto md:w-[400px] md:max-h-[80vh] md:rounded-[24px] rounded-t-[24px] shadow-2xl relative transform translate-y-full md:translate-y-0 md:scale-95 transition-transform duration-200 flex flex-col overflow-hidden"
            onclick="event.stopPropagation()">
            <div class="h-16 border-b border-gray-100 flex items-center justify-between px-4 shrink-0"><button
                    onclick="closeSettings()"
                    class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center hover:bg-gray-200 transition-colors"><i
                        data-lucide="arrow-left" class="w-6 h-6 text-gray-700"></i></button><span
                    class="font-bold text-gray-900 text-lg">Settings</span>
                <div class="w-10"></div>
            </div>
            <div class="p-4 flex flex-col gap-2" id="settings-content"></div>
        </div>
    </div>
    <div id="privacy-overlay"
        class="fixed inset-0 z-[80] flex items-end md:items-center justify-center bg-black/40 backdrop-blur-sm hidden opacity-0 transition-opacity duration-200"
        onclick="closePrivacySettings()">
        <div id="privacy-modal"
            class="bg-white w-full h-full md:h-auto md:w-[450px] md:max-h-[90vh] md:rounded-[24px] rounded-none shadow-2xl relative transform translate-y-full md:translate-y-0 md:scale-95 transition-transform duration-200 flex flex-col overflow-hidden"
            onclick="event.stopPropagation()">
            <div class="flex justify-between items-center h-16 px-4 border-b border-gray-100 shrink-0 bg-white">
                <div class="flex items-center gap-3"><img id="privacy-user-avatar" src=""
                        class="w-8 h-8 rounded-full bg-gray-100 border border-gray-200 object-cover"><span
                        id="privacy-user-name" class="font-bold text-gray-900 text-sm">User</span></div><button
                    onclick="closePrivacySettings()"
                    class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center hover:bg-gray-200 transition-colors"><i
                        data-lucide="x" class="w-5 h-5 text-gray-600"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto p-4 space-y-2">
                <div class="p-4 bg-gray-50 rounded-xl">
                    <div class="toggle-setting-row">
                        <div>
                            <div class="font-bold text-gray-900 text-[15px]">Private Account</div>
                            <div class="text-xs text-gray-500 mt-0.5">Only followers can see your posts</div>
                        </div>
                        <div id="toggle-privacy-main" class="toggle-switch"
                            onclick="updatePrivacySetting('privateNetwork')">
                            <div class="toggle-dot"></div>
                        </div>
                    </div>
                    <div class="toggle-setting-row">
                        <div>
                            <div class="font-bold text-gray-900 text-[15px]">Hide Connections</div>
                            <div class="text-xs text-gray-500 mt-0.5">Hide your following and followers lists</div>
                        </div>
                        <div id="toggle-hide-connections" class="toggle-switch"
                            onclick="updatePrivacySetting('hideConnections')">
                            <div class="toggle-dot"></div>
                        </div>
                    </div>
                </div>
                <div class="p-4">
                    <p class="text-xs text-gray-400 text-center leading-relaxed">Changes are saved automatically and
                        applied immediately.</p>
                </div>
            </div>
        </div>
    </div>
    <div id="profile-filter-overlay"
        class="fixed inset-0 z-[80] flex items-end md:items-center justify-center bg-black/40 backdrop-blur-sm hidden opacity-0 transition-opacity duration-200"
        onclick="closeProfileFilter()">
        <div id="profile-filter-modal"
            class="bg-white w-full h-auto md:w-[400px] md:rounded-[24px] rounded-t-[24px] shadow-2xl relative transform translate-y-full md:translate-y-0 md:scale-95 transition-transform duration-200 flex flex-col overflow-hidden"
            onclick="event.stopPropagation()">
            <div class="h-16 border-b border-gray-100 flex items-center justify-between px-4 shrink-0"><button
                    onclick="closeProfileFilter()"
                    class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center hover:bg-gray-200 transition-colors"><i
                        data-lucide="arrow-left" class="w-6 h-6 text-gray-700"></i></button><span
                    class="font-bold text-gray-900 text-lg">Filter</span>
                <div class="w-10"></div>
            </div>
            <div class="p-4">
                <div class="mb-0">
                    <h3 class="text-xs font-bold text-gray-500 uppercase mb-3 px-1">Sort By</h3>
                    <div class="flex flex-col gap-2"><button onclick="setProfileSort('latest')"
                            class="flex items-center justify-between p-3 rounded-xl hover:bg-gray-50 transition-colors group"><span
                                class="font-bold text-gray-900">Latest</span><i id="sort-check-latest"
                                data-lucide="check" class="w-5 h-5 text-blue-600 hidden"></i></button><button
                            onclick="setProfileSort('oldest')"
                            class="flex items-center justify-between p-3 rounded-xl hover:bg-gray-50 transition-colors group"><span
                                class="font-bold text-gray-900">Oldest</span><i id="sort-check-oldest"
                                data-lucide="check" class="w-5 h-5 text-blue-600 hidden"></i></button><button
                            onclick="setProfileSort('popular')"
                            class="flex items-center justify-between p-3 rounded-xl hover:bg-gray-50 transition-colors group"><span
                                class="font-bold text-gray-900">Popular</span><i id="sort-check-popular"
                                data-lucide="check" class="w-5 h-5 text-blue-600 hidden"></i></button></div>
                </div>
            </div>
        </div>
    </div>
    <div id="user-list-overlay"
        class="fixed inset-0 z-[70] flex items-end md:items-center justify-center bg-black/40 backdrop-blur-sm hidden opacity-0 transition-opacity duration-200"
        onclick="closeUserList()">
        <div id="user-list-modal"
            class="bg-white w-full h-[70vh] md:h-auto md:w-[400px] md:max-h-[80vh] md:rounded-[24px] rounded-t-[24px] shadow-2xl relative transform translate-y-full md:translate-y-0 md:scale-95 transition-transform duration-200 flex flex-col overflow-hidden"
            onclick="event.stopPropagation()">
            <div class="h-16 border-b border-gray-100 flex items-center justify-between px-4 shrink-0"><button
                    onclick="closeUserList()"
                    class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center hover:bg-gray-200 transition-colors"><i
                        data-lucide="arrow-left" class="w-6 h-6 text-gray-700"></i></button><span
                    class="font-bold text-gray-900 text-lg" id="user-list-title">Users</span>
                <div class="w-10"></div>
            </div>
            <div id="user-list-content" class="flex-1 overflow-y-auto p-2"></div>
        </div>
    </div>
    <div id="create-menu-overlay"
        class="fixed inset-0 z-[70] flex items-end md:items-center justify-center bg-black/40 backdrop-blur-sm hidden opacity-0 transition-opacity duration-200"
        onclick="closeCreateMenu()">
        <div id="create-menu-modal"
            class="bg-white w-full h-auto md:w-[400px] md:max-h-[80vh] md:rounded-[24px] rounded-t-[24px] shadow-2xl relative transform translate-y-full md:translate-y-0 md:scale-95 transition-transform duration-200 flex flex-col overflow-hidden"
            onclick="event.stopPropagation()">
            <div class="h-16 border-b border-gray-100 flex items-center justify-between px-4 shrink-0"><button
                    onclick="closeCreateMenu()"
                    class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center hover:bg-gray-200 transition-colors"><i
                        data-lucide="arrow-left" class="w-6 h-6 text-gray-700"></i></button><span
                    class="font-bold text-gray-900 text-lg">Create New</span>
                <div class="w-10"></div>
            </div>
            <div class="p-2 flex flex-col gap-1"><button onclick="openCompose(); closeCreateMenu()"
                    class="flex items-center gap-4 p-4 hover:bg-gray-50 rounded-2xl transition-colors text-left group">
                    <div
                        class="w-12 h-12 rounded-full bg-gray-100 text-gray-900 flex items-center justify-center group-hover:bg-gray-200 transition-colors">
                        <i data-lucide="pen-tool" class="w-6 h-6"></i>
                    </div>
                    <div>
                        <div class="font-bold text-gray-900 text-lg">Create Post</div>
                        <div class="text-sm text-gray-500">Share with your network</div>
                    </div>
                </button><button id="create-option-ad" onclick="openPromoModal(event); closeCreateMenu()"
                    class="flex items-center gap-4 p-4 hover:bg-gray-50 rounded-2xl transition-colors text-left group hidden">
                    <div
                        class="w-12 h-12 rounded-full bg-gray-100 text-gray-900 flex items-center justify-center group-hover:bg-gray-200 transition-colors">
                        <i data-lucide="megaphone" class="w-6 h-6"></i>
                    </div>
                    <div>
                        <div class="font-bold text-gray-900 text-lg">Create Ad</div>
                        <div class="text-sm text-gray-500">Promote content</div>
                    </div>
                </button></div>
        </div>
    </div>
    <div id="edit-profile-overlay"
        class="fixed inset-0 z-50 flex items-end md:items-center justify-center bg-black/40 backdrop-blur-sm hidden opacity-0 transition-opacity duration-200"
        onclick="closeEditProfile()">
        <div id="edit-profile-modal"
            class="bg-white w-full h-full md:h-auto md:w-[95%] md:max-w-[500px] md:max-h-[90vh] md:rounded-none shadow-2xl relative transform translate-y-full md:translate-y-0 md:scale-95 transition-transform duration-200 flex flex-col overflow-hidden"
            onclick="event.stopPropagation()">
            <div class="flex justify-between items-center h-16 px-4 border-b border-gray-100 shrink-0 bg-white"><button
                    onclick="closeEditProfile()"
                    class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center hover:bg-gray-200 transition-colors"><i
                        data-lucide="arrow-left" class="w-6 h-6 text-gray-700"></i></button>
                <h2 class="text-lg font-bold google-font">Edit Profile</h2>
                <div class="w-10"></div>
            </div>
            <div class="flex-1 overflow-y-auto p-0 pb-20 md:pb-6 relative">
                <div class="relative">
                    <div id="banner-edit-area"
                        class="h-36 w-full bg-gray-200 relative overflow-hidden cursor-grab group"
                        onclick="document.getElementById('edit-banner-input').click()"><img id="edit-banner-preview"
                            src="" class="w-full h-full object-cover pointer-events-none select-none">
                        <div
                            class="absolute inset-0 bg-black/20 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                            <i data-lucide="camera" class="text-white w-8 h-8 drop-shadow-md"></i>
                        </div>
                    </div>
                    <div class="absolute -bottom-10 left-4">
                        <div class="relative group cursor-pointer"
                            onclick="document.getElementById('edit-avatar-input').click()"><img id="edit-avatar-preview"
                                src="" class="w-24 h-24 rounded-full border-4 border-white bg-gray-100 object-cover">
                            <div
                                class="absolute inset-0 rounded-full bg-black/20 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                <i data-lucide="camera" class="text-white w-6 h-6 drop-shadow-md"></i>
                            </div>
                        </div>
                    </div>
                    <div
                        class="absolute top-2 right-2 bg-black/50 text-white text-[10px] px-2 py-1 rounded-md pointer-events-none backdrop-blur-sm">
                        Drag to reposition: <span id="banner-pos-hint">50%</span></div>
                </div>
                <div class="mt-12 px-6 flex flex-col gap-6"><input type="file" id="edit-avatar-input" class="hidden"
                        accept="image/*" onchange="handleEditAvatarSelect(event)"><input type="file"
                        id="edit-banner-input" class="hidden" accept="image/*" onchange="handleEditBannerSelect(event)">
                    <div><label class="text-xs font-bold text-gray-500 uppercase">Display Name</label><input type="text"
                            id="edit-name"
                            class="w-full border-b border-gray-200 py-2 outline-none focus:border-blue-500 font-medium text-gray-900 text-lg">
                        <div id="name-change-hint" class="text-[10px] text-gray-400 mt-1">You can change your name once
                            a week.</div>
                    </div>
                    <div><label class="text-xs font-bold text-gray-500 uppercase">Username</label>
                        <div class="relative"><span
                                class="absolute left-0 top-2 text-gray-400 font-medium">@</span><input type="text"
                                id="edit-username"
                                class="w-full border-b border-gray-200 py-2 pl-4 outline-none focus:border-blue-500 font-medium text-gray-900"
                                maxlength="20" oninput="checkUsername(this)"></div>
                        <div class="flex justify-between items-center mt-1">
                            <div id="username-change-hint" class="text-[10px] text-gray-400">You can change this once a
                                week.</div>
                            <div id="username-counter" class="text-[10px] text-gray-400">0/20</div>
                        </div>
                        <div id="username-error" class="text-xs text-red-500 font-medium mt-1 hidden">Username is taken.
                        </div>
                    </div>
                    <div><label class="text-xs font-bold text-gray-500 uppercase">Email</label><input type="text"
                            id="edit-email"
                            class="w-full border-b border-gray-200 py-2 outline-none text-gray-500 bg-transparent select-text"
                            disabled></div>
                    <div><label class="text-xs font-bold text-gray-500 uppercase">Bio</label><textarea id="edit-bio"
                            class="w-full border-b border-gray-200 py-2 outline-none focus:border-blue-500 text-sm text-gray-700 resize-none"
                            rows="3"></textarea></div>
                </div>
            </div>
            <div class="p-4 border-t border-gray-100 bg-white absolute bottom-0 w-full md:relative"><button
                    id="save-profile-btn" onclick="saveProfileChanges()"
                    class="w-full bg-gray-100 text-gray-900 py-3 rounded-xl font-bold hover:bg-gray-200 transition-all">Save
                    Changes</button></div>
        </div>
    </div>
    <input type="file" id="event-cover-input" class="hidden" accept="image/*" onchange="handleEventCoverSelect(event)">
    <div id="event-overlay"
        class="fixed inset-0 z-[55] flex items-center justify-center bg-[#000]/40 backdrop-blur-sm opacity-0 pointer-events-none transition-opacity duration-200">
        <div id="event-modal-box"
            class="bg-white w-[95%] max-w-[550px] rounded-[16px] shadow-2xl relative transform scale-95 transition-transform duration-200 flex flex-col overflow-hidden p-0">
            <div id="event-cover-preview-container" class="w-full h-40 bg-gray-100 hidden relative group"><img
                    id="event-cover-preview" class="w-full h-full object-cover"><button onclick="removeEventCover()"
                    class="absolute top-2 right-2 bg-black/50 text-white p-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity hover:bg-black/70 z-20"><i
                        data-lucide="x" class="w-4 h-4"></i></button><button
                    onclick="document.getElementById('event-cover-input').click()"
                    class="absolute top-1/2 -translate-y-1/2 right-2 bg-white/80 text-gray-700 text-xs font-bold px-3 py-1.5 rounded-full opacity-0 group-hover:opacity-100 transition-opacity hover:bg-white z-20 shadow-sm">Change</button>
            </div><button onclick="closeEventComposer()"
                class="absolute top-4 right-4 icon-btn hover:bg-[#f0f4f9] z-10 bg-white/50 backdrop-blur-sm"><i
                    data-lucide="x" class="w-5 h-5"></i></button>
            <div class="p-8 pt-6">
                <div id="add-cover-btn"
                    class="mb-6 opacity-60 hover:opacity-100 transition-opacity cursor-pointer flex items-center gap-2 text-sm text-[#667085]"
                    onclick="document.getElementById('event-cover-input').click()"><i data-lucide="image"
                        class="w-4 h-4"></i> Add cover</div><input type="text" id="event-title"
                    placeholder="Untitled Event"
                    class="text-3xl font-bold text-[#1f1f1f] placeholder-[#d1d5db] border-none outline-none bg-transparent w-full mb-6 google-font">
                <div class="flex flex-col gap-1 mb-6">
                    <div class="notion-input-row">
                        <div class="notion-label"><i data-lucide="clock" class="w-4 h-4"></i> Date</div><input
                            type="date" id="event-date" class="notion-input">
                    </div>
                    <div class="notion-input-row">
                        <div class="notion-label"><i data-lucide="watch" class="w-4 h-4"></i> Time</div><input
                            type="time" id="event-time" class="notion-input">
                    </div>
                    <div class="notion-input-row">
                        <div class="notion-label"><i data-lucide="map-pin" class="w-4 h-4"></i> Location</div><input
                            type="text" id="event-location" placeholder="Add location..." class="notion-input">
                    </div>
                </div><textarea id="event-desc" placeholder="Add description..."
                    class="w-full min-h-[100px] resize-none border-none outline-none text-[#374151] text-[15px] leading-relaxed bg-transparent"></textarea>
                <div class="flex justify-end mt-6 pt-4 border-t border-gray-100"><button onclick="publishEvent()"
                        class="bg-[#0b57d0] text-white px-6 py-2 rounded-lg font-bold text-sm hover:bg-[#0b57d0]/90 transition-all shadow-sm">Create
                        Event</button></div>
            </div>
        </div>
    </div>
    <div id="compose-overlay"
        class="fixed inset-0 z-[55] flex items-end md:items-center justify-center bg-[#000]/40 backdrop-blur-sm opacity-0 pointer-events-none transition-opacity duration-200"
        onclick="attemptCloseCompose()">
        <div id="compose-modal"
            class="bg-white w-full h-full md:h-auto md:w-[95%] md:max-w-[620px] rounded-none md:rounded-[24px] shadow-2xl relative transform translate-y-full md:translate-y-0 md:scale-95 transition-transform duration-200 flex flex-col overflow-hidden"
            onclick="event.stopPropagation()">
            <div id="compose-progress-overlay"
                class="absolute inset-0 bg-white/90 backdrop-blur-sm z-[60] hidden flex-col items-center justify-center">
                <div class="w-64 h-2 bg-gray-200 rounded-full overflow-hidden mb-4">
                    <div id="post-progress-bar" class="h-full bg-[#0b57d0] transition-all duration-300 w-0"></div>
                </div>
                <p class="font-bold text-gray-900 animate-pulse">Posting...</p>
            </div>
            <div class="flex items-center justify-between h-16 px-4 border-b border-gray-100 md:h-16"><button
                    onclick="handleComposeBack()"
                    class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center hover:bg-gray-200 transition-colors"><i
                        data-lucide="arrow-left" class="w-6 h-6 text-gray-700"></i></button><span
                    class="text-lg font-bold text-gray-900" id="compose-header-title">Create Post</span>
                <div class="w-10"></div>
            </div>
            <div id="compose-body" class="flex-1 overflow-y-auto relative">
                <div id="compose-step-1" class="p-4 h-full flex flex-col">
                    <div class="grid grid-cols-2 gap-4" id="media-grid-container"></div>
                </div>
                <div id="compose-step-2" class="p-4 hidden">
                    <div class="flex gap-3 mb-4 items-center"><img id="compose-avatar" src=""
                            class="w-10 h-10 rounded-full border border-gray-100 bg-gray-50 object-cover">
                        <div>
                            <div id="compose-name" class="text-[15px] font-bold text-[#1f1f1f]">User</div>
                        </div>
                    </div>
                    <div class="relative"><textarea id="compose-text" placeholder="What's on your mind?"
                            class="w-full min-h-[150px] text-lg resize-none border-none outline-none bg-transparent placeholder-gray-400"
                            oninput="checkWordCount(this)"></textarea>
                        <div id="word-count-display"
                            class="absolute bottom-2 right-2 text-xs text-gray-400 font-medium pointer-events-none">
                            0/500 words</div>
                    </div>
                    <div id="collab-chips-container" class="flex flex-wrap mb-2"></div>
                </div>
            </div>
            <div class="bg-white border-t border-gray-100 z-10">
                <div id="compose-footer-settings" class="hidden border-b border-gray-100">
                    <div class="flex items-center justify-between p-3 cursor-pointer hover:bg-gray-50 transition-colors"
                        onclick="toggleComposeSettings()"><span
                            class="text-xs font-bold text-gray-500 uppercase tracking-wider flex items-center gap-2"><i
                                data-lucide="settings-2" class="w-4 h-4"></i> Post Settings</span><i
                            data-lucide="chevron-up" id="compose-settings-arrow"
                            class="w-4 h-4 text-gray-400 transition-transform"></i></div>
                    <div id="compose-settings-area" class="hidden px-4 pb-4 space-y-3 bg-gray-50/50">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2 text-sm text-gray-700"><i data-lucide="lock"
                                    class="w-4 h-4"></i> Private (Followers Only)</div><input type="checkbox"
                                id="post-setting-privacy" class="accent-blue-600 w-4 h-4 cursor-pointer">
                        </div>
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2 text-sm text-gray-700"><i data-lucide="heart"
                                    class="w-4 h-4"></i> Show Like Count</div><input type="checkbox"
                                id="post-setting-likes" class="accent-blue-600 w-4 h-4 cursor-pointer" checked>
                        </div>
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2 text-sm text-gray-700"><i data-lucide="message-square"
                                    class="w-4 h-4"></i> Show Comment Count</div><input type="checkbox"
                                id="post-setting-comments" class="accent-blue-600 w-4 h-4 cursor-pointer" checked>
                        </div>
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2 text-sm text-gray-700"><i data-lucide="users"
                                    class="w-4 h-4"></i> Allow viewers to see who liked</div><input type="checkbox"
                                id="post-setting-like-view" class="accent-blue-600 w-4 h-4 cursor-pointer" checked>
                        </div>
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2 text-sm text-gray-700"><i data-lucide="message-circle"
                                    class="w-4 h-4"></i> Allow comments</div><input type="checkbox"
                                id="post-setting-allow-comments" class="accent-blue-600 w-4 h-4 cursor-pointer" checked>
                        </div>
                        <div class="flex items-center justify-between cursor-pointer p-2 hover:bg-gray-100 rounded-lg transition-colors"
                            onclick="openClaimOverlay()">
                            <div class="flex items-center gap-2 text-sm text-gray-700"><i data-lucide="shopping-bag"
                                    class="w-4 h-4"></i> Add Claim Link</div>
                            <div class="flex items-center gap-2"><span id="claim-status-indicator"
                                    class="text-xs font-bold text-gray-400">Off</span><i data-lucide="chevron-right"
                                    class="w-4 h-4 text-gray-400"></i></div>
                        </div>
                    </div>
                </div>
                <div class="p-4"><button id="compose-action-btn"
                        class="w-full py-3 bg-gray-100 text-gray-900 font-bold rounded-xl hover:bg-gray-200 transition-colors"
                        onclick="handleComposeAction()">Skip</button></div>
            </div>
        </div>
    </div>
    <div id="profile-preview-overlay"
        class="fixed inset-0 z-[110] flex items-end md:items-center justify-center bg-black/40 backdrop-blur-sm hidden opacity-0 transition-opacity duration-200"
        onclick="closeProfilePreview()">
        <div id="profile-preview-card"
            class="bg-white w-full md:w-[360px] md:rounded-[24px] rounded-t-[24px] shadow-2xl relative transform translate-y-full md:translate-y-0 md:scale-95 transition-transform duration-200 flex flex-col overflow-hidden"
            onclick="event.stopPropagation()">
            <div id="pp-banner" class="h-32 w-full bg-gray-200 bg-cover bg-center"></div>
            <div class="px-5 relative flex-1">
                <div class="flex justify-between items-end -mt-10 mb-3"><img id="pp-avatar" src=""
                        class="w-20 h-20 rounded-full border-4 border-white bg-white object-cover shadow-sm">
                    <div class="w-1"></div>
                </div>
                <div class="mb-4">
                    <h3 id="pp-name" class="font-bold text-xl text-gray-900 flex items-center gap-1">User</h3>
                    <div id="pp-username" class="text-sm text-gray-500 font-medium">@user</div>
                </div>
                <div class="flex justify-between items-center mb-6 px-2">
                    <div class="text-center">
                        <div id="pp-posts-count" class="font-bold text-gray-900 text-lg">0</div>
                        <div class="text-xs text-gray-500 uppercase font-bold tracking-wide">Posts</div>
                    </div>
                    <div class="text-center">
                        <div id="pp-followers-count" class="font-bold text-gray-900 text-lg">0</div>
                        <div class="text-xs text-gray-500 uppercase font-bold tracking-wide">Followers</div>
                    </div>
                    <div class="text-center">
                        <div id="pp-following-count" class="font-bold text-gray-900 text-lg">0</div>
                        <div class="text-xs text-gray-500 uppercase font-bold tracking-wide">Following</div>
                    </div>
                </div>
            </div>
            <div class="p-4 border-t border-gray-100 flex items-center gap-3 bg-white pb-6 md:pb-4"><button
                    id="pp-visit-btn"
                    class="flex-1 py-3 bg-[#0b57d0] text-white font-bold rounded-xl hover:bg-blue-700 transition-colors text-sm">Visit
                    Profile</button><button id="pp-share-btn"
                    class="w-11 h-11 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center text-gray-700 transition-colors shrink-0"><i
                        data-lucide="redo-2" class="w-5 h-5"></i></button><button onclick="closeProfilePreview()"
                    class="w-11 h-11 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center text-gray-700 transition-colors shrink-0"><i
                        data-lucide="x" class="w-6 h-6"></i></button></div>
        </div>
    </div>
    <div id="claim-link-overlay"
        class="fixed inset-0 z-[85] flex items-center justify-center bg-black/60 backdrop-blur-sm hidden opacity-0 transition-opacity duration-300">
        <div id="claim-link-modal"
            class="bg-white w-[90%] max-w-[400px] rounded-2xl shadow-none border-0 ring-0 outline-none p-6 transform translate-y-full md:translate-y-0 md:scale-95 transition-all duration-300">
            <h3 class="text-lg font-bold text-gray-900 mb-4">Add Claim Link</h3><input type="url" id="claim-link-input"
                placeholder="https://example.com/product"
                class="w-full border-b border-gray-200 py-2 outline-none focus:border-blue-500 font-medium text-gray-900 mb-6">
            <div class="flex justify-end gap-3"><button onclick="closeClaimOverlay()"
                    class="px-4 py-2 text-gray-600 font-bold text-sm hover:bg-gray-100 rounded-lg">Cancel</button><button
                    onclick="saveClaimLink()"
                    class="px-4 py-2 bg-[#0b57d0] text-white font-bold text-sm rounded-lg hover:bg-blue-700">Save</button>
            </div>
        </div>
    </div>
    <aside id="main-sidebar" class="hidden md:flex app-panel">
        <div class="h-12 flex items-center gap-3 mb-6 px-2 cursor-pointer" onclick="switchView('feed')"><img
                src="https://i.imghippo.com/files/fRGt5603uII.png" class="w-8 h-8 object-contain">
            <h1 class="text-[20px] font-bold text-[#1f1f1f] hidden lg:block tracking-tight">EduLink</h1>
        </div><button onclick="openCreateMenu()" class="create-btn hidden lg:flex"><i data-lucide="plus"
                class="w-5 h-5"></i><span>Create</span></button>
        <nav class="flex-1 space-y-1" id="desktop-nav-items"><a href="#" onclick="switchView('feed');return false;"
                id="nav-feed" class="nav-item active">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24"
                    class="custom-icon custom-icon-filled" id="nav-feed-icon">
                    <path
                        d="M3 10.5L10.2 4.6C11.3 3.7 12.7 3.7 13.8 4.6L21 10.5C21.6 11 22 11.7 22 12.5V19C22 20.7 20.7 22 19 22H15C14.4 22 14 21.6 14 21V15C14 13.9 13.1 13 12 13C10.9 13 10 13.9 10 15V21C10 21.6 9.6 22 9 22H5C3.3 22 2 20.7 2 19V12.5C2 11.7 2.4 11 3 10.5Z" />
                </svg>
                <span class="hidden lg:block">Home</span></a><a href="#" onclick="switchView('explore');return false;"
                id="nav-explore" class="nav-item">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24"
                    class="custom-icon custom-icon-outline" id="nav-explore-icon">
                    <circle cx="11" cy="11" r="8" />
                    <path d="M21 21l-4.35-4.35" />
                </svg>
                <span class="hidden lg:block">Explore</span></a><a href="#"
                onclick="switchView('notifications');return false;" id="nav-notifications" class="nav-item relative">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24"
                    class="custom-icon custom-icon-outline" id="nav-notifications-icon">
                    <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9" />
                    <path d="M13.73 21a2 2 0 0 1-3.46 0" />
                </svg>
                <span class="hidden lg:block">Activity</span><span id="nav-notif-badge" class="nav-badge">0</span></a><a
                href="#" onclick="showProfile(auth.currentUser?auth.currentUser.uid:null);return false;"
                id="nav-profile" class="nav-item"><i data-lucide="user" class="w-7 h-7"></i> <span
                    class="hidden lg:block">Profile</span></a></nav>
        <div class="mt-auto pt-4 border-t border-gray-100 flex flex-col gap-2">
            <div class="sidebar-user group cursor-pointer" onclick="openSettings()">
                <div
                    class="w-9 h-9 rounded-full bg-gray-100 flex items-center justify-center text-gray-600 hover:bg-gray-200 transition-colors">
                    <i data-lucide="settings" class="w-5 h-5"></i>
                </div>
                <div class="hidden lg:block">
                    <div class="text-sm font-bold text-[#1f1f1f]">Settings</div>
                </div>
            </div>
            <div class="sidebar-user group" onclick="showProfile(auth.currentUser?auth.currentUser.uid:null)"><img
                    id="sidebar-avatar" src=""
                    class="w-9 h-9 rounded-full bg-gray-100 border border-gray-200 shrink-0 object-cover">
                <div class="hidden lg:block">
                    <div id="sidebar-name"
                        class="text-sm font-bold text-[#1f1f1f] group-hover:text-blue-700 transition-colors truncate w-[140px]">
                        User</div>
                    <div class="text-xs text-[#667085]">View Profile</div>
                </div>
            </div>
        </div>
    </aside>
    <div id="workspace-layout" class="flex-1 flex min-w-0 gap-4 relative overflow-hidden transition-all duration-300">
        <main id="main-panel" class="flex-1 app-panel min-w-0 relative">
            <header id="main-header"
                class="h-16 md:h-20 flex items-center justify-between px-4 md:px-6 shrink-0 z-20 absolute top-0 w-full bg-white/95 md:bg-white/90 backdrop-blur-md border-b border-[#f0f0f0] transition-transform duration-300">
                <div class="md:hidden flex items-center gap-3 cursor-pointer"
                    onclick="switchView('feed'); renderFeed();"><img src="https://i.imghippo.com/files/fRGt5603uII.png"
                        class="w-8 h-8 object-contain">
                    <h1 class="text-lg font-bold text-[#1f1f1f] tracking-tight">EduLink</h1>
                </div>
                <div class="flex-1 max-w-[600px] relative group hidden md:block"><i data-lucide="search"
                        class="absolute left-5 top-3.5 w-5 h-5 text-[#667085] group-focus-within:text-[#0b57d0] transition-colors"></i><input
                        type="text" placeholder="Search EduLink" id="global-search" oninput="handleSearch(this.value)"
                        class="w-full bg-[#f3f4f6] rounded-full py-3.5 pl-14 pr-6 outline-none focus:bg-[#ffffff] focus:shadow-sm focus:ring-1 focus:ring-gray-200 transition-all text-[#1f1f1f] text-[15px]">
                </div>
                <div class="flex items-center gap-3 pl-4"><button onclick="openSettings()"
                        class="icon-btn hover:bg-gray-100 md:hidden"><i data-lucide="settings"
                            class="w-6 h-6"></i></button><button class="icon-btn relative" onclick="openFeedFilter()"><i
                            data-lucide="user-round-pen" class="w-6 h-6"></i></button><img id="header-avatar" src=""
                        class="w-9 h-9 rounded-full bg-gray-100 border border-gray-200 cursor-pointer hover:ring-2 ring-offset-1 ring-blue-500 transition-all hidden md:block"
                        onclick="showProfile(auth.currentUser?auth.currentUser.uid:null)"></div>
            </header>
            <div id="ptr-spinner"><i data-lucide="arrow-down" class="w-5 h-5"></i></div>
            <div id="view-feed" class="flex-1 h-full overflow-y-auto no-scrollbar p-0 bg-white pt-16 md:pt-20">
                <div id="feed-container"></div>
            </div>
            <div id="view-saved"
                class="flex-1 h-full overflow-y-auto no-scrollbar p-0 md:p-6 hidden bg-[#f9fafb] md:bg-[#fff] pt-16 md:pt-6">
                <h2 class="text-2xl font-bold mb-6 px-4 md:px-0">Saved Posts</h2>
                <div id="saved-container" class="space-y-4"></div>
            </div>
            <div id="view-network"
                class="flex-1 h-full overflow-y-auto no-scrollbar p-0 md:p-6 hidden bg-[#f9fafb] md:bg-[#fff] pt-16 md:pt-6">
                <h2 class="text-2xl font-bold mb-6 px-4 md:px-0">My Network</h2>
                <div class="tab-group mb-4 mx-0 md:mx-0"><button onclick="switchNetworkTab('people')"
                        id="net-tab-people" class="tab-btn active">People</button><button
                        onclick="switchNetworkTab('posts')" id="net-tab-posts" class="tab-btn">Posts</button></div>
                <div id="network-content"></div>
            </div>
            <div id="view-profile" class="flex-1 h-full overflow-y-auto no-scrollbar hidden bg-white"></div>
            <div id="view-notifications"
                class="flex-1 h-full overflow-y-auto no-scrollbar p-0 md:p-6 hidden bg-white pt-16 md:pt-6">
                <div class="flex justify-between items-center mb-6 px-4 md:px-0 hidden md:flex">
                    <h2 class="text-2xl font-bold">Activity</h2><button onclick="clearAllNotifications()"
                        class="text-xs text-red-500 font-bold hover:underline">Clear All</button>
                </div>
                <div id="notification-list" class="flex flex-col w-full pb-24 md:pb-0"></div>
            </div>
            <div id="view-events"
                class="flex-1 h-full overflow-y-auto p-0 md:p-6 hidden bg-[#f9fafb] md:bg-[#fff] pt-16 md:pt-6">
                <div class="flex items-center justify-between mb-6 px-4 md:px-0">
                    <h2 class="text-2xl font-bold text-[#1f1f1f]">Upcoming Events</h2><button
                        onclick="openEventComposer()"
                        class="bg-[#0b57d0] text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2"><i
                            data-lucide="plus" class="w-4 h-4"></i> New Event</button>
                </div>
                <div id="events-list" class="grid grid-cols-1 gap-4 px-4 md:px-0"></div>
            </div>
            <div id="view-explore" class="flex-1 h-full overflow-y-auto no-scrollbar p-0 md:pt-20 hidden bg-white">
                <div id="explore-header-container"
                    class="sticky top-0 bg-white z-20 border-b border-gray-100 md:hidden">
                    <div class="h-14 flex items-center px-4 shrink-0">
                        <div class="relative bg-gray-100 rounded-xl flex items-center px-3 py-2 w-full"><i
                                data-lucide="search" class="w-4 h-4 text-gray-400 mr-2"></i><input type="text"
                                id="mobile-explore-search"
                                class="bg-transparent border-none outline-none text-sm w-full" placeholder="Search..."
                                oninput="handleSearch(this.value)"></div>
                    </div>
                    <div class="tab-group"><button id="tab-explore-main" onclick="switchExploreMainTab('explore')"
                            class="tab-btn active"><i data-lucide="grid" class="w-5 h-5"></i></button><button
                            id="tab-explore-video" onclick="switchExploreMainTab('video')" class="tab-btn"><i
                                data-lucide="play-circle" class="w-5 h-5"></i></button><button id="tab-explore-people"
                            onclick="switchExploreMainTab('people')" class="tab-btn"><i data-lucide="users"
                                class="w-5 h-5"></i></button><button id="tab-explore-tags"
                            onclick="switchExploreMainTab('tags')" class="tab-btn"><i data-lucide="hash"
                                class="w-5 h-5"></i></button></div>
                </div>
                <div class="hidden md:block w-full bg-white z-10 border-b border-gray-100">
                    <div class="max-w-5xl mx-auto tab-group border-b-0 px-0 justify-center"><button
                            id="tab-explore-main-d" onclick="switchExploreMainTab('explore')"
                            class="tab-btn active max-w-[120px]"><i data-lucide="grid" class="w-4 h-4"></i>
                            Posts</button><button id="tab-explore-video-d" onclick="switchExploreMainTab('video')"
                            class="tab-btn max-w-[120px]"><i data-lucide="play-circle" class="w-4 h-4"></i>
                            Videos</button><button id="tab-explore-people-d" onclick="switchExploreMainTab('people')"
                            class="tab-btn max-w-[120px]"><i data-lucide="users" class="w-4 h-4"></i>
                            People</button><button id="tab-explore-tags-d" onclick="switchExploreMainTab('tags')"
                            class="tab-btn max-w-[120px]"><i data-lucide="hash" class="w-4 h-4"></i> Tags</button></div>
                </div>
                <div id="explore-content-wrapper" class="pb-32 max-w-5xl mx-auto py-6">
                    <div id="explore-people-results" class="hidden flex-col p-4 pt-0"></div>
                    <div id="explore-results" class="space-y-0 pt-0"></div>
                </div>
            </div>
        </main>
        <aside id="trending-panel" class="trending-panel hidden xl:flex app-panel mb-16 md:mb-0 flex-col bg-white">
            <div
                class="h-16 md:h-20 shrink-0 border-b border-[#f0f0f0] flex items-center justify-between px-6 bg-white/95 backdrop-blur z-20">
                <div class="flex items-center gap-3"><span
                        class="text-[19px] font-bold text-[#1f1f1f] google-font">People</span></div>
            </div>
            <div class="flex-1 overflow-y-auto p-5">
                <div class="mb-8">
                    <h3 class="text-lg font-bold text-[#1f1f1f] mb-4">Who to follow</h3>
                    <div id="who-to-follow-list" class="flex flex-col gap-4"></div>
                </div>
                <div id="promo-section" class="hidden">
                    <div class="relative group rounded-xl overflow-hidden cursor-pointer"><a id="promo-link" href="#"
                            target="_blank" class="block w-full h-full"><img id="promo-image" src=""
                                class="w-full h-auto object-cover rounded-xl border border-gray-200 hover:opacity-95 transition-opacity"></a><button
                            id="edit-promo-btn" onclick="openPromoModal(event)"
                            class="absolute top-2 right-2 bg-black/60 text-white p-2 rounded-full opacity-0 group-hover:opacity-100 transition-opacity hover:bg-black/80 hidden z-20"><i
                                data-lucide="edit-2" class="w-4 h-4"></i></button>
                        <div
                            class="absolute bottom-2 left-2 bg-black/60 text-white text-[10px] px-2 py-0.5 rounded-md font-medium uppercase tracking-wide backdrop-blur-sm pointer-events-none">
                            Promoted</div>
                    </div>
                </div>
            </div>
        </aside>
    </div>
    <nav id="mobile-bottom-nav"
        class="md:hidden fixed bottom-0 left-0 w-full bg-white border-t border-[#eaecf0] h-[64px] flex items-center justify-around z-50 pb-[env(safe-area-inset-bottom)] px-2 shadow-lg transition-transform duration-300">
        <div class="mobile-nav-item active" onclick="switchView('feed')" id="mobile-nav-feed">
            <svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="0 0 24 24"
                class="custom-icon custom-icon-filled" id="mobile-feed-icon" style="stroke-width: 2;">
                <path
                    d="M3 10.5L10.2 4.6C11.3 3.7 12.7 3.7 13.8 4.6L21 10.5C21.6 11 22 11.7 22 12.5V19C22 20.7 20.7 22 19 22H15C14.4 22 14 21.6 14 21V15C14 13.9 13.1 13 12 13C10.9 13 10 13.9 10 15V21C10 21.6 9.6 22 9 22H5C3.3 22 2 20.7 2 19V12.5C2 11.7 2.4 11 3 10.5Z" />
            </svg>
        </div>
        <div class="mobile-nav-item" onclick="switchView('explore')" id="mobile-nav-explore">
            <svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="0 0 24 24"
                class="custom-icon custom-icon-outline" id="mobile-explore-icon" style="stroke-width: 2;">
                <circle cx="11" cy="11" r="8" />
                <path d="M21 21l-4.35-4.35" />
            </svg>
        </div>
        <div class="mobile-nav-item" onclick="openCreateMenu()" id="mobile-nav-create">
            <svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="0 0 24 24"
                class="custom-icon custom-icon-outline" id="mobile-create-icon" style="stroke-width: 2;">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
                <line x1="12" y1="8" x2="12" y2="16" />
                <line x1="8" y1="12" x2="16" y2="12" />
            </svg>
        </div>
        <div class="mobile-nav-item" onclick="switchView('notifications')" id="mobile-nav-notifications">
            <div class="relative">
                <svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="0 0 24 24"
                    class="custom-icon custom-icon-outline" id="mobile-notifications-icon" style="stroke-width: 2;">
                    <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9" />
                    <path d="M13.73 21a2 2 0 0 1-3.46 0" />
                </svg>
                <span id="mobile-footer-badge" class="mobile-footer-badge">0</span>
            </div>
        </div>
        <div class="mobile-nav-item" onclick="showProfile(auth.currentUser?auth.currentUser.uid:null)"
            id="mobile-nav-profile"><img id="mobile-avatar" src="" class="w-6 h-6 rounded-full border border-gray-200">
        </div>
    </nav>
    <input type="file" id="media-input" class="hidden" accept="image/*,video/*" onchange="handleFileSelect(event)">
    <input type="file" id="grid-upload-input" class="hidden" accept="image/*,video/*"
        onchange="onGridFileSelect(event)">
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js"; import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js"; import { getFirestore, collection, doc, getDoc, setDoc, updateDoc, deleteDoc, arrayUnion, arrayRemove, addDoc, onSnapshot, query, orderBy, where, serverTimestamp, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js"; import { getStorage, ref, uploadString, getDownloadURL, uploadBytes } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";
        const firebaseConfig = { apiKey: "AIzaSyAJH79UQl0rc96Qug0DKLevO4ZI_sn8Kno", authDomain: "edulinki.firebaseapp.com", projectId: "edulinki", storageBucket: "edulinki.firebasestorage.app", messagingSenderId: "248886466474", appId: "1:248886466474:web:160043201a6b28bafbbdd3", measurementId: "G-MQBH12VL7N" };
        const app = initializeApp(firebaseConfig), auth = getAuth(app), db = getFirestore(app), storage = getStorage(app); window.auth = auth; window.db = db;
        let currentUser = null, users = [], posts = [], notifications = [], savedPosts = [], activeNotifTab = 'all', activeNetworkTab = 'people';
        window.replyingToCommentId = null; window.currentViewingProfileId = null; window.activeExploreTab = 'explore'; window.activeExploreCategory = 'For You'; window.currentProfileTab = 'posts';
        window.currentMedia = []; window.uploadMode = 'single'; window.currentMediaType = null; window.isWebSearchActive = false;
        let stopGeneration = false, abortController = null; window.isPlusMenuOpen = false; window.currentEventCover = null; window.editingPostId = null; window.threadParentCommentId = null; window.threadPostId = null;
        let currentEventCoverBlob = null, currentAvatarBlob = null, currentBannerBlob = null; window.currentPromoBlob = null;
        window.notifSelectionMode = false; window.selectedNotifs = new Set(); window.notifSearchTerm = ''; window.selectedCollaborators = [];
        window.currentSharePid = null; window.activeFeedFilter = 'all'; window.currentSuggestionIds = []; window.lastSuggestionRefresh = 0;
        window.composeStep = 1; window.composeImages = [null, null, null, null]; window.composeImageBlobs = [...window.composeImages];
        window.expandedTexts = new Set(); window.currentViewName = 'feed';
        let lastScrollTop = 0, lastExploreScrollTop = 0, html5QrCode, ptrStartY = 0, ptrDist = 0, isPtr = false, isRefreshing = false, exitAttempt = false;
        window.profileSort = 'latest'; window.isDesktopThreadMode = false;
        window.currentDownloadImages = []; window.selectedDownloadIndices = new Set();
        window.currentCommentFilter = 'latest'; window.sessionSeenPosts = new Set();
        window.trackInteraction = async (pid, type, weight = 1) => { if (!currentUser) return; const r = doc(db, "users", currentUser.id), p = posts.find(x => x.id === pid); if (!p) return; const s = currentUser.interests || {}; s.authors = s.authors || {}; s.tags = s.tags || {}; s.disliked = s.disliked || []; if (type === 'not_interested') { if (!s.disliked.includes(pid)) s.disliked.push(pid); weight = -50 } if (p.authorId) s.authors[p.authorId] = (s.authors[p.authorId] || 0) + weight; const tags = p.content.match(/#(\w+)/g); if (tags) tags.forEach(t => { const tn = t.substring(1).toLowerCase(); s.tags[tn] = (s.tags[tn] || 0) + weight }); await updateDoc(r, { interests: s }); currentUser.interests = s; renderFeed(); if (type === 'not_interested') { showToast("We'll show you less of this") } else if (type === 'show_more') showToast("We'll show you more of this") };
        const getPostScore = (p, refreshSalt = 0.5) => {
            if (!currentUser) return 0;
            const s = currentUser.interests || {};
            if (s.disliked && s.disliked.includes(p.id)) return -2000;
            if (window.sessionSeenPosts.has(p.id)) return -500;

            const ts = p.timestamp?.toDate ? p.timestamp.toDate().getTime() : new Date(p.timestamp || 0).getTime();
            const hoursOld = (Date.now() - ts) / 3600000;

            const rawRel = (p.authorId && s.authors && s.authors[p.authorId]) ? s.authors[p.authorId] : 0;
            const relationship = Math.min(100, rawRel * 12);

            let rawInterest = 0;
            const tags = p.content.match(/#(\w+)/g);
            if (tags && s.tags) tags.forEach(t => { const tn = t.substring(1).toLowerCase(); if (s.tags[tn]) rawInterest += s.tags[tn] });
            const interest = Math.min(100, rawInterest * 10);

            const recency = Math.min(100, (1 / (hoursOld + 1)) * 1000);
            const likesCount = p.likes?.length || 0;
            const commentsCount = p.comments?.length || 0;
            const engagement = Math.min(100, (likesCount * 3) + (commentsCount * 6));

            let finalScore = (relationship * 0.35) + (interest * 0.45) * 1.5 + (recency * 0.1) + (engagement * 0.1);

            // Use the refreshSalt to create a unique but stable shuffle for this render cycle
            // Incorporate User ID to ensure different people see different orders
            const userInt = (currentUser.id.charCodeAt(0) + (currentUser.id.charCodeAt(currentUser.id.length - 1) || 0));
            const varietyWeight = ((refreshSalt * 1000 + userInt) % 100) / 100;
            finalScore *= (0.7 + (varietyWeight * 0.6)); // +/- 30% shuffle for higher variety

            return finalScore;
        };
        window.commentSearchTerm = ''; window.isCommentSearchOpen = false;
        window.currentClaimLink = null;
        const feedView = document.getElementById('view-feed'), exploreView = document.getElementById('view-explore'), ptrSpinner = document.getElementById('ptr-spinner'), refreshIcons = () => window.lucide?.createIcons();
        if (feedView) { feedView.addEventListener('touchstart', e => { if (!feedView.scrollTop && !isRefreshing) { ptrStartY = e.touches[0].pageY; isPtr = true; ptrSpinner.style.transition = 'none' } }, { passive: true }); feedView.addEventListener('touchmove', e => { if (!isPtr || isRefreshing) return; const d = e.touches[0].pageY - ptrStartY; if (d > 0 && !feedView.scrollTop) { if (e.cancelable) e.preventDefault(); ptrDist = d; const y = Math.min(d * .4, 80); Object.assign(ptrSpinner.style, { transform: `translateX(-50%) translateY(${y}px) rotate(${y * 3}deg)`, opacity: Math.min(y / 40, 1) }) } else { isPtr = false; ptrSpinner.style.opacity = '0'; ptrSpinner.style.transform = 'translateX(-50%) translateY(-20px)' } }, { passive: false }); feedView.addEventListener('touchend', async () => { if (!isPtr || isRefreshing) return; isPtr = false; ptrSpinner.style.transition = 'all .3s'; if (ptrDist > 100) { isRefreshing = true; Object.assign(ptrSpinner.style, { transform: 'translateX(-50%) translateY(50px)', opacity: '1' }); ptrSpinner.innerHTML = '<i data-lucide="loader-2" class="animate-spin w-5 h-5 text-blue-600"></i>'; refreshIcons(); await new Promise(r => setTimeout(r, 1000)); renderFeed(); showToast("Feed updated"); isRefreshing = false; ptrSpinner.style.transform = 'translateX(-50%) translateY(-20px)'; ptrSpinner.style.opacity = '0'; setTimeout(() => { ptrSpinner.innerHTML = '<i data-lucide="arrow-down" class="w-5 h-5 text-blue-600"></i>'; refreshIcons() }, 300) } else { ptrSpinner.style.transform = 'translateX(-50%) translateY(-20px)'; ptrSpinner.style.opacity = '0' } ptrDist = 0 }); feedView.addEventListener('scroll', () => { const c = feedView.scrollTop, h = document.getElementById('main-header'); h.style.transform = c > lastScrollTop && c > 60 ? 'translateY(-100%)' : 'translateY(0)'; lastScrollTop = Math.max(0, c) }, { passive: true }) }
        if (exploreView) exploreView.addEventListener('scroll', () => { const c = exploreView.scrollTop, h = document.getElementById('explore-header-container'); h.style.transform = c > lastExploreScrollTop && c > 60 ? 'translateY(-100%)' : 'translateY(0)'; lastExploreScrollTop = Math.max(0, c) }, { passive: true });
        const formatDate = t => { if (!t) return ''; const d = t.toDate ? t.toDate() : new Date(t); if (isNaN(d.getTime())) return ''; const now = new Date(), s = (now - d) / 1000; if (s < 60) return 'Now'; if (s < 3600) return Math.floor(s / 60) + 'm ago'; if (s < 86400) return Math.floor(s / 3600) + 'h ago'; if (s < 604800) return Math.floor(s / 86400) + 'd ago'; return d.toLocaleDateString() };
        const formatContent = t => {
            if (!t) return '';
            return t.replace(/[&<>]/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;' }[c]))
                .replace(/@(\w+)/g, (m, u) => {
                    const f = users.find(x => (x.username || '').toLowerCase() === u.toLowerCase());
                    return `<span class="text-blue-600 font-bold ${f ? 'cursor-pointer hover:underline" onclick="event.stopPropagation(); showProfile(\'' + f.id + '\')' : ''}">@${u}</span>`
                })
                .replace(/#(\w+)/g, '<span class="text-blue-600 font-bold cursor-pointer hover:underline" onclick="event.stopPropagation(); searchTag(\'$1\')">#$1</span>')
                .replace(/\n/g, '<br>')
                .replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" class="text-blue-600 hover:underline" onclick="event.stopPropagation(); event.preventDefault(); confirmAndOpenLink(\'$1\')">$1</a>');
        };

        window.fetchLinkPreview = async (url) => {
            try {
                const response = await fetch(`https://api.microlink.io?url=${encodeURIComponent(url)}`);
                const data = await response.json();
                if (data.status === 'success') {
                    return {
                        title: data.data.title,
                        description: data.data.description,
                        image: data.data.image?.url,
                        url: data.data.url,
                        domain: new URL(url).hostname.replace('www.', '')
                    };
                }
            } catch (e) {
                console.error('Link preview failed:', e);
            }
            return null;
        };

        window.renderLinkPreview = async (url, containerId) => {
            const container = document.getElementById(containerId);
            if (!container) return;
            const preview = await window.fetchLinkPreview(url);
            if (preview) {
                container.innerHTML = `<a href="${preview.url}" target="_blank" class="link-preview-card" onclick="event.stopPropagation(); event.preventDefault(); confirmAndOpenLink('${preview.url}')">${preview.image ? `<img src="${preview.image}" class="link-preview-image" alt="${preview.title || 'Preview'}">` : ''}<div class="link-preview-content">${preview.title ? `<div class="link-preview-title">${preview.title}</div>` : ''}${preview.description ? `<div class="link-preview-desc">${preview.description}</div>` : ''}<div class="link-preview-domain"><i data-lucide="globe" class="w-3 h-3"></i>${preview.domain}</div></div></a>`;
                refreshIcons();
            } else {
                container.remove();
            }
        };

        window.renderTextWithReadMore = (text, id, limit = 180) => { if (!text) return ''; const isExpanded = window.expandedTexts.has(id); if (text.length <= limit) return formatContent(text); const display = isExpanded ? formatContent(text) : formatContent(text.substring(0, limit)) + '...'; return `${display}<span class="read-more-btn" onclick="event.stopPropagation(); toggleTextExpansion('${id}')">${isExpanded ? 'less' : 'more'}</span>` };
        window.toggleTextExpansion = id => {
            const isExpanding = !window.expandedTexts.has(id);
            let elToScroll = null, container = null, startTop = 0;

            if (id.startsWith('post-')) {
                const pid = id.replace('post-', '');
                elToScroll = document.getElementById(`post-card-feed-${pid}`) || document.getElementById(`post-card-explore-${pid}`);
            } else if (id.startsWith('comment-')) {
                const cid = id.replace('comment-', '');
                elToScroll = document.getElementById(`comment-${cid}`);
            }

            if (elToScroll) {
                container = elToScroll.closest('.app-panel') || window;
                startTop = elToScroll.getBoundingClientRect().top;
            }

            if (window.expandedTexts.has(id)) window.expandedTexts.delete(id);
            else window.expandedTexts.add(id);

            if (id.startsWith('post-')) {
                const pid = id.replace('post-', ''), p = posts.find(x => x.id === pid);
                if (p) document.querySelectorAll(`.js-post-body-${pid}`).forEach(el => el.innerHTML = window.renderTextWithReadMore(p.content, id));
            } else if (id.startsWith('comment-')) {
                const cid = id.replace('comment-', '');
                let foundC = null;
                for (const p of posts) if (p.comments) { foundC = p.comments.find(c => c.id === cid); if (foundC) break }
                if (foundC) document.querySelectorAll(`.js-comment-body-${cid}`).forEach(el => el.innerHTML = window.renderTextWithReadMore(foundC.content, id));
            }

            if (!isExpanding && elToScroll) {
                elToScroll.scrollIntoView({ behavior: 'smooth', block: 'start' });
                // Tiny delay to ensure smooth scroll finishes or header doesn't hide it
                setTimeout(() => {
                    if (container === window) window.scrollBy(0, -70);
                    else container.scrollBy(0, -70);
                }, 50);
            }
        };
        window.searchTag = t => { closePostView(); switchView('explore'); document.getElementById('mobile-explore-search').value = document.getElementById('global-search').value = `#${t}`; handleSearch(`#${t}`) };
        window.manageHistory = m => window.history.pushState({ modal: m }, "");
        window.syncURLState = () => {
            const params = new URLSearchParams();
            if (window.currentViewName) params.set('view', window.currentViewName);
            if (window.currentViewingProfileId) params.set('uid', window.currentViewingProfileId);
            if (window.currentProfileTab && window.currentViewName === 'profile') params.set('tab', window.currentProfileTab);
            if (window.currentViewName === 'explore' && window.activeExploreTab) params.set('etab', window.activeExploreTab);
            const searchVal = document.getElementById('global-search')?.value || document.getElementById('mobile-explore-search')?.value;
            if (searchVal) params.set('q', searchVal);
            const newurl = window.location.protocol + "//" + window.location.host + window.location.pathname + '?' + params.toString();
            window.history.replaceState({ path: newurl }, '', newurl);
        };
        window.initializeStateFromURL = () => {
            const params = new URLSearchParams(window.location.search);
            const view = params.get('view');
            const uid = params.get('uid');
            const tab = params.get('tab');
            const etab = params.get('etab');
            const q = params.get('q');
            const postId = params.get('postId');

            if (postId) {
                setTimeout(() => openPostView(postId), 1000);
                return;
            }

            if (view) {
                if (view === 'profile' && uid) {
                    showProfile(uid, tab || 'posts');
                } else if (view === 'explore') {
                    switchView('explore');
                    if (etab) {
                        window.activeExploreTab = etab;
                        switchExploreMainTab(etab);
                    }
                    if (q) {
                        const gs = document.getElementById('global-search'), ms = document.getElementById('mobile-explore-search');
                        if (gs) gs.value = q;
                        if (ms) ms.value = q;
                        handleSearch(q);
                    }
                } else {
                    switchView(view);
                }
            }
        };
        const canSeePost = (p) => { if (!p || !currentUser) return false; if (p.authorId === currentUser.id) return true; const author = users.find(u => u.id === p.authorId); if (!author) return false; const isFollowing = currentUser.following.includes(p.authorId); const isAccountPrivate = author.settings?.privateNetwork; const isPostPrivate = p.settings?.privacy === 'private'; if (isAccountPrivate && !isFollowing) return false; if (isPostPrivate && !isFollowing) return false; return true };
        onAuthStateChanged(auth, async u => { const l = document.getElementById('app-loader'); if (!u) return window.location.href = '/login'; const r = doc(db, "users", u.uid), s = await getDoc(r), off = u.email === 'edulinkbht@gmail.com'; if (s.exists()) { const data = s.data(); if (data.banned) { document.getElementById('banned-overlay').classList.remove('hidden'); if (l) { l.style.opacity = '0'; setTimeout(() => l.remove(), 500) } return } currentUser = { id: u.uid, ...data }; if (off && !currentUser.isOfficial) await updateDoc(r, { isOfficial: true }) } else { const newUser = { name: u.displayName || 'User', email: u.email, username: 'user' + u.uid.substring(0, 6).toLowerCase(), avatar: u.photoURL || `https://ui-avatars.com/api/?name=${u.displayName || 'User'}&background=random`, banner: '', bio: 'Hello EduLink!', isOfficial: u.email === 'edulinkbht@gmail.com', following: [], followers: [], saved: [], timestamp: serverTimestamp() }; await setDoc(r, newUser); currentUser = { id: u.uid, ...newUser } } currentUser.following ||= []; currentUser.followers ||= []; currentUser.friends ||= []; currentUser.saved ||= []; currentUser.links ||= []; currentUser.settings ||= { privateNetwork: false }; window.currentUser = currentUser; savedPosts = currentUser.saved; if (!currentUser.username) document.getElementById('username-modal').classList.remove('hidden'); updateUserInterface(); initRealtimeListeners(); refreshIcons(); initBannerDrag(); window.history.replaceState({ root: true }, ""); if (l) { l.style.opacity = '0'; setTimeout(() => l.remove(), 500) } initializeStateFromURL(); });
        window.onpopstate = e => { const modals = [{ id: 'post-view-overlay', close: window.closePostView }, { id: 'thread-overlay', close: window.closeThread }, { id: 'edit-profile-overlay', close: window.closeEditProfile }, { id: 'likes-overlay', close: window.closeLikes }, { id: 'user-list-overlay', close: window.closeUserList }, { id: 'feed-filter-overlay', close: window.closeFeedFilter }, { id: 'compose-overlay', close: window.attemptCloseCompose }, { id: 'share-overlay', close: window.closeShareMenu }, { id: 'post-options-overlay', close: window.hidePostMenu }, { id: 'settings-overlay', close: window.closeSettings }, { id: 'notif-options-overlay', close: window.closeNotifOptions }, { id: 'qr-overlay', close: window.closeQR }, { id: 'privacy-overlay', close: window.closePrivacySettings }, { id: 'profile-filter-overlay', close: window.closeProfileFilter }, { id: 'download-select-overlay', close: window.closeDownloadSelect }, { id: 'comment-options-overlay', close: window.closeCommentOptions }, { id: 'create-menu-overlay', close: window.closeCreateMenu }, { id: 'announcement-overlay', close: window.closeAnnouncement }, { id: 'profile-preview-overlay', close: window.closeProfilePreview }, { id: 'comment-filter-overlay', close: window.closeCommentFilter }, { id: 'claim-link-overlay', close: window.closeClaimOverlay }, { id: 'view-profile', close: () => window.switchView('feed') }]; let closedAny = false; if (e.state && e.state.modal) { } else { for (let m of modals) { const el = document.getElementById(m.id); if (el && !el.classList.contains('hidden') && !el.classList.contains('opacity-0')) { if (m.id === 'view-profile') { if (window.currentViewingProfileId) { window.switchView('feed'); window.currentViewingProfileId = null; closedAny = true } } else if (m.id === 'compose-overlay') { window.closeCompose(); closedAny = true } else if (m.id === 'create-menu-overlay') { window.closeCreateMenu(); closedAny = true } else { m.close(); closedAny = true } if (closedAny) break } } } if (!closedAny) { if (exitAttempt) { } else { window.history.pushState({ root: true }, ""); exitAttempt = true; showToast("Press back again to exit"); setTimeout(() => { exitAttempt = false }, 2000) } } };
        window.checkUsername = e => { const v = e.value.trim().toLowerCase(), l = v.length; document.getElementById('username-counter').innerText = `${l}/20`; if (l < 3) { document.getElementById('username-error').classList.add('hidden'); return } const t = users.some(u => u.username === v && u.id !== currentUser.id); const err = document.getElementById('username-error'); if (t) { err.innerText = "Username taken"; err.classList.remove('hidden') } else err.classList.add('hidden') };
        window.saveUsername = async () => { const v = document.getElementById('new-username-input').value.trim().toLowerCase(); if (v.length < 3 || v.length > 20 || /\s/.test(v) || !/^[a-z0-9_.]+$/.test(v)) return showToast("Invalid username", true); if (!(await getDocs(query(collection(db, "users"), where("username", "==", v)))).empty) return showToast("Taken", true); await updateDoc(doc(db, "users", currentUser.id), { username: v }); currentUser.username = v; document.getElementById('username-modal').classList.add('hidden'); showToast("Username set!") };
        function initRealtimeListeners() { onSnapshot(collection(db, "users"), s => { users = s.docs.map(d => ({ id: d.id, ...d.data() })); const me = users.find(u => u.id === currentUser.id); if (me && me.banned) { document.getElementById('banned-overlay').classList.remove('hidden') } if (window.pendingProfileUid && users.some(u => u.id === window.pendingProfileUid)) { showProfile(window.pendingProfileUid); window.pendingProfileUid = null; window.history.replaceState({}, document.title, window.location.pathname) } if (!document.getElementById('view-network').classList.contains('hidden')) renderNetwork(); if (!document.getElementById('privacy-overlay').classList.contains('hidden')) { const u = users.find(x => x.id === currentUser.id); if (u && u.settings) { const pt = document.getElementById('toggle-privacy-main'), ht = document.getElementById('toggle-hide-connections'); if (u.settings.privateNetwork) pt.classList.add('active'); else pt.classList.remove('active'); if (u.settings.hideConnections) ht.classList.add('active'); else ht.classList.remove('active') } } if (window.currentViewingProfileId && !document.getElementById('view-profile').classList.contains('hidden')) renderProfileContent(window.currentViewingProfileId, window.currentProfileTab); renderRightSidebar(); refreshIcons() }); onSnapshot(doc(db, "global", "promo"), s => { const sec = document.getElementById('promo-section'); if (s.exists() && s.data().imageUrl) { sec.classList.remove('hidden'); document.getElementById('promo-image').src = s.data().imageUrl; document.getElementById('promo-link').href = s.data().linkUrl || '#' } else if (currentUser?.email !== 'edulinkbht@gmail.com') sec.classList.add('hidden') }); onSnapshot(query(collection(db, "posts"), orderBy("timestamp", "desc")), { includeMetadataChanges: true }, s => { posts = s.docs.map(d => ({ id: d.id, ...d.data(), timestamp: d.data().timestamp })); const ch = s.docChanges(); ch.filter(c => c.type === 'removed').forEach(c => { document.querySelectorAll(`[id*='post-card-'][id$='-${c.doc.id}']`).forEach(el => el.remove()) }); if (ch.some(c => c.type === 'added')) { if (!document.getElementById('view-feed').classList.contains('hidden')) renderFeed(); if (!document.getElementById('view-explore').classList.contains('hidden')) handleSearch(document.getElementById('global-search').value || document.getElementById('mobile-explore-search').value) } posts.forEach(p => { const isLiked = p.likes && p.likes.includes(currentUser.id); document.querySelectorAll(`.js-like-btn-${p.id}`).forEach(b => b.classList.toggle('active', isLiked)); document.querySelectorAll(`.js-like-count-${p.id}`).forEach(el => el.innerText = (p.likes?.length > 0) ? p.likes.length : 'Like'); document.querySelectorAll(`.js-comment-count-${p.id}`).forEach(el => el.innerText = (p.comments?.length > 0) ? p.comments.length : 'Comment'); const isSaved = savedPosts.includes(p.id); document.querySelectorAll(`.js-save-btn-${p.id}`).forEach(b => b.classList.toggle('active', isSaved)); document.querySelectorAll(`.js-post-body-${p.id}`).forEach(el => el.innerHTML = window.renderTextWithReadMore(p.content, `post-${p.id}`)) }); if (!document.getElementById('view-saved').classList.contains('hidden')) renderSaved(); if (!document.getElementById('view-network').classList.contains('hidden') && activeNetworkTab === 'posts') renderNetwork(); if (!document.getElementById('view-profile').classList.contains('hidden') && window.currentViewingProfileId) renderProfileContent(window.currentViewingProfileId, window.currentProfileTab); if (window.currentViewingPostId) { const cp = posts.find(p => p.id === window.currentViewingPostId); if (cp) { if (window.isDesktopThreadMode) renderDesktopThread(window.threadPostId, window.threadParentCommentId); else renderCommentsInModal(window.currentViewingPostId); updatePostViewStats(window.currentViewingPostId) } else closePostView() } if (window.threadPostId && !window.isDesktopThreadMode) renderThreadContent(window.threadPostId, window.threadParentCommentId); renderRightSidebar(); setTimeout(refreshIcons, 5) }); onSnapshot(query(collection(db, "notifications"), where("receiverId", "==", currentUser.id)), s => { notifications = s.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => (b.timestamp?.toDate?.() || 0) - (a.timestamp?.toDate?.() || 0)); const u = notifications.filter(n => !n.read).length, t = u > 99 ? '99+' : u, d = document.getElementById('nav-notif-badge'), m = document.getElementById('mobile-footer-badge'); if (d) { d.style.display = u ? 'flex' : 'none'; d.innerText = t } if (m) { m.style.display = u ? 'flex' : 'none'; m.innerText = t } if (!document.getElementById('view-notifications').classList.contains('hidden')) renderNotifications(); refreshIcons() }) }
        window.renderRightSidebar = () => { const l = document.getElementById('who-to-follow-list'), now = Date.now(); if (!l || !currentUser) return; if (!window.currentSuggestionIds?.length || now - (window.lastSuggestionRefresh || 0) > 180000) { window.currentSuggestionIds = users.filter(u => u.id !== currentUser.id && u.name).sort(() => .5 - Math.random()).slice(0, 3).map(u => u.id); window.lastSuggestionRefresh = now } const c = window.currentSuggestionIds.map(id => users.find(u => u.id === id)).filter(Boolean); l.innerHTML = c.length ? c.map(u => { const isF = currentUser.following.includes(u.id); return `<div class="flex items-center justify-between" onclick="showProfile('${u.id}')"><div class="flex items-center gap-3 overflow-hidden"><div class="img-placeholder rounded-full w-10 h-10 shrink-0"><img src="${u.avatar}" class="w-10 h-10 rounded-full object-cover"></div><div class="min-w-0"><div class="font-bold text-sm text-gray-900 truncate hover:underline cursor-pointer flex items-center gap-1">${u.name}${u.banned ? '<i data-lucide="ban" class="w-3 h-3 text-red-500"></i>' : ''}</div><div class="text-xs text-gray-500 truncate">@${u.username || 'user'}</div></div></div><button onclick="event.stopPropagation(); toggleFollow('${u.id}')" class="${isF ? 'bg-gray-100 text-gray-900 border border-gray-200' : 'bg-black text-white'} text-xs px-3 py-1.5 rounded-full font-bold hover:opacity-80 transition-colors">${isF ? 'Following' : 'Follow'}</button></div>` }).join('') : '<div class="text-sm text-gray-400 p-2">No suggestions.</div>' };
        window.openPromoModal = e => { if (e) { e.stopPropagation(); e.preventDefault() } document.getElementById('promo-modal').classList.remove('hidden'); const i = document.getElementById('promo-image'), l = document.getElementById('promo-link'); if (i.src) document.getElementById('promo-img-url').value = i.src; if (l.href) document.getElementById('promo-target-url').value = l.href };
        window.handlePromoFile = e => { const f = e.target.files[0]; if (f) { window.currentPromoBlob = f; showToast("Image selected") } };
        window.savePromo = async () => { const b = event.target, ot = b.innerText; b.innerText = "Saving..."; b.disabled = true; let i = document.getElementById('promo-img-url').value.trim(); const l = document.getElementById('promo-target-url').value.trim(); if (window.currentPromoBlob) try { i = await uploadToImgHippo(window.currentPromoBlob) } catch (e) { return showToast("Upload failed") } if (!i) { showToast("Image URL required"); b.innerText = ot; b.disabled = false; return } await setDoc(doc(db, "global", "promo"), { imageUrl: i, linkUrl: l }); showToast("Promo updated!"); document.getElementById('promo-modal').classList.add('hidden'); window.currentPromoBlob = null; b.innerText = ot; b.disabled = false };
        window.updatePostViewStats = pid => { const p = posts.find(x => x.id === pid); if (!p) return; const dl = document.getElementById('post-view-likes-count'); if (dl) dl.innerText = `${p.likes ? p.likes.length : 0} likes`; const mlc = document.getElementById(`mobile-overlay-like-count-${pid}`); if (mlc) mlc.innerText = `${p.likes ? p.likes.length : 0} likes` };
        function updateUserInterface() { if (!currentUser) return; const u = currentUser; document.getElementById('sidebar-name').innerText = u.name; document.getElementById('sidebar-avatar').src = u.avatar; document.getElementById('mobile-avatar').src = u.avatar; document.getElementById('header-avatar').src = u.avatar; document.getElementById('compose-name').innerText = u.name; document.getElementById('compose-avatar').src = u.avatar; document.getElementById('edit-name').value = u.name; document.getElementById('edit-username').value = u.username || ""; document.getElementById('edit-bio').value = u.bio; document.getElementById('edit-avatar-preview').src = u.avatar; document.getElementById('edit-banner-preview').src = u.banner || 'https://images.unsplash.com/photo-1579546929518-9e396f3cc809?ixlib=rb-1.2.1&auto=format&fit=crop&w=1000&q=80'; document.getElementById('edit-banner-preview').style.objectPosition = `center ${currentBannerPos}%`; document.getElementById('banner-pos-hint').innerText = `${currentBannerPos}%`; const tp = document.getElementById('toggle-privacy'); if (tp) u.settings?.privateNetwork ? tp.classList.add('active') : tp.classList.remove('active'); if (u.email === 'edulinkbht@gmail.com') { document.getElementById('edit-promo-btn').classList.remove('hidden'); document.getElementById('promo-section').classList.remove('hidden'); document.getElementById('create-option-ad').classList.remove('hidden') } else document.getElementById('create-option-ad').classList.add('hidden'); refreshIcons() }
        let alertCallback = null; window.showAlert = (m, cb) => { document.getElementById('alert-msg').innerText = m; const a = document.getElementById('custom-alert'); a.classList.remove('hidden'); setTimeout(() => { a.classList.remove('opacity-0'); document.getElementById('custom-alert-box').classList.remove('scale-95') }, 10); alertCallback = cb; const b = document.getElementById('alert-confirm-btn'), nb = b.cloneNode(!0); b.parentNode.replaceChild(nb, b); nb.onclick = () => { if (alertCallback) alertCallback(); closeAlert(!0) } };
        window.closeAlert = () => { const a = document.getElementById('custom-alert'); a.classList.add('opacity-0'); document.getElementById('custom-alert-box').classList.add('scale-95'); setTimeout(() => a.classList.add('hidden'), 200) };
        window.confirmAndOpenLink = url => showAlert("Are you sure you would like to proceed? We don't take responsibility for your actions after you leave this site.", () => window.open(url, '_blank'));
        let isDraggingBanner = false, startY = 0, initialBannerPos = 50, currentBannerPos = 50;
        function initBannerDrag() { const c = document.getElementById('banner-edit-area'); c.addEventListener('mousedown', sd); c.addEventListener('touchstart', sd, { passive: false }); window.addEventListener('mousemove', dg); window.addEventListener('touchmove', dg, { passive: false }); window.addEventListener('mouseup', ed); window.addEventListener('touchend', ed) }
        function sd(e) { if (e.target.closest('#banner-edit-area')) { isDraggingBanner = !0; startY = e.type.includes('mouse') ? e.clientY : e.touches[0].clientY; initialBannerPos = currentBannerPos } }
        function dg(e) { if (!isDraggingBanner) return; if (e.cancelable) e.preventDefault(); const y = e.type.includes('mouse') ? e.clientY : e.touches[0].clientY, d = startY - y, p = initialBannerPos + (d / 2); currentBannerPos = Math.round(Math.max(0, Math.min(100, p))); document.getElementById('edit-banner-preview').style.objectPosition = `center ${currentBannerPos}%`; document.getElementById('banner-pos-hint').innerText = `${currentBannerPos}%` }
        function ed() { isDraggingBanner = !1 }
        window.openSettings = () => { manageHistory('settings-overlay'); const c = document.getElementById('settings-content'); let admBtn = ''; if (currentUser.email === 'edulinkbht@gmail.com') admBtn = `<button onclick="openAnnouncement()" class="post-option-item group w-full"><div class="icon-circle"><i data-lucide="megaphone" class="w-5 h-5"></i></div><div class="flex-1"><div class="font-bold text-gray-900 text-[15px]">Broadcast Announcement</div><div class="text-xs text-gray-500">Send to all users</div></div></button>`; c.innerHTML = `<button onclick="openPrivacySettings()" class="post-option-item group w-full"><div class="icon-circle"><i data-lucide="lock" class="w-5 h-5"></i></div><div class="flex-1"><div class="font-bold text-gray-900 text-[15px]">Account Privacy</div><div class="text-xs text-gray-500">Manage visibility and data</div></div></button>${admBtn}<button onclick="window.location.href='/blog'" class="post-option-item group w-full"><div class="icon-circle"><i data-lucide="info" class="w-5 h-5"></i></div><div class="flex-1"><div class="font-bold text-gray-900 text-[15px]">About Us</div><div class="text-xs text-gray-500">Learn more about EduLink</div></div></button><button onclick="window.location.href='/termsandservices'" class="post-option-item group w-full"><div class="icon-circle"><i data-lucide="file-text" class="w-5 h-5"></i></div><div class="flex-1"><div class="font-bold text-gray-900 text-[15px]">Terms of Use</div><div class="text-xs text-gray-500">Policies and agreements</div></div></button><div class="h-px bg-gray-100 my-1"></div><button onclick="doLogout()" class="post-option-item group w-full"><div class="icon-circle bg-red-50 text-red-600"><i data-lucide="log-out" class="w-5 h-5"></i></div><div class="font-bold text-black text-[15px]">Log Out</div></button>`; toggleModalAnim('settings-overlay', 'settings-modal', !0); refreshIcons() }; window.closeSettings = () => toggleModalAnim('settings-overlay', 'settings-modal', !1);
        window.openPrivacySettings = () => { manageHistory('privacy-overlay'); closeSettings(); document.getElementById('privacy-overlay').classList.remove('hidden'); toggleModalAnim('privacy-overlay', 'privacy-modal', !0); document.getElementById('privacy-user-avatar').src = currentUser.avatar; document.getElementById('privacy-user-name').innerText = currentUser.name; const s = currentUser.settings || {}, pt = document.getElementById('toggle-privacy-main'), ht = document.getElementById('toggle-hide-connections'); if (s.privateNetwork) pt.classList.add('active'); else pt.classList.remove('active'); if (s.hideConnections) ht.classList.add('active'); else ht.classList.remove('active') }; window.closePrivacySettings = () => toggleModalAnim('privacy-overlay', 'privacy-modal', !1);
        window.updatePrivacySetting = async k => { const el = k === 'privateNetwork' ? document.getElementById('toggle-privacy-main') : document.getElementById('toggle-hide-connections'), ia = el.classList.contains('active'), nv = !ia; el.classList.toggle('active'); const s = currentUser.settings || {}, k2 = k; s[k2] = nv; await updateDoc(doc(db, "users", currentUser.id), { settings: s }); currentUser.settings = s; if (k === 'privateNetwork') showToast(`Account is now ${nv ? 'Private' : 'Public'}`); else showToast("Settings saved") };
        window.openProfileFilter = () => { manageHistory('profile-filter-overlay'); toggleModalAnim('profile-filter-overlay', 'profile-filter-modal', !0);['latest', 'oldest', 'popular'].forEach(s => { const el = document.getElementById(`sort-check-${s}`); if (window.profileSort === s) el.classList.remove('hidden'); else el.classList.add('hidden') }) }; window.closeProfileFilter = () => toggleModalAnim('profile-filter-overlay', 'profile-filter-modal', !1);
        window.setProfileSort = s => { window.profileSort = s; renderProfileContent(window.currentViewingProfileId, window.currentProfileTab); closeProfileFilter() };
        window.togglePrivacy = async () => { const t = document.getElementById('toggle-privacy'), p = !t.classList.contains('active'); t.classList.toggle('active'); const s = currentUser.settings || {}; s.privateNetwork = p; await updateDoc(doc(db, "users", currentUser.id), { settings: s }); currentUser.settings = s; showToast(`Account is ${p ? 'Private' : 'Public'}`) };
        window.switchView = async (v, direction = 'none') => { ['feed', 'events', 'saved', 'network', 'profile', 'explore', 'notifications'].forEach(n => { const e = document.getElementById(`view-${n}`); if (e) e.classList.add('hidden', 'slide-in-right', 'slide-in-left') }); const tp = document.getElementById('trending-panel'), mh = document.getElementById('main-header'), mbn = document.getElementById('mobile-bottom-nav'), mnh = document.getElementById('mobile-notifications-header'); window.currentViewName = v; if (mh) { mh.classList.remove('hidden'); mh.style.transform = 'translateY(0)' } if (mbn) mbn.classList.remove('hidden'); if (mnh) mnh.classList.add('hidden', 'flex'); if (v === 'profile' && mh) mh.classList.add('hidden'); if (window.innerWidth < 768) { if (v === 'notifications') { if (mh) mh.classList.add('hidden'); if (mnh) mnh.classList.remove('hidden'), mnh.classList.add('flex') } else if (v === 'explore' && mh) mh.classList.add('hidden') } if (window.innerWidth >= 1280) tp.classList.remove('hidden'), tp.classList.add('xl:flex'); if (v !== 'ai') { const el = document.getElementById(`view-${v}`); if (el) { el.classList.remove('hidden'); if (direction === 'left') el.classList.add('slide-in-left'); if (direction === 'right') el.classList.add('slide-in-right') } } document.querySelectorAll('.nav-item,.mobile-nav-item').forEach(e => e.classList.remove('active')); const nav = document.getElementById(`nav-${v}`), mnav = document.querySelectorAll('.mobile-nav-item'); if (nav) nav.classList.add('active'); if (v === 'feed') { mnav[0]?.classList.add('active'); if (document.getElementById('feed-container').children.length === 0) renderFeed() } else if (v === 'explore') { mnav[1]?.classList.add('active'); switchExploreMainTab('explore') } else if (v === 'network') { if (nav) nav.classList.add('active'); if (document.getElementById('network-content').children.length === 0) renderNetwork() } else if (v === 'notifications') { if (nav) nav.classList.add('active'); mnav[3]?.classList.add('active'); renderNotifications(); const un = notifications.filter(n => !n.read); if (un.length > 0) { const b = writeBatch(db); un.forEach(n => b.update(doc(db, "notifications", n.id), { read: !0 })); await b.commit() } } else if (v === 'saved') { if (nav) nav.classList.add('active'); if (document.getElementById('saved-container').children.length === 0) renderSaved() } else if (v === 'profile') { mnav[4]?.classList.add('active') } syncURLState(); setTimeout(() => refreshIcons(), 10) };
        window.switchNetworkTab = t => { activeNetworkTab = t; document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); document.getElementById(`net-tab-${t}`)?.classList.add('active'); renderNetwork(); syncURLState() };
        window.renderNetwork = () => { const c = document.getElementById('network-content'), isP = activeNetworkTab === 'people'; c.innerHTML = ""; if (isP) { const f = users.filter(u => currentUser.following.includes(u.id)); if (!f.length) c.innerHTML = '<div class="flex flex-col items-center justify-center py-10 opacity-60"><p>You aren\'t following anyone yet.</p></div>'; else { const g = document.createElement('div'); g.className = "grid grid-cols-1 md:grid-cols-2 gap-4 px-4 md:px-0"; f.forEach(u => { const d = document.createElement('div'); d.className = "bg-white p-4 rounded-xl border border-gray-100 flex items-center gap-4 hover:shadow-md transition-all cursor-pointer"; d.onclick = () => showProfile(u.id); d.innerHTML = `<div class="w-12 h-12 rounded-full border border-gray-100 shrink-0"><img src="${u.avatar}" class="w-full h-full rounded-full object-cover" onclick="event.stopPropagation();openProfilePreview('${u.id}')"></div><div><h4 class="font-bold text-gray-900 flex items-center gap-1">${u.name} ${u.isOfficial ? '<i data-lucide="badge-check" class="w-4 h-4 official-badge ml-1"></i>' : ''}${u.banned ? '<i data-lucide="ban" class="w-3 h-3 text-red-500"></i>' : ''}</h4><p class="text-xs text-gray-500 line-clamp-1">${u.bio}</p></div><button onclick="event.stopPropagation(); toggleFollow('${u.id}')" class="ml-auto text-xs border border-gray-200 px-3 py-1 rounded-full hover:bg-gray-50">Unfollow</button>`; g.appendChild(d) }); c.appendChild(g) } } else { const fp = posts.filter(p => currentUser.following.includes(p.authorId) && canSeePost(p)); if (!fp.length) c.innerHTML = '<div class="text-center py-10 text-gray-400">No posts.</div>'; else { const pc = document.createElement('div'); pc.className = "space-y-4 px-4 md:px-0"; fp.forEach(p => pc.appendChild(createPostElement(p, 'network'))); c.appendChild(pc) } } refreshIcons() };
        window.renderFeed = t => {
            const c = document.getElementById('feed-container');
            c.innerHTML = "";
            let filtered = posts.filter(p => {
                if (!canSeePost(p)) return false;
                const a = users.find(u => u.id === p.authorId);
                const fol = currentUser.following.includes(p.authorId);
                let pf = true;
                if (window.activeFeedFilter === 'following') pf = fol;
                else if (window.activeFeedFilter === 'friends') {
                    const isF = fol && (a?.following && a.following.includes(currentUser.id));
                    pf = isF;
                }
                const ms = (!t || p.content.toLowerCase().includes(t.toLowerCase()));
                return pf && ms;
            });

            if (window.activeFeedFilter === 'all') {
                // Aggressive randomization for true "refresh" feel
                filtered = filtered.sort(() => Math.random() - 0.5);
                filtered.sort((a, b) => getPostScore(b, Math.random()) - getPostScore(a, Math.random()));
            }

            if (filtered.length === 0) {
                let msg = "No posts found", sub = "Try adjusting filters", icon = "inbox";
                if (window.activeFeedFilter === 'following') { msg = "Follow someone"; sub = "You aren't following anyone yet."; icon = "user-plus" }
                else if (window.activeFeedFilter === 'all') { msg = "Welcome to EduLink"; sub = "Be the first to share!"; icon = "pen-tool" }
                c.innerHTML = `<div class="flex flex-col items-center justify-center py-12 text-center"><div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-4 text-gray-400"><i data-lucide="${icon}" class="w-8 h-8"></i></div><h3 class="text-gray-900 font-bold text-lg">${msg}</h3><p class="text-gray-500 text-sm mt-1 max-w-xs">${sub}</p></div>`;
            } else {
                filtered.forEach((p, index) => {
                    c.appendChild(createPostElement(p, 'feed'));

                    // Mark as seen in session
                    window.sessionSeenPosts.add(p.id);

                    // Injection logic: Post-like Spotlight
                    // Wait until 7th post, then show every 12 posts
                    // Injection logic: Dual Spotlight System (Vertical & Horizontal)
                    // Show less often: Start at 7th, then every 20 posts
                    const spotIndex = index + 1;
                    if (spotIndex === 5 || (spotIndex > 5 && (spotIndex - 5) % 10 === 0)) {
                        const spot = document.createElement('article');
                        spot.className = "post-card bg-white overflow-hidden mb-4";

                        // Determine type: Odd occurrences = Horizontal (People You May Know), Even = Vertical (Influencer Spotlight)
                        const occurrence = (spotIndex === 5) ? 1 : ((spotIndex - 5) / 10) + 1;
                        const useHorizontal = occurrence % 2 !== 0;

                        if (useHorizontal) {
                            // NEW HORIZONTAL LIST (People You May Know)
                            const suggestions = users.filter(u => u.id !== currentUser.id && !currentUser.following.includes(u.id)).sort(() => .5 - Math.random()).slice(0, 10);
                            if (suggestions.length > 2) {
                                spot.innerHTML = `
                                    <div class="px-4 py-3 border-b border-gray-100 flex items-center justify-between">
                                        <div>
                                            <div class="text-[15px] font-bold text-gray-900">Community Spotlight</div>
                                            <div class="text-xs text-gray-500">People you may know</div>
                                        </div>
                                        <button onclick="switchView('explore')" class="text-xs font-bold text-blue-600 hover:text-blue-700">See all</button>
                                    </div>
                                    <div class="flex overflow-x-auto gap-3 p-4 no-scrollbar pb-6" style="scroll-padding-left: 16px;">
                                        ${suggestions.map(u => {
                                    const isFollowing = currentUser.following.includes(u.id);
                                    return `
                                            <div class="flex-shrink-0 w-[140px] border border-gray-200 rounded-xl p-3 flex flex-col items-center bg-white cursor-pointer hover:border-gray-300 transition-colors" onclick="showProfile('${u.id}')">
                                                <div class="w-16 h-16 rounded-full mb-3 relative">
                                                    <img src="${u.avatar}" class="w-full h-full rounded-full object-cover border border-gray-100">
                                                </div>
                                                <div class="text-sm font-bold text-gray-900 text-center truncate w-full mb-0.5">${u.name}</div>
                                                <div class="text-xs text-gray-500 text-center truncate w-full mb-3">@${u.username || 'user'}</div>
                                                <button id="ul-btn-${u.id}" onclick="event.stopPropagation(); toggleFollow('${u.id}')" class="w-full bg-[#0b57d0] text-white hover:bg-blue-700 text-xs font-bold py-1.5 rounded-lg transition-colors">${isFollowing ? 'Following' : 'Follow'}</button>
                                            </div>
                                        `}).join('')}
                                    </div>
                                `;
                                c.appendChild(spot);
                            }
                        } else {
                            // OLD VERTICAL LIST (Influencer/Specific Spotlight)
                            const qualityUsers = users.filter(u => {
                                const name = u.name?.toLowerCase() || "";
                                const hasFullPfp = u.avatar && (u.avatar.startsWith('data:') || u.avatar.length > 100);
                                const isSpecific = name.includes('ngawang') || name.includes('tshogyal') || name.includes('soname') || name.includes('yangtshel') || name.includes('jigdral');
                                return hasFullPfp || isSpecific;
                            });
                            const displayUsers = qualityUsers.slice(0, 5);

                            spot.innerHTML = `
                                <div class="p-4 flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center text-white shrink-0">
                                        <i data-lucide="sparkles" class="w-5 h-5"></i>
                                    </div>
                                    <div class="flex-1">
                                        <div class="text-[15px] font-bold text-gray-900 line-height-1">Community Spotlight</div>
                                        <div class="text-[13px] text-gray-500 line-height-1 mt-0.5">Suggestions based on your interests</div>
                                    </div>
                                </div>
                                <div class="px-4 pb-4">
                                    <p class="text-[15px] text-gray-800 leading-relaxed mb-4">Discover influential educators and top-performing creators on EduLink. Connect with people who share your passion for learning.</p>
                                    <div class="flex -space-x-3 overflow-hidden mb-1">
                                        ${displayUsers.map(u => `<img class="inline-block h-9 w-9 rounded-full ring-2 ring-white object-cover" src="${u.avatar}" alt="${u.name}">`).join('')}
                                        ${qualityUsers.length > 5 ? `<div class="flex items-center justify-center h-9 w-9 rounded-full ring-2 ring-white bg-gray-100 text-[11px] font-bold text-gray-500">+${qualityUsers.length - 5}</div>` : ''}
                                    </div>
                                </div>
                                <div class="px-4 py-3 bg-white border-t border-gray-100 flex items-center justify-between group cursor-pointer hover:bg-gray-50 transition-colors" onclick="switchExploreMainTab('people')">
                                    <span class="text-[13px] font-bold text-gray-500">See more creators like this</span>
                                    <i data-lucide="chevron-right" class="w-4 h-4 text-gray-400 group-hover:translate-x-1 transition-transform"></i>
                                </div>
                            `;
                            c.appendChild(spot);
                        }
                    }
                });
            }
            refreshIcons();
        };
        window.openFeedFilter = () => { manageHistory('feed-filter-overlay'); toggleModalAnim('feed-filter-overlay', 'feed-filter-modal', !0) }; window.closeFeedFilter = () => toggleModalAnim('feed-filter-overlay', 'feed-filter-modal', !1); window.switchFeedFilter = f => { window.activeFeedFilter = f; closeFeedFilter(); renderFeed(); const m = { all: 'All Posts', following: 'Following', friends: 'Friends Only' }; showToast(`Filter: ${m[f]}`) };
        let touchStartX = 0, touchEndX = 0; window.handleTouchStart = e => touchStartX = e.changedTouches[0].screenX; window.handleTouchEnd = (e, pid, ov) => { touchEndX = e.changedTouches[0].screenX; const w = e.currentTarget.closest('.post-carousel'); if (w && Math.abs(touchStartX - touchEndX) > 50) moveCarousel(w.id, touchStartX > touchEndX ? 1 : -1) };
        function createPostElement(p, ctx = 'feed') {
            const a = users.find(u => u.id === p.authorId) || { name: 'Unknown', avatar: '', isOfficial: false, id: p.authorId }, st = p.settings || { privacy: 'public', showLikes: true, showComments: true }, d = document.createElement('article'); d.id = `post-card-${ctx}-${p.id}`; d.className = "post-card group overflow-hidden"; d.onclick = () => { openPostView(p.id); trackInteraction(p.id, 'view', 1) }; let mh = "", lh = ""; if (p.media) { const ma = Array.isArray(p.media) ? p.media : [p.media]; if (ma.length === 1) { const s = ma[0], iv = s.includes('video') || s.includes('.mp4'); mh = `<div class="mt-3 rounded-xl overflow-hidden aspect-[4/5] ${iv ? 'bg-black flex items-center justify-center' : 'bg-gray-200 cursor-pointer'}" onclick="event.stopPropagation();${iv ? '' : `openLightbox('${s}','image')`}">${iv ? `<video src="${s}" class="w-full h-full object-cover" controls onclick="event.stopPropagation()"></video>` : `<img src="${s}" class="w-full h-full object-cover">`}</div>` } else { const cid = `carousel-${ctx}-${p.id}`, iid = `inner-${ctx}-${p.id}`, cntId = `counter-${ctx}-${p.id}`; let sl = '', dt = ''; ma.forEach((s, i) => { sl += `<div class="post-carousel-item bg-gray-200">${(s.includes('video') || s.includes('.mp4')) ? `<video src="${s}" controls></video>` : `<img src="${s}" class="w-full h-full object-cover">`}</div>`; dt += `<div class="carousel-dot ${i === 0 ? 'active' : ''}" id="dot-${ctx}-${p.id}-${i}"></div>` }); mh = `<div class="carousel-wrapper"><div class="mt-3 rounded-xl overflow-hidden post-carousel touch-pan-y" id="${cid}" ontouchstart="handleTouchStart(event)" ontouchend="handleTouchEnd(event,'${p.id}',false)"><div class="post-carousel-inner" id="${iid}">${sl}</div><button class="carousel-nav-btn prev hidden md:flex" onclick="event.stopPropagation();moveCarousel('${cid}',-1)"><i data-lucide="chevron-left" class="w-4 h-4"></i></button><button class="carousel-nav-btn next hidden md:flex" onclick="event.stopPropagation();moveCarousel('${cid}',1)"><i data-lucide="chevron-right" class="w-4 h-4"></i></button></div><div class="carousel-dots-outside">${dt}</div></div>`; (window.carouselStates = window.carouselStates || {})[cid] = { index: 0, total: ma.length } } } if (p.likes?.length && currentUser.following) {
                const f = p.likes.filter(id => currentUser.following.includes(id) && id !== currentUser.id);
                if (f.length > 0) {
                    const fri = f.map(id => users.find(u => u.id === id)).filter(Boolean).slice(0, 3);
                    let avatars = '';
                    fri.forEach((u, i) => { avatars += `<img src="${u.avatar}" class="w-6 h-6 rounded-full border-2 border-white ${i > 0 ? '-ml-3' : ''} z-${30 - i * 10} object-cover">` });
                    let txt = '';
                    if (f.length === 1) txt = `Liked by <span class="font-bold text-gray-900">${fri[0].name}</span>`;
                    else if (f.length === 2) txt = `Liked by <span class="font-bold text-gray-900">${fri[0].name}</span> and others`;
                    else txt = `Liked by <span class="font-bold text-gray-900">${fri[0].name}</span> and ${f.length - 1} others`;
                    lh = `<div class="px-4 py-3 bg-white border-t border-gray-100 flex items-center gap-3 cursor-pointer hover:bg-gray-50 transition-colors group" onclick="openLikes('${p.id}')">
                            <div class="flex items-center -space-x-2 pl-1">
                                ${fri.map(u => `<img src="${u.avatar}" class="w-6 h-6 rounded-full border border-white object-cover">`).join('')}
                            </div>
                            <div class="text-sm font-medium text-gray-700">Your friends interacted with this</div>
                            <div class="flex-1"></div>
                            <i data-lucide="chevron-right" class="w-4 h-4 text-gray-400 group-hover:translate-x-0.5 transition-transform"></i>
                          </div>`;
                }
            } const isLiked = p.likes?.includes(currentUser.id), isSaved = savedPosts.includes(p.id); const likeText = (p.likes?.length > 0) ? p.likes.length : (st.showLikes ? 'Like' : ''); const commentText = (p.comments?.length > 0) ? p.comments.length : (st.showComments ? 'Comment' : '');
            let rightActionBtn = '';
            if (p.claimLink) {
                rightActionBtn = `<button class="action-btn text-[#0b57d0] border-blue-100 bg-blue-50 hover:bg-blue-100" onclick="event.stopPropagation(); confirmAndOpenLink('${p.claimLink}')"><i data-lucide="shopping-bag" class="w-4 h-4"></i> Claim</button>`;
            } else {
                rightActionBtn = `<button class="action-btn bookmark js-save-btn-${p.id} ${isSaved ? 'active' : ''}" onclick="event.stopPropagation(); toggleSave('${p.id}')"><i data-lucide="bookmark"></i></button>`;
            }
            const urlMatch = p.content.match(/(https?:\/\/[^\s]+)/), previewId = `preview-${ctx}-${p.id}`, previewHtml = urlMatch ? `<div id="${previewId}"></div>` : '';
            if (urlMatch) setTimeout(() => window.renderLinkPreview(urlMatch[0], previewId), 100);
            d.innerHTML = `<div class="p-4 md:p-5"><div class="post-header"><div class="flex gap-3"><div class="post-avatar-container w-10 h-10 rounded-full"><img src="${a.avatar}" class="post-avatar cursor-pointer w-full h-full" onclick="event.stopPropagation();openProfilePreview('${a.id}')"></div><div><div class="flex items-center"><span class="post-author-name" onclick="event.stopPropagation(); showProfile('${a.id}')">${a.name}</span>${a.isOfficial ? '<i data-lucide="badge-check" class="w-4 h-4 official-badge ml-1"></i>' : ''}${a.banned ? '<i data-lucide="ban" class="w-3 h-3 text-red-500 ml-1"></i>' : ''}${st.privacy === 'private' ? '<i data-lucide="lock" class="w-3 h-3 text-gray-400 ml-1"></i>' : ''}</div><div class="post-meta flex items-center">${formatDate(p.timestamp)}</div></div></div><button class="icon-btn w-8 h-8 -mr-2" onclick="showPostOptions(event,'${p.id}','${p.authorId}')"><i data-lucide="more-horizontal" class="w-5 h-5"></i></button></div><div class="post-content"><div class="post-body js-post-body-${p.id}">${window.renderTextWithReadMore(p.content, `post-${p.id}`)}</div>${previewHtml}${mh}</div><div class="post-actions"><button class="action-btn like js-like-btn-${p.id} ${isLiked ? 'active' : ''}" onclick="event.stopPropagation(); toggleLike('${p.id}')"><i data-lucide="heart"></i> <span class="js-like-count-${p.id}">${likeText}</span></button><button class="action-btn comment" onclick="event.stopPropagation(); openPostView('${p.id}')"><i data-lucide="${st.allowComments === false ? 'message-circle-off' : 'message-circle'}"></i> <span class="js-comment-count-${p.id}">${commentText}</span></button><button class="action-btn share-btn" onclick="event.stopPropagation(); sharePost('${p.id}')"><i data-lucide="redo-2"></i> <span class="hidden sm:inline">Share</span></button><div class="flex-1"></div>${rightActionBtn}</div></div>${lh}`; return d
        }
        window.moveCarousel = (cid, dir) => { const s = window.carouselStates[cid]; if (!s) return; let n = s.index + dir; if (n < 0) n = 0; if (n >= s.total) n = s.total - 1; s.index = n; const outer = document.getElementById(cid), inner = outer ? outer.querySelector('.post-carousel-inner') : null; if (inner) inner.style.transform = `translateX(-${n * 100}%)`; const dc = document.getElementById(cid).nextElementSibling; if (dc) dc.querySelectorAll('.carousel-dot').forEach((d, i) => d.classList.toggle('active', i === n)); const ctid = cid.replace('carousel-', 'counter-'), cnt = document.getElementById(ctid); if (cnt) cnt.innerText = n + 1 };
        window.switchExploreMainTab = t => { window.activeExploreTab = t; const m = t === 'explore' ? 'main' : t;['main', 'video', 'people', 'tags'].forEach(x => { const el = document.getElementById(`tab-explore-${x}`), ed = document.getElementById(`tab-explore-${x}-d`); if (el) el.classList.remove('active'); if (ed) ed.classList.remove('active') }); document.getElementById(`tab-explore-${m}`)?.classList.add('active'); document.getElementById(`tab-explore-${m}-d`)?.classList.add('active'); window.activeExploreCategory = t === 'video' ? 'All' : 'For You'; handleSearch(document.getElementById('mobile-explore-search').value); syncURLState() };
        window.toggleExploreSearch = () => { const b = document.getElementById('explore-search-bar'); if (b) { b.classList.toggle('hidden'); if (!b.classList.contains('hidden')) document.getElementById('mobile-explore-search').focus() } };
        window.handleSearch = q => { if (document.getElementById('view-explore').classList.contains('hidden')) switchView('explore'); const t = q ? q.toLowerCase().trim() : '', pl = document.getElementById('explore-people-results'), v = document.getElementById('explore-results'); if (window.activeExploreTab === 'people') { pl.classList.remove('hidden'); pl.classList.add('flex'); v.innerHTML = ''; pl.innerHTML = ''; const fu = t ? users.filter(u => (u.name || "").toLowerCase().includes(t) || (u.username || "").toLowerCase().includes(t)) : users.slice(0, 10); if (fu.length) fu.forEach(u => { const d = document.createElement('div'); d.className = "flex items-center justify-between p-4 border-b border-gray-100 hover:bg-gray-50 cursor-pointer last:border-b-0"; d.onclick = () => showProfile(u.id); d.innerHTML = `<div class="flex items-center gap-3"><div class="img-placeholder rounded-full w-12 h-12 shrink-0"><img src="${u.avatar}" class="w-full h-full rounded-full object-cover"></div><div><div class="font-bold text-[#1f1f1f] text-[15px] flex items-center gap-1">${u.name}${u.isOfficial ? '<i data-lucide="badge-check" class="w-4 h-4 official-badge"></i>' : ''}${u.banned ? '<i data-lucide="ban" class="w-3 h-3 text-red-500"></i>' : ''}</div><div class="text-xs text-gray-500 font-medium">@${u.username || 'user'}  ${u.followers?.length || 0} followers</div></div></div><button onclick="event.stopPropagation(); toggleFollow('${u.id}')" class="bg-black text-white text-xs px-4 py-1.5 rounded-full font-bold hover:bg-gray-800 transition-colors shadow-sm">Follow</button>`; pl.appendChild(d) }); else pl.innerHTML = '<div class="text-gray-400 text-xs italic text-center py-4">No people found</div>' } else { pl.classList.add('hidden'); pl.classList.remove('flex'); v.innerHTML = ''; let fp = posts.filter(p => { if (window.activeExploreTab === 'video') return p.media && (Array.isArray(p.media) ? p.media.some(m => m.includes('video') || m.endsWith('.mp4')) : (p.media.includes('video') || p.media.endsWith('.mp4'))); if (window.activeExploreTab === 'tags') return p.content.includes('#'); return true }); if (t) fp = fp.filter(p => p.content.toLowerCase().includes(t)); else if (window.activeExploreTab !== 'tags') fp.sort(() => .5 - Math.random()); fp = fp.filter(p => canSeePost(p)); if (!fp.length) v.innerHTML = '<div class="text-center py-20 text-gray-400"><p>No posts found.</p></div>'; else { const l = document.createElement('div'); l.className = "flex flex-col gap-0.5 md:gap-4"; fp.forEach(p => l.appendChild(createPostElement(p, 'explore'))); v.appendChild(l) } } syncURLState(); refreshIcons() };
        window.openCollabSelector = () => { manageHistory('user-list-overlay'); const o = document.getElementById('user-list-overlay'), c = document.getElementById('user-list-content'); document.getElementById('user-list-title').innerText = "Tag Collaborators"; c.innerHTML = ''; const r = users.filter(u => u.id !== currentUser.id && (currentUser.following.includes(u.id) || currentUser.followers.includes(u.id))); if (!r.length) c.innerHTML = '<div class="text-center text-gray-400 py-8">No contacts.</div>'; else r.forEach(u => { const sel = window.selectedCollaborators.find(x => x.id === u.id), d = document.createElement('div'); d.className = `flex items-center justify-between p-3 hover:bg-gray-50 rounded-xl cursor-pointer ${sel ? 'bg-gray-100' : ''}`; d.onclick = () => toggleCollaborator(u); d.innerHTML = `<div class="flex items-center gap-3"><img src="${u.avatar}" class="w-10 h-10 rounded-full border border-gray-200 object-cover"><div><div class="font-bold text-sm text-gray-900">${u.name}</div><div class="text-xs text-gray-500">@${u.username || 'user'}</div></div></div>${sel ? '<i data-lucide="check" class="text-gray-600 w-5 h-5"></i>' : ''}`; c.appendChild(d) }); o.classList.remove('hidden'); refreshIcons() };
        window.toggleCollaborator = u => { const i = window.selectedCollaborators.findIndex(x => x.id === u.id); if (i > -1) window.selectedCollaborators.splice(i, 1); else window.selectedCollaborators.push({ id: u.id, name: u.name, avatar: u.avatar, username: u.username, status: 'pending' }); closeUserList(); openCollabSelector(); renderCollabChips() }; window.renderCollabChips = () => { const c = document.getElementById('collab-chips-container'); c.innerHTML = ''; window.selectedCollaborators.forEach(u => { const ch = document.createElement('div'); ch.className = 'collab-chip'; ch.innerHTML = `<img src="${u.avatar}" class="w-4 h-4 rounded-full mr-2"> <span>${u.name}</span> <i onclick="event.stopPropagation(); removeCollaborator('${u.id}')" data-lucide="x" class="w-3 h-3 ml-2 text-gray-500 hover:text-red-500 cursor-pointer"></i>`; c.appendChild(ch) }); refreshIcons() }; window.removeCollaborator = id => { window.selectedCollaborators = window.selectedCollaborators.filter(u => u.id !== id); renderCollabChips() };
        window.openCollabList = pid => { manageHistory('user-list-overlay'); const p = posts.find(x => x.id === pid); if (!p || !p.collaborators) return; const c = document.getElementById('user-list-content'); document.getElementById('user-list-title').innerText = "Collaborators"; c.innerHTML = ''; p.collaborators.filter(x => x.status === 'accepted').forEach(u => { const d = document.createElement('div'); d.className = "flex items-center justify-between p-3 hover:bg-gray-50 rounded-xl cursor-pointer"; d.onclick = () => { closeUserList(); showProfile(u.id) }; d.innerHTML = `<div class="flex items-center gap-3"><img src="${u.avatar}" class="w-10 h-10 rounded-full border border-gray-200 object-cover"><div><div class="font-bold text-sm text-gray-900">${u.name}</div><div class="text-xs text-gray-500">@${u.username || 'user'}</div></div></div>`; c.appendChild(d) }); document.getElementById('user-list-overlay').classList.remove('hidden') };
        window.openUserList = (type, uid) => { const u = users.find(x => x.id === uid); if (!u) return; manageHistory('user-list-overlay'); const m = document.getElementById('user-list-overlay'), c = document.getElementById('user-list-content'); document.getElementById('user-list-title').innerText = type === 'following' ? 'Following' : 'Followers'; const me = uid === currentUser.id, fol = currentUser.following.includes(uid), priv = u.settings?.privateNetwork, hide = u.settings?.hideConnections; if (!me && (hide || (priv && !fol))) { c.innerHTML = `<div class="flex flex-col items-center justify-center py-10 text-gray-400 opacity-60"><i data-lucide="${hide ? 'eye-off' : 'lock'}" class="w-16 h-16 mb-2"></i><p>${hide ? 'Connections hidden' : 'Account is private'}</p></div>` } else { const ids = type === 'following' ? (u.following || []) : (u.followers || []); if (!ids.length) c.innerHTML = '<div class="text-center text-gray-400 py-8">No users found.</div>'; else { c.innerHTML = ''; ids.forEach(id => { const user = users.find(x => x.id === id); if (user) { const d = document.createElement('div'); d.className = "flex items-center justify-between p-3 hover:bg-gray-50 rounded-xl cursor-pointer"; d.onclick = () => { closeUserList(); showProfile(user.id) }; d.innerHTML = `<div class="flex items-center gap-3"><img src="${user.avatar}" class="w-10 h-10 rounded-full border border-gray-200 object-cover"><div><div class="font-bold text-sm text-gray-900">${user.name}</div><div class="text-xs text-gray-500">@${user.username || 'user'}</div></div></div>`; c.appendChild(d) } }) } } toggleModalAnim('user-list-overlay', 'user-list-modal', !0); refreshIcons() }; window.closeUserList = () => toggleModalAnim('user-list-overlay', 'user-list-modal', !1);
        window.toggleLike = async (pid) => { const isLiking = !document.querySelector(`.js-like-btn-${pid}`)?.classList.contains('active'); document.querySelectorAll(`.js-like-btn-${pid}`).forEach(b => b.classList.toggle('active', isLiking)); document.querySelectorAll(`.js-like-count-${pid}`).forEach(el => { let t = el.innerText; let c = parseInt(t); if (isNaN(c)) c = 0; let nc = Math.max(0, c + (isLiking ? 1 : -1)); el.innerText = nc === 0 ? 'Like' : nc }); const ovBtn = document.getElementById('post-view-like-btn'); if (ovBtn) { if (isLiking) { ovBtn.classList.add('fill-red-500', 'text-red-500'); ovBtn.classList.remove('text-gray-700') } else { ovBtn.classList.remove('fill-red-500', 'text-red-500'); ovBtn.classList.add('text-gray-700') } } const movBtn = document.getElementById(`mobile-overlay-like-btn-${pid}`); if (movBtn) { if (isLiking) { movBtn.classList.add('fill-red-500', 'text-red-500'); movBtn.classList.remove('text-900') } else { movBtn.classList.remove('fill-red-500', 'text-red-500'); movBtn.classList.add('text-900') } } const r = doc(db, "posts", pid), p = posts.find(x => x.id === pid); if (p.likes && p.likes.includes(currentUser.id)) await updateDoc(r, { likes: arrayRemove(currentUser.id) }); else { await updateDoc(r, { likes: arrayUnion(currentUser.id) }); if (p.authorId !== currentUser.id) sendNotification(p.authorId, 'like', 'liked your post', pid) } if (isLiking) trackInteraction(pid, 'like', 2); };
        const toggleModalAnim = (oid, mid, s) => { const o = document.getElementById(oid), m = document.getElementById(mid); if (s) { o.classList.remove('hidden'); m.style.transition = 'none'; o.classList.add('opacity-0'); m.classList.add('translate-y-full', 'md:scale-95'); m.classList.remove('translate-y-0', 'md:scale-100'); void m.offsetWidth; m.style.transition = ''; setTimeout(() => { o.classList.remove('opacity-0'); m.classList.remove('translate-y-full', 'md:scale-95'); m.classList.add('translate-y-0', 'md:scale-100') }, 20) } else { o.classList.add('opacity-0'); m.classList.add('translate-y-full', 'md:scale-95'); m.classList.remove('translate-y-0', 'md:scale-100'); setTimeout(() => o.classList.add('hidden'), 200) } };
        window.openLikes = pid => { manageHistory('likes-overlay'); const p = posts.find(x => x.id === pid), c = document.getElementById('likes-list-content'); const searchInput = document.getElementById('likes-search-input'); if (searchInput) searchInput.value = ''; if (p.settings?.allowLikeView === false && p.authorId !== currentUser.id) { c.innerHTML = '<div class="text-center text-gray-400 py-8">Creator hid likes.</div>'; toggleModalAnim('likes-overlay', 'likes-modal', true); return } renderLikesList(p.likes || []); searchInput.oninput = (e) => { const term = e.target.value.toLowerCase(); const allLikes = p.likes || []; if (!term) { renderLikesList(allLikes) } else { const filtered = allLikes.filter(uid => { const u = users.find(x => x.id === uid); return u && (u.name.toLowerCase().includes(term) || (u.username && u.username.toLowerCase().includes(term))) }); renderLikesList(filtered) } }; toggleModalAnim('likes-overlay', 'likes-modal', true) };
        window.renderLikesList = (idList) => { const c = document.getElementById('likes-list-content'); if (!idList || !idList.length) { c.innerHTML = '<div class="text-center text-gray-400 py-8">No matching users.</div>'; return } c.innerHTML = idList.map(uid => { const u = users.find(x => x.id === uid); return u ? `<div class="flex items-center gap-3 p-3 hover:bg-gray-50 rounded-xl cursor-pointer" onclick="closeLikes();showProfile('${u.id}')"><div class="img-placeholder rounded-full w-10 h-10 shrink-0"><img src="${u.avatar}" class="w-full h-full rounded-full object-cover"></div><div><div class="font-bold text-sm text-gray-900">${u.name}</div><div class="text-xs text-gray-500 truncate w-32">${u.bio}</div></div></div>` : '' }).join('') };
        window.closeLikes = () => toggleModalAnim('likes-overlay', 'likes-modal', !1);
        window.toggleSave = async (pid) => { const isSaving = !document.querySelector(`.js-save-btn-${pid}`)?.classList.contains('active'); document.querySelectorAll(`.js-save-btn-${pid}`).forEach(b => b.classList.toggle('active', isSaving)); showToast(isSaving ? "Saved" : "Removed"); const ovBtn = document.getElementById('post-view-save-btn'); if (ovBtn) { if (isSaving) { ovBtn.classList.add('fill-yellow-500', 'text-yellow-500'); ovBtn.classList.remove('text-gray-700') } else { ovBtn.classList.remove('fill-yellow-500', 'text-yellow-500'); ovBtn.classList.add('text-gray-700') } } const movBtn = document.getElementById(`mobile-overlay-save-btn-${pid}`); if (movBtn) { if (isSaving) { movBtn.classList.add('fill-yellow-500', 'text-yellow-500'); movBtn.classList.remove('text-900') } else { movBtn.classList.remove('fill-yellow-500', 'text-yellow-500'); movBtn.classList.add('text-900') } } if (isSaving) savedPosts.push(pid); else savedPosts = savedPosts.filter(x => x !== pid); await updateDoc(doc(db, "users", currentUser.id), { saved: isSaving ? arrayUnion(pid) : arrayRemove(pid) }) };
        function createCarouselHTML(ma, prefix, pid) { let sl = '', dt = ''; ma.forEach((s, i) => { sl += `<div class="post-carousel-item img-placeholder bg-gray-200">${(s.startsWith('data:video') || s.includes('.mp4')) ? `<video src="${s}" controls></video>` : `<img src="${s}" class="w-full h-full object-cover">`}</div>`; dt += `<div class="carousel-dot ${i === 0 ? 'active' : ''}" id="${prefix}-dot-${pid}-${i}"></div>` }); const cid = `${prefix}-carousel-${pid}`, iid = `${prefix}-inner-${pid}`; if (!window.carouselStates) window.carouselStates = {}; window.carouselStates[cid] = { index: 0, total: ma.length }; return `<div class="carousel-wrapper mt-3"><div class="rounded-lg overflow-hidden post-carousel shadow-sm" id="${cid}" ontouchstart="handleTouchStart(event)" ontouchend="handleTouchEnd(event,'${pid}',true)"><div class="post-carousel-inner" id="${iid}">${sl}</div><button class="carousel-nav-btn prev hidden md:flex" onclick="event.stopPropagation();moveCarousel('${cid}',-1)"><i data-lucide="chevron-left" class="w-4 h-4"></i></button><button class="carousel-nav-btn next hidden md:flex" onclick="event.stopPropagation();moveCarousel('${cid}',1)"><i data-lucide="chevron-right" class="w-4 h-4"></i></button></div><div class="carousel-dots-outside">${dt}</div></div>` }
        window.sharePost = pid => { manageHistory('share-overlay'); window.currentSharePid = pid; const url = `${window.location.origin}${window.location.pathname}?postId=${pid}`, p = posts.find(x => x.id === pid), pc = document.getElementById('share-post-preview'); document.getElementById('share-link-input').value = url; document.getElementById('share-link-text').innerText = url; if (p) { const a = users.find(u => u.id === p.authorId) || { name: 'Unknown', avatar: '' }; document.getElementById('share-owner-avatar').src = a.avatar; const m = p.media ? (Array.isArray(p.media) ? p.media[0] : p.media) : null, isV = m && (m.includes('video') || m.endsWith('.mp4')), mh = m ? (isV ? `<div class="w-16 h-16 bg-black rounded-lg flex items-center justify-center shrink-0"><i data-lucide="play" class="w-6 h-6 text-white"></i></div>` : `<img src="${m}" class="w-16 h-16 rounded-lg object-cover shrink-0 bg-gray-200">`) : ''; pc.innerHTML = `<div class="bg-white border border-gray-200 rounded-xl p-3 mb-6"><div class="flex items-center gap-2 mb-2"><img src="${a.avatar}" class="w-5 h-5 rounded-full object-cover"><span class="text-xs font-bold text-gray-900 truncate">${a.name}</span></div><div class="flex gap-3 items-center"><div class="flex-1 min-w-0"><p class="text-xs text-gray-600 line-clamp-2 mb-2 leading-relaxed">${p.content || (m ? 'Shared a post' : '')}</p><div class="flex items-center gap-3 text-gray-400"><div class="flex items-center gap-1 text-[10px] font-medium"><i data-lucide="heart" class="w-3 h-3"></i> ${p.likes?.length || 0}</div><div class="flex items-center gap-1 text-[10px] font-medium"><i data-lucide="message-circle" class="w-3 h-3"></i> ${p.comments?.length || 0}</div></div></div>${mh}</div></div>`; pc.classList.remove('hidden'); const dl = document.getElementById('share-dl-btn'); if (dl) dl.remove(); if (m && !isV) { const g = document.getElementById('share-grid-options'); if (!document.getElementById(`share-dl-${pid}`)) { const d = document.createElement('div'); d.id = `share-dl-${pid}`; d.className = "share-icon-btn"; d.onclick = () => triggerShare('download'); d.innerHTML = `<div class="share-icon-circle bg-gray-100 text-gray-800 border border-gray-200" id="dl-icon-${pid}"><i data-lucide="download" class="w-6 h-6"></i></div><span class="text-xs font-medium text-gray-700" id="dl-text-${pid}">Download</span>`; g.appendChild(d) } } refreshIcons() } else pc.classList.add('hidden'); toggleModalAnim('share-overlay', 'share-modal', !0) };
        window.closeShareMenu = () => { const o = document.getElementById('share-overlay'), m = document.getElementById('share-modal'); o.classList.add('opacity-0'); m.classList.add('translate-y-full', 'md:scale-95'); m.classList.remove('translate-y-0', 'md:scale-100'); setTimeout(() => { o.classList.add('hidden'); window.currentSharePid = null; document.querySelectorAll('[id^="share-dl-"]').forEach(e => e.remove()) }, 200) };
        window.openDownloadSelect = i => { manageHistory('download-select-overlay'); window.currentDownloadImages = i; window.selectedDownloadIndices.clear(); const m = document.getElementById('download-select-modal'), o = document.getElementById('download-select-overlay'), c = document.getElementById('download-select-content'); c.innerHTML = i.map((u, x) => `<div class="aspect-square rounded-xl overflow-hidden relative border-2 transition-all cursor-pointer border-gray-200 hover:border-gray-300" onclick="toggleDownloadSelect(${x},this)"><img src="${u}" class="w-full h-full object-cover pointer-events-none"><div class="absolute top-2 right-2 w-6 h-6 rounded-full bg-black/40 border-white border-2 flex items-center justify-center transition-colors"></div></div>`).join(''); updateDownloadBtn(); m.style.transform = ''; m.style.transition = 'none'; o.classList.add('opacity-0'); m.classList.add('translate-y-full', 'md:scale-95'); m.classList.remove('translate-y-0', 'md:scale-100'); o.classList.remove('hidden'); void m.offsetWidth; m.style.transition = ''; setTimeout(() => { o.classList.remove('opacity-0'); m.classList.remove('translate-y-full', 'md:scale-95'); m.classList.add('translate-y-0', 'md:scale-100') }, 20) }; window.closeDownloadSelect = () => { const o = document.getElementById('download-select-overlay'), m = document.getElementById('download-select-modal'); o.classList.add('opacity-0'); m.classList.add('translate-y-full', 'md:scale-95'); m.classList.remove('translate-y-0', 'md:scale-100'); setTimeout(() => o.classList.add('hidden'), 200) }; window.toggleDownloadSelect = (i, e) => { window.selectedDownloadIndices.has(i) ? window.selectedDownloadIndices.delete(i) : window.selectedDownloadIndices.add(i); const s = window.selectedDownloadIndices.has(i); e.className = `aspect-square rounded-xl overflow-hidden relative border-2 transition-all cursor-pointer ${s ? 'border-blue-500 ring-2 ring-blue-500/20' : 'border-gray-200 hover:border-gray-300'}`; const d = e.querySelector('div.absolute'); d.className = `absolute top-2 right-2 w-6 h-6 rounded-full ${s ? 'bg-blue-500 border-blue-500' : 'bg-black/40 border-white'} border-2 flex items-center justify-center transition-colors`; d.innerHTML = s ? '<i data-lucide="check" class="w-3 h-3 text-white"></i>' : ''; refreshIcons(); updateDownloadBtn() }; window.updateDownloadBtn = () => { const c = window.selectedDownloadIndices.size, b = document.getElementById('download-action-btn'); b.innerText = `Download ${c > 0 ? `(${c})` : ''}`; b.disabled = c === 0; b.className = `w-full py-3 rounded-xl font-bold transition-all ${c > 0 ? 'bg-[#0b57d0] text-white hover:bg-blue-700' : 'bg-gray-100 text-gray-400 cursor-not-allowed'}` }; window.downloadSelectedImages = async () => { const idx = Array.from(window.selectedDownloadIndices); if (!idx.length) return; const b = document.getElementById('download-action-btn'); b.innerText = "Downloading..."; for (const i of idx) { const u = window.currentDownloadImages[i]; try { const r = await fetch(u), bl = await r.blob(), url = window.URL.createObjectURL(bl), a = document.createElement('a'); a.style.display = 'none'; a.href = url; a.download = `edulink_img_${Date.now()}_${i}.jpg`; document.body.appendChild(a); a.click(); window.URL.revokeObjectURL(url); a.remove(); await new Promise(r => setTimeout(r, 500)) } catch (e) { } } showToast("Saved to device"); closeDownloadSelect(); closeShareMenu() };
        window.triggerShare = (pf, meta) => { if (!window.currentSharePid) return; const u = `${window.location.origin}${window.location.pathname}?postId=${window.currentSharePid}`, txt = "Check out this post on EduLink!", acts = { copy: () => navigator.clipboard.writeText(u).then(() => showToast("Link copied!")), twitter: () => window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(txt)}&url=${encodeURIComponent(u)}`, '_blank'), whatsapp: () => window.open(`https://wa.me/?text=${encodeURIComponent(txt + " " + u)}`, '_blank'), email: () => window.open(`mailto:?subject=${encodeURIComponent(txt)}&body=${encodeURIComponent(txt + "\n\n" + u)}`), download: async () => { const pid = window.currentSharePid, p = posts.find(x => x.id === pid); if (!p || !p.media) return; const ml = Array.isArray(p.media) ? p.media : [p.media], imgs = ml.filter(x => x && !x.includes('video') && !x.endsWith('.mp4') && !x.startsWith('data:video')); if (!imgs.length) return showToast("No images"); if (imgs.length === 1) { const icon = document.getElementById(`dl-icon-${pid}`), txtSpan = document.getElementById(`dl-text-${pid}`); if (icon && txtSpan) { const oi = icon.innerHTML, ot = txtSpan.innerText; icon.innerHTML = '<i data-lucide="loader-2" class="w-6 h-6 animate-spin"></i>'; txtSpan.innerText = "Saving..."; refreshIcons(); try { const r = await fetch(imgs[0]), b = await r.blob(), url = window.URL.createObjectURL(b), a = document.createElement('a'); a.style.display = 'none'; a.href = url; a.download = `edulink_post_${pid}.jpg`; document.body.appendChild(a); a.click(); window.URL.revokeObjectURL(url); a.remove(); showToast("Saved to device"); closeShareMenu() } catch (e) { showToast("Download failed", !0) } finally { icon.innerHTML = oi; txtSpan.innerText = ot; refreshIcons() } } } else openDownloadSelect(imgs) } }; acts[pf]?.(); if (pf !== 'copy' && pf !== 'download') closeShareMenu() };
        window.renderSaved = () => { const c = document.getElementById('saved-container'); c.innerHTML = ''; if (!savedPosts.length) c.innerHTML = '<div class="flex flex-col items-center justify-center h-full text-gray-400 opacity-60"><i data-lucide="bookmark" class="w-16 h-16 mb-2"></i><p>No saved posts</p></div>'; else posts.filter(p => savedPosts.includes(p.id)).forEach(p => c.appendChild(createPostElement(p, 'saved'))); refreshIcons() };
        async function sendNotification(rid, t, c, pid = null) { await setDoc(doc(db, "notifications", `${t}_${currentUser.id}_${pid || 'general'}_${rid}`), { receiverId: rid, senderId: currentUser.id, type: t, content: c, timestamp: serverTimestamp(), read: !1, postId: pid }, { merge: !0 }) }
        window.switchNotifTab = t => { activeNotifTab = t; document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));[`ntab-${t}`, `ntab-${t}-mobile`].forEach(id => document.getElementById(id)?.classList.add('active')); renderNotifications() };
        window.toggleNotifMenu = () => { manageHistory('notif-options-overlay'); const o = document.getElementById('notif-options-overlay'), m = document.getElementById('notif-options-modal'); o.classList.remove('hidden'); m.style.transition = 'none'; o.classList.add('opacity-0'); m.classList.add('translate-y-full'); void m.offsetWidth; m.style.transition = ''; setTimeout(() => { o.classList.remove('opacity-0'); m.classList.remove('translate-y-full') }, 20) }; window.closeNotifOptions = () => { const o = document.getElementById('notif-options-overlay'), m = document.getElementById('notif-options-modal'); o.classList.add('opacity-0'); m.classList.add('translate-y-full'); setTimeout(() => o.classList.add('hidden'), 200) };
        window.toggleNotifSelection = () => { window.notifSelectionMode = !window.notifSelectionMode; if (!window.notifSelectionMode) window.selectedNotifs.clear(); renderNotifications() };
        window.toggleNotifSearchMobile = () => {
            const d = document.getElementById('notif-header-default'), s = document.getElementById('notif-header-search');
            if (d && s) {
                const isSearchActive = d.classList.contains('hidden');
                if (isSearchActive) {
                    d.classList.remove('hidden');
                    d.classList.add('flex');
                    s.classList.add('hidden');
                    s.classList.remove('flex');
                    window.notifSearchTerm = '';
                    const si = document.getElementById('notif-search');
                    if (si) si.value = '';
                    renderNotifications();
                } else {
                    d.classList.add('hidden');
                    d.classList.remove('flex');
                    s.classList.remove('hidden');
                    s.classList.add('flex');
                    const si = document.getElementById('notif-search');
                    if (si) si.focus();
                }
                refreshIcons();
            }
        };
        window.handleNotifSearch = v => { window.notifSearchTerm = v.toLowerCase(); renderNotifications() };
        window.toggleNotifSelect = id => { window.selectedNotifs.has(id) ? window.selectedNotifs.delete(id) : window.selectedNotifs.add(id); renderNotifications() };
        window.deleteSelectedNotifs = async () => { if (!window.selectedNotifs.size) return showToast("None selected"); showAlert(`Delete ${window.selectedNotifs.size} items?`, async () => { const b = writeBatch(db); window.selectedNotifs.forEach(id => b.delete(doc(db, "notifications", id))); await b.commit(); window.notifSelectionMode = false; window.selectedNotifs.clear(); toggleNotifMenu(); showToast("Deleted") }) };
        window.renderNotifications = () => {
            const c = document.getElementById('notification-list'), term = window.notifSearchTerm;
            let fl = notifications.filter(n => {
                const s = users.find(u => u.id === n.senderId) || { name: 'Admin', isOfficial: !1 };
                const matchesSearch = (!term || n.content.toLowerCase().includes(term) || (s.name || '').toLowerCase().includes(term) || (s.username || '').toLowerCase().includes(term));
                return matchesSearch;
            });
            if (!fl.length) return c.innerHTML = '<div class="text-center text-xs text-gray-400 py-4">No notifications</div>';
            const likeGroups = new Map(), commentGroups = new Map(), finalItems = []; fl.forEach(n => { if (n.type === 'like' && n.postId) { if (!likeGroups.has(n.postId)) likeGroups.set(n.postId, { notifs: [], latestTs: 0 }); const g = likeGroups.get(n.postId); g.notifs.push(n); const ts = n.timestamp?.toDate ? n.timestamp.toDate().getTime() : new Date(n.timestamp || 0).getTime(); if (ts > g.latestTs) g.latestTs = ts } else if (n.type === 'comment' && n.postId) { if (!commentGroups.has(n.postId)) commentGroups.set(n.postId, { notifs: [], latestTs: 0 }); const g = commentGroups.get(n.postId); g.notifs.push(n); const ts = n.timestamp?.toDate ? n.timestamp.toDate().getTime() : new Date(n.timestamp || 0).getTime(); if (ts > g.latestTs) g.latestTs = ts } else { finalItems.push({ type: 'single', data: n, ts: n.timestamp?.toDate ? n.timestamp.toDate().getTime() : new Date(n.timestamp || 0).getTime() }) } }); likeGroups.forEach((g, pid) => { finalItems.push({ type: 'group_like', data: g.notifs, postId: pid, ts: g.latestTs }) }); commentGroups.forEach((g, pid) => { finalItems.push({ type: 'group_comment', data: g.notifs, postId: pid, ts: g.latestTs }) }); finalItems.sort((a, b) => b.ts - a.ts); c.innerHTML = finalItems.map(item => {
                if (item.type === 'group_like' || item.type === 'group_comment') { const notifs = item.data, pid = item.postId, p = posts.find(x => x.id === pid); const postImg = p ? (Array.isArray(p.media) ? p.media[0] : p.media) : null; const isVid = postImg && (postImg.includes('video') || postImg.endsWith('.mp4')); const showImg = postImg && !isVid ? postImg : null; const sortedNotifs = notifs.sort((a, b) => { const ta = a.timestamp?.toDate ? a.timestamp.toDate().getTime() : new Date(a.timestamp || 0).getTime(); const tb = b.timestamp?.toDate ? b.timestamp.toDate().getTime() : new Date(b.timestamp || 0).getTime(); return tb - ta }); const uniqueIds = new Set(); const senders = []; sortedNotifs.forEach(n => { if (!uniqueIds.has(n.senderId)) { uniqueIds.add(n.senderId); const u = users.find(user => user.id === n.senderId); if (u) senders.push(u) } }); const count = senders.length; if (count === 0) return ''; let avatars = '', showCount = Math.min(count, 2); for (let i = 0; i < showCount; i++)avatars += `<img src="${senders[i].avatar}" class="w-10 h-10 rounded-full border-2 border-white object-cover ${i > 0 ? '-ml-4' : ''} z-${20 - i * 10}" onclick="event.stopPropagation();openProfilePreview('${senders[i].id}')">`; let text = ''; const actionText = item.type === 'group_like' ? 'liked your post' : 'commented on your post'; const iconClass = item.type === 'group_like' ? 'bg-red-500' : 'bg-blue-500'; const iconName = item.type === 'group_like' ? 'heart' : 'message-circle'; if (count === 1) text = `<span class="font-bold text-gray-900 inline-flex items-center">@${senders[0].username || 'user'}${senders[0].isOfficial ? '<i data-lucide="badge-check" class="w-3 h-3 official-badge ml-1"></i>' : ''}</span> ${actionText}.`; else if (count === 2) text = `<span class="font-bold text-gray-900 inline-flex items-center">@${senders[0].username || 'user'}${senders[0].isOfficial ? '<i data-lucide="badge-check" class="w-3 h-3 official-badge ml-1"></i>' : ''}</span> and <span class="font-bold text-gray-900 inline-flex items-center">@${senders[1].username || 'user'}${senders[1].isOfficial ? '<i data-lucide="badge-check" class="w-3 h-3 official-badge ml-1"></i>' : ''}</span> ${actionText}.`; else text = `<span class="font-bold text-gray-900 inline-flex items-center">@${senders[0].username || 'user'}${senders[0].isOfficial ? '<i data-lucide="badge-check" class="w-3 h-3 official-badge ml-1"></i>' : ''}</span>, <span class="font-bold text-gray-900 inline-flex items-center">@${senders[1].username || 'user'}${senders[1].isOfficial ? '<i data-lucide="badge-check" class="w-3 h-3 official-badge ml-1"></i>' : ''}</span> and ${count - 2} others ${actionText}.`; return `<div class="w-full flex items-center justify-between p-4 border-b border-gray-100 bg-white hover:bg-gray-50 transition-colors cursor-pointer" onclick="openPostView('${pid}')"><div class="flex items-center gap-3"><div class="relative flex items-center shrink-0">${avatars}<div class="absolute -bottom-1 -right-1 w-5 h-5 rounded-full ${iconClass} flex items-center justify-center border border-white shadow-sm z-30"><i data-lucide="${iconName}" class="w-3.5 h-3.5 text-white fill-white"></i></div></div><div class="text-[14px] leading-snug ml-1">${text}<div class="text-[11px] text-gray-400 mt-0.5">${formatDate(item.ts)}</div></div></div>${showImg ? `<div class="w-10 h-10 rounded-md shrink-0 border border-gray-200"><img src="${showImg}" class="w-full h-full rounded-md object-cover"></div>` : ''}</div>` } else {
                    const n = item.data, s = users.find(u => u.id === n.senderId) || { name: 'Admin', avatar: '', username: 'user', isOfficial: !1 }, map = { like: { i: 'heart', c: 'bg-red-500', fill: 'fill-white' }, comment: { i: 'message-circle', c: 'bg-blue-500', fill: 'fill-white' }, reply: { i: 'corner-down-right', c: 'bg-teal-500', fill: '' }, follow: { i: 'user-plus', c: 'bg-indigo-500', fill: '' }, official: { i: 'badge-check', c: 'bg-blue-600', fill: '' }, system: { i: 'badge-check', c: 'bg-blue-600', fill: '' }, follow_request: { i: 'lock', c: 'bg-orange-500', fill: '' }, collab_request: { i: 'users', c: 'bg-pink-500', fill: '' }, mention: { i: 'at-sign', c: 'bg-green-500', fill: '' }, default: { i: 'bell', c: 'bg-gray-500', fill: '' } }, cfg = map[n.type] || map.default, p = n.postId ? posts.find(x => x.id === n.postId) : null, postImg = p ? (Array.isArray(p.media) ? p.media[0] : p.media) : null, isVid = postImg && (postImg.includes('video') || postImg.endsWith('.mp4')), showImg = postImg && !isVid ? postImg : null, click = window.notifSelectionMode ? '' : (['like', 'comment', 'reply', 'mention'].includes(n.type) && n.postId ? `openPostView('${n.postId}')` : `showProfile('${s.id}')`);
                    const urlMatch = n.content.match(/(https?:\/\/[^\s]+)/), previewId = `preview-notif-${n.id}`, previewHtml = (urlMatch && (n.type === 'system' || n.type === 'official')) ? `<div id="${previewId}"></div>` : '';
                    if (urlMatch && (n.type === 'system' || n.type === 'official')) setTimeout(() => window.renderLinkPreview(urlMatch[0], previewId), 100);
                    let act = ''; if (n.type === 'follow_request') act = `<div class="flex gap-2 mt-2"><button onclick="acceptFollow('${n.id}','${s.id}')" class="btn-xs-blue">Accept</button><button onclick="deleteNotification('${n.id}')" class="btn-xs-gray">Delete</button></div>`; if (n.type === 'collab_request') act = `<div class="flex gap-2 mt-2"><button onclick="acceptCollab('${n.id}','${n.postId}')" class="btn-xs-blue">Accept</button><button onclick="declineCollab('${n.id}','${n.postId}')" class="btn-xs-gray">Decline</button></div>`; const chk = window.notifSelectionMode ? `<div class="pt-1 mr-3"><input type="checkbox" ${window.selectedNotifs.has(n.id) ? 'checked' : ''} onchange="toggleNotifSelect('${n.id}')" class="w-4 h-4 accent-blue-600 cursor-pointer rounded"></div>` : ''; return `<div class="w-full flex items-start justify-between p-4 border-b border-gray-100 bg-white hover:bg-gray-50 transition-colors"><div class="flex items-start flex-1 gap-3">${chk}<div class="relative cursor-pointer shrink-0" onclick="${window.notifSelectionMode ? '' : `event.stopPropagation();openProfilePreview('${s.id}')`}"><img src="${s.avatar}" class="w-10 h-10 rounded-full bg-gray-200 object-cover border border-gray-100"><div class="absolute -bottom-1 -right-1 w-5 h-5 rounded-full ${cfg.c} flex items-center justify-center border border-white shadow-sm"><i data-lucide="${cfg.i}" class="w-3.5 h-3.5 text-white ${cfg.fill || ''}"></i></div></div><div class="flex-1 min-w-0 pt-0.5"><div class="text-[14px] leading-snug cursor-pointer" onclick="${click}"><span class="font-bold text-gray-900 hover:underline flex items-center gap-1">@${s.username || 'user'} ${s.isOfficial ? '<i data-lucide="badge-check" class="w-3 h-3 official-badge"></i>' : ''}</span> <span class="text-gray-600 ml-1">${n.content}</span></div>${previewHtml}<div class="text-[11px] text-gray-400 mt-1">${formatDate(item.ts)}</div>${act}</div></div>${showImg ? `<div class="w-10 h-10 rounded-md shrink-0 border border-gray-200"><img src="${showImg}" class="w-full h-full rounded-md object-cover" onclick="openPostView('${n.postId}')"></div>` : ''}${!window.notifSelectionMode && !showImg ? `<button onclick="deleteNotification('${n.id}')" class="p-1.5 text-gray-300 hover:text-red-500 hover:bg-red-50 rounded-full transition-all self-start -mt-1"><i data-lucide="x" class="w-3.5 h-3.5"></i></button>` : ''}</div>`
                }
            }).join(''); refreshIcons()
        };
        window.openProfilePreview = (uid) => { const u = users.find(x => x.id === uid); if (!u) return; manageHistory('profile-preview-overlay'); document.getElementById('pp-avatar').src = u.avatar; document.getElementById('pp-banner').style.backgroundImage = `url(${u.banner || 'https://images.unsplash.com/photo-1579546929518-9e396f3cc809?ixlib=rb-1.2.1&auto=format&fit=crop&w=1000&q=80'})`; document.getElementById('pp-name').innerHTML = `${u.name} ${u.isOfficial ? '<i data-lucide="badge-check" class="w-4 h-4 official-badge"></i>' : ''}`; document.getElementById('pp-username').innerText = `@${u.username || 'user'}`; const pCount = posts.filter(p => p.authorId === uid && (p.content || p.media)).length; document.getElementById('pp-posts-count').innerText = pCount; document.getElementById('pp-followers-count').innerText = u.followers ? u.followers.length : 0; document.getElementById('pp-following-count').innerText = u.following ? u.following.length : 0; document.getElementById('pp-visit-btn').onclick = () => { closeProfilePreview(); showProfile(uid) }; document.getElementById('pp-share-btn').onclick = (e) => { e.stopPropagation(); closeProfilePreview(); manageHistory('share-overlay'); window.currentSharePid = null; const url = `${window.location.origin}${window.location.pathname}?profileId=${uid}`; document.getElementById('share-link-input').value = url; document.getElementById('share-link-text').innerText = url; document.getElementById('share-owner-avatar').src = u.avatar; const pc = document.getElementById('share-post-preview'); pc.innerHTML = `<div class="bg-white border border-gray-200 rounded-xl p-3 mb-6 flex items-center gap-3"><img src="${u.avatar}" class="w-12 h-12 rounded-full border border-gray-100 object-cover"><div class="flex-1 min-w-0"><div class="font-bold text-gray-900">${u.name}</div><div class="text-xs text-gray-500">@${u.username}</div></div><button class="bg-blue-600 text-white text-xs px-3 py-1.5 rounded-full font-bold">View</button></div>`; pc.classList.remove('hidden'); toggleModalAnim('share-overlay', 'share-modal', !0) }; toggleModalAnim('profile-preview-overlay', 'profile-preview-card', true); refreshIcons() };
        window.closeProfilePreview = () => { toggleModalAnim('profile-preview-overlay', 'profile-preview-card', false) }; window.deleteNotification = async id => showAlert("Delete?", async () => await deleteDoc(doc(db, "notifications", id))); window.clearAllNotifications = async () => showAlert("Clear all?", async () => { const b = writeBatch(db), s = await getDocs(query(collection(db, "notifications"), where("receiverId", "==", currentUser.id))); s.forEach(d => b.delete(d.ref)); await b.commit(); showToast("Cleared") }); window.toggleNotifications = () => switchView('notifications');
        window.acceptCollab = async (nid, pid) => { const r = doc(db, "posts", pid), s = await getDoc(r); if (s.exists()) { const c = s.data().collaborators || [], i = c.findIndex(x => x.id === currentUser.id); if (i > -1) { c[i].status = 'accepted'; await updateDoc(r, { collaborators: c }); showToast("Accepted!") } } await deleteDoc(doc(db, "notifications", nid)) }; window.declineCollab = async (nid, pid) => { const r = doc(db, "posts", pid), s = await getDoc(r); if (s.exists()) await updateDoc(r, { collaborators: (s.data().collaborators || []).filter(x => x.id !== currentUser.id) }); showToast("Declined"); await deleteDoc(doc(db, "notifications", nid)) }; window.acceptFollow = async (nid, sid) => { await Promise.all([updateDoc(doc(db, "users", currentUser.id), { followers: arrayUnion(sid) }), updateDoc(doc(db, "users", sid), { following: arrayUnion(currentUser.id) }), deleteDoc(doc(db, "notifications", nid)), sendNotification(sid, 'follow', 'accepted follow')]); showToast("Accepted") };
        window.toggleFollow = async (uid) => { const m = doc(db, "users", currentUser.id), t = doc(db, "users", uid), u = users.find(x => x.id === uid), isF = currentUser.following.includes(uid), priv = u?.settings?.privateNetwork; if (isF) { currentUser.following = currentUser.following.filter(id => id !== uid); showToast("Unfollowed"); await Promise.all([updateDoc(m, { following: arrayRemove(uid) }), updateDoc(t, { followers: arrayRemove(currentUser.id) })]) } else { if (priv) { showToast("Request sent"); sendNotification(uid, 'follow_request', 'wants to follow you') } else { currentUser.following.push(uid); showToast("Following"); await Promise.all([updateDoc(m, { following: arrayUnion(uid) }), updateDoc(t, { followers: arrayUnion(currentUser.id) }), sendNotification(uid, 'follow', 'started following you')]) } } const btn = document.getElementById('profile-follow-btn'); if (btn) btn.innerText = isF ? (priv ? 'Request' : 'Follow') : (priv ? 'Requested' : 'Following'); const ul = document.getElementById(`ul-btn-${uid}`); if (ul) { ul.innerText = !isF ? 'Following' : 'Follow'; } renderRightSidebar(); if (!document.getElementById('view-network').classList.contains('hidden')) renderNetwork(); refreshIcons() };
        window.showProfile = (uid, tab = 'posts') => {
            if (!uid) uid = currentUser.id; if (window.currentViewingProfileId !== uid) manageHistory('view-profile'); closePostView(); closeThread(); window.currentViewingProfileId = uid; window.currentProfileTab = tab; const u = users.find(x => x.id === uid); if (!u) return; const c = document.getElementById('view-profile'), me = uid === currentUser.id, fol = currentUser.following?.includes(uid); let ab = me ? `<div class="flex gap-2"><button onclick="openEditProfile()" class="bg-gray-100 text-gray-700 px-4 py-2 rounded-lg font-bold text-sm hover:bg-gray-200">Edit Profile</button><button onclick="openQR()" class="bg-gray-100 text-gray-700 px-2 py-2 rounded-lg hover:bg-gray-200"><i data-lucide="qr-code" class="w-5 h-5"></i></button></div>` : `<div class="flex gap-2"><button id="profile-follow-btn" onclick="toggleFollow('${uid}')" class="${fol ? 'bg-gray-100 text-gray-700' : 'bg-[#0b57d0] text-white'} px-4 py-2 rounded-lg font-bold text-sm transition-colors">${fol ? 'Following' : (u.settings?.privateNetwork ? 'Request' : 'Follow')}</button><button onclick="openQR('${uid}')" class="bg-gray-100 text-gray-700 px-2 py-2 rounded-lg hover:bg-gray-200"><i data-lucide="qr-code" class="w-5 h-5"></i></button></div>`; const canViewConnections = me || (!u.settings?.hideConnections && !u.settings?.privateNetwork); const clickFollowing = canViewConnections ? `onclick="openUserList('following','${uid}')"` : `onclick="showToast('Connections are private')"`; const clickFollowers = canViewConnections ? `onclick="openUserList('followers','${uid}')"` : `onclick="showToast('Connections are private')"`; const cursorClass = canViewConnections ? 'cursor-pointer hover:underline' : 'cursor-default opacity-80'; let stats = `<div class="flex gap-4 mt-3 text-sm text-gray-500"><span class="${cursorClass}" ${clickFollowing}><strong class="text-gray-900">${u.following?.length || 0}</strong> Following</span><span class="${cursorClass}" ${clickFollowers}><strong class="text-gray-900">${u.followers?.length || 0}</strong> Followers</span></div>`; const tabs = ['posts', 'saved', 'liked', 'tagged'].map(t => (!me && t === 'saved') ? '' : `<button onclick="switchProfileTab('${t}')" class="tab-btn ${tab === t ? 'active' : ''}"><i data-lucide="${{ posts: 'grid', saved: 'bookmark', liked: 'heart', tagged: 'user-check' }[t]}" class="w-5 h-5"></i></button>`).join('');
            const urlMatch = u.bio?.match(/(https?:\/\/[^\s]+)/), previewId = `preview-bio-${u.id}`, previewHtml = urlMatch ? `<div id="${previewId}"></div>` : '';
            if (urlMatch) setTimeout(() => window.renderLinkPreview(urlMatch[0], previewId), 100);
            c.innerHTML = `<div class="profile-banner-container"><img src="${u.banner || 'https://images.unsplash.com/photo-1579546929518-9e396f3cc809?ixlib=rb-1.2.1&auto=format&fit=crop&w=1000&q=80'}" class="profile-banner-img" style="object-position:center ${u.bannerPos || 50}%"></div><div class="bg-white rounded-t-[30px] -mt-6 relative z-10 pt-2 px-4 md:px-6 min-h-[calc(100%-140px)] shadow-[0_-2px_10px_rgba(0,0,0,0.05)]"><div class="flex justify-between items-end -mt-14 mb-4 px-2"><div class="rounded-full border-4 border-white bg-white w-24 h-24 shrink-0"><img src="${u.avatar}" class="w-full h-full rounded-full object-cover cursor-pointer" onclick="openLightbox('${u.avatar}')"></div>${ab}</div><div class="mb-6"><h1 class="text-2xl font-bold text-gray-900 flex items-center gap-2">${u.name} ${u.isOfficial ? '<i data-lucide="badge-check" class="w-6 h-6 official-badge ml-1"></i>' : ''}${u.banned ? '<i data-lucide="ban" class="text-red-600 w-6 h-6"></i>' : ''}</h1><div class="text-sm font-medium text-gray-500">@${u.username || 'user'}</div><p class="text-gray-600 mt-2">${formatContent(u.bio || '')}</p>${previewHtml}${stats}</div><div class="tab-group mb-0">${tabs}</div><div id="profile-content-area" class="pt-1 md:pt-4 pb-20 md:pb-0"></div></div>`; switchView('profile'); renderProfileContent(uid, tab); syncURLState(); refreshIcons()
        };
        window.switchProfileTab = t => { if (t === 'posts' && window.currentProfileTab === 'posts') { openProfileFilter(); return } document.querySelectorAll('#view-profile .tab-btn').forEach(b => b.classList.toggle('active', b.getAttribute('onclick').includes(t))); window.currentProfileTab = t; renderProfileContent(window.currentViewingProfileId, t); syncURLState() };
        window.renderProfileContent = (uid, t) => { const c = document.getElementById('profile-content-area'), u = users.find(x => x.id === uid); c.innerHTML = ""; if (t === 'liked' && uid !== currentUser.id) return c.innerHTML = '<div class="flex flex-col items-center justify-center py-20 text-gray-400 opacity-60"><i data-lucide="lock" class="w-16 h-16 mb-2"></i><p>This user\'s likes are private.</p></div>', refreshIcons(); let tp = posts.filter(p => t === 'posts' ? p.authorId === uid : t === 'saved' ? savedPosts.includes(p.id) : t === 'liked' ? p.likes?.includes(uid) : (p.collaborators?.some(x => x.id === uid && x.status === 'accepted') || p.mentions?.includes(uid))); if (uid !== currentUser.id && t === 'posts') { const isF = currentUser.following.includes(uid); if (u.settings?.privateNetwork && !isF) { c.innerHTML = '<div class="flex flex-col items-center justify-center py-20 text-gray-400 opacity-60"><i data-lucide="lock" class="w-16 h-16 mb-2"></i><p>This account is private.</p></div>'; refreshIcons(); return } tp = tp.filter(p => (p.settings?.privacy === 'public' || currentUser.following.includes(uid))) } if (window.profileSort === 'latest') tp.sort((a, b) => b.timestamp - a.timestamp); else if (window.profileSort === 'oldest') tp.sort((a, b) => a.timestamp - b.timestamp); else if (window.profileSort === 'popular') tp.sort((a, b) => (b.likes?.length || 0) - (a.likes?.length || 0)); if (tp.length === 0) c.innerHTML = '<div class="text-center py-20 text-gray-400">No posts yet</div>'; else c.innerHTML = `<div class="grid-post-container">${tp.map(p => { const m = Array.isArray(p.media) ? p.media[0] : p.media, isV = m && (m.includes('video') || m.endsWith('.mp4') || m.startsWith('data:video')); return `<div class="grid-post-item group bg-gray-200 ${!m ? 'border border-gray-300' : ''}" onclick="openPostView('${p.id}')">${m ? (isV ? `<video src="${m}" class="w-full h-full object-cover pointer-events-none"></video><div class="absolute inset-0 flex items-center justify-center"><i data-lucide="play" class="w-8 h-8 text-white drop-shadow-md"></i></div>` : `<img src="${m}" class="w-full h-full object-cover">` + (Array.isArray(p.media) && p.media.length > 1 ? `<div class="absolute top-2 right-2"><i data-lucide="layers" class="w-4 h-4 text-white drop-shadow-md"></i></div>` : '')) : `<div class="grid-post-text-preview">${p.content.substring(0, 60)}${p.content.length > 60 ? '...' : ''}</div>`}<div class="grid-post-overlay"><div class="flex items-center gap-1"><i data-lucide="heart" class="w-5 h-5 fill-white"></i> ${p.likes?.length > 0 ? p.likes.length : '0'}</div><div class="flex items-center gap-1"><i data-lucide="message-circle" class="w-5 h-5 fill-white"></i> ${p.comments?.length > 0 ? p.comments.length : ''}</div></div></div>` }).join('')}</div>`; refreshIcons() };
        window.openUserList = (type, uid) => { const u = users.find(x => x.id === uid); if (!u) return; manageHistory('user-list-overlay'); const m = document.getElementById('user-list-overlay'), c = document.getElementById('user-list-content'); document.getElementById('user-list-title').innerText = type === 'following' ? 'Following' : 'Followers'; const me = uid === currentUser.id, fol = currentUser.following.includes(uid), priv = u.settings?.privateNetwork, hide = u.settings?.hideConnections; if (!me && (hide || (priv && !fol))) { c.innerHTML = `<div class="flex flex-col items-center justify-center py-10 text-gray-400 opacity-60"><i data-lucide="${hide ? 'eye-off' : 'lock'}" class="w-16 h-16 mb-2"></i><p>${hide ? 'Connections hidden' : 'Account is private'}</p></div>` } else { const ids = type === 'following' ? (u.following || []) : (u.followers || []); if (!ids.length) c.innerHTML = '<div class="text-center text-gray-400 py-8">No users found.</div>'; else { c.innerHTML = ''; ids.forEach(id => { const user = users.find(x => x.id === id); if (user) { const d = document.createElement('div'); d.className = "flex items-center justify-between p-3 hover:bg-gray-50 rounded-xl cursor-pointer"; d.onclick = () => { closeUserList(); showProfile(user.id) }; d.innerHTML = `<div class="flex items-center gap-3"><img src="${user.avatar}" class="w-10 h-10 rounded-full border border-gray-200 object-cover"><div><div class="font-bold text-sm text-gray-900">${user.name}</div><div class="text-xs text-gray-500">@${user.username || 'user'}</div></div></div>`; c.appendChild(d) } }) } } toggleModalAnim('user-list-overlay', 'user-list-modal', !0); refreshIcons() }; window.closeUserList = () => toggleModalAnim('user-list-overlay', 'user-list-modal', !1);
        window.openEditProfile = () => { manageHistory('edit-profile-overlay'); document.getElementById('edit-banner-preview').src = currentUser.banner || 'https://images.unsplash.com/photo-1579546929518-9e396f3cc809?ixlib=rb-1.2.1&auto=format&fit=crop&w=1000&q=80'; document.getElementById('edit-banner-preview').style.objectPosition = `center ${currentBannerPos = initialBannerPos = currentUser.bannerPos || 50}%`; document.getElementById('banner-pos-hint').innerText = `${currentBannerPos}%`; document.getElementById('edit-email').value = currentUser.email || ""; const ONE_WEEK = 604800000; const now = Date.now(); const lastNameChange = currentUser.lastNameChange?.toDate?.()?.getTime() || 0; const daysLeftName = Math.ceil((lastNameChange + ONE_WEEK - now) / (1000 * 60 * 60 * 24)); const canEditName = now - lastNameChange > ONE_WEEK; const lastUserChange = currentUser.lastUsernameChange?.toDate?.()?.getTime() || 0; const daysLeftUser = Math.ceil((lastUserChange + ONE_WEEK - now) / (1000 * 60 * 60 * 24)); const canEditUser = now - lastUserChange > ONE_WEEK; const ni = document.getElementById('edit-name'); ni.value = currentUser.name; ni.disabled = !canEditName; document.getElementById('name-change-hint').innerText = canEditName ? "You can change your name once a week." : `Wait ${daysLeftName} days to change name.`; document.getElementById('name-change-hint').className = canEditName ? "text-[10px] text-gray-400 mt-1" : "text-[10px] text-red-500 mt-1 font-medium"; const ui = document.getElementById('edit-username'); ui.value = currentUser.username || ""; ui.disabled = !canEditUser; document.getElementById('username-change-hint').innerText = canEditUser ? "You can change this once a week." : `Wait ${daysLeftUser} days to change username.`; document.getElementById('username-change-hint').className = canEditUser ? "text-[10px] text-gray-400" : "text-[10px] text-red-500 font-medium"; document.getElementById('username-counter').innerText = `${(currentUser.username || "").length}/20`; document.body.classList.add('modal-open'); toggleModalAnim('edit-profile-overlay', 'edit-profile-modal', !0) };
        window.closeEditProfile = () => { document.body.classList.remove('modal-open'); toggleModalAnim('edit-profile-overlay', 'edit-profile-modal', !1) }; window.handleEditAvatarSelect = e => { const f = e.target.files[0]; if (f) { currentAvatarBlob = f; const r = new FileReader(); r.onload = x => document.getElementById('edit-avatar-preview').src = x.target.result; r.readAsDataURL(f) } }; window.handleEditBannerSelect = e => { const f = e.target.files[0]; if (f) { currentBannerBlob = f; const r = new FileReader(); r.onload = x => document.getElementById('edit-banner-preview').src = x.target.result; r.readAsDataURL(f) } };
        window.saveProfileChanges = async () => { const n = document.getElementById('edit-name').value.trim(); const bio = document.getElementById('edit-bio').value; const un = document.getElementById('edit-username').value.trim().toLowerCase(); if (!n) return showToast("Name required", true); const ONE_WEEK = 604800000; const now = Date.now(); const nameChanged = n !== currentUser.name; const userChanged = un !== currentUser.username; if (nameChanged) { const lastNameChange = currentUser.lastNameChange?.toDate?.()?.getTime() || 0; if (now - lastNameChange < ONE_WEEK) return showToast("Name change limit reached", true) } if (userChanged) { const lastUserChange = currentUser.lastUsernameChange?.toDate?.()?.getTime() || 0; if (now - lastUserChange < ONE_WEEK) return showToast("Username limit reached", true); if (un.length < 3 || un.length > 20 || !/^[a-z0-9_.]+$/.test(un)) return showToast("Invalid username", true); const q = query(collection(db, "users"), where("username", "==", un)); const snap = await getDocs(q); if (!snap.empty && snap.docs[0].id !== currentUser.id) return showToast("Username taken", true) } const progOverlay = document.getElementById('action-progress-overlay'); const progBar = document.getElementById('action-progress-bar'); progOverlay.classList.remove('hidden'); progOverlay.classList.add('flex'); let pr = 0; const int = setInterval(() => { if (pr < 90) { pr += Math.random() * 5; progBar.style.width = `${Math.min(pr, 90)}%` } }, 100); try { let av = currentUser.avatar, bu = currentUser.banner; if (currentAvatarBlob) av = await uploadToImgHippo(currentAvatarBlob); if (currentBannerBlob) bu = await uploadToImgHippo(currentBannerBlob); const updateData = { name: n, bio: bio, avatar: av, banner: bu, bannerPos: currentBannerPos, username: un }; if (nameChanged) updateData.lastNameChange = serverTimestamp(); if (userChanged) updateData.lastUsernameChange = serverTimestamp(); await updateDoc(doc(db, "users", currentUser.id), updateData); Object.assign(currentUser, { name: n, bio: bio, avatar: av, banner: bu, bannerPos: currentBannerPos, username: un, lastNameChange: nameChanged ? { toDate: () => new Date() } : currentUser.lastNameChange, lastUsernameChange: userChanged ? { toDate: () => new Date() } : currentUser.lastUsernameChange }); currentAvatarBlob = currentBannerBlob = null; updateUserInterface(); clearInterval(int); progBar.style.width = '100%'; await new Promise(r => setTimeout(r, 500)); progOverlay.classList.add('hidden'); progOverlay.classList.remove('flex'); progBar.style.width = '0%'; closeEditProfile(); showProfile(currentUser.id, window.currentProfileTab); showToast("Profile Updated") } catch (e) { console.error(e); clearInterval(int); progOverlay.classList.add('hidden'); progOverlay.classList.remove('flex'); showToast("Update failed", true) } };
        window.openClaimOverlay = () => { manageHistory('claim-link-overlay'); const input = document.getElementById('claim-link-input'); input.value = window.currentClaimLink || ''; toggleModalAnim('claim-link-overlay', 'claim-link-modal', true); setTimeout(() => input.focus(), 100) }; window.closeClaimOverlay = () => toggleModalAnim('claim-link-overlay', 'claim-link-modal', false);
        window.saveClaimLink = () => { const input = document.getElementById('claim-link-input'), url = input.value.trim(); if (url && !url.startsWith('http://') && !url.startsWith('https://')) return showToast("Invalid URL", true); window.currentClaimLink = url || null; const ind = document.getElementById('claim-status-indicator'); if (ind) { if (url) { ind.innerText = 'On'; ind.classList.remove('text-gray-400'); ind.classList.add('text-green-600') } else { ind.innerText = 'Off'; ind.classList.remove('text-green-600'); ind.classList.add('text-gray-400') } } showToast(url ? "Link added" : "Link removed"); closeClaimOverlay() };
        window.openPostView = pid => {
            const p = posts.find(x => x.id === pid); if (!p) return; const a = users.find(u => u.id === p.authorId) || { name: 'Unknown', avatar: '' }, isMe = p.authorId === currentUser.id, isFollowing = currentUser.following.includes(p.authorId); if (!isMe && a.settings?.privateNetwork && !isFollowing) { showToast("This account is private"); return } manageHistory('post-view-overlay'); const o = document.getElementById('post-view-overlay'), c = document.getElementById('post-view-container'); window.currentViewingPostId = pid; window.isDesktopThreadMode = false; window.currentCommentFilter = 'latest'; window.commentSearchTerm = ''; window.isCommentSearchOpen = false; o.classList.remove('hidden'); o.classList.add('flex');
            const urlMatch = p.content.match(/(https?:\/\/[^\s]+)/), previewIdD = `preview-overlay-d-${p.id}`, previewIdM = `preview-overlay-m-${p.id}`;
            const previewHtmlD = urlMatch ? `<div id="${previewIdD}"></div>` : '', previewHtmlM = urlMatch ? `<div id="${previewIdM}"></div>` : '';
            if (urlMatch) {
                setTimeout(() => window.renderLinkPreview(urlMatch[0], previewIdD), 100);
                setTimeout(() => window.renderLinkPreview(urlMatch[0], previewIdM), 100);
            }
            let mhDesktop = '', mhMobile = ''; if (p.media) { const ma = Array.isArray(p.media) ? p.media : [p.media]; if (ma.length === 1) { const s = ma[0], iv = s.includes('video') || s.endsWith('.mp4') || s.startsWith('data:video'); const mhtml = iv ? `<video src="${s}" class="stage-content rounded-lg mt-3" controls playsinline></video>` : `<div class="img-placeholder rounded-lg mt-3 overflow-hidden"><img src="${s}" class="stage-content w-full h-full object-cover"></div>`; mhDesktop = mhtml; mhMobile = mhtml } else { mhDesktop = createCarouselHTML(ma, 'overlay-carousel-desktop', p.id); mhMobile = createCarouselHTML(ma, 'overlay-carousel-mobile', p.id) } } const isLiked = p.likes?.includes(currentUser.id), isSaved = savedPosts.includes(p.id), postBodyHtml = window.renderTextWithReadMore(p.content, `post-${p.id}`), allowComments = p.settings?.allowComments !== false, commentInputDesktop = allowComments ? `<div class="relative"><div id="mention-suggestions-desktop" class="mention-suggestions hidden"></div><div class="flex items-center gap-2"><img src="${currentUser.avatar}" class="w-8 h-8 rounded-full bg-gray-200 object-cover shrink-0"><input type="text" id="comment-input-desktop" placeholder="Add a comment..." class="flex-1 bg-[#f2f2f2] rounded-[24px] px-4 py-3.5 text-sm outline-none text-gray-900 placeholder-gray-500" onkeydown="handleMentionKeydown(event,'comment-input-desktop','mention-suggestions-desktop');if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();submitCommentDesktop();}" onkeyup="handleMentionInput('comment-input-desktop','mention-suggestions-desktop')"><button onclick="submitCommentDesktop()" class="w-10 h-10 bg-[#065fd4] rounded-full flex items-center justify-center text-white shrink-0 hover:bg-blue-700 transition-colors shadow-sm"><i data-lucide="arrow-up" class="w-5 h-5"></i></button></div></div>` : `<div class="bg-gray-50 text-gray-500 text-sm p-4 text-center italic border-t border-gray-100">Creator turned off commenting.</div>`, commentInputMobile = allowComments ? `<div class="relative"><div id="mention-suggestions-mobile" class="mention-suggestions hidden"></div><div class="flex items-center gap-2"><img src="${currentUser.avatar}" class="w-8 h-8 rounded-full bg-gray-200 object-cover shrink-0"><input type="text" id="mobile-comment-input" placeholder="Add a comment..." class="flex-1 bg-[#f2f2f2] rounded-[24px] px-4 py-3 text-sm outline-none text-gray-900 placeholder-gray-500" onkeydown="handleMentionKeydown(event,'mobile-comment-input','mention-suggestions-mobile')" onkeyup="handleMentionInput('mobile-comment-input','mention-suggestions-mobile')"><button onclick="submitCommentMobile()" class="w-10 h-10 bg-[#065fd4] rounded-full flex items-center justify-center text-white shrink-0 hover:bg-blue-700 transition-colors shadow-sm"><i data-lucide="arrow-up" class="w-5 h-5"></i></button></div></div>` : `<div class="bg-gray-50 text-gray-500 text-sm p-3 text-center italic rounded-xl mt-2">Creator turned off commenting.</div>`; const badge = a.isOfficial ? '<i data-lucide="badge-check" class="w-4 h-4 official-badge ml-1"></i>' : ''; const filterBtn = `<button onclick="openCommentFilter()" class="icon-btn hover:bg-gray-100"><i data-lucide="list-filter" class="w-5 h-5 text-gray-600"></i></button>`; const filterLabel = window.currentCommentFilter.charAt(0).toUpperCase() + window.currentCommentFilter.slice(1); const headerHtml = `<div class="px-4 py-3 bg-white sticky top-0 z-10 border-t border-b border-gray-300 transition-all"><div id="mobile-comment-header-default" class="flex items-center justify-between"><h3 class="font-bold text-gray-900 text-[15px]">Comments</h3><div class="flex items-center gap-2"><button onclick="toggleCommentSearch()" class="icon-btn w-8 h-8 bg-gray-50 hover:bg-gray-100"><i data-lucide="search" class="w-4 h-4 text-gray-600"></i></button><button onclick="openCommentFilter()" class="flex items-center gap-2 text-xs font-bold text-gray-600 bg-gray-100 px-3 py-1.5 rounded-full hover:bg-gray-200 transition-colors"><span id="current-filter-label">${filterLabel}</span> <i data-lucide="list-filter" class="w-4 h-4"></i></button></div></div><div id="mobile-comment-header-search" class="hidden flex items-center gap-2 w-full"><div class="relative flex-1"><i data-lucide="search" class="absolute left-3 top-2.5 w-4 h-4 text-gray-400"></i><input type="text" id="comment-search-input-mobile" oninput="handleCommentSearch(this.value)" class="w-full bg-gray-100 rounded-full py-2 pl-9 pr-4 text-sm outline-none" placeholder="Search..."></div><button onclick="toggleCommentSearch()" class="p-2 bg-gray-100 rounded-full"><i data-lucide="x" class="w-5 h-5 text-gray-600"></i></button></div></div>`;
            let desktopAction = '', mobileAction = ''; if (p.claimLink) { const cb = `<button class="action-btn text-[#0b57d0] border-blue-100 bg-blue-50 hover:bg-blue-100" onclick="event.stopPropagation(); confirmAndOpenLink('${p.claimLink}')"><i data-lucide="shopping-bag" class="w-4 h-4"></i> Claim</button>`; desktopAction = cb; mobileAction = cb } else { desktopAction = `<button class="action-btn bookmark js-save-btn-${p.id} ${isSaved ? 'active' : ''}" onclick="event.stopPropagation(); toggleSave('${p.id}')"><i data-lucide="bookmark"></i></button>`; mobileAction = `<button class="action-btn bookmark js-save-btn-${p.id} ${isSaved ? 'active' : ''}" onclick="event.stopPropagation(); toggleSave('${p.id}')"><i data-lucide="bookmark"></i></button>` }
            const desktopHTML = `<div class="desktop-split-view hidden md:flex"><div class="desktop-post-container"><div class="h-16 px-4 border-b border-gray-100 flex items-center justify-between sticky top-0 bg-white z-10"><div class="flex items-center gap-3 cursor-pointer" onclick="closePostView();showProfile('${a.id}')"><img src="${a.avatar}" class="w-10 h-10 rounded-full border border-gray-100 object-cover"><div><div class="font-bold text-gray-900 text-sm flex items-center">${a.name}${badge}</div><div class="text-xs text-gray-500">@${a.username || 'user'}</div></div></div><div class="flex items-center gap-2"><button onclick="showPostOptions(event, '${p.id}', '${p.authorId}')" class="w-8 h-8 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center"><i data-lucide="more-horizontal" class="w-5 h-5 text-gray-600"></i></button><button onclick="closePostView()" class="w-8 h-8 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center"><i data-lucide="x" class="w-5 h-5 text-gray-600"></i></button></div></div><div class="flex-1 overflow-y-auto p-4"><div class="text-[15px] leading-relaxed text-gray-900 whitespace-pre-wrap mb-4 js-post-body-${p.id}">${postBodyHtml}</div>${previewHtmlD}${mhDesktop}</div><div class="h-auto px-4 py-1 border-t border-gray-100 bg-white z-10"><div class="post-actions !pt-1 !pb-0"><button class="action-btn like js-like-btn-${p.id} ${isLiked ? 'active' : ''}" onclick="toggleLike('${p.id}')"><i data-lucide="heart"></i> <span class="js-like-count-${p.id}">${(p.likes?.length > 0) ? p.likes.length : 'Like'}</span></button><button class="action-btn comment" onclick="${allowComments ? 'document.getElementById(\'comment-input-desktop\').focus()' : ''}"><i data-lucide="message-circle"></i> <span class="js-comment-count-${p.id}">${(p.comments?.length > 0) ? p.comments.length : 'Comment'}</span></button><button class="action-btn share-btn" onclick="sharePost('${p.id}')"><i data-lucide="redo-2"></i> <span class="hidden sm:inline">Share</span></button><div class="flex-1"></div>${desktopAction}</div><div class="text-xs text-gray-500 mt-0.5 pl-1">${formatDate(p.timestamp)}</div></div></div><div class="desktop-comments-container"><div id="post-view-comments-header" class="h-16 flex items-center justify-between px-4 border-b border-gray-100 bg-white z-10"><div id="comment-header-default" class="flex items-center justify-between w-full"><span class="font-bold text-lg text-gray-900">Comments</span><div class="flex items-center gap-2"><button onclick="toggleCommentSearch()" class="icon-btn hover:bg-gray-100"><i data-lucide="search" class="w-5 h-5 text-gray-600"></i></button>${filterBtn}</div></div><div id="comment-header-search" class="hidden w-full flex items-center gap-2"><div class="relative flex-1"><i data-lucide="search" class="absolute left-3 top-2.5 w-4 h-4 text-gray-400"></i><input type="text" id="comment-search-input-desktop" oninput="handleCommentSearch(this.value)" class="w-full bg-gray-100 rounded-full py-2 pl-9 pr-4 text-sm outline-none" placeholder="Search comments..."></div><button onclick="toggleCommentSearch()" class="p-2 hover:bg-gray-100 rounded-full"><i data-lucide="x" class="w-5 h-5 text-gray-600"></i></button></div></div><div id="post-view-comments" class="flex-1 overflow-y-auto p-0"></div><div class="p-4 border-t border-gray-100">${commentInputDesktop}</div></div></div>`; const mobileHTML = `<div class="mobile-overlay-layout md:hidden"><div class="mobile-fixed-header"><span class="font-bold text-lg text-gray-900">Post</span><div class="flex items-center gap-2"><button onclick="showPostOptions(event, '${p.id}', '${p.authorId}')" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center"><i data-lucide="more-horizontal" class="w-5 h-5 text-gray-600"></i></button><button onclick="closePostView()" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center"><i data-lucide="x" class="w-5 h-5 text-gray-600"></i></button></div></div><div class="mobile-scroll-content"><div class="flex items-center gap-3 p-4 pb-2"><img src="${a.avatar}" class="w-10 h-10 rounded-full border border-gray-100 object-cover cursor-pointer" onclick="event.stopPropagation();openProfilePreview('${a.id}')"><div onclick="closePostView();showProfile('${a.id}')"><div class="font-bold text-gray-900 text-sm flex items-center">${a.name}${badge}</div><div class="text-xs text-gray-500">@${a.username || 'user'}</div></div></div><div class="px-4 py-2 text-[15px] leading-relaxed text-gray-900 whitespace-pre-wrap js-post-body-${p.id}">${postBodyHtml}</div><div class="px-4">${previewHtmlM}</div><div class="px-4 pb-4">${mhMobile}</div><div class="px-4 py-2 font-bold text-sm text-gray-900 mb-2 hidden" id="mobile-overlay-like-count-${p.id}">${(p.likes?.length > 0) ? p.likes.length + ' likes' : '0 likes'}</div>${headerHtml}<div id="mobile-post-comments" class="flex-1 p-0 pb-4"></div></div><div class="mobile-fixed-footer"><div class="post-actions mb-1 !pt-1 !pb-0"><button class="action-btn like js-like-btn-${p.id} ${isLiked ? 'active' : ''}" onclick="toggleLike('${p.id}')"><i data-lucide="heart"></i> <span class="js-like-count-${p.id}">${(p.likes?.length > 0) ? p.likes.length : 'Like'}</span></button><button class="action-btn comment" onclick="${allowComments ? 'document.getElementById(\'mobile-comment-input\').focus()' : ''}"><i data-lucide="message-circle"></i> <span class="js-comment-count-${p.id}">${(p.comments?.length > 0) ? p.comments.length : 'Comment'}</span></button><button class="action-btn share-btn" onclick="sharePost('${p.id}')"><i data-lucide="redo-2"></i> <span class="hidden sm:inline">Share</span></button><div class="flex-1"></div>${mobileAction}</div>${commentInputMobile}</div></div>`; c.innerHTML = desktopHTML + mobileHTML; renderCommentsInModal(pid); refreshIcons()
        };
        window.toggleCommentSearch = () => { window.isCommentSearchOpen = !window.isCommentSearchOpen; window.commentSearchTerm = ''; const dhd = document.getElementById('comment-header-default'), dhs = document.getElementById('comment-header-search'); if (dhd && dhs) { if (window.isCommentSearchOpen) { dhd.classList.add('hidden'); dhs.classList.remove('hidden'); setTimeout(() => document.getElementById('comment-search-input-desktop')?.focus(), 100) } else { dhd.classList.remove('hidden'); dhs.classList.add('hidden'); renderCommentsInModal(window.currentViewingPostId) } } const mhd = document.getElementById('mobile-comment-header-default'), mhs = document.getElementById('mobile-comment-header-search'); if (mhd && mhs) { if (window.isCommentSearchOpen) { mhd.classList.add('hidden'); mhs.classList.remove('hidden'); setTimeout(() => document.getElementById('comment-search-input-mobile')?.focus(), 100) } else { mhd.classList.remove('hidden'); mhs.classList.add('hidden'); renderCommentsInModal(window.currentViewingPostId) } } };
        window.handleCommentSearch = (val) => { window.commentSearchTerm = val.toLowerCase(); renderCommentsInModal(window.currentViewingPostId) };
        window.toggleMobileCommentDrawer = () => document.querySelector('.discussion-panel')?.classList.toggle('open'); window.closePostView = () => { const o = document.getElementById('post-view-overlay'); o.classList.add('hidden'); o.classList.remove('flex'); document.body.classList.remove('reel-mode'); document.querySelector('.discussion-panel')?.classList.remove('open'); window.currentViewingPostId = window.replyingToCommentId = null; window.isDesktopThreadMode = false; document.querySelector('#post-view-media-container video')?.pause() };
        window.doLogout = async () => { await auth.signOut(); window.location.href = "/login" };
        window.openCommentFilter = () => { manageHistory('comment-filter-overlay'); toggleModalAnim('comment-filter-overlay', 'comment-filter-modal', !0);['top', 'latest', 'oldest', 'verified', 'creator'].forEach(s => { const el = document.getElementById(`cfilter-check-${s}`); if (window.currentCommentFilter === s) el.classList.remove('hidden'); else el.classList.add('hidden') }) }; window.closeCommentFilter = () => toggleModalAnim('comment-filter-overlay', 'comment-filter-modal', !1);
        window.setCommentFilter = s => { window.currentCommentFilter = s; const l = document.querySelectorAll('#current-filter-label'); l.forEach(e => e.innerText = s.charAt(0).toUpperCase() + s.slice(1)); closeCommentFilter(); if (window.currentViewingPostId) renderCommentsInModal(window.currentViewingPostId) };
        window.currentMentionHighlight = -1;
        window.handleMentionInput = (inputId, suggestionsId) => { const input = document.getElementById(inputId), container = document.getElementById(suggestionsId); if (!input || !container) return; const val = input.value, cursorPos = input.selectionStart; const textBeforeCursor = val.substring(0, cursorPos); const atIndex = textBeforeCursor.lastIndexOf('@'); if (atIndex === -1 || (atIndex > 0 && /\S/.test(textBeforeCursor[atIndex - 1]))) { container.classList.add('hidden'); window.currentMentionHighlight = -1; return } const searchTerm = textBeforeCursor.substring(atIndex + 1).toLowerCase(); const spaceAfterAt = searchTerm.indexOf(' '); if (spaceAfterAt !== -1) { container.classList.add('hidden'); window.currentMentionHighlight = -1; return } const filtered = users.filter(u => { const name = (u.name || '').toLowerCase(), username = (u.username || '').toLowerCase(); return u.id !== currentUser.id && (name.startsWith(searchTerm) || username.startsWith(searchTerm)) }).slice(0, 8); if (filtered.length === 0) { container.classList.add('hidden'); window.currentMentionHighlight = -1; return } container.innerHTML = filtered.map((u, idx) => `<div class="mention-item ${idx === 0 ? 'highlighted' : ''}" data-index="${idx}" onclick="insertMention('${inputId}','${suggestionsId}','${u.username || 'user'}','${u.name}')"><img src="${u.avatar}" alt="${u.name}"><div><div class="mention-item-name">${u.name}</div><div class="mention-item-username">@${u.username || 'user'}</div></div></div>`).join(''); container.classList.remove('hidden'); window.currentMentionHighlight = 0 };
        window.handleMentionKeydown = (event, inputId, suggestionsId) => { const container = document.getElementById(suggestionsId); if (!container || container.classList.contains('hidden')) return; const items = container.querySelectorAll('.mention-item'); if (items.length === 0) return; if (event.key === 'ArrowDown') { event.preventDefault(); window.currentMentionHighlight = Math.min(window.currentMentionHighlight + 1, items.length - 1); items.forEach((item, idx) => { item.classList.toggle('highlighted', idx === window.currentMentionHighlight) }); items[window.currentMentionHighlight].scrollIntoView({ block: 'nearest' }) } else if (event.key === 'ArrowUp') { event.preventDefault(); window.currentMentionHighlight = Math.max(window.currentMentionHighlight - 1, 0); items.forEach((item, idx) => { item.classList.toggle('highlighted', idx === window.currentMentionHighlight) }); items[window.currentMentionHighlight].scrollIntoView({ block: 'nearest' }) } else if (event.key === 'Enter' && !event.shiftKey) { if (window.currentMentionHighlight >= 0 && items[window.currentMentionHighlight]) { event.preventDefault(); items[window.currentMentionHighlight].click() } } else if (event.key === 'Escape') { event.preventDefault(); container.classList.add('hidden'); window.currentMentionHighlight = -1 } };
        window.insertMention = (inputId, suggestionsId, username, name) => { const input = document.getElementById(inputId), container = document.getElementById(suggestionsId); if (!input || !container) return; const val = input.value, cursorPos = input.selectionStart, textBefore = val.substring(0, cursorPos), atIndex = textBefore.lastIndexOf('@'); if (atIndex === -1) return; const textAfter = val.substring(cursorPos), newText = val.substring(0, atIndex) + `@${username} ` + textAfter; input.value = newText; const newCursorPos = atIndex + username.length + 2; input.setSelectionRange(newCursorPos, newCursorPos); input.focus(); container.classList.add('hidden'); window.currentMentionHighlight = -1 };
        function renderCommentsInModal(pid) { const p = posts.find(x => x.id === pid); if (!p) return; const desktopC = document.getElementById('post-view-comments'), mobileC = document.getElementById('mobile-post-comments'); let topLevel = p.comments?.filter(x => !x.parentId) || []; const filter = window.currentCommentFilter; if (window.commentSearchTerm) { const term = window.commentSearchTerm; topLevel = topLevel.filter(c => { const auth = users.find(u => u.id === c.authorId) || {}; const textMatch = c.content.toLowerCase().includes(term); const nameMatch = (auth.name || '').toLowerCase().includes(term); const userMatch = (auth.username || '').toLowerCase().includes(term); return textMatch || nameMatch || userMatch }) } if (filter === 'verified') { topLevel = topLevel.filter(c => { const u = users.find(user => user.id === c.authorId); return u && u.isOfficial }) } else if (filter === 'creator') { topLevel = topLevel.filter(c => c.authorId === p.authorId) } if (filter === 'top') { topLevel.sort((a, b) => (b.likes?.length || 0) - (a.likes?.length || 0)) } else if (filter === 'oldest') { topLevel.sort((a, b) => a.timestamp - b.timestamp) } else { topLevel.sort((a, b) => b.timestamp - a.timestamp) } const html = topLevel.length ? topLevel.map(c => { const replyCount = p.comments.filter(r => r.parentId === c.id).length; return createCommentHTML(c, pid, replyCount) }).join('') : '<div class="flex flex-col items-center justify-center py-10 text-gray-400"><i data-lucide="message-square" class="w-12 h-12 mb-2 opacity-50"></i><p>No comments found.</p></div>'; if (desktopC && !window.isDesktopThreadMode) desktopC.innerHTML = html; if (mobileC) mobileC.innerHTML = html; refreshIcons() }
        function createCommentHTML(c, pid, replyCount) {
            const p = posts.find(x => x.id === pid); const isAuthorLiked = p && c.likes && c.likes.includes(p.authorId); let authorBadge = ''; if (isAuthorLiked) { const pa = users.find(u => u.id === p.authorId); if (pa) { authorBadge = `<div class="flex items-center gap-1.5 mt-1 w-fit"><div class="relative w-4 h-4 shrink-0"><img src="${pa.avatar}" class="w-full h-full rounded-full object-cover border border-white"><div class="absolute -bottom-0.5 -right-0.5 bg-red-500 rounded-full p-[2px] border border-white flex items-center justify-center"><i data-lucide="heart" class="w-1.5 h-1.5 text-white fill-white"></i></div></div><span class="text-[10px] text-gray-500 font-medium">Liked by author</span></div>` } }
            const a = users.find(u => u.id === c.authorId) || { name: 'Unknown', avatar: '', username: 'user' }, replyHandle = a.username || "user", isMe = c.authorId === currentUser.id, isLiked = c.likes && c.likes.includes(currentUser.id), likeCount = c.likes ? c.likes.length : 0;
            const urlMatch = c.content.match(/(https?:\/\/[^\s]+)/), previewId = `preview-comment-${c.id}`, previewHtml = urlMatch ? `<div id="${previewId}"></div>` : '';
            if (urlMatch) setTimeout(() => window.renderLinkPreview(urlMatch[0], previewId), 100);
            const repliesBtn = replyCount > 0 ? `<div class="view-replies-btn mt-1" onclick="openThread('${pid}','${c.id}')">View ${replyCount} ${replyCount === 1 ? '' : 's'}</div>` : ''; const actionsHtml = `<div class="float-right flex items-center gap-1 ml-2 mb-1"><button class="w-8 h-8 rounded-full bg-gray-50 hover:bg-gray-100 flex items-center justify-center transition-colors ${isLiked ? 'text-red-500 bg-red-50' : 'text-gray-700'}" onclick="toggleCommentLike('${pid}','${c.id}')"><i data-lucide="heart" class="${isLiked ? 'fill-current' : ''} w-4 h-4"></i></button><button class="w-8 h-8 rounded-full bg-gray-50 hover:bg-gray-100 flex items-center justify-center text-gray-700 transition-colors" onclick="replyToComment('${c.id}','${replyHandle}')"><i data-lucide="corner-down-right" class="w-4 h-4"></i></button><button class="w-8 h-8 rounded-full bg-gray-50 hover:bg-gray-100 flex items-center justify-center text-gray-700 transition-colors" onclick="openCommentMoreMenu('${c.id}','${pid}','${c.timestamp}',${isMe})"><i data-lucide="more-horizontal" class="w-4 h-4"></i></button></div>`; return `<div class="comment-item flex gap-3 px-4 py-3 relative group transition-colors hover:bg-gray-50/50 border-b border-gray-100 last:border-0"><img src="${a.avatar}" class="w-9 h-9 rounded-full object-cover border border-gray-100 shrink-0 cursor-pointer mt-0.5" onclick="event.stopPropagation();openProfilePreview('${a.id}')"><div class="flex-1 min-w-0">${actionsHtml}<div class="flex items-center gap-1 mb-0.5"><span onclick="closePostView();showProfile('${c.authorId}')" class="font-bold text-[13px] text-gray-900 cursor-pointer hover:underline">@${a.username || 'user'}</span>${a.isOfficial ? '<i data-lucide="badge-check" class="w-3.5 h-3.5 official-badge ml-1"></i>' : ''}${a.banned ? '<i data-lucide="ban" class="w-3 h-3 text-red-500 ml-1"></i>' : ''}<span class="text-xs text-gray-500 ml-1 font-normal"> ${formatDate(c.timestamp)}</span></div><div class="text-[14px] text-gray-800 leading-relaxed break-words js-comment-body-${c.id}">${window.renderTextWithReadMore(c.content, `comment-${c.id}`)}</div>${previewHtml}${authorBadge}<div class="flex items-center gap-3 mt-1.5 min-h-[16px]">${repliesBtn}<span class="text-xs text-gray-500 font-medium">${likeCount} like${likeCount === 1 ? '' : 's'}</span></div></div></div>`
        }
        window.openCommentMoreMenu = (cid, pid, ts, isMe) => { manageHistory('comment-options-overlay'); const o = document.getElementById('comment-options-overlay'), m = document.getElementById('comment-options-modal'), c = document.getElementById('comment-options-content'); c.innerHTML = `<div class="p-2">${isMe ? `<button onclick="deleteComment('${pid}','${cid}'); closeCommentOptions()" class="flex items-center gap-4 w-full p-4 hover:bg-red-50 rounded-xl transition-colors font-bold text-red-600 text-left group"><div class="w-10 h-10 rounded-full bg-red-100 flex items-center justify-center group-hover:bg-red-200 transition-colors"><i data-lucide="trash-2" class="w-5 h-5"></i></div><span>Delete Comment</span></button>` : `<button onclick="showToast('Reported'); closeCommentOptions()" class="flex items-center gap-4 w-full p-4 hover:bg-gray-50 rounded-xl transition-colors font-bold text-gray-700 text-left group"><div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center group-hover:bg-gray-200 transition-colors"><i data-lucide="flag" class="w-5 h-5"></i></div><span>Report Comment</span></button>`}</div>`; refreshIcons(); toggleModalAnim('comment-options-overlay', 'comment-options-modal', !0) };
        window.closeCommentOptions = () => toggleModalAnim('comment-options-overlay', 'comment-options-modal', !1);
        window.openThread = (pid, cid) => { if (window.innerWidth >= 768) { window.isDesktopThreadMode = true; window.threadPostId = pid; window.threadParentCommentId = cid; renderDesktopThread(pid, cid); return } manageHistory('thread-overlay'); window.threadPostId = pid; window.threadParentCommentId = cid; renderThreadContent(pid, cid); document.getElementById('thread-overlay').classList.remove('hidden'); setTimeout(() => { document.getElementById('thread-input').focus(); document.getElementById('thread-input-avatar').src = currentUser.avatar }, 100) }; window.closeThread = () => { document.getElementById('thread-overlay').classList.add('hidden'); if (!window.currentViewingPostId) { window.threadPostId = null; window.threadParentCommentId = null } window.replyingToCommentId = null; window.isDesktopThreadMode = false; if (window.currentViewingPostId && window.innerWidth >= 768) renderCommentsInModal(window.currentViewingPostId) };
        window.renderDesktopThread = (pid, cid) => { const p = posts.find(x => x.id === pid); if (!p) return; const parent = p.comments.find(x => x.id === cid); if (!parent) return; const replies = p.comments.filter(x => x.parentId === cid), pa = users.find(u => u.id === parent.authorId) || { name: 'Unknown', avatar: '', username: 'user' }, header = document.getElementById('post-view-comments-header'); if (header) header.innerHTML = `<div class="flex items-center gap-3"><button onclick="closeThread()" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center hover:bg-gray-200"><i data-lucide="arrow-left" class="w-5 h-5 text-gray-600"></i></button><span>Replies to @${pa.username || 'user'}</span></div>`; const html = `<div class="pt-2 pb-0 relative">${createCommentHTML(parent, pid, 0)}<div class="replies-line-container">${replies.length > 0 ? replies.map(r => createCommentHTML(r, pid, 0)).join('') : '<div class="text-xs text-gray-400 pl-4 py-4">No replies yet. Be the first to reply!</div>'}</div></div>`; document.getElementById('post-view-comments').innerHTML = html; refreshIcons() };
        window.renderThreadContent = (pid, cid) => { const p = posts.find(x => x.id === pid); if (!p) return; const parent = p.comments.find(x => x.id === cid); if (!parent) return; const replies = p.comments.filter(x => x.parentId === cid); const html = `<div class="pt-2 pb-0 relative">${createCommentHTML(parent, pid, 0)}<div class="replies-line-container">${replies.length > 0 ? replies.map(r => createCommentHTML(r, pid, 0)).join('') : '<div class="text-xs text-gray-400 pl-4 py-4">No replies yet. Be the first to reply!</div>'}</div></div>`; const c = document.getElementById('thread-content'); c.innerHTML = html; refreshIcons() };
        window.submitThreadReply = async () => { const t = document.getElementById('thread-input').value.trim(); if (!t || !window.threadPostId || !window.threadParentCommentId) return; const r = doc(db, "posts", window.threadPostId), nc = { id: "c-" + Date.now() + "-" + Math.floor(Math.random() * 1000), authorId: currentUser.id, content: t, timestamp: Date.now(), likes: [], parentId: window.threadParentCommentId }; await updateDoc(r, { comments: arrayUnion(nc) }); const p = posts.find(x => x.id === window.threadPostId), pc = p.comments.find(x => x.id === window.threadParentCommentId); if (pc && pc.authorId !== currentUser.id) sendNotification(pc.authorId, 'reply', 'replied to your comment', window.threadPostId); const mm = t.match(/@(\w+)/g); if (mm) { mm.forEach(m => { const uname = m.substring(1).toLowerCase(), found = users.find(u => (u.username || "").toLowerCase() === uname); if (found && found.id !== currentUser.id) sendNotification(found.id, 'mention', 'mentioned you in a reply', window.threadPostId) }) } document.getElementById('thread-input').value = "" };
        window.deleteComment = async (pid, cid) => { showAlert("Delete comment?", async () => { const r = doc(db, "posts", pid), p = posts.find(x => x.id === pid), nc = p.comments.filter(x => x.id !== cid && x.parentId !== cid); await updateDoc(r, { comments: nc }); showToast("Deleted") }) };
        window.toggleCommentLike = async (pid, cid) => { const p = posts.find(x => x.id === pid); if (!p) return; const c = p.comments || [], i = c.findIndex(x => x.id === cid); if (i === -1) return; const cm = c[i]; if (!cm.likes) cm.likes = []; if (cm.likes.includes(currentUser.id)) cm.likes = cm.likes.filter(x => x !== currentUser.id); else { cm.likes.push(currentUser.id); if (cm.authorId !== currentUser.id) sendNotification(cm.authorId, 'like', 'liked your comment', pid) } c[i] = cm; await updateDoc(doc(db, "posts", pid), { comments: c }) };
        window.replyToComment = (cid, u) => { const p = posts.find(p => p.comments && p.comments.some(c => c.id === cid)); if (p) window.openThread(p.id, cid) };
        window.submitCommentDesktop = async () => { const t = document.getElementById('comment-input-desktop').value.trim(); if (!t || !window.currentViewingPostId) return; if (window.isDesktopThreadMode && window.threadParentCommentId) { window.replyingToCommentId = window.threadParentCommentId; await postCommentCommon(t); window.replyingToCommentId = null } else await postCommentCommon(t); document.getElementById('comment-input-desktop').value = "" }; window.submitCommentMobile = async () => { const t = document.getElementById('mobile-comment-input').value.trim(); if (!t || !window.currentViewingPostId) return; await postCommentCommon(t); document.getElementById('mobile-comment-input').value = "" };
        async function postCommentCommon(t) { const r = doc(db, "posts", window.currentViewingPostId), nc = { id: "c-" + Date.now() + "-" + Math.floor(Math.random() * 1000), authorId: currentUser.id, content: t, timestamp: Date.now(), likes: [], parentId: window.replyingToCommentId }; await updateDoc(r, { comments: arrayUnion(nc) }); const p = posts.find(x => x.id === window.currentViewingPostId); if (window.replyingToCommentId) { const pc = p.comments.find(x => x.id === window.replyingToCommentId); if (pc && pc.authorId !== currentUser.id) sendNotification(pc.authorId, 'reply', 'replied to your comment', window.currentViewingPostId) } else if (p && p.authorId !== currentUser.id) sendNotification(p.authorId, 'comment', 'commented on your post', window.currentViewingPostId); const mm = t.match(/@(\w+)/g); if (mm) { mm.forEach(m => { const uname = m.substring(1).toLowerCase(), found = users.find(u => (u.username || "").toLowerCase() === uname); if (found && found.id !== currentUser.id) sendNotification(found.id, 'mention', 'mentioned you in a comment', window.currentViewingPostId) }) } window.replyingToCommentId = null }
        window.promptForImageLink = () => { const u = prompt("Enter Image URL:"); if (u && (u.startsWith('http') || u.startsWith('data:'))) { window.currentMedia = [u]; window.currentMediaType = 'image'; document.getElementById('media-preview-container').classList.remove('hidden'); document.getElementById('preview-inner').innerHTML = `<img src="${u}" class="h-20 w-20 object-cover rounded-md">`; showToast("Added") } };
        window.openAnnouncement = () => { manageHistory('announcement-overlay'); const o = document.getElementById('announcement-overlay'); toggleModalAnim('announcement-overlay', 'announcement-overlay-modal', !0); closeSettings() }; window.closeAnnouncement = () => { toggleModalAnim('announcement-overlay', 'announcement-overlay-modal', !1) };
        window.sendAnnouncement = async () => { const t = document.getElementById('announcement-text').value.trim(); if (!t) return; showAlert("Broadcast?", async () => { for (const u of users) if (u.id !== currentUser.id) await addDoc(collection(db, "notifications"), { receiverId: u.id, senderId: currentUser.id, type: 'system', content: t, timestamp: serverTimestamp(), read: !1 }); showToast("Sent"); document.getElementById('announcement-text').value = ""; closeAnnouncement() }) };
        window.openCreateMenu = () => { manageHistory('create-menu-overlay'); toggleModalAnim('create-menu-overlay', 'create-menu-modal', !0) }; window.closeCreateMenu = () => { toggleModalAnim('create-menu-overlay', 'create-menu-modal', !1) }; window.openEventComposer = () => { manageHistory('event-overlay'); closeCreateMenu(); removeEventCover(); document.getElementById('event-overlay').classList.remove('opacity-0', 'pointer-events-none'); document.getElementById('event-modal-box').classList.remove('scale-95') }; window.closeEventComposer = () => { document.getElementById('event-overlay').classList.add('opacity-0', 'pointer-events-none'); document.getElementById('event-modal-box').classList.add('scale-95') };
        window.handleEventCoverSelect = e => { const f = e.target.files[0]; if (f) { currentEventCoverBlob = f; const r = new FileReader(); r.onload = x => { window.currentEventCover = x.target.result; document.getElementById('event-cover-preview').src = window.currentEventCover; document.getElementById('event-cover-preview-container').classList.remove('hidden'); document.getElementById('add-cover-btn').classList.add('hidden') }; r.readAsDataURL(f) } }; window.removeEventCover = () => { window.currentEventCover = null; currentEventCoverBlob = null; document.getElementById('event-cover-preview').src = ""; document.getElementById('event-cover-preview-container').classList.add('hidden'); document.getElementById('add-cover-btn').classList.remove('hidden'); document.getElementById('event-cover-input').value = "" }; window.publishEvent = () => { showToast("Coming soon!", !1); closeEventComposer() };
        window.showPostOptions = (e, pid, aid) => { e.stopPropagation(); manageHistory('post-options-overlay'); const o = document.getElementById('post-options-overlay'), m = document.getElementById('post-options-modal'), c = document.getElementById('post-options-content'), me = aid === currentUser.id, adm = currentUser.email === 'edulinkbht@gmail.com', p = posts.find(x => x.id === pid); const postTime = p.timestamp?.toDate ? p.timestamp.toDate() : new Date(p.timestamp); const canEdit = me && (Date.now() - postTime.getTime() < 604800000); let h = ''; if (me) { if (canEdit) h += `<button onclick="editPost('${pid}'); hidePostMenu()" class="flex items-center gap-3 w-full p-4 hover:bg-gray-50 rounded-xl transition-colors font-bold text-gray-800 text-left"><i data-lucide="edit-2" class="w-5 h-5"></i> Edit Post</button>`; } if (me || adm) h += `<button onclick="deletePost('${pid}'); hidePostMenu()" class="flex items-center gap-3 w-full p-4 hover:bg-red-50 rounded-xl transition-colors font-bold text-red-600 text-left"><i data-lucide="trash-2" class="w-5 h-5"></i> Delete Post</button>`; if (!me) { const s = savedPosts.includes(pid); h += `<button onclick="toggleSave('${pid}'); hidePostMenu()" class="flex items-center gap-3 w-full p-4 hover:bg-gray-50 rounded-xl transition-colors font-bold text-gray-800 text-left"><i data-lucide="bookmark" class="w-5 h-5 ${s ? 'fill-yellow-500 text-yellow-500' : ''}"></i> ${s ? 'Unsave' : 'Save'} Post</button>`; h += `<button onclick="trackInteraction('${pid}','not_interested'); hidePostMenu()" class="flex items-center gap-3 w-full p-4 hover:bg-gray-50 rounded-xl transition-colors font-bold text-gray-800 text-left"><i data-lucide="eye-off" class="w-5 h-5"></i> Not Interested</button>`; h += `<button onclick="trackInteraction('${pid}','show_more',10); hidePostMenu()" class="flex items-center gap-3 w-full p-4 hover:bg-gray-50 rounded-xl transition-colors font-bold text-gray-800 text-left"><i data-lucide="trending-up" class="w-5 h-5"></i> Show me more of this</button>`; h += `<button onclick="showToast('Reported'); hidePostMenu()" class="flex items-center gap-3 w-full p-4 hover:bg-red-50 rounded-xl transition-colors font-bold text-red-600 text-left"><i data-lucide="flag" class="w-5 h-5"></i> Report Post</button>` } h += `<button onclick="sharePost('${pid}'); hidePostMenu()" class="flex items-center gap-3 w-full p-4 hover:bg-gray-50 rounded-xl transition-colors font-bold text-gray-800 text-left"><i data-lucide="link" class="w-5 h-5"></i> Copy Link</button>`; c.innerHTML = h; refreshIcons(); m.style.transform = ''; m.style.transition = 'none'; o.classList.add('opacity-0'); m.classList.add('translate-y-full', 'md:scale-95'); m.classList.remove('translate-y-0', 'md:scale-100'); o.classList.remove('hidden'); void m.offsetWidth; m.style.transition = ''; setTimeout(() => { o.classList.remove('opacity-0'); m.classList.remove('translate-y-full', 'md:scale-95'); m.classList.add('translate-y-0', 'md:scale-100') }, 20) };
        window.hidePostMenu = () => { const o = document.getElementById('post-options-overlay'), m = document.getElementById('post-options-modal'); o.classList.add('opacity-0'); m.classList.add('translate-y-full', 'md:scale-95'); m.classList.remove('translate-y-0', 'md:scale-100'); setTimeout(() => o.classList.add('hidden'), 200) };
        window.editPost = pid => { const p = posts.find(x => x.id === pid); if (!p) return; document.getElementById('compose-text').value = p.content; window.editingPostId = pid; document.getElementById('compose-header-title').innerText = "Edit Post"; window.composeImages = [null, null, null, null]; window.composeImageBlobs = [null, null, null, null]; if (p.media) { const m = Array.isArray(p.media) ? p.media : [p.media]; m.forEach((url, i) => { if (i < 4) window.composeImages[i] = url }) } renderMediaGrid(); window.composeStep = 1; document.getElementById('compose-step-1').classList.remove('hidden'); document.getElementById('compose-step-2').classList.add('hidden'); document.getElementById('compose-footer-settings').classList.add('hidden'); const hasImage = window.composeImages.some(x => x !== null), btn = document.getElementById('compose-action-btn'); btn.innerText = hasImage ? "Next" : "Skip"; btn.onclick = window.handleComposeAction; openCompose(!0) }; window.deletePost = async pid => { showAlert("Delete post?", async () => { await deleteDoc(doc(db, "posts", pid)); showToast("Deleted") }) };
        window.openCompose = (isEdit = false) => {
            manageHistory('compose-overlay'); closeCreateMenu(); document.getElementById('compose-overlay').classList.remove('opacity-0', 'pointer-events-none'); const modal = document.getElementById('compose-modal'); modal.classList.remove('scale-95'); modal.classList.remove('translate-y-full');
            if (modal) {
                modal.ondragover = e => { e.preventDefault(); modal.classList.add('drag-over') };
                modal.ondragleave = () => modal.classList.remove('drag-over');
                modal.ondrop = e => { e.preventDefault(); modal.classList.remove('drag-over'); const files = e.dataTransfer.files; if (files.length) handleDroppedFiles(files) };
            }
            if (!isEdit) { window.composeStep = 1; window.composeImages = [null, null, null, null]; window.composeImageBlobs = [null, null, null, null]; window.selectedCollaborators = []; window.editingPostId = null; window.currentClaimLink = null; document.getElementById('claim-link-input').value = ''; const ci = document.getElementById('claim-status-indicator'); if (ci) { ci.innerText = 'Off'; ci.classList.remove('text-green-600'); ci.classList.add('text-gray-400') } document.getElementById('compose-text').value = ""; document.getElementById('word-count-display').innerText = "0/500 words"; document.getElementById('compose-header-title').innerText = "Create Post"; document.getElementById('compose-step-1').classList.remove('hidden'); document.getElementById('compose-step-2').classList.add('hidden'); document.getElementById('compose-action-btn').innerText = "Skip"; renderMediaGrid(); renderCollabChips() }
        };
        window.handleDroppedFiles = files => {
            const count = Math.min(files.length, 4);
            let added = 0;
            for (let i = 0; i < 4 && added < count; i++) {
                if (window.composeImages[i] === null) {
                    const file = files[added];
                    if (file.type.startsWith('image/') || file.type.startsWith('video/')) {
                        const reader = new FileReader();
                        const idx = i;
                        reader.onload = ev => {
                            window.composeImages[idx] = ev.target.result;
                            window.composeImageBlobs[idx] = file;
                            renderMediaGrid();
                        };
                        reader.readAsDataURL(file);
                        added++;
                    }
                }
            }
            if (added > 0) showToast(`${added} file(s) added`);
        };
        window.checkWordCount = e => { const w = e.value.trim().split(/\s+/).filter(x => x).length; document.getElementById('word-count-display').innerText = `${w}/500 words` };
        window.attemptCloseCompose = () => { const hc = document.getElementById('compose-text').value.trim().length > 0 || window.composeImages.some(x => x !== null); if (hc && !window.editingPostId) showAlert("Discard post?", () => closeCompose()); else closeCompose() };
        window.closeCompose = () => { document.getElementById('compose-overlay').classList.add('opacity-0', 'pointer-events-none'); const modal = document.getElementById('compose-modal'); modal.classList.add('scale-95'); modal.classList.add('translate-y-full'); setTimeout(() => { window.editingPostId = null; document.getElementById('compose-text').value = ""; window.composeImages = [null, null, null, null]; window.composeImageBlobs = [null, null, null, null] }, 200) };
        window.toggleComposeSettings = () => { const a = document.getElementById('compose-settings-area'), ar = document.getElementById('compose-settings-arrow'); a.classList.toggle('hidden'); ar.style.transform = a.classList.contains('hidden') ? 'rotate(0deg)' : 'rotate(180deg)' };
        window.openUploadOptions = () => document.getElementById('upload-options-modal').classList.remove('hidden'); window.triggerUpload = m => { window.uploadMode = m; document.getElementById('upload-options-modal').classList.add('hidden'); const i = document.getElementById('media-input'); if (m === 'multiple') i.setAttribute('multiple', ''); else i.removeAttribute('multiple'); i.click() }; window.handleFileSelect = e => { const f = e.target.files; if (f.length > 0) { window.currentMediaBlob = []; window.currentMedia = []; const c = document.getElementById('media-preview-container'), inr = document.getElementById('preview-inner'); c.classList.remove('hidden'); inr.innerHTML = ''; const ps = Array.from(f).map(file => { window.currentMediaBlob.push(file); return new Promise(r => { const d = new FileReader(); d.onload = ev => { window.currentMedia.push(ev.target.result); const iv = file.type.startsWith('video'), el = document.createElement(iv ? 'video' : 'img'); el.src = ev.target.result; el.className = "h-20 w-20 object-cover rounded-md border border-gray-200 shrink-0"; inr.appendChild(el); r() }; d.readAsDataURL(file) }) }); Promise.all(ps).then(() => showToast(`${f.length} file(s) ready`)) } }; window.removeMedia = () => { window.currentMedia = []; window.currentMediaBlob = []; document.getElementById('media-preview-container').classList.add('hidden'); document.getElementById('media-input').value = "" };
        window.renderMediaGrid = () => { const grid = document.getElementById('media-grid-container'), btn = document.getElementById('compose-action-btn'); grid.innerHTML = ''; let hasImage = false; for (let i = 0; i < 4; i++) { const url = window.composeImages[i], div = document.createElement('div'); div.className = "aspect-square border-2 border-dashed border-gray-300 rounded-xl flex items-center justify-center relative overflow-hidden bg-gray-50 transition-colors"; if (url) { hasImage = true; div.className = "aspect-square rounded-xl overflow-hidden relative shadow-sm border border-gray-200 cursor-pointer hover:opacity-90 transition-opacity"; div.onclick = () => openImageAdjust(i); if (url.includes('video') || url.endsWith('.mp4') || (window.composeImageBlobs[i] && window.composeImageBlobs[i].type.startsWith('video'))) div.innerHTML = `<video src="${url}" class="w-full h-full object-cover pointer-events-none"></video><button onclick="event.stopPropagation();removeGridImage(${i})" class="absolute top-2 right-2 bg-black/60 text-white p-1 rounded-full hover:bg-black/80"><i data-lucide="x" class="w-4 h-4"></i></button>`; else div.innerHTML = `<img src="${url}" class="w-full h-full object-cover" id="compose-img-${i}"><button onclick="event.stopPropagation();removeGridImage(${i})" class="absolute top-2 right-2 bg-black/60 text-white p-1 rounded-full hover:bg-black/80"><i data-lucide="x" class="w-4 h-4"></i></button>` } else { const isNext = (i === 0) || (window.composeImages[i - 1] !== null); if (isNext) { div.innerHTML = `<i data-lucide="plus" class="w-8 h-8 text-gray-400"></i>`; div.classList.add('cursor-pointer', 'hover:bg-gray-100'); div.onclick = () => window.handleGridUpload(i) } else { div.innerHTML = ''; div.className = "aspect-square border-2 border-dashed border-gray-200 rounded-xl bg-transparent" } } grid.appendChild(div) } if (window.composeStep === 1) { btn.innerText = hasImage ? "Next" : "Skip"; btn.onclick = window.handleComposeAction } refreshIcons() };
        window.openImageAdjust = i => {
            const url = window.composeImages[i]; if (!url || url.includes('video') || url.endsWith('.mp4')) return; window.adjustingImageIndex = i; window.adjustZoom = 1; window.adjustX = 0; window.adjustY = 0; manageHistory('adjust-image-overlay'); const o = document.getElementById('adjust-image-overlay'), img = document.getElementById('adjust-image-target'); img.src = url; img.style.transform = `translate(0px, 0px) scale(1)`; document.getElementById('adjust-zoom-range').value = 1; o.classList.remove('hidden'); setTimeout(() => o.classList.remove('opacity-0'), 20);
            const wrap = document.getElementById('adjust-image-wrapper');
            const startDrag = e => { isDraggingImage = !0; dragStartX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX; dragStartY = e.type.includes('mouse') ? e.clientY : e.touches[0].clientY; initialX = window.adjustX; initialY = window.adjustY };
            const doDrag = e => { if (!isDraggingImage) return; e.preventDefault(); const x = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX, y = e.type.includes('mouse') ? e.clientY : e.touches[0].clientY, dx = x - dragStartX, dy = y - dragStartY; window.adjustX = initialX + dx; window.adjustY = initialY + dy; updateImageAdjust() };
            const endDrag = () => { isDraggingImage = !1 };
            wrap.onmousedown = startDrag; wrap.ontouchstart = startDrag; window.onmousemove = doDrag; window.ontouchmove = doDrag; window.onmouseup = endDrag; window.ontouchend = endDrag;
        };
        window.updateImageAdjust = () => { const z = document.getElementById('adjust-zoom-range').value; window.adjustZoom = z; document.getElementById('adjust-image-target').style.transform = `translate(${window.adjustX}px, ${window.adjustY}px) scale(${z})` };
        window.closeImageAdjust = () => { const o = document.getElementById('adjust-image-overlay'); o.classList.add('opacity-0'); setTimeout(() => { o.classList.add('hidden'); window.adjustingImageIndex = null }, 200) };
        window.saveImageAdjust = () => {
            const i = window.adjustingImageIndex; if (i === null) return; const img = document.getElementById('adjust-image-target'), canvas = document.createElement('canvas'), ctx = canvas.getContext('2d'), w = img.naturalWidth, h = img.naturalHeight, wrapper = document.getElementById('adjust-image-wrapper'), rect = wrapper.getBoundingClientRect();
            canvas.width = 1080; canvas.height = 1080;
            const scaleFactor = 1080 / rect.width;
            ctx.fillStyle = '#000'; ctx.fillRect(0, 0, 1080, 1080);
            ctx.translate(canvas.width / 2, canvas.height / 2);
            ctx.translate(window.adjustX * scaleFactor, window.adjustY * scaleFactor);
            ctx.scale(window.adjustZoom, window.adjustZoom);
            const ratio = Math.min(rect.width / w, rect.height / h);
            const renderedW = w * ratio * scaleFactor;
            const renderedH = h * ratio * scaleFactor;
            ctx.drawImage(img, -renderedW / 2, -renderedH / 2, renderedW, renderedH);
            canvas.toBlob(b => { window.composeImageBlobs[i] = b; const u = URL.createObjectURL(b); window.composeImages[i] = u; renderMediaGrid(); closeImageAdjust() }, 'image/jpeg', 0.95);
        };
        window.handleGridUpload = i => { window.currentUploadIndex = i; document.getElementById('grid-upload-input').click() }; window.onGridFileSelect = e => { const f = e.target.files[0]; if (!f) return; const r = new FileReader(); r.onload = ev => { window.composeImages[window.currentUploadIndex] = ev.target.result; window.composeImageBlobs[window.currentUploadIndex] = f; renderMediaGrid() }; r.readAsDataURL(f); document.getElementById('grid-upload-input').value = "" }; window.removeGridImage = i => { window.composeImages[i] = null; window.composeImageBlobs[i] = null; const v = window.composeImages.filter(x => x !== null), vb = window.composeImageBlobs.filter(x => x !== null); window.composeImages = [null, null, null, null]; window.composeImageBlobs = [null, null, null, null]; v.forEach((val, idx) => window.composeImages[idx] = val); vb.forEach((val, idx) => window.composeImageBlobs[idx] = val); renderMediaGrid() };
        window.handleComposeAction = () => { if (window.composeStep === 1) goToStep2(); else publishPost() }; window.goToStep2 = () => { window.composeStep = 2; document.getElementById('compose-step-1').classList.add('hidden'); document.getElementById('compose-step-2').classList.remove('hidden'); document.getElementById('compose-footer-settings').classList.remove('hidden'); document.getElementById('compose-action-btn').innerText = "Post"; document.getElementById('compose-action-btn').onclick = window.publishPost };
        window.handleComposeBack = () => { if (window.composeStep === 2) { window.composeStep = 1; document.getElementById('compose-step-1').classList.remove('hidden'); document.getElementById('compose-step-2').classList.add('hidden'); document.getElementById('compose-footer-settings').classList.add('hidden'); document.getElementById('compose-header-title').innerText = "Create Post"; const hasImage = window.composeImages.some(x => x !== null), btn = document.getElementById('compose-action-btn'); btn.innerText = hasImage ? "Next" : "Skip"; btn.onclick = window.handleComposeAction } else attemptCloseCompose() };
        async function uploadToImgHippo(f) { const d = new FormData(); d.append('api_key', 'd28bf3c492ad07b53dc4e3f9ce99b072'); d.append('file', f); try { const r = await fetch('https://api.imghippo.com/v1/upload', { method: 'POST', body: d }), j = await r.json(); if (j.success) return j.data.url; else throw new Error('Upload failed') } catch (e) { throw e } }
        window.publishPost = async () => { const tr = document.getElementById('compose-text').value.trim(), hasImages = window.composeImages.some(x => x !== null); if (!tr.trim() && !hasImages) return showToast("Empty!", !0); if (tr.trim().split(/\s+/).length > 500) return showToast("Post too long (max 500 words)", !0); const po = document.getElementById('compose-progress-overlay'), pb = document.getElementById('post-progress-bar'); po.classList.remove('hidden'); po.classList.add('flex'); let pr = 0; const int = setInterval(() => { if (pr < 90) { pr += Math.random() * 15; pb.style.width = `${Math.min(pr, 90)}%` } }, 300); const priv = document.getElementById('post-setting-privacy').checked, sl = document.getElementById('post-setting-likes').checked, sc = document.getElementById('post-setting-comments').checked, alv = document.getElementById('post-setting-like-view').checked, ac = document.getElementById('post-setting-allow-comments').checked; try { let mu = []; for (let i = 0; i < 4; i++) { const url = window.composeImages[i], blob = window.composeImageBlobs[i]; if (url) { if (blob) { try { mu.push(await uploadToImgHippo(blob)) } catch (e) { const mr = ref(storage, `posts/${currentUser.id}/${Date.now()}_${i}_${blob.name}`); await uploadBytes(mr, blob); mu.push(await getDownloadURL(mr)) } } else mu.push(url) } } const mp = mu.length === 1 ? mu[0] : (mu.length > 0 ? mu : null), mm = tr.match(/@(\w+)/g), mids = []; if (mm) { mm.forEach(m => { const uname = m.substring(1).toLowerCase(), found = users.find(u => (u.username || "").toLowerCase() === uname); if (found) mids.push(found.id) }) } const pd = { authorId: currentUser.id, content: tr, media: mp, timestamp: serverTimestamp(), likes: [], comments: [], collaborators: window.selectedCollaborators || [], mentions: mids, claimLink: window.currentClaimLink || null, settings: { privacy: priv ? 'private' : 'public', showLikes: sl, showComments: sc, allowLikeView: alv, allowComments: ac } }; let pid = null; if (window.editingPostId) { await updateDoc(doc(db, "posts", window.editingPostId), { content: tr, media: mp, settings: pd.settings, claimLink: window.currentClaimLink || null }); pid = window.editingPostId; showToast("Updated!") } else { const r = await addDoc(collection(db, "posts"), pd); pid = r.id; showToast("Posted!"); if (window.selectedCollaborators?.length) window.selectedCollaborators.forEach(c => sendNotification(c.id, 'collab_request', 'invited to collaborate', pid)) } if (mids.length > 0) mids.forEach(uid => { if (uid !== currentUser.id) sendNotification(uid, 'mention', 'mentioned you in a post', pid) }); clearInterval(int); pb.style.width = '100%'; await new Promise(r => setTimeout(r, 500)); po.classList.add('hidden'); po.classList.remove('flex'); pb.style.width = '0%'; closeCompose() } catch (e) { console.error(e); clearInterval(int); po.classList.add('hidden'); po.classList.remove('flex'); showToast("Error", !0) } };
        window.showToast = (m, e = false) => { const t = document.getElementById('toast'), tm = document.getElementById('toast-msg'), i = document.getElementById('toast-icon'); tm.innerText = m; if (e) { t.style.backgroundColor = '#d93025'; i.setAttribute('data-lucide', 'alert-circle'); i.classList.remove('text-[#c4eed0]'); i.classList.add('text-white') } else { t.style.backgroundColor = '#303134'; i.setAttribute('data-lucide', 'check-circle-2'); i.classList.add('text-[#c4eed0]'); i.classList.remove('text-white') } refreshIcons(); t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 3000) };
        window.openLightbox = (s, t = 'image') => { const w = document.getElementById('lightbox-wrapper'), l = document.getElementById('lightbox'); if (t === 'video' || s.includes('.mp4') || s.includes('data:video')) w.innerHTML = `<video src="${s}" controls autoplay class="max-w-full max-h-[90vh] rounded-lg shadow-2xl"></video>`; else w.innerHTML = `<img src="${s}" class="max-w-full max-h-[90vh] rounded-lg shadow-2xl object-contain">`; l.classList.add('active'); l.classList.remove('pointer-events-none', 'opacity-0') }; window.closeLightbox = () => { const l = document.getElementById('lightbox'); l.classList.remove('active'); l.classList.add('pointer-events-none', 'opacity-0'); const v = l.querySelector('video'); if (v) v.pause() };
        window.openQR = uid => { manageHistory('qr-overlay'); const id = uid || currentUser.id, u = users.find(x => x.id === id) || currentUser, url = `${window.location.origin}${window.location.pathname}?uid=${id}`, qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(url)}`; document.getElementById('qr-image').src = qrUrl; const disp = u.username ? `@${u.username}` : u.name; document.getElementById('qr-display-name').innerText = disp; document.getElementById('qr-owner-avatar').src = u.avatar; document.getElementById('qr-hidden-url').value = url; const o = document.getElementById('qr-overlay'), m = document.getElementById('qr-modal'); m.style.transform = ''; m.style.transition = 'none'; o.classList.add('opacity-0'); m.classList.add('translate-y-full', 'md:scale-95'); m.classList.remove('translate-y-0', 'md:scale-100'); o.classList.remove('hidden'); void m.offsetWidth; m.style.transition = ''; setTimeout(() => { o.classList.remove('opacity-0'); m.classList.remove('translate-y-full', 'md:scale-95'); m.classList.add('translate-y-0', 'md:scale-100') }, 20) };
        window.copyQRLink = () => { const u = document.getElementById('qr-hidden-url').value; if (u) navigator.clipboard.writeText(u).then(() => showToast("Link copied!")) }; window.closeQR = () => { const o = document.getElementById('qr-overlay'), m = document.getElementById('qr-modal'); o.classList.add('opacity-0'); m.classList.add('translate-y-full', 'md:scale-95'); m.classList.remove('translate-y-0', 'md:scale-100'); setTimeout(() => o.classList.add('hidden'), 200) };
        window.openScanner = () => { const o = document.getElementById('scanner-overlay'); o.classList.remove('hidden'); o.classList.add('flex'); if (!html5QrCode) html5QrCode = new Html5Qrcode("qr-reader"); html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 250 } }, onScanSuccess).catch(e => { console.error(e); showToast("Camera error", !0); closeScanner() }) }; window.closeScanner = () => { if (html5QrCode) { html5QrCode.stop().then(() => { const o = document.getElementById('scanner-overlay'); o.classList.add('hidden'); o.classList.remove('flex') }).catch(console.error) } else { const o = document.getElementById('scanner-overlay'); o.classList.add('hidden'); o.classList.remove('flex') } };
        function onScanSuccess(t) { if (t.includes('uid=')) { const uid = new URLSearchParams(new URL(t).search).get('uid'); if (uid) { closeScanner(); showProfile(uid); showToast("Profile found!") } } else { closeScanner(); showToast("Invalid EduLink QR", !0) } }
        window.openUserList = (type, uid) => { manageHistory('user-list-overlay'); const u = users.find(x => x.id === uid); if (!u) return; const list = type === 'following' ? u.following : u.followers, title = type === 'following' ? 'Following' : 'Followers', c = document.getElementById('user-list-content'); document.getElementById('user-list-title').innerText = title; c.innerHTML = ''; if (!list || list.length === 0) c.innerHTML = '<div class="text-center text-gray-400 py-8">No users found.</div>'; else list.forEach(id => { const fu = users.find(x => x.id === id); if (fu) { const d = document.createElement('div'); d.className = "flex items-center justify-between p-3 hover:bg-gray-50 rounded-xl cursor-pointer"; d.onclick = () => { closeUserList(); showProfile(fu.id) }; const isF = currentUser.following.includes(fu.id), isMe = fu.id === currentUser.id; let btn = ''; if (!isMe) { const cls = isF ? "bg-gray-100 text-gray-900" : "bg-black text-white", txt = isF ? "Following" : "Follow"; btn = `<button id="ul-btn-${fu.id}" onclick="event.stopPropagation(); toggleFollow('${fu.id}')" class="text-xs font-bold px-3 py-1.5 rounded-full border border-gray-200 transition-colors ${cls}">${txt}</button>` } d.innerHTML = `<div class="flex items-center gap-3 overflow-hidden"><img src="${fu.avatar}" class="w-10 h-10 rounded-full border border-gray-100 object-cover shrink-0 bg-gray-50"><div class="min-w-0"><div class="font-bold text-sm text-gray-900 truncate">${fu.name} ${fu.isOfficial ? '<i data-lucide="badge-check" class="w-3 h-3 inline text-blue-500"></i>' : ''}</div><div class="text-xs text-gray-500 truncate">@${fu.username || 'user'}</div></div></div>${btn}`; c.appendChild(d) } }); refreshIcons(); const o = document.getElementById('user-list-overlay'), m = document.getElementById('user-list-modal'); m.style.transform = ''; m.style.transition = 'none'; o.classList.add('opacity-0'); m.classList.add('translate-y-full', 'md:scale-95'); m.classList.remove('translate-y-0', 'md:scale-100'); o.classList.remove('hidden'); void m.offsetWidth; m.style.transition = ''; setTimeout(() => { o.classList.remove('opacity-0'); m.classList.remove('translate-y-full', 'md:scale-95'); m.classList.add('translate-y-0', 'md:scale-100') }, 20) };
        window.closeUserList = () => { const o = document.getElementById('user-list-overlay'), m = document.getElementById('user-list-modal'); o.classList.add('opacity-0'); m.classList.add('translate-y-full', 'md:scale-95'); m.classList.remove('translate-y-0', 'md:scale-100'); setTimeout(() => o.classList.add('hidden'), 200) };
        if (typeof setupSwipeClose === 'function') { setupSwipeClose('share-modal', 'share-overlay', window.closeShareMenu); setupSwipeClose('edit-profile-modal', 'edit-profile-overlay', window.closeEditProfile); setupSwipeClose('likes-modal', 'likes-overlay', window.closeLikes); setupSwipeClose('post-options-modal', 'post-options-overlay', window.hidePostMenu); setupSwipeClose('notif-options-modal', 'notif-options-overlay', window.closeNotifOptions); setupSwipeClose('qr-modal', 'qr-overlay', window.closeQR); setupSwipeClose('user-list-modal', 'user-list-overlay', window.closeUserList); setupSwipeClose('feed-filter-modal', 'feed-filter-overlay', window.closeFeedFilter); setupSwipeClose('download-select-modal', 'download-select-overlay', window.closeDownloadSelect) }
        let mentionHighlightIndex = -1;
        window.handleMentionInput = (inputId, suggestionsId) => {
            const input = document.getElementById(inputId);
            const suggestions = document.getElementById(suggestionsId);
            if (!input || !suggestions) return;
            const value = input.value;
            const cursorPos = input.selectionStart;
            const textBeforeCursor = value.substring(0, cursorPos);
            const atMatch = textBeforeCursor.match(/@(\w*)$/);
            if (atMatch) {
                const query = atMatch[1].toLowerCase();
                const filteredUsers = users.filter(u => {
                    const username = (u.username || '').toLowerCase();
                    const name = u.name.toLowerCase();
                    return username.includes(query) || name.toLowerCase().includes(query);
                }).slice(0, 8);
                if (filteredUsers.length > 0) {
                    suggestions.innerHTML = filteredUsers.map((u, idx) => `
                        <div class="mention-item ${idx === 0 ? 'highlighted' : ''}" data-username="${u.username || 'user'}" onclick="selectMention('${inputId}', '${suggestionsId}', '${u.username || 'user'}')">
                            <img src="${u.avatar}" class="w-8 h-8 rounded-full object-cover border border-gray-200">
                            <div class="flex-1 min-w-0">
                                <div class="font-bold text-sm text-gray-900 truncate">${u.name} ${u.isOfficial ? '<i data-lucide="badge-check" class="w-3 h-3 inline official-badge"></i>' : ''}</div>
                                <div class="text-xs text-gray-500 truncate">@${u.username || 'user'}</div>
                            </div>
                        </div>
                    `).join('');
                    suggestions.classList.remove('hidden');
                    mentionHighlightIndex = 0;
                    refreshIcons();
                } else {
                    suggestions.classList.add('hidden');
                }
            } else {
                suggestions.classList.add('hidden');
                mentionHighlightIndex = -1;
            }
        };
        window.handleMentionKeydown = (event, inputId, suggestionsId) => {
            const suggestions = document.getElementById(suggestionsId);
            if (!suggestions || suggestions.classList.contains('hidden')) return;
            const items = suggestions.querySelectorAll('.mention-item');
            if (items.length === 0) return;
            if (event.key === 'ArrowDown') {
                event.preventDefault();
                mentionHighlightIndex = (mentionHighlightIndex + 1) % items.length;
                items.forEach((item, idx) => {
                    item.classList.toggle('highlighted', idx === mentionHighlightIndex);
                });
            } else if (event.key === 'ArrowUp') {
                event.preventDefault();
                mentionHighlightIndex = mentionHighlightIndex <= 0 ? items.length - 1 : mentionHighlightIndex - 1;
                items.forEach((item, idx) => {
                    item.classList.toggle('highlighted', idx === mentionHighlightIndex);
                });
            } else if (event.key === 'Enter' && mentionHighlightIndex >= 0 && mentionHighlightIndex < items.length) {
                event.preventDefault();
                const username = items[mentionHighlightIndex].getAttribute('data-username');
                selectMention(inputId, suggestionsId, username);
            } else if (event.key === 'Escape') {
                suggestions.classList.add('hidden');
                mentionHighlightIndex = -1;
            }
        };
        window.selectMention = (inputId, suggestionsId, username) => {
            const input = document.getElementById(inputId);
            const suggestions = document.getElementById(suggestionsId);
            if (!input) return;
            const value = input.value;
            const cursorPos = input.selectionStart;
            const textBeforeCursor = value.substring(0, cursorPos);
            const textAfterCursor = value.substring(cursorPos);
            const atMatch = textBeforeCursor.match(/@(\w*)$/);
            if (atMatch) {
                const beforeAt = textBeforeCursor.substring(0, textBeforeCursor.length - atMatch[0].length);
                input.value = beforeAt + '@' + username + ' ' + textAfterCursor;
                const newCursorPos = beforeAt.length + username.length + 2;
                input.setSelectionRange(newCursorPos, newCursorPos);
                input.focus();
            }
            suggestions.classList.add('hidden');
            mentionHighlightIndex = -1;
        };

        // Custom icon state toggler
        window.updateNavIcons = (activeView) => {
            // Desktop icons
            const desktopIcons = {
                'feed': document.getElementById('nav-feed-icon'),
                'explore': document.getElementById('nav-explore-icon'),
                'notifications': document.getElementById('nav-notifications-icon')
            };

            // Mobile icons
            const mobileIcons = {
                'feed': document.getElementById('mobile-feed-icon'),
                'explore': document.getElementById('mobile-explore-icon'),
                'notifications': document.getElementById('mobile-notifications-icon')
            };

            // Update desktop icons
            Object.keys(desktopIcons).forEach(view => {
                const icon = desktopIcons[view];
                if (icon) {
                    if (view === activeView) {
                        // Explore uses bold outline instead of fill
                        if (view === 'explore') {
                            icon.classList.remove('custom-icon-outline', 'custom-icon-filled');
                            icon.classList.add('custom-icon-bold');
                        } else {
                            icon.classList.remove('custom-icon-outline', 'custom-icon-bold');
                            icon.classList.add('custom-icon-filled');
                        }
                    } else {
                        icon.classList.remove('custom-icon-filled', 'custom-icon-bold');
                        icon.classList.add('custom-icon-outline');
                    }
                }
            });

            // Update mobile icons
            Object.keys(mobileIcons).forEach(view => {
                const icon = mobileIcons[view];
                if (icon) {
                    if (view === activeView) {
                        // Explore uses bold outline instead of fill
                        if (view === 'explore') {
                            icon.classList.remove('custom-icon-outline', 'custom-icon-filled');
                            icon.classList.add('custom-icon-bold');
                        } else {
                            icon.classList.remove('custom-icon-outline', 'custom-icon-bold');
                            icon.classList.add('custom-icon-filled');
                        }
                    } else {
                        icon.classList.remove('custom-icon-filled', 'custom-icon-bold');
                        icon.classList.add('custom-icon-outline');
                    }
                }
            });
        };

        // Override switchView to include icon updates
        const originalSwitchView = window.switchView;
        window.switchView = function (view) {
            if (originalSwitchView) originalSwitchView(view);
            updateNavIcons(view);
        };

        const up = new URLSearchParams(window.location.search), dl = up.get('uid'); if (dl) window.pendingProfileUid = dl; refreshIcons();
    </script>
</body>

</html>
