<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>EduLink Chat</title>
<link rel="icon" type="image/png" href="https://i.imghippo.com/files/vgr8207c.png">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Google+Sans:wght@400;500;700&display=swap');
:root{--primary:#0095f6;--bg-chat-bubble-self:#3797f0;--bg-chat-bubble-other:#efefef;}
body{font-family:'Inter',sans-serif;background-color:#fff;overflow:hidden;overscroll-behavior:none;}
.google-font{font-family:'Google Sans','Inter',sans-serif}
*{scrollbar-width:none;-ms-overflow-style:none}*::-webkit-scrollbar{width:0;height:0;display:none}
.fade-in{animation:fadeUp .3s cubic-bezier(.2,0,0,1) forwards;opacity:0;transform:translateY(10px)}
@keyframes fadeUp{to{opacity:1;transform:translateY(0)}}

/* Chat Layout */
.chat-layout { display: flex; height: 100vh; width: 100vw; overflow: hidden; }
.sidebar { width: 100%; height: 100%; border-right: 1px solid #dbdbdb; display: flex; flex-direction: column; background: #fff; z-index: 10; }
.chat-window { flex: 1; height: 100%; display: flex; flex-direction: column; background: #fff; position: absolute; top: 0; left: 0; width: 100%; transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.2, 0, 0, 1); z-index: 20; }

@media (min-width: 768px) {
    .sidebar { width: 350px; flex-shrink: 0; }
    .chat-window { position: relative; transform: translateX(0); width: auto; }
}

/* Mobile Active State */
body.chat-active .sidebar { display: none; } 
@media (min-width: 768px) { body.chat-active .sidebar { display: flex; } }
body.chat-active .chat-window { transform: translateX(0); }

/* Messages */
.msg-group { display: flex; flex-direction: column; margin-bottom: 2px; position: relative; width: 100%; }
.msg-group:hover .msg-actions { opacity: 1; }

.msg-container { display: flex; width: 100%; position: relative; }
.msg-container.self { justify-content: flex-end; }
.msg-container.other { justify-content: flex-start; }

.msg-bubble { max-width: 70%; padding: 10px 14px; border-radius: 22px; position: relative; word-wrap: break-word; font-size: 15px; line-height: 1.4; transition: background-color 0.2s; }
.msg-self { background-color: var(--bg-chat-bubble-self); color: white; border-bottom-right-radius: 4px; }
.msg-other { background-color: var(--bg-chat-bubble-other); color: #000; border-bottom-left-radius: 4px; }

/* Grouping corners */
.msg-group + .msg-group .msg-self { border-top-right-radius: 4px; }
.msg-group + .msg-group .msg-other { border-top-left-radius: 4px; }

/* Message Actions (Delete) */
.msg-actions { opacity: 0; transition: opacity 0.2s; display: flex; align-items: center; padding: 0 8px; }
.msg-container.self .msg-actions { order: -1; } 
.msg-container.other .msg-actions { order: 1; } 

.action-btn { width: 24px; height: 24px; border-radius: 50%; background: transparent; display: flex; align-items: center; justify-content: center; cursor: pointer; color: #999; }
.action-btn:hover { background: #f0f0f0; color: #ff3b30; }

/* Post Card */
.chat-post-card { background: #efefef; border-radius: 16px; overflow: hidden; width: 260px; margin-top: 4px; cursor: pointer; transition: opacity 0.2s; display: flex; flex-direction: column; border: 1px solid rgba(0,0,0,0.05); }
.msg-self .chat-post-card { background: #4db5f9; border: none; }
.msg-self .cpc-footer { color: white; opacity: 0.95; }
.msg-self .cpc-header span { color: white; }
.chat-post-card:hover { opacity: 0.95; }

.cpc-header { padding: 10px; display: flex; align-items: center; gap: 8px; }
.cpc-img-container { width: 100%; aspect-ratio: 1/1; background: #e0e0e0; overflow: hidden; display: flex; align-items: center; justify-content: center; }
.cpc-img { width: 100%; height: 100%; object-fit: cover; }
.cpc-footer { padding: 12px; font-size: 13px; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; font-weight: 500; }

/* Heart - Normal Icon */
.heart-fixed { transition: transform 0.1s; }
.heart-fixed:active { transform: scale(0.9); }

/* Input */
.chat-input-area { padding: 16px; display: flex; align-items: center; gap: 12px; border-top: 1px solid #dbdbdb; background: #fff; }
.chat-input { background: #efefef; border-radius: 22px; padding: 11px 16px; flex: 1; outline: none; border: 1px solid transparent; font-size: 15px; max-height: 100px; resize: none; transition: border 0.2s; }
.chat-input:focus { border-color: #dbdbdb; }

/* User List */
.user-item { padding: 10px 16px; display: flex; align-items: center; gap: 12px; cursor: pointer; transition: background 0.2s; }
.user-item:hover { background-color: #fafafa; }
.user-item.active { background-color: #efefef; }

#new-chat-modal { transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
#new-chat-modal.open { transform: translateY(0); }

/* Custom Alert Overlay */
#custom-alert-overlay { background-color: rgba(0, 0, 0, 0.65); backdrop-filter: blur(2px); }
.custom-alert-box { animation: scaleIn 0.2s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
@keyframes scaleIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
</style>
</head>
<body>

<div class="chat-layout">
    <!-- LEFT SIDEBAR -->
    <aside class="sidebar" id="sidebar-panel">
        <div class="h-16 flex items-center justify-between px-5 border-b border-gray-100 shrink-0">
            <div class="flex items-center gap-2 cursor-pointer" onclick="window.location.href='/home'">
                <i data-lucide="chevron-left" class="w-6 h-6 md:hidden"></i>
                <h1 class="text-xl font-bold text-gray-900 google-font flex items-center gap-1">
                    <span id="current-username">Loading...</span>
                    <i data-lucide="chevron-down" class="w-4 h-4 text-gray-500"></i>
                </h1>
            </div>
            <button onclick="openNewChatModal()" class="w-10 h-10 flex items-center justify-center hover:bg-gray-100 rounded-full transition-colors">
                <i data-lucide="square-pen" class="w-6 h-6 text-gray-800"></i>
            </button>
        </div>
        
        <div class="px-4 py-3 border-b border-gray-100 hidden md:block">
            <div class="font-bold text-[16px] text-gray-900">Messages</div>
        </div>

        <div class="flex-1 overflow-y-auto overflow-x-hidden" id="chat-list-container">
            <div class="flex flex-col items-center justify-center h-40 opacity-50">
                <i data-lucide="loader-2" class="w-6 h-6 animate-spin text-gray-400"></i>
            </div>
        </div>
    </aside>

    <!-- RIGHT MAIN -->
    <main class="chat-window hidden md:flex" id="chat-window-panel">
        <!-- Empty State -->
        <div id="empty-state" class="w-full h-full flex flex-col items-center justify-center text-center p-8 bg-white">
            <div class="w-24 h-24 rounded-full border-2 border-black flex items-center justify-center mb-4 relative">
                <i data-lucide="send" class="w-12 h-12 text-black ml-1 mt-1 transform -rotate-12"></i>
            </div>
            <h2 class="text-xl font-medium text-gray-900 mb-2">Your Messages</h2>
            <p class="text-sm text-gray-500 mb-6">Send private photos and messages to a friend.</p>
            <button onclick="openNewChatModal()" class="bg-[#0095f6] text-white px-5 py-2.5 rounded-lg font-semibold text-sm hover:bg-blue-600 transition-colors">Send message</button>
        </div>

        <!-- Chat Interface -->
        <div id="active-chat-interface" class="w-full h-full flex flex-col hidden bg-white">
            <header class="h-16 px-4 flex items-center justify-between border-b border-gray-100 shrink-0 bg-white/95 backdrop-blur z-20">
                <div class="flex items-center gap-3">
                    <button onclick="closeChat()" class="md:hidden w-8 h-8 -ml-2 flex items-center justify-center hover:bg-gray-50 rounded-full">
                        <i data-lucide="arrow-left" class="w-6 h-6 text-gray-800"></i>
                    </button>
                    <div class="flex items-center gap-3 cursor-pointer hover:opacity-70 transition-opacity" onclick="viewProfile()">
                        <img id="chat-header-avatar" src="" class="w-8 h-8 rounded-full border border-gray-200 object-cover bg-gray-100">
                        <div>
                            <div class="font-bold text-gray-900 text-[15px] leading-tight" id="chat-header-name">User</div>
                            <div class="text-xs text-gray-500 leading-tight" id="chat-header-status">Active now</div>
                        </div>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <button class="icon-btn" onclick="alert('Voice call coming soon')"><i data-lucide="phone" class="w-6 h-6 text-gray-800"></i></button>
                    <button class="icon-btn" onclick="alert('Video call coming soon')"><i data-lucide="video" class="w-7 h-7 text-gray-800"></i></button>
                    <button class="icon-btn"><i data-lucide="info" class="w-6 h-6 text-gray-800"></i></button>
                </div>
            </header>

            <div id="messages-container" class="flex-1 overflow-y-auto p-4 flex flex-col gap-1 pb-4 scroll-smooth"></div>

            <div class="chat-input-area">
                <button class="shrink-0 p-2 hover:bg-gray-100 rounded-full transition-colors" onclick="document.getElementById('img-upload').click()">
                    <i data-lucide="image" class="w-6 h-6 text-gray-800"></i>
                </button>
                <input type="file" id="img-upload" class="hidden" accept="image/*" onchange="handleImageUpload(event)">
                
                <div class="flex-1 relative">
                    <input type="text" id="message-input" class="chat-input w-full" placeholder="Message..." onkeydown="handleTyping(event)" autocomplete="off">
                </div>
                
                <button id="send-btn" class="shrink-0 p-2 text-[#0095f6] font-bold text-sm hidden hover:text-blue-700 transition-colors" onclick="sendMessage()">Send</button>
                <button id="like-btn" class="shrink-0 p-2 hover:bg-gray-100 rounded-full transition-colors" onclick="sendHeart()">
                    <i data-lucide="heart" class="w-6 h-6 text-gray-800"></i>
                </button>
            </div>
        </div>
    </main>
</div>

<!-- New Chat Modal -->
<div id="new-chat-overlay" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center opacity-0 transition-opacity duration-200" onclick="closeNewChatModal()">
    <div id="new-chat-modal" class="bg-white w-full max-w-md h-[70vh] md:h-[600px] md:rounded-xl shadow-2xl flex flex-col transform translate-y-10 md:translate-y-0 overflow-hidden" onclick="event.stopPropagation()">
        <div class="h-12 border-b border-gray-100 flex items-center justify-between px-4 shrink-0 bg-white">
            <button onclick="closeNewChatModal()" class="w-8 h-8 flex items-center justify-center"><i data-lucide="x" class="w-6 h-6 text-gray-800"></i></button>
            <span class="font-bold text-gray-900" id="modal-title">New Message</span>
            <div class="w-8"></div>
        </div>
        
        <div class="p-3 border-b border-gray-100 flex items-center gap-2">
            <span class="font-bold text-gray-900 text-[15px]">To:</span>
            <input type="text" id="user-search-input" placeholder="Search..." class="flex-1 outline-none text-[15px]" oninput="handleUserSearch(this.value)">
        </div>

        <div id="share-preview-container" class="hidden p-3 bg-gray-50 border-b border-gray-100 flex items-center gap-3">
            <img id="share-preview-img" class="w-12 h-12 rounded object-cover bg-gray-200">
            <div class="flex-1 min-w-0">
                <div class="text-xs text-gray-500 font-medium">Sharing post</div>
                <div class="text-sm font-semibold truncate" id="share-preview-text">...</div>
            </div>
        </div>

        <div id="search-results" class="flex-1 overflow-y-auto p-2">
            <div class="text-gray-900 font-semibold text-sm px-4 py-3">Suggested</div>
            <div id="suggested-users-list"></div>
        </div>

        <div class="p-4 border-t border-gray-100 bg-white">
            <button onclick="startChat()" class="w-full bg-[#0095f6] text-white py-3 rounded-lg font-bold opacity-50 cursor-not-allowed transition-opacity" id="start-chat-btn" disabled>Chat</button>
        </div>
    </div>
</div>

<!-- Custom Action Alert Modal (Instagram Style) -->
<div id="custom-alert-overlay" class="hidden fixed inset-0 z-[100] flex items-center justify-center">
    <div class="bg-white rounded-2xl w-[80%] max-w-[270px] overflow-hidden text-center shadow-2xl custom-alert-box" onclick="event.stopPropagation()">
        <div class="p-5">
            <h3 class="font-bold text-lg mb-1" id="alert-title">Unsend Message?</h3>
            <p class="text-gray-500 text-[13px] leading-relaxed" id="alert-msg">This will remove the message for everyone.</p>
        </div>
        <div class="border-t border-gray-200 flex flex-col">
            <button id="alert-confirm-btn" class="w-full py-3.5 text-red-500 font-bold border-b border-gray-200 active:bg-gray-50 text-[15px]">Unsend</button>
            <button onclick="closeCustomAlert()" class="w-full py-3.5 text-gray-900 active:bg-gray-50 text-[15px]">Cancel</button>
        </div>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, collection, doc, getDoc, setDoc, updateDoc, onSnapshot, query, where, orderBy, serverTimestamp, addDoc, limit, getDocs, deleteDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

const firebaseConfig = { apiKey: "AIzaSyAJH79UQl0rc96Qug0DKLevO4ZI_sn8Kno", authDomain: "edulinki.firebaseapp.com", projectId: "edulinki", storageBucket: "edulinki.firebasestorage.app", messagingSenderId: "248886466474", appId: "1:248886466474:web:160043201a6b28bafbbdd3", measurementId: "G-MQBH12VL7N" };
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

let currentUser = null;
let currentChatId = null;
let currentChatUser = null;
let selectedUserForNewChat = null;
let unsubscribeMessages = null;
let pendingSharePost = null;

onAuthStateChanged(auth, async (u) => {
    if (!u) {
        window.location.href = '/home'; 
        return;
    }
    const userDoc = await getDoc(doc(db, "users", u.uid));
    currentUser = { id: u.uid, ...userDoc.data() };
    document.getElementById('current-username').innerText = currentUser.username || currentUser.name;
    loadConversations();
    lucide.createIcons();
    checkForSharedPost();
});

// Load Chats
function loadConversations() {
    const q = query(
        collection(db, "chats"), 
        where("participants", "array-contains", currentUser.id)
    );

    onSnapshot(q, async (snapshot) => {
        const container = document.getElementById('chat-list-container');
        if (snapshot.empty) {
            container.innerHTML = '<div class="p-6 text-center text-gray-500 text-sm mt-10">No messages yet.<br>Start a conversation!</div>';
            return;
        }

        const chats = [];
        snapshot.forEach(doc => chats.push({ id: doc.id, ...doc.data() }));

        chats.sort((a, b) => {
            const tA = a.lastMessageTimestamp?.toMillis() || 0;
            const tB = b.lastMessageTimestamp?.toMillis() || 0;
            return tB - tA; 
        });

        container.innerHTML = '';
        
        for (const chat of chats) {
            const otherUserId = chat.participants.find(uid => uid !== currentUser.id);
            if (!otherUserId) continue;

            let otherUser = { name: 'User', avatar: 'https://via.placeholder.com/150' };
            try {
                const uSnap = await getDoc(doc(db, "users", otherUserId));
                if (uSnap.exists()) otherUser = uSnap.data();
            } catch (e) {}

            const isUnread = !chat.readBy || !chat.readBy.includes(currentUser.id);
            const isSelected = currentChatId === chat.id;
            const timeStr = formatTime(chat.lastMessageTimestamp);
            const lastMsg = chat.lastMessage || 'Start chatting';
            
            const div = document.createElement('div');
            div.className = `user-item ${isSelected ? 'active' : ''}`;
            div.onclick = () => openChat(chat.id, otherUser, otherUserId);
            div.innerHTML = `
                <div class="relative shrink-0">
                    <img src="${otherUser.avatar}" class="w-14 h-14 rounded-full border border-gray-100 object-cover">
                    ${isUnread ? '<div class="absolute bottom-0 right-0 w-3.5 h-3.5 bg-blue-500 rounded-full border-2 border-white"></div>' : ''}
                </div>
                <div class="flex-1 min-w-0">
                    <div class="font-normal text-gray-900 text-[15px] truncate">${otherUser.name}</div>
                    <div class="flex items-center gap-1 text-[13px] ${isUnread ? "font-bold text-gray-900" : "text-gray-500"}">
                        <span class="truncate block max-w-[140px]">${lastMsg}</span>
                        <span class="shrink-0 text-gray-400 font-normal">· ${timeStr}</span>
                    </div>
                </div>
            `;
            container.appendChild(div);
        }
    });
}

// Shared Post Check
async function checkForSharedPost() {
    const urlParams = new URLSearchParams(window.location.search);
    const sharedPostId = urlParams.get('sharePostId');
    if (sharedPostId) {
        try {
            const postSnap = await getDoc(doc(db, "posts", sharedPostId));
            if (postSnap.exists()) {
                pendingSharePost = { id: postSnap.id, ...postSnap.data() };
                openNewChatModal();
                document.getElementById('modal-title').innerText = "Share Post";
                document.getElementById('start-chat-btn').innerText = "Send";
                const previewDiv = document.getElementById('share-preview-container');
                previewDiv.classList.remove('hidden');
                document.getElementById('share-preview-text').innerText = pendingSharePost.content || "Post";
                let img = pendingSharePost.image || (pendingSharePost.media?.[0]) || 'https://via.placeholder.com/150';
                document.getElementById('share-preview-img').src = img;
                window.history.replaceState({}, document.title, "chat.html");
            }
        } catch (e) {}
    }
}

// Chat Window Logic
window.openChat = async (chatId, user, userId) => {
    currentChatId = chatId;
    currentChatUser = { ...user, id: userId };
    
    document.body.classList.add('chat-active');
    document.getElementById('chat-window-panel').classList.remove('hidden');
    document.getElementById('empty-state').classList.add('hidden');
    document.getElementById('active-chat-interface').classList.remove('hidden');
    document.querySelectorAll('.user-item').forEach(el => el.classList.remove('active'));
    
    document.getElementById('chat-header-name').innerText = user.name;
    document.getElementById('chat-header-avatar').src = user.avatar;
    document.getElementById('chat-header-avatar').onclick = () => window.location.href = `/home?profileId=${userId}`;

    updateDoc(doc(db, "chats", chatId), {
        readBy: [currentUser.id, userId]
    }).catch(e => {});

    loadMessages(chatId);
};

window.closeChat = () => {
    document.body.classList.remove('chat-active');
    currentChatId = null;
    if (unsubscribeMessages) unsubscribeMessages();
};

window.viewProfile = () => {
    if (currentChatUser) {
        window.location.href = `/home?profileId=${currentChatUser.id}`;
    }
};

function loadMessages(chatId) {
    if (unsubscribeMessages) unsubscribeMessages();
    const q = query(collection(db, `chats/${chatId}/messages`), orderBy("timestamp", "asc"));
    const container = document.getElementById('messages-container');

    unsubscribeMessages = onSnapshot(q, (snapshot) => {
        container.innerHTML = ''; 
        snapshot.forEach((msgDoc) => {
            const msg = msgDoc.data();
            
            // Filter hidden messages
            if (msg.hiddenBy && msg.hiddenBy.includes(currentUser.id)) return;

            const isSelf = msg.senderId === currentUser.id;

            const div = document.createElement('div');
            div.className = `msg-group fade-in`;
            
            let contentHtml = '';
            let bubbleStyle = '';

            if (msg.type === 'image') {
                contentHtml = `<img src="${msg.content}" class="rounded-lg max-w-full cursor-pointer border border-gray-100" onclick="window.open('${msg.content}', '_blank')">`;
                bubbleStyle = 'padding: 4px; background: transparent;';
            } else if (msg.type === 'post') {
                let postData = typeof msg.postData === 'string' ? JSON.parse(msg.postData) : msg.postData;
                contentHtml = renderPostCard(postData, isSelf);
                bubbleStyle = 'padding: 0; background: transparent; overflow: hidden;';
            } else if (msg.type === 'heart') {
                 // Clean red heart icon
                 contentHtml = `<i data-lucide="heart" class="w-12 h-12 text-[#ff3040] fill-[#ff3040] heart-fixed"></i>`;
                 bubbleStyle = 'background: transparent; padding: 0;';
            } else {
                contentHtml = linkify(msg.content);
            }

            // Only allow Unsend (Delete) for self, Hide (Delete for me) for others
            const actions = `
                <div class="msg-actions">
                    <div class="action-btn" onclick="deleteMessage('${msgDoc.id}', ${isSelf})" title="${isSelf ? 'Unsend' : 'Delete for Me'}">
                        <i data-lucide="${isSelf ? 'trash-2' : 'eye-off'}" class="w-4 h-4"></i>
                    </div>
                </div>
            `;

            div.innerHTML = `
                <div class="msg-container ${isSelf ? 'self' : 'other'}">
                    <div class="msg-bubble ${isSelf ? 'msg-self' : 'msg-other'}" style="${bubbleStyle}">
                        ${contentHtml}
                    </div>
                    ${actions}
                </div>
            `;

            container.appendChild(div);
        });

        setTimeout(() => { container.scrollTop = container.scrollHeight; }, 100);
        lucide.createIcons();
    });
}

function renderPostCard(post, isSelf) {
    let img = null;
    if (post.image) img = post.image;
    else if (post.media && Array.isArray(post.media) && post.media.length > 0) img = post.media[0];
    else if (typeof post.media === 'string') img = post.media;

    // Check if the media is actually a video or empty, if so, don't show the image block if we want only images
    // The user requirement: "if a post donest hve an image jsut dont show the image container"
    
    const hasImage = img && !img.includes('video') && !img.endsWith('.mp4');

    const imgHtml = hasImage ? 
        `<div class="cpc-img-container"><img src="${img}" class="cpc-img"></div>` : 
        ``; // Empty string removes the container

    return `
        <div class="chat-post-card" onclick="window.location.href='/home?postId=${post.id}'">
            <div class="cpc-header">
                <img src="${post.authorAvatar || 'https://via.placeholder.com/50'}" class="w-6 h-6 rounded-full border border-white/20 object-cover">
                <span class="font-bold text-xs truncate">${post.authorName || 'User'}</span>
            </div>
            ${imgHtml}
            <div class="cpc-footer">
                <p class="truncate font-medium">${post.content || 'Shared post'}</p>
            </div>
        </div>
    `;
}

function linkify(text) {
    if(!text) return '';
    const urlRegex = /(https?:\/\/[^\s]+)/g;
    return text.replace(urlRegex, (url) => {
        return `<a href="${url}" target="_blank" class="underline hover:opacity-80 break-all">${url}</a>`;
    });
}

function formatTime(timestamp) {
    if (!timestamp) return '';
    const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
    const diff = new Date() - date;
    if (diff < 86400000) return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    if (diff < 604800000) return date.toLocaleDateString([], { weekday: 'short' });
    return date.toLocaleDateString([], { month: 'short', day: 'numeric' });
}

window.handleTyping = (e) => {
    const val = e.target.value.trim();
    const sendBtn = document.getElementById('send-btn');
    const likeBtn = document.getElementById('like-btn');
    
    if (val.length > 0) {
        sendBtn.classList.remove('hidden');
        likeBtn.classList.add('hidden');
    } else {
        sendBtn.classList.add('hidden');
        likeBtn.classList.remove('hidden');
    }

    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
};

window.sendMessage = async (type = 'text', content = null, extraData = {}) => {
    if (!currentChatId || !currentUser) return;
    
    const input = document.getElementById('message-input');
    let msgContent = content || input.value.trim();
    
    if (!msgContent && type === 'text') return;

    // Detect Post Link
    const postLinkMatch = msgContent.match(/postId=([a-zA-Z0-9_-]+)/);
    if (type === 'text' && postLinkMatch) {
        const postId = postLinkMatch[1];
        try {
            const postSnap = await getDoc(doc(db, "posts", postId));
            if (postSnap.exists()) {
                type = 'post';
                // Fetch author info to ensure the card looks good immediately
                const postRaw = postSnap.data();
                // Get author info for the post preview if missing
                if(!postRaw.authorAvatar || !postRaw.authorName) {
                    try {
                        const authSnap = await getDoc(doc(db, "users", postRaw.authorId));
                        if(authSnap.exists()){
                            const ad = authSnap.data();
                            postRaw.authorName = ad.name;
                            postRaw.authorAvatar = ad.avatar;
                        }
                    } catch(e){}
                }
                extraData = { postData: { id: postSnap.id, ...postRaw } };
                msgContent = ''; 
            }
        } catch (e) { console.log('Link expansion failed', e); }
    }

    input.value = '';
    document.getElementById('send-btn').classList.add('hidden');
    document.getElementById('like-btn').classList.remove('hidden');
    document.getElementById('message-input').focus();

    const messageData = {
        senderId: currentUser.id,
        content: msgContent,
        timestamp: serverTimestamp(),
        type: type,
        ...extraData
    };

    try {
        await addDoc(collection(db, `chats/${currentChatId}/messages`), messageData);
        
        let preview = msgContent;
        if (type === 'image') preview = 'Sent a photo';
        if (type === 'post') preview = `Sent a post`;
        if (type === 'heart') preview = '❤️';

        await updateDoc(doc(db, "chats", currentChatId), {
            lastMessage: preview,
            lastMessageTimestamp: serverTimestamp(),
            readBy: [currentUser.id]
        });
    } catch (error) {
        console.error("Error sending message:", error);
    }
};

window.sendHeart = () => sendMessage('heart', '❤️');

window.handleImageUpload = async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const btn = document.getElementById('send-btn');
    btn.innerText = '...';
    btn.classList.remove('hidden');
    
    try {
        const storageRef = ref(storage, `chat_images/${currentChatId}/${Date.now()}_${file.name}`);
        const snapshot = await uploadBytes(storageRef, file);
        const downloadURL = await getDownloadURL(snapshot.ref);
        await sendMessage('image', downloadURL);
    } catch (error) {
        console.error("Upload failed", error);
        alert("Failed to upload image. " + error.message);
    } finally {
        btn.innerText = 'Send';
        btn.classList.add('hidden');
        e.target.value = '';
    }
};

// Custom Alert Logic
window.showCustomAlert = (title, message, confirmText, isRed, onConfirm) => {
    const overlay = document.getElementById('custom-alert-overlay');
    document.getElementById('alert-title').innerText = title;
    document.getElementById('alert-msg').innerText = message;
    
    const confirmBtn = document.getElementById('alert-confirm-btn');
    // Remove old listeners by cloning
    const newBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newBtn, confirmBtn);
    
    newBtn.innerText = confirmText;
    newBtn.className = `w-full py-3.5 font-bold border-b border-gray-200 active:bg-gray-50 text-[15px] ${isRed ? 'text-red-500' : 'text-blue-500'}`;
    
    newBtn.onclick = () => {
        onConfirm();
        closeCustomAlert();
    };
    
    overlay.classList.remove('hidden');
};

window.closeCustomAlert = () => {
    document.getElementById('custom-alert-overlay').classList.add('hidden');
};

window.deleteMessage = async (msgId, isSelf) => {
    if (isSelf) {
        showCustomAlert("Unsend Message?", "This will remove the message for everyone.", "Unsend", true, async () => {
            try {
                await deleteDoc(doc(db, `chats/${currentChatId}/messages`, msgId));
            } catch (error) {
                console.error("Error deleting message", error);
            }
        });
    } else {
        showCustomAlert("Delete for Me?", "This message will be hidden from your view.", "Delete", true, async () => {
            try {
                // Update the message document to include current user in 'hiddenBy'
                await updateDoc(doc(db, `chats/${currentChatId}/messages`, msgId), {
                    hiddenBy: arrayUnion(currentUser.id)
                });
            } catch (error) {
                console.error("Error hiding message", error);
            }
        });
    }
};

// Modal Logic
window.openNewChatModal = () => {
    document.getElementById('new-chat-overlay').classList.remove('hidden');
    setTimeout(() => {
        document.getElementById('new-chat-overlay').classList.remove('opacity-0');
        document.getElementById('new-chat-modal').classList.add('open');
    }, 10);
    document.getElementById('user-search-input').focus();
    loadSuggestedUsers();
};

window.closeNewChatModal = () => {
    document.getElementById('new-chat-overlay').classList.add('opacity-0');
    document.getElementById('new-chat-modal').classList.remove('open');
    setTimeout(() => {
        document.getElementById('new-chat-overlay').classList.add('hidden');
        pendingSharePost = null;
        document.getElementById('modal-title').innerText = "New Message";
        document.getElementById('start-chat-btn').innerText = "Chat";
        document.getElementById('share-preview-container').classList.add('hidden');
    }, 300);
    
    selectedUserForNewChat = null;
    document.getElementById('start-chat-btn').disabled = true;
    document.getElementById('start-chat-btn').classList.add('opacity-50');
    document.getElementById('user-search-input').value = '';
};

async function loadSuggestedUsers() {
    const q = query(collection(db, "users"), limit(15));
    const snap = await getDocs(q);
    const list = document.getElementById('suggested-users-list');
    list.innerHTML = '';
    snap.forEach(doc => {
        const u = {id: doc.id, ...doc.data()};
        if (u.id === currentUser.id) return;
        renderSearchUserItem(u, list);
    });
}

window.handleUserSearch = async (val) => {
    const term = val.toLowerCase().trim();
    if (!term) return loadSuggestedUsers();
    
    const list = document.getElementById('suggested-users-list');
    list.innerHTML = '<div class="p-4 text-center"><i data-lucide="loader-2" class="animate-spin w-5 h-5 mx-auto"></i></div>';
    
    const q = query(collection(db, "users"));
    const snap = await getDocs(q);
    list.innerHTML = '';
    let found = false;
    snap.forEach(doc => {
        const u = {id: doc.id, ...doc.data()};
        if (u.id === currentUser.id) return;
        if (u.name.toLowerCase().includes(term) || (u.username || '').toLowerCase().includes(term)) {
            renderSearchUserItem(u, list);
            found = true;
        }
    });
    if (!found) list.innerHTML = '<div class="p-4 text-center text-gray-500 text-sm">No users found.</div>';
    lucide.createIcons();
};

function renderSearchUserItem(user, container) {
    const div = document.createElement('div');
    div.className = 'flex items-center gap-3 p-3 hover:bg-gray-50 cursor-pointer rounded-xl transition-colors';
    div.onclick = () => selectUserForChat(user, div);
    div.innerHTML = `
        <img src="${user.avatar}" class="w-12 h-12 rounded-full border border-gray-100 object-cover">
        <div class="flex-1">
            <div class="font-bold text-gray-900 text-sm">${user.name}</div>
            <div class="text-xs text-gray-500">@${user.username || 'user'}</div>
        </div>
        <div class="selection-indicator w-6 h-6 rounded-full border-2 border-gray-300 flex items-center justify-center transition-all">
            <div class="w-3 h-3 bg-blue-500 rounded-full hidden"></div>
        </div>
    `;
    container.appendChild(div);
}

function selectUserForChat(user, element) {
    document.querySelectorAll('.selection-indicator').forEach(el => {
        el.style.borderColor = '#d1d5db';
        el.style.backgroundColor = 'transparent';
        el.querySelector('div').classList.add('hidden');
    });
    const indicator = element.querySelector('.selection-indicator');
    indicator.style.borderColor = '#0095f6';
    indicator.style.backgroundColor = '#0095f6';
    indicator.innerHTML = '<i data-lucide="check" class="w-4 h-4 text-white"></i>';
    lucide.createIcons();
    selectedUserForNewChat = user;
    const btn = document.getElementById('start-chat-btn');
    btn.disabled = false;
    btn.classList.remove('opacity-50', 'cursor-not-allowed');
    btn.classList.add('cursor-pointer');
}

window.startChat = async () => {
    if (!selectedUserForNewChat) return;
    const targetUser = selectedUserForNewChat;
    closeNewChatModal();

    const q = query(collection(db, "chats"), where("participants", "array-contains", currentUser.id));
    const snap = await getDocs(q);
    let chatId = null;
    snap.forEach(doc => {
        const data = doc.data();
        if (data.participants.includes(targetUser.id) && data.participants.length === 2) chatId = doc.id;
    });

    if (!chatId) {
        const ref = await addDoc(collection(db, "chats"), {
            participants: [currentUser.id, targetUser.id],
            lastMessage: pendingSharePost ? 'Sent a post' : 'Started a conversation',
            lastMessageTimestamp: serverTimestamp(),
            readBy: [currentUser.id]
        });
        chatId = ref.id;
    }

    await openChat(chatId, targetUser, targetUser.id);

    if (pendingSharePost) {
        await sendMessage('post', '', { postData: pendingSharePost });
        pendingSharePost = null;
    }
};

lucide.createIcons();
</script>
</body>
</html>
