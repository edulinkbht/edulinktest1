<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>EduLink Chat</title>
<link rel="icon" type="image/png" href="https://i.imghippo.com/files/vgr8207c.png">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Google+Sans:wght@400;500;700&display=swap');
:root{--primary:#0095f6;--bg-chat-bubble-self:#3797f0;--bg-chat-bubble-other:#efefef;}
body{font-family:'Inter',sans-serif;background-color:#fff;overflow:hidden;overscroll-behavior:none;}
.google-font{font-family:'Google Sans','Inter',sans-serif}
*{scrollbar-width:none;-ms-overflow-style:none}*::-webkit-scrollbar{width:0;height:0;display:none}
.fade-in{animation:fadeUp .3s cubic-bezier(.2,0,0,1) forwards;opacity:0;transform:translateY(10px)}
@keyframes fadeUp{to{opacity:1;transform:translateY(0)}}
.noselect { -webkit-touch-callout: none; -webkit-user-select: none; -khtml-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; }

/* Chat Layout */
.chat-layout { display: flex; height: 100vh; width: 100vw; overflow: hidden; }
.sidebar { width: 100%; height: 100%; border-right: 1px solid #dbdbdb; display: flex; flex-direction: column; background: #fff; z-index: 10; }
.chat-window { flex: 1; height: 100%; display: flex; flex-direction: column; background: #fff; position: absolute; top: 0; left: 0; width: 100%; transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.2, 0, 0, 1); z-index: 20; }

@media (min-width: 768px) {
    .sidebar { width: 350px; flex-shrink: 0; }
    .chat-window { position: relative; transform: translateX(0); width: auto; }
}

/* Mobile Active State */
body.chat-active .sidebar { display: none; } 
@media (min-width: 768px) { body.chat-active .sidebar { display: flex; } }
body.chat-active .chat-window { transform: translateX(0); }

/* Messages */
.msg-group { display: flex; flex-direction: column; margin-bottom: 2px; position: relative; width: 100%; transition: margin 0.2s; }
.msg-group.has-reaction { margin-bottom: 26px; } 

.msg-container { display: flex; width: 100%; position: relative; align-items: flex-end; }
.msg-container.self { justify-content: flex-end; }
.msg-container.other { justify-content: flex-start; }

/* Highlight Animation for Scroll */
@keyframes highlightMsg { 0% { background-color: rgba(0, 149, 246, 0.1); } 100% { background-color: transparent; } }
.highlight-message .msg-bubble { animation: highlightMsg 2s ease-out; }

/* Avatar Styles */
.msg-avatar {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    margin-right: 8px;
    object-fit: cover;
    flex-shrink: 0;
    align-self: flex-end; 
    margin-bottom: 4px;
}
.msg-avatar-placeholder {
    width: 28px;
    margin-right: 8px;
    flex-shrink: 0;
}

/* Swipe Wrapper */
.msg-swipe-wrapper {
    position: relative;
    max-width: 70%;
    transition: transform 0.1s cubic-bezier(0,0,0.2,1);
    touch-action: pan-y; 
    display: flex;
    align-items: flex-end; 
}
.msg-container.self .msg-swipe-wrapper { flex-direction: row-reverse; }

.reply-icon-container {
    position: absolute;
    top: 50%;
    transform: translateY(-50%) scale(0);
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.2s;
    opacity: 0;
}
.msg-container.other .reply-icon-container { right: -40px; }
.msg-container.self .reply-icon-container { left: -40px; }

/* Message Content Stack (Reply + Bubble) */
.msg-content-stack {
    display: flex;
    flex-direction: column;
    width: 100%;
}
.msg-container.self .msg-content-stack { align-items: flex-end; }
.msg-container.other .msg-content-stack { align-items: flex-start; }

/* Reply Block - Integrated Style */
.reply-upper-block {
    padding: 10px 12px;
    font-size: 13px;
    cursor: pointer;
    max-width: 100%;
    display: flex;
    flex-direction: column;
    position: relative;
    z-index: 1;
    margin-bottom: 0;
    transition: transform 0.1s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    line-height: 1.3;
}

.reply-upper-block:active {
    transform: scale(1.02);
    opacity: 1;
}

/* Rounded corners logic to attach to bubble */
.reply-block-self {
    /* Changed from translucent black to solid darker blue to match theme */
    background-color: #2a8bf2; 
    color: rgba(255,255,255,0.95);
    align-self: flex-end;
    margin-right: 0;
    border-radius: 18px 18px 4px 18px;
    /* Optional: Subtle separator if needed, but color diff is usually enough */
}

.reply-block-other {
    background-color: #e5e5e5; /* Slightly darker gray than bubble */
    color: #000000;
    align-self: flex-start;
    margin-left: 0;
    border-left: 3px solid #b0b0b0; /* Subtle grey accent line */
    border-radius: 18px 18px 18px 4px;
}

.reply-header {
    font-size: 11px;
    margin-bottom: 2px;
    font-weight: 500;
    opacity: 0.8;
}

.reply-body {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    opacity: 0.95;
}

/* Ensure Text Color in Reply Block Other is Black */
.reply-block-other .reply-header, 
.reply-block-other .reply-body {
    color: #000000;
}

/* Main Bubble */
.msg-bubble { 
    width: fit-content;
    padding: 10px 14px; 
    border-radius: 22px; 
    position: relative; 
    word-wrap: break-word; 
    font-size: 15px; 
    line-height: 1.4; 
    cursor: pointer;
    z-index: 2;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
}
.msg-bubble:active { transform: scale(0.98); transition: transform 0.1s; }

.msg-self { background-color: var(--bg-chat-bubble-self); color: white; border-bottom-right-radius: 4px; }
.msg-other { background-color: var(--bg-chat-bubble-other); color: #000; border-bottom-left-radius: 4px; }

/* Connected Bubble Styling when Reply exists */
/* Pull up the bubble to overlap the reply block slightly for seamless look */
.bubble-connected-self { border-top-right-radius: 4px; border-top-left-radius: 18px; margin-top: -4px; }
.bubble-connected-other { border-top-left-radius: 4px; border-top-right-radius: 18px; margin-top: -4px; }

/* Transparent Bubble for Hearts/Emojis - High Specificity */
.bubble-transparent, .msg-container .bubble-transparent { 
    background-color: transparent !important; 
    background: transparent !important;
    box-shadow: none !important; 
    padding: 0 !important; 
    border: none !important;
}

/* Emoji Sizes */
.emoji-jumbo { font-size: 48px; line-height: 1.1; }
.emoji-large { font-size: 32px; line-height: 1.1; }

/* Grouping Logic */
.msg-group + .msg-group .msg-self { border-top-right-radius: 4px; }
.msg-group + .msg-group .msg-other { border-top-left-radius: 4px; }

/* Seen Status */
.seen-status {
    font-size: 11px;
    color: #8e8e8e;
    font-weight: 500;
    margin-top: 2px;
    margin-bottom: 10px;
    text-align: right;
    width: 100%;
    padding-right: 10px;
    animation: fadeIn 0.3s ease;
}
@keyframes fadeIn { from{opacity:0;} to{opacity:1;} }

/* Reply Context Banner (Input Area) */
#reply-context-bar {
    display: none;
    align-items: center;
    justify-content: space-between;
    padding: 12px 16px;
    background: #f9f9f9;
    border-top: 1px solid #dbdbdb;
    border-bottom: 1px solid #dbdbdb;
    font-size: 14px;
}
#reply-context-bar.active { display: flex; }

/* Post Card */
.chat-post-card { background: #efefef; border-radius: 16px; overflow: hidden; width: 260px; margin-top: 4px; cursor: pointer; transition: opacity 0.2s; display: flex; flex-direction: column; border: 1px solid rgba(0,0,0,0.05); }
.msg-self .chat-post-card { background: #4db5f9; border: none; }
.msg-self .cpc-footer { color: white; opacity: 0.95; }
.msg-self .cpc-header span { color: white; }
.chat-post-card:hover { opacity: 0.95; }

.cpc-header { padding: 10px; display: flex; align-items: center; gap: 8px; width: 100%; }
.cpc-img-container { width: 100%; aspect-ratio: 1/1; background: #e0e0e0; overflow: hidden; display: flex; align-items: center; justify-content: center; }
.cpc-img { width: 100%; height: 100%; object-fit: cover; }
.cpc-footer { padding: 12px; font-size: 13px; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; font-weight: 500; }

.heart-fixed { transition: transform 0.1s; }
.heart-fixed:active { transform: scale(0.9); }

/* Message Reaction */
.msg-reaction { 
    position: absolute; 
    bottom: -10px; 
    right: 0; 
    background: white; 
    border-radius: 999px; 
    padding: 2px; 
    box-shadow: 0 1px 3px rgba(0,0,0,0.15); 
    border: 1px solid #f0f0f0; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    width: 24px; 
    height: 24px; 
    z-index: 10; 
}
.msg-self .msg-reaction { right: 0; }
.msg-other .msg-reaction { left: 0; right: auto; }

/* Input */
.chat-input-area { padding: 16px; display: flex; align-items: center; gap: 12px; background: #fff; }
.chat-input { background: #efefef; border-radius: 22px; padding: 11px 16px; flex: 1; outline: none; border: 1px solid transparent; font-size: 15px; max-height: 100px; resize: none; transition: border 0.2s; }
.chat-input:focus { border-color: #dbdbdb; }

/* User List */
.user-item { padding: 10px 16px; display: flex; align-items: center; gap: 12px; cursor: pointer; transition: background 0.2s; }
.user-item:hover { background-color: #fafafa; }
.user-item.active { background-color: #efefef; }

#new-chat-modal { transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
#new-chat-modal.open { transform: translateY(0); }

/* Details Overlay */
#chat-details-panel { transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
#chat-details-overlay.open #chat-details-panel { transform: translateX(0); }

/* Profile Design */
.profile-banner { height: 160px; width: 100%; background-color: #e5e7eb; background-size: cover; background-position: center; }
.profile-content-curve { border-radius: 30px 30px 0 0; margin-top: -24px; background: white; position: relative; z-index: 10; padding-top: 10px; min-height: 300px; padding-bottom: 80px; }
.profile-avatar-wrapper { margin-top: -60px; margin-left: 20px; margin-bottom: 12px; position: relative; z-index: 20; width: 96px; height: 96px; }
.details-footer { position: absolute; bottom: 0; left: 0; width: 100%; height: 80px; background: white; border-top: 1px solid #f0f0f0; display: flex; align-items: center; padding: 0 20px; gap: 12px; z-index: 30; padding-bottom: env(safe-area-inset-bottom); }
.like-animation { animation: popLike 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
@keyframes popLike { 0% { transform: scale(0); opacity: 0; } 50% { transform: scale(1.2); opacity: 1; } 100% { transform: scale(1); opacity: 1; } }

</style>
</head>
<body class="noselect">

<div class="chat-layout">
    <!-- LEFT SIDEBAR -->
    <aside class="sidebar" id="sidebar-panel">
        <div class="h-16 flex items-center justify-between px-5 border-b border-gray-100 shrink-0">
            <div class="flex items-center gap-2 cursor-pointer" onclick="window.location.href='/home'">
                <i data-lucide="chevron-left" class="w-6 h-6 md:hidden"></i>
                <h1 class="text-xl font-bold text-gray-900 google-font flex items-center gap-1">
                    <span id="current-username">Loading...</span>
                    <i data-lucide="chevron-down" class="w-4 h-4 text-gray-500"></i>
                </h1>
            </div>
            <button onclick="openNewChatModal()" class="w-10 h-10 flex items-center justify-center hover:bg-gray-100 rounded-full transition-colors">
                <i data-lucide="square-pen" class="w-6 h-6 text-gray-800"></i>
            </button>
        </div>
        
        <div class="px-4 py-3 border-b border-gray-100 hidden md:block">
            <div class="font-bold text-[16px] text-gray-900">Messages</div>
        </div>

        <div class="flex-1 overflow-y-auto overflow-x-hidden" id="chat-list-container">
            <div class="flex flex-col items-center justify-center h-40 opacity-50">
                <i data-lucide="loader-2" class="w-6 h-6 animate-spin text-gray-400"></i>
            </div>
        </div>
    </aside>

    <!-- RIGHT MAIN -->
    <main class="chat-window hidden md:flex" id="chat-window-panel">
        <!-- Empty State -->
        <div id="empty-state" class="w-full h-full flex flex-col items-center justify-center text-center p-8 bg-white">
            <div class="w-24 h-24 rounded-full border-2 border-black flex items-center justify-center mb-4 relative">
                <i data-lucide="send" class="w-12 h-12 text-black ml-1 mt-1 transform -rotate-12"></i>
            </div>
            <h2 class="text-xl font-medium text-gray-900 mb-2">Your Messages</h2>
            <p class="text-sm text-gray-500 mb-6">Send private photos and messages to a friend.</p>
            <button onclick="openNewChatModal()" class="bg-[#0095f6] text-white px-5 py-2.5 rounded-lg font-semibold text-sm hover:bg-blue-600 transition-colors">Send message</button>
        </div>

        <!-- Chat Interface -->
        <div id="active-chat-interface" class="w-full h-full flex flex-col hidden bg-white relative">
            <header class="h-16 px-4 flex items-center justify-between border-b border-gray-100 shrink-0 bg-white/95 backdrop-blur z-20">
                <div class="flex items-center gap-3">
                    <button onclick="closeChat()" class="md:hidden w-8 h-8 -ml-2 flex items-center justify-center hover:bg-gray-50 rounded-full">
                        <i data-lucide="arrow-left" class="w-6 h-6 text-gray-800"></i>
                    </button>
                    <div class="flex items-center gap-3 cursor-pointer hover:opacity-70 transition-opacity" onclick="openChatDetails()">
                        <img id="chat-header-avatar" src="" class="w-8 h-8 rounded-full border border-gray-200 object-cover bg-gray-100">
                        <div>
                            <div class="font-bold text-gray-900 text-[15px] leading-tight" id="chat-header-name">User</div>
                            <div class="text-xs text-gray-500 leading-tight flex items-center gap-1.5" id="chat-header-status">
                                Active now <span class="w-2 h-2 rounded-full bg-green-500 block"></span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <button class="icon-btn" onclick="openChatDetails()"><i data-lucide="info" class="w-6 h-6 text-gray-800"></i></button>
                </div>
            </header>

            <div id="messages-container" class="flex-1 overflow-y-auto p-4 flex flex-col gap-1 pb-4 scroll-smooth"></div>

            <!-- Reply Banner (Input Area) -->
            <div id="reply-context-bar">
                <div class="flex flex-col border-l-4 border-gray-300 pl-3">
                    <span class="text-[#0095f6] font-semibold text-xs mb-0.5" id="reply-to-user">Replying to...</span>
                    <span class="text-gray-500 text-xs truncate max-w-[250px]" id="reply-to-text">Message</span>
                </div>
                <button onclick="cancelReply()" class="p-2"><i data-lucide="x" class="w-5 h-5 text-gray-500"></i></button>
            </div>

            <div class="chat-input-area border-t border-gray-100">
                <button class="shrink-0 p-2 hover:bg-gray-100 rounded-full transition-colors" onclick="document.getElementById('img-upload').click()">
                    <i data-lucide="image" class="w-7 h-7 text-gray-800"></i>
                </button>
                <input type="file" id="img-upload" class="hidden" accept="image/*" onchange="handleImageUpload(event)">
                
                <div class="flex-1 relative">
                    <input type="text" id="message-input" class="chat-input w-full" placeholder="Message..." onkeydown="handleTyping(event)" autocomplete="off">
                </div>
                
                <button id="send-btn" class="shrink-0 p-2 text-[#0095f6] font-bold hidden hover:text-blue-700 transition-colors" onclick="sendMessage()">
                    <i data-lucide="send" class="w-7 h-7 fill-current"></i>
                </button>
                <button id="like-btn" class="shrink-0 p-2 hover:bg-gray-100 rounded-full transition-colors" onclick="sendHeart()">
                    <i data-lucide="heart" class="w-7 h-7 text-gray-800"></i>
                </button>
            </div>
        </div>
    </main>
</div>

<!-- Chat Details Overlay, Message Options, New Chat Modal (same as before) -->
<div id="chat-details-overlay" class="fixed inset-0 z-50 bg-black/40 hidden flex justify-end transition-opacity duration-200 opacity-0" onclick="closeChatDetails()">
    <div id="chat-details-panel" class="bg-white w-full md:w-96 h-full shadow-2xl transform translate-x-full flex flex-col relative" onclick="event.stopPropagation()">
         <div class="flex-1 overflow-y-auto bg-white">
             <div class="profile-banner" id="cd-banner"></div>
             <div class="profile-content-curve">
                 <div class="profile-avatar-wrapper">
                    <img id="cd-avatar" src="" class="w-full h-full rounded-full border-4 border-white bg-white object-cover shadow-sm">
                 </div>
                 <div class="px-6 mt-1">
                     <h2 id="cd-name" class="text-2xl font-bold text-gray-900 flex items-center gap-1">User</h2>
                     <div id="cd-username" class="text-sm text-gray-500 font-medium">@username</div>
                     <p id="cd-bio" class="text-gray-700 text-[15px] leading-relaxed mt-3"></p>
                     <div class="flex gap-4 mt-4 mb-6 text-sm text-gray-500 border-b border-gray-100 pb-6">
                        <div class="cursor-pointer hover:underline flex items-center gap-1">
                            <strong class="text-gray-900 text-base" id="cd-following">0</strong> Following
                        </div>
                        <div class="cursor-pointer hover:underline flex items-center gap-1">
                            <strong class="text-gray-900 text-base" id="cd-followers">0</strong> Followers
                        </div>
                     </div>
                 </div>
             </div>
        </div>
        <div class="details-footer">
            <button onclick="viewProfileFromDetails()" class="flex-1 py-3 bg-[#0095f6] hover:bg-blue-600 rounded-xl font-bold text-sm transition-colors text-white shadow-sm text-center">View Profile</button>
            <button onclick="closeChatDetails()" class="w-12 h-12 flex items-center justify-center hover:bg-gray-100 bg-gray-50 rounded-full border border-gray-200 transition-colors shrink-0">
                <i data-lucide="x" class="w-5 h-5 text-gray-700"></i>
            </button>
        </div>
    </div>
</div>

<div id="msg-options-overlay" class="fixed inset-0 z-[100] flex items-end md:items-center justify-center bg-black/40 backdrop-blur-sm hidden opacity-0 transition-opacity duration-200" onclick="closeMsgOptions()">
    <div id="msg-options-modal" class="bg-white w-full md:w-[420px] md:rounded-2xl rounded-t-2xl shadow-2xl relative transform translate-y-full md:translate-y-0 md:scale-95 transition-transform duration-200 flex flex-col overflow-hidden" onclick="event.stopPropagation()">
        <!-- Content injected via JS -->
    </div>
</div>

<div id="new-chat-overlay" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center opacity-0 transition-opacity duration-200" onclick="closeNewChatModal()">
    <div id="new-chat-modal" class="bg-white w-full max-w-md h-[70vh] md:h-[600px] md:rounded-xl shadow-2xl flex flex-col transform translate-y-10 md:translate-y-0 overflow-hidden" onclick="event.stopPropagation()">
        <div class="h-12 border-b border-gray-100 flex items-center justify-between px-4 shrink-0 bg-white">
            <button onclick="closeNewChatModal()" class="w-8 h-8 flex items-center justify-center"><i data-lucide="x" class="w-6 h-6 text-gray-800"></i></button>
            <span class="font-bold text-gray-900" id="modal-title">New Message</span>
            <div class="w-8"></div>
        </div>
        <div class="p-3 border-b border-gray-100 flex items-center gap-2">
            <span class="font-bold text-gray-900 text-[15px]">To:</span>
            <input type="text" id="user-search-input" placeholder="Search..." class="flex-1 outline-none text-[15px]" oninput="handleUserSearch(this.value)">
        </div>
        <div id="share-preview-container" class="hidden p-3 bg-gray-50 border-b border-gray-100 flex items-center gap-3">
            <img id="share-preview-img" class="w-12 h-12 rounded object-cover bg-gray-200">
            <div class="flex-1 min-w-0">
                <div class="text-xs text-gray-500 font-medium">Sharing post</div>
                <div class="text-sm font-semibold truncate" id="share-preview-text">...</div>
            </div>
        </div>
        <div id="search-results" class="flex-1 overflow-y-auto p-2">
            <div class="text-gray-900 font-semibold text-sm px-4 py-3">Suggested</div>
            <div id="suggested-users-list"></div>
        </div>
        <div class="p-4 border-t border-gray-100 bg-white">
            <button onclick="startChat()" class="w-full bg-[#0095f6] text-white py-3 rounded-lg font-bold opacity-50 cursor-not-allowed transition-opacity" id="start-chat-btn" disabled>Chat</button>
        </div>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, collection, doc, getDoc, setDoc, updateDoc, onSnapshot, query, where, orderBy, serverTimestamp, addDoc, limit, getDocs, deleteDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

const firebaseConfig = { apiKey: "AIzaSyAJH79UQl0rc96Qug0DKLevO4ZI_sn8Kno", authDomain: "edulinki.firebaseapp.com", projectId: "edulinki", storageBucket: "edulinki.firebasestorage.app", messagingSenderId: "248886466474", appId: "1:248886466474:web:160043201a6b28bafbbdd3", measurementId: "G-MQBH12VL7N" };
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

let currentUser = null;
let currentChatId = null;
let currentChatUser = null;
let currentChatData = null; 
let selectedUserForNewChat = null;
let unsubscribeMessages = null;
let unsubscribeConversations = null;
let unsubscribeChatMeta = null;
let pendingSharePost = null;
let currentMsgContext = null;
let currentReplyContext = null;

// Gestures
let pressTimer = null;
let pressStartX = 0;
let pressStartY = 0;
let conversationRenderId = 0; 
let postClickTimer = null;
let messageClickTimer = null;

// Swipe logic variables
let swipeStartX = 0;
let swipeStartY = 0;
let activeSwipeEl = null;
let isSwiping = false;

onAuthStateChanged(auth, async (u) => {
    if (!u) {
        window.location.href = '/home'; 
        return;
    }
    const userDoc = await getDoc(doc(db, "users", u.uid));
    currentUser = { id: u.uid, ...userDoc.data() };
    document.getElementById('current-username').innerText = currentUser.username || currentUser.name;
    loadConversations();
    lucide.createIcons();
    checkForSharedPost();
});

function loadConversations() {
    if (unsubscribeConversations) unsubscribeConversations();
    
    const container = document.getElementById('chat-list-container');
    container.innerHTML = '<div class="flex flex-col items-center justify-center h-40 opacity-50"><i data-lucide="loader-2" class="w-6 h-6 animate-spin text-gray-400"></i></div>';
    
    const q = query(
        collection(db, "chats"), 
        where("participants", "array-contains", currentUser.id)
    );

    unsubscribeConversations = onSnapshot(q, async (snapshot) => {
        const currentRenderId = ++conversationRenderId;

        if (snapshot.empty) {
            container.innerHTML = '<div class="p-6 text-center text-gray-500 text-sm mt-10">No messages yet.<br>Start a conversation!</div>';
            return;
        }

        const chatsData = [];
        snapshot.forEach(doc => chatsData.push({ id: doc.id, ...doc.data() }));

        chatsData.sort((a, b) => {
            const tA = a.lastMessageTimestamp?.toMillis() || 0;
            const tB = b.lastMessageTimestamp?.toMillis() || 0;
            return tB - tA; 
        });

        const renderedItems = await Promise.all(chatsData.map(async (chat) => {
            const otherUserId = chat.participants.find(uid => uid !== currentUser.id);
            if (!otherUserId) return '';

            let otherUser = { name: 'User', avatar: 'https://via.placeholder.com/150' };
            try {
                const uSnap = await getDoc(doc(db, "users", otherUserId));
                if (uSnap.exists()) otherUser = uSnap.data();
            } catch (e) {}

            const isUnread = !chat.readBy || !chat.readBy.includes(currentUser.id);
            const isSelected = currentChatId === chat.id;
            const timeStr = formatTime(chat.lastMessageTimestamp);
            const lastMsg = chat.lastMessage || 'Start chatting';
            
            let statusHtml = '';
            if (isUnread) {
                statusHtml = `<div class="w-2.5 h-2.5 bg-[#0095f6] rounded-full shrink-0"></div>`;
            }

            const userJson = JSON.stringify(otherUser).replace(/"/g, '&quot;');
            
            return `
            <div class="user-item ${isSelected ? 'active' : ''}" onclick="openChat('${chat.id}', ${userJson}, '${otherUserId}')">
                <div class="relative shrink-0">
                    <img src="${otherUser.avatar}" class="w-14 h-14 rounded-full border border-gray-100 object-cover">
                </div>
                <div class="flex-1 min-w-0">
                    <div class="font-normal text-gray-900 text-[15px] truncate">${otherUser.name}</div>
                    <div class="flex items-center gap-1 text-[13px] ${isUnread ? "font-bold text-gray-900" : "text-gray-500"}">
                        <span class="truncate block max-w-[170px]">${lastMsg}</span>
                        <span class="shrink-0 text-gray-400 font-normal">· ${timeStr}</span>
                    </div>
                </div>
                ${statusHtml}
            </div>`;
        }));

        if (currentRenderId !== conversationRenderId) return;
        container.innerHTML = renderedItems.join('');
        lucide.createIcons();
    });
}

window.openChat = async (chatId, user, userId) => {
    currentChatId = chatId;
    currentChatUser = { ...user, id: userId };
    cancelReply(); 

    document.body.classList.add('chat-active');
    document.getElementById('chat-window-panel').classList.remove('hidden');
    document.getElementById('empty-state').classList.add('hidden');
    document.getElementById('active-chat-interface').classList.remove('hidden');
    
    document.querySelectorAll('.user-item').forEach(el => el.classList.remove('active'));
    
    document.getElementById('chat-header-name').innerText = user.name;
    document.getElementById('chat-header-avatar').src = user.avatar;
    
    if (unsubscribeChatMeta) unsubscribeChatMeta();
    unsubscribeChatMeta = onSnapshot(doc(db, "chats", chatId), (docSnap) => {
        if (docSnap.exists()) {
            currentChatData = docSnap.data();
            renderSeenStatus(); 
        }
    });

    try {
        const uSnap = await getDoc(doc(db, "users", userId));
        if (uSnap.exists()) currentChatUser = { id: userId, ...uSnap.data() };
    } catch(e) {}

    updateDoc(doc(db, "chats", chatId), {
        readBy: arrayUnion(currentUser.id)
    }).catch(e => {});

    loadMessages(chatId);
};

async function checkForSharedPost() {
    const urlParams = new URLSearchParams(window.location.search);
    const sharedPostId = urlParams.get('sharePostId');
    if (sharedPostId) {
        try {
            const postSnap = await getDoc(doc(db, "posts", sharedPostId));
            if (postSnap.exists()) {
                pendingSharePost = { id: postSnap.id, ...postSnap.data() };
                openNewChatModal();
                document.getElementById('modal-title').innerText = "Share Post";
                document.getElementById('start-chat-btn').innerText = "Send";
                const previewDiv = document.getElementById('share-preview-container');
                previewDiv.classList.remove('hidden');
                document.getElementById('share-preview-text').innerText = pendingSharePost.content || "Post";
                let img = pendingSharePost.image || (pendingSharePost.media?.[0]) || 'https://via.placeholder.com/150';
                document.getElementById('share-preview-img').src = img;
                window.history.replaceState({}, document.title, "chat.html");
            }
        } catch (e) {}
    }
}

window.closeChat = () => {
    document.body.classList.remove('chat-active');
    currentChatId = null;
    if (unsubscribeMessages) unsubscribeMessages();
    if (unsubscribeChatMeta) unsubscribeChatMeta();
};

window.viewProfile = () => {
    if (currentChatUser) {
        window.location.href = `/home?profileId=${currentChatUser.id}`;
    }
};

function loadMessages(chatId) {
    if (unsubscribeMessages) unsubscribeMessages();
    const q = query(collection(db, `chats/${chatId}/messages`), orderBy("timestamp", "asc"));
    const container = document.getElementById('messages-container');

    unsubscribeMessages = onSnapshot(q, (snapshot) => {
        const messages = [];
        snapshot.forEach(doc => {
            const d = doc.data();
            if(!d.hiddenBy || !d.hiddenBy.includes(currentUser.id)) {
                messages.push({ id: doc.id, ...d });
            }
        });

        container.innerHTML = ''; 
        let lastMessageFromSelf = null;

        messages.forEach((msg, index) => {
            const isSelf = msg.senderId === currentUser.id;
            
            if (isSelf) lastMessageFromSelf = { id: msg.id, ...msg };
            
            // Avatar logic: Show if not self AND (next msg is from different sender OR undefined)
            let showAvatar = false;
            if (!isSelf) {
                const nextMsg = messages[index + 1];
                if (!nextMsg || nextMsg.senderId !== msg.senderId) {
                    showAvatar = true;
                }
            }

            const hasReactions = msg.reactions && msg.reactions.length > 0;
            
            const div = document.createElement('div');
            div.className = `msg-group fade-in ${hasReactions ? 'has-reaction' : ''}`;
            div.id = `msg-group-${msg.id}`;
            
            const reactionHtml = hasReactions ? `<div class="msg-reaction like-animation"><i data-lucide="heart" class="w-3.5 h-3.5 fill-red-500 text-red-500"></i></div>` : '';

            const reactionsJson = JSON.stringify(msg.reactions || []).replace(/"/g, '&quot;');

            let contentHtml = '';
            let bubbleStyle = '';
            let rawContent = msg.content;
            let bubbleClass = isSelf ? 'msg-self' : 'msg-other';
            let isTransparent = false;
            let replyHtml = '';
            
            // Emoji Detection
            const isEmojiOnly = msg.type === 'text' && 
                                /^[ \p{Emoji_Presentation}\p{Extended_Pictographic}\u{1F3FB}-\u{1F3FF}\u{200D}]+$/u.test(msg.content) && 
                                msg.content.length < 15;

            // Reply Block Logic
            if (msg.replyTo) {
                const replyClass = isSelf ? 'reply-block-self' : 'reply-block-other';
                replyHtml = `
                    <div class="reply-upper-block ${replyClass}" onclick="window.scrollToMessage('${msg.replyTo.id}')">
                        <span class="reply-header">Replying to ${msg.replyTo.name || 'User'}</span>
                        <span class="reply-body">${msg.replyTo.body || 'Message'}</span>
                    </div>
                `;
                
                if (!isTransparent) {
                   bubbleClass += isSelf ? ' bubble-connected-self' : ' bubble-connected-other';
                }
            }

            if (msg.type === 'image') {
                contentHtml = `<img src="${msg.content}" class="rounded-lg max-w-full cursor-pointer border border-gray-100" onclick="window.open('${msg.content}', '_blank'); event.stopPropagation();">`;
                bubbleStyle = 'padding: 4px; background: transparent;';
                bubbleClass = 'bubble-transparent';
                isTransparent = true;
                rawContent = "Photo";
            } else if (msg.type === 'post') {
                let postData = typeof msg.postData === 'string' ? JSON.parse(msg.postData) : msg.postData;
                contentHtml = renderPostCard(postData, isSelf);
                bubbleStyle = 'padding: 0; background: transparent;';
                bubbleClass = 'bubble-transparent';
                isTransparent = true;
                rawContent = "Post";
            } else if (msg.type === 'heart') {
                 contentHtml = `<i data-lucide="heart" class="w-12 h-12 text-[#ff3040] fill-[#ff3040] heart-fixed"></i>`;
                 bubbleStyle = 'background: transparent; padding: 0;';
                 bubbleClass = 'bubble-transparent';
                 isTransparent = true;
                 rawContent = "";
            } else if (isEmojiOnly) {
                contentHtml = `<div class="${msg.content.length <= 6 ? 'emoji-jumbo' : 'emoji-large'}">${msg.content}</div>`;
                bubbleStyle = 'background: transparent; padding: 0;';
                bubbleClass = 'bubble-transparent';
                isTransparent = true;
            } else {
                contentHtml = linkify(msg.content);
            }

            // Swipe Handlers
            const swipeHandlers = `
                ontouchstart="handleSwipeStart(event, '${msg.id}', '${escapeHtml(rawContent)}', '${isSelf ? 'You' : (currentChatUser ? currentChatUser.name : 'User')}')"
                ontouchmove="handleSwipeMove(event)"
                ontouchend="handleSwipeEnd(event)"
            `;

            // Interaction Handlers (Click + Hold + Double Click)
            const interactHandlers = `
                ondblclick="toggleMessageLike('${msg.id}')"
                onclick="handleMessageClick(event, '${msg.id}', '${escapeHtml(rawContent)}', ${isSelf}, '${msg.type}', ${reactionsJson})"
                onmousedown="handlePressStart(event, '${msg.id}', '${escapeHtml(rawContent)}', ${isSelf}, '${msg.type}', ${reactionsJson})"
                ontouchstart="handlePressStart(event, '${msg.id}', '${escapeHtml(rawContent)}', ${isSelf}, '${msg.type}', ${reactionsJson}')"
                onmouseup="handlePressEnd(event)"
                ontouchend="handlePressEnd(event)"
                onmousemove="handlePressMove(event)"
                ontouchmove="handlePressMove(event)"
                oncontextmenu="return false;"
            `;

            // Avatar Rendering
            let avatarElement = '';
            if (!isSelf) {
                if (showAvatar) {
                    const avatarUrl = currentChatUser?.avatar || 'https://via.placeholder.com/150';
                    avatarElement = `<img src="${avatarUrl}" class="msg-avatar">`;
                } else {
                    avatarElement = `<div class="msg-avatar-placeholder"></div>`;
                }
            }

            div.innerHTML = `
                <div class="msg-container ${isSelf ? 'self' : 'other'}">
                    
                    ${!isSelf ? avatarElement : ''}

                    <div class="msg-swipe-wrapper" id="swipe-${msg.id}" ${swipeHandlers}>
                        
                        <div class="reply-icon-container">
                            <div class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center shadow-sm">
                                <i data-lucide="reply" class="w-4 h-4 text-gray-500"></i>
                            </div>
                        </div>
                        
                        <div class="msg-content-stack">
                            ${replyHtml}
                            <div class="msg-bubble ${bubbleClass} noselect" style="${bubbleStyle}" ${interactHandlers}>
                                ${contentHtml}
                                ${reactionHtml}
                            </div>
                        </div>

                    </div>

                </div>
            `;
            container.appendChild(div);
        });

        const statusDiv = document.createElement('div');
        statusDiv.id = 'seen-status-container';
        container.appendChild(statusDiv);
        
        if (lastMessageFromSelf) {
            renderSeenStatus(lastMessageFromSelf.id);
        }

        setTimeout(() => { container.scrollTop = container.scrollHeight; }, 100);
        lucide.createIcons();
    });
}

window.handleMessageClick = (e, msgId, content, isSelf, type, reactions) => {
    // Debounce single click to allow double click to happen
    if (messageClickTimer) clearTimeout(messageClickTimer);
    
    // If user is swiping or long pressing, don't trigger
    if(pressTimer !== null || activeSwipeEl !== null) return;

    messageClickTimer = setTimeout(() => {
        openMsgOptions(msgId, content, isSelf, type, reactions);
        messageClickTimer = null;
    }, 250); // 250ms wait for double click
};

window.scrollToMessage = (msgId) => {
    const el = document.getElementById(`msg-group-${msgId}`);
    if (el) {
        el.scrollIntoView({behavior: 'smooth', block: 'center'});
        el.classList.add('highlight-message');
        setTimeout(() => {
            el.classList.remove('highlight-message');
        }, 2000);
    }
};

function renderSeenStatus(lastSelfMsgId = null) {
    const container = document.getElementById('seen-status-container');
    if (!container) return;
    
    if (!currentChatData || !currentChatData.readBy || !currentChatUser) {
        container.innerHTML = '';
        return;
    }

    const isReadByOther = currentChatData.readBy.includes(currentChatUser.id);
    const allMsgs = document.querySelectorAll('.msg-container');
    if (allMsgs.length === 0) return;
    const lastEl = allMsgs[allMsgs.length - 1];
    
    if (lastEl.classList.contains('self')) {
         if (isReadByOther) {
             container.innerHTML = `<div class="seen-status">Seen</div>`;
         } else {
             container.innerHTML = `<div class="seen-status">Delivered</div>`;
         }
    } else {
        container.innerHTML = '';
    }
}

// Swipe to Reply Logic
window.handleSwipeStart = (e, msgId, content, user) => {
    if (e.touches.length > 1) return;
    
    activeSwipeEl = e.currentTarget;
    swipeStartX = e.touches[0].clientX;
    swipeStartY = e.touches[0].clientY;
    isSwiping = false;
    
    activeSwipeEl.dataset.msgId = msgId;
    activeSwipeEl.dataset.content = content;
    activeSwipeEl.dataset.user = user;
    
    activeSwipeEl.style.transition = 'none';
};

window.handleSwipeMove = (e) => {
    if (!activeSwipeEl) return;
    const currentX = e.touches[0].clientX;
    const currentY = e.touches[0].clientY;
    const diffX = currentX - swipeStartX;
    const diffY = currentY - swipeStartY;

    if (!isSwiping) {
        if (Math.abs(diffX) > 10 && Math.abs(diffX) > Math.abs(diffY)) {
            isSwiping = true;
            if (pressTimer) {
                clearTimeout(pressTimer);
                pressTimer = null;
            }
        } else {
            return; 
        }
    }

    if (isSwiping) {
        e.preventDefault(); 
        let translate = diffX * 0.5;
        if (translate > 80) translate = 80 + (translate - 80) * 0.2;
        if (translate < -80) translate = -80 + (translate + 80) * 0.2;
        activeSwipeEl.style.transform = `translateX(${translate}px)`;
        
        const icon = activeSwipeEl.querySelector('.reply-icon-container');
        if (icon) {
            const progress = Math.min(Math.abs(translate) / 50, 1);
            icon.style.opacity = progress;
            icon.style.transform = `translateY(-50%) scale(${0.5 + progress * 0.5})`;
        }
    }
};

window.handleSwipeEnd = (e) => {
    if (!activeSwipeEl) return;
    
    activeSwipeEl.style.transition = 'transform 0.3s cubic-bezier(0.2, 0, 0, 1)';
    activeSwipeEl.style.transform = 'translateX(0)';
    
    const icon = activeSwipeEl.querySelector('.reply-icon-container');
    if (icon) {
        icon.style.opacity = '0';
        icon.style.transform = 'translateY(-50%) scale(0)';
    }

    const diffX = e.changedTouches[0].clientX - swipeStartX;

    if (isSwiping && Math.abs(diffX) > 50) {
        replyToMessage(
            activeSwipeEl.dataset.msgId, 
            activeSwipeEl.dataset.content, 
            activeSwipeEl.dataset.user
        );
    }
    
    activeSwipeEl = null;
    isSwiping = false;
};

window.replyToMessage = (msgId, content, username) => {
    currentReplyContext = { msgId, content, username };
    
    const banner = document.getElementById('reply-context-bar');
    const userEl = document.getElementById('reply-to-user');
    const textEl = document.getElementById('reply-to-text');
    
    userEl.innerText = `Replying to ${username}`;
    textEl.innerText = content;
    
    banner.classList.add('active');
    document.getElementById('message-input').focus();
};

window.cancelReply = () => {
    currentReplyContext = null;
    document.getElementById('reply-context-bar').classList.remove('active');
};

function escapeHtml(text) {
  if (!text) return '';
  return text.replace(/'/g, "\\'").replace(/"/g, '&quot;');
}

window.handlePostClick = (postId) => {
    if (postClickTimer) {
        clearTimeout(postClickTimer);
        postClickTimer = null;
        return; 
    }
    postClickTimer = setTimeout(() => {
        window.location.href = '/home?postId=' + postId;
        postClickTimer = null;
    }, 250); 
};

function renderPostCard(post, isSelf) {
    let img = null;
    if (post.image) img = post.image;
    else if (post.media && Array.isArray(post.media) && post.media.length > 0) img = post.media[0];
    else if (typeof post.media === 'string') img = post.media;

    const hasImage = img && !img.includes('video') && !img.endsWith('.mp4');
    const imgHtml = hasImage ? `<div class="cpc-img-container"><img src="${img}" class="cpc-img"></div>` : ``; 

    return `
        <div class="chat-post-card" onclick="window.handlePostClick('${post.id}')">
            <div class="cpc-header">
                <img src="${post.authorAvatar || 'https://via.placeholder.com/50'}" class="w-6 h-6 rounded-full border border-white/20 object-cover flex-shrink-0">
                <span class="font-bold text-xs truncate flex-1">${post.authorName || 'User'}</span>
            </div>
            ${imgHtml}
            <div class="cpc-footer">
                <p class="truncate font-medium">${post.content || 'Shared post'}</p>
            </div>
        </div>
    `;
}

function linkify(text) {
    if(!text) return '';
    const urlRegex = /(https?:\/\/[^\s]+)/g;
    return text.replace(urlRegex, (url) => {
        return `<a href="${url}" target="_blank" class="underline hover:opacity-80 break-all">${url}</a>`;
    });
}

function formatTime(timestamp) {
    if (!timestamp) return '';
    const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
    const diff = new Date() - date;
    if (diff < 86400000) return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    if (diff < 604800000) return date.toLocaleDateString([], { weekday: 'short' });
    return date.toLocaleDateString([], { month: 'short', day: 'numeric' });
}

window.toggleMessageLike = async (msgId) => {
    // Cancel any pending single click action
    if(messageClickTimer) {
        clearTimeout(messageClickTimer);
        messageClickTimer = null;
    }

    if (!currentChatId || !currentUser) return;
    const msgRef = doc(db, `chats/${currentChatId}/messages`, msgId);
    try {
        const msgSnap = await getDoc(msgRef);
        if (msgSnap.exists()) {
            const data = msgSnap.data();
            const reactions = data.reactions || [];
            if (reactions.includes(currentUser.id)) {
                await updateDoc(msgRef, { reactions: arrayRemove(currentUser.id) });
            } else {
                await updateDoc(msgRef, { reactions: arrayUnion(currentUser.id) });
            }
        }
    } catch(e) {}
};

window.handleTyping = (e) => {
    const val = e.target.value.trim();
    const sendBtn = document.getElementById('send-btn');
    const likeBtn = document.getElementById('like-btn');
    
    if (val.length > 0) {
        sendBtn.classList.remove('hidden');
        likeBtn.classList.add('hidden');
    } else {
        sendBtn.classList.add('hidden');
        likeBtn.classList.remove('hidden');
    }

    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
};

window.sendMessage = async (type = 'text', content = null, extraData = {}) => {
    if (!currentChatId || !currentUser) return;
    
    const input = document.getElementById('message-input');
    let msgContent = content || input.value.trim();
    
    if (!msgContent && type === 'text') return;

    const postLinkMatch = msgContent.match(/postId=([a-zA-Z0-9_-]+)/);
    if (type === 'text' && postLinkMatch) {
        const postId = postLinkMatch[1];
        try {
            const postSnap = await getDoc(doc(db, "posts", postId));
            if (postSnap.exists()) {
                type = 'post';
                const postRaw = postSnap.data();
                if(!postRaw.authorAvatar || !postRaw.authorName) {
                    try {
                        const authSnap = await getDoc(doc(db, "users", postRaw.authorId));
                        if(authSnap.exists()){
                            const ad = authSnap.data();
                            postRaw.authorName = ad.name;
                            postRaw.authorAvatar = ad.avatar;
                        }
                    } catch(e){}
                }
                extraData = { postData: { id: postSnap.id, ...postRaw } };
                msgContent = ''; 
            }
        } catch (e) {}
    }

    input.value = '';
    document.getElementById('send-btn').classList.add('hidden');
    document.getElementById('like-btn').classList.remove('hidden');
    document.getElementById('message-input').focus();

    const messageData = {
        senderId: currentUser.id,
        content: msgContent,
        timestamp: serverTimestamp(),
        type: type,
        ...extraData
    };

    if (currentReplyContext) {
        messageData.replyTo = {
            id: currentReplyContext.msgId,
            body: currentReplyContext.content,
            name: currentReplyContext.username
        };
        cancelReply();
    }

    try {
        await addDoc(collection(db, `chats/${currentChatId}/messages`), messageData);
        
        let preview = msgContent;
        if (type === 'image') preview = 'Sent a photo';
        if (type === 'post') preview = `Sent a post`;
        if (type === 'heart') preview = '❤️';

        await updateDoc(doc(db, "chats", currentChatId), {
            lastMessage: preview,
            lastMessageTimestamp: serverTimestamp(),
            readBy: [currentUser.id],
            lastSenderId: currentUser.id
        });
    } catch (error) {
        console.error("Error sending message:", error);
    }
};

window.sendHeart = () => sendMessage('heart', '❤️');

window.handleImageUpload = async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const btn = document.getElementById('send-btn');
    btn.classList.remove('hidden');
    
    try {
        const storageRef = ref(storage, `chat_images/${currentChatId}/${Date.now()}_${file.name}`);
        const snapshot = await uploadBytes(storageRef, file);
        const downloadURL = await getDownloadURL(snapshot.ref);
        await sendMessage('image', downloadURL);
    } catch (error) {
        alert("Failed to upload image.");
    } finally {
        btn.classList.add('hidden');
        e.target.value = '';
    }
};

window.openChatDetails = () => {
    if(!currentChatUser) return;
    const u = currentChatUser;
    document.getElementById('cd-avatar').src = u.avatar;
    document.getElementById('cd-banner').style.backgroundImage = `url(${u.banner || 'https://images.unsplash.com/photo-1579546929518-9e396f3cc809?ixlib=rb-1.2.1&auto=format&fit=crop&w=1000&q=80'})`;
    document.getElementById('cd-name').innerHTML = `${u.name} ${u.isOfficial ? '<i data-lucide="badge-check" class="w-4 h-4 text-blue-500 fill-white"></i>' : ''}`;
    document.getElementById('cd-username').innerText = `@${u.username || 'user'}`;
    document.getElementById('cd-bio').innerText = u.bio || '';
    
    document.getElementById('cd-followers').innerText = u.followers ? u.followers.length : 0;
    document.getElementById('cd-following').innerText = u.following ? u.following.length : 0;

    const overlay = document.getElementById('chat-details-overlay');
    overlay.classList.remove('hidden');
    setTimeout(() => {
        overlay.classList.remove('opacity-0');
        overlay.classList.add('open');
    }, 10);
    lucide.createIcons();
};

window.closeChatDetails = () => {
    const overlay = document.getElementById('chat-details-overlay');
    overlay.classList.remove('open');
    overlay.classList.add('opacity-0');
    setTimeout(() => overlay.classList.add('hidden'), 300);
};

window.viewProfileFromDetails = () => {
    closeChatDetails();
    if (currentChatUser) {
        window.location.href = `/home?profileId=${currentChatUser.id}`;
    }
};

// --- Long Press Message Options Logic ---
window.handlePressStart = (e, msgId, content, isSelf, type, reactions) => {
    if (e.type === 'mousedown' && e.button !== 0) return;
    
    if (e.type === 'contextmenu') e.preventDefault();
    
    pressStartX = e.touches ? e.touches[0].clientX : e.clientX;
    pressStartY = e.touches ? e.touches[0].clientY : e.clientY;
    
    pressTimer = setTimeout(() => {
        // Clear click timer if a long press is detected
        if(messageClickTimer) {
             clearTimeout(messageClickTimer);
             messageClickTimer = null;
        }
        openMsgOptions(msgId, content, isSelf, type, reactions);
    }, 500); 
};

window.handlePressMove = (e) => {
    if(!pressTimer) return;
    const x = e.touches ? e.touches[0].clientX : e.clientX;
    const y = e.touches ? e.touches[0].clientY : e.clientY;
    const diffX = Math.abs(x - pressStartX);
    const diffY = Math.abs(y - pressStartY);
    
    // Increased tolerance to 20px to make hold more robust on mobile
    if(diffX > 20 || diffY > 20) {
        clearTimeout(pressTimer);
        pressTimer = null;
    }
};

window.handlePressEnd = (e) => {
    if(pressTimer) {
        clearTimeout(pressTimer);
        pressTimer = null;
    }
};

window.openMsgOptions = (msgId, content, isSelf, type, reactions) => {
    currentMsgContext = { msgId, content, isSelf, type };
    const modal = document.getElementById('msg-options-modal');
    
    let html = `<div class="p-2 flex flex-col gap-1">`;
    
    if (reactions && reactions.length > 0) {
        let reactorHtml = '';
        reactions.forEach(uid => {
            let u = null;
            if(uid === currentUser.id) u = currentUser;
            else if(uid === currentChatUser.id) u = currentChatUser;
            
            if(u) {
                reactorHtml += `
                <div class="flex items-center gap-2 p-2 rounded-lg hover:bg-gray-50">
                    <img src="${u.avatar}" class="w-6 h-6 rounded-full object-cover">
                    <span class="text-xs font-bold text-gray-900">${u.name}</span>
                    <i data-lucide="heart" class="w-3 h-3 text-red-500 fill-red-500 ml-auto"></i>
                </div>`;
            }
        });
        
        if (reactorHtml) {
            html += `
            <div class="px-2 pt-2 pb-1 text-xs font-bold text-gray-500 uppercase tracking-wide">Reactions</div>
            <div class="mb-2 bg-white rounded-xl border border-gray-100 p-1">
                ${reactorHtml}
            </div>
            `;
        }
    }

    html += `<button onclick="triggerReplyFromModal()" class="w-full text-left px-4 py-3 hover:bg-gray-50 rounded-xl font-bold text-gray-700 flex items-center gap-3 text-sm"><i data-lucide="reply" class="w-5 h-5 text-gray-500"></i> Reply</button>`;

    if (type === 'text') {
         html += `<button onclick="copyMsgText()" class="w-full text-left px-4 py-3 hover:bg-gray-50 rounded-xl font-bold text-gray-700 flex items-center gap-3 text-sm"><i data-lucide="copy" class="w-5 h-5 text-gray-500"></i> Copy</button>`;
    }

    if (isSelf) {
        html += `<button onclick="unsendMsg()" class="w-full text-left px-4 py-3 hover:bg-red-50 rounded-xl font-bold text-red-600 flex items-center gap-3 text-sm"><i data-lucide="trash-2" class="w-5 h-5"></i> Unsend</button>`;
    }

    html += `<button onclick="deleteForMe()" class="w-full text-left px-4 py-3 hover:bg-gray-50 rounded-xl font-bold text-gray-700 flex items-center gap-3 text-sm"><i data-lucide="eye-off" class="w-5 h-5 text-gray-500"></i> Delete for me</button>`;

    html += `</div><div class="p-2 border-t border-gray-100"><button onclick="closeMsgOptions()" class="w-full py-3 font-bold text-gray-900 hover:bg-gray-50 rounded-xl text-sm">Cancel</button></div>`;
    
    modal.innerHTML = html;
    lucide.createIcons();

    const overlay = document.getElementById('msg-options-overlay');
    overlay.classList.remove('hidden');
    setTimeout(() => {
        overlay.classList.remove('opacity-0');
        modal.classList.remove('translate-y-full','md:scale-95');
        modal.classList.add('translate-y-0','md:scale-100');
    }, 10);
};

window.closeMsgOptions = () => {
    const overlay = document.getElementById('msg-options-overlay');
    const modal = document.getElementById('msg-options-modal');
    overlay.classList.add('opacity-0');
    modal.classList.add('translate-y-full','md:scale-95');
    modal.classList.remove('translate-y-0','md:scale-100');
    setTimeout(() => overlay.classList.add('hidden'), 200);
};

window.triggerReplyFromModal = () => {
    if(currentMsgContext) {
        replyToMessage(currentMsgContext.msgId, currentMsgContext.content, currentMsgContext.isSelf ? 'You' : (currentChatUser ? currentChatUser.name : 'User'));
    }
    closeMsgOptions();
};

window.copyMsgText = () => {
    if (currentMsgContext && currentMsgContext.content) {
        navigator.clipboard.writeText(currentMsgContext.content);
    }
    closeMsgOptions();
};

window.unsendMsg = async () => {
    if (!currentMsgContext) return;
    const { msgId } = currentMsgContext;
    closeMsgOptions();
    try {
        await deleteDoc(doc(db, `chats/${currentChatId}/messages`, msgId));
        updateDoc(doc(db, "chats", currentChatId), { lastMessage: "Message unsent" }).catch(()=>{});
    } catch(e) {}
};

window.deleteForMe = async () => {
    if (!currentMsgContext) return;
    const { msgId } = currentMsgContext;
    closeMsgOptions();
    try {
        await updateDoc(doc(db, `chats/${currentChatId}/messages`, msgId), {
            hiddenBy: arrayUnion(currentUser.id)
        });
    } catch(e) {}
};

window.openNewChatModal = () => {
    document.getElementById('new-chat-overlay').classList.remove('hidden');
    setTimeout(() => {
        document.getElementById('new-chat-overlay').classList.remove('opacity-0');
        document.getElementById('new-chat-modal').classList.add('open');
    }, 10);
    document.getElementById('user-search-input').focus();
    loadSuggestedUsers();
};

window.closeNewChatModal = () => {
    document.getElementById('new-chat-overlay').classList.add('opacity-0');
    document.getElementById('new-chat-modal').classList.remove('open');
    setTimeout(() => {
        document.getElementById('new-chat-overlay').classList.add('hidden');
        pendingSharePost = null;
        document.getElementById('modal-title').innerText = "New Message";
        document.getElementById('start-chat-btn').innerText = "Chat";
        document.getElementById('share-preview-container').classList.add('hidden');
    }, 300);
    
    selectedUserForNewChat = null;
    document.getElementById('start-chat-btn').disabled = true;
    document.getElementById('start-chat-btn').classList.add('opacity-50');
    document.getElementById('user-search-input').value = '';
};

async function loadSuggestedUsers() {
    const q = query(collection(db, "users"), limit(15));
    const snap = await getDocs(q);
    const list = document.getElementById('suggested-users-list');
    list.innerHTML = '';
    snap.forEach(doc => {
        const u = {id: doc.id, ...doc.data()};
        if (u.id === currentUser.id) return;
        renderSearchUserItem(u, list);
    });
}

window.handleUserSearch = async (val) => {
    const term = val.toLowerCase().trim();
    if (!term) return loadSuggestedUsers();
    
    const list = document.getElementById('suggested-users-list');
    list.innerHTML = '<div class="p-4 text-center"><i data-lucide="loader-2" class="animate-spin w-5 h-5 mx-auto"></i></div>';
    
    const q = query(collection(db, "users"));
    const snap = await getDocs(q);
    list.innerHTML = '';
    let found = false;
    snap.forEach(doc => {
        const u = {id: doc.id, ...doc.data()};
        if (u.id === currentUser.id) return;
        if (u.name.toLowerCase().includes(term) || (u.username || '').toLowerCase().includes(term)) {
            renderSearchUserItem(u, list);
            found = true;
        }
    });
    if (!found) list.innerHTML = '<div class="p-4 text-center text-gray-500 text-sm">No users found.</div>';
    lucide.createIcons();
};

function renderSearchUserItem(user, container) {
    const div = document.createElement('div');
    div.className = 'flex items-center gap-3 p-3 hover:bg-gray-50 cursor-pointer rounded-xl transition-colors';
    div.onclick = () => selectUserForChat(user, div);
    div.innerHTML = `
        <img src="${user.avatar}" class="w-12 h-12 rounded-full border border-gray-100 object-cover">
        <div class="flex-1">
            <div class="font-bold text-gray-900 text-sm">${user.name}</div>
            <div class="text-xs text-gray-500">@${user.username || 'user'}</div>
        </div>
        <div class="selection-indicator w-6 h-6 rounded-full border-2 border-gray-300 flex items-center justify-center transition-all">
            <div class="w-3 h-3 bg-blue-500 rounded-full hidden"></div>
        </div>
    `;
    container.appendChild(div);
}

function selectUserForChat(user, element) {
    document.querySelectorAll('.selection-indicator').forEach(el => {
        el.style.borderColor = '#d1d5db';
        el.style.backgroundColor = 'transparent';
        el.querySelector('div').classList.add('hidden');
    });
    const indicator = element.querySelector('.selection-indicator');
    indicator.style.borderColor = '#0095f6';
    indicator.style.backgroundColor = '#0095f6';
    indicator.innerHTML = '<i data-lucide="check" class="w-4 h-4 text-white"></i>';
    lucide.createIcons();
    selectedUserForNewChat = user;
    const btn = document.getElementById('start-chat-btn');
    btn.disabled = false;
    btn.classList.remove('opacity-50', 'cursor-not-allowed');
    btn.classList.add('cursor-pointer');
}

window.startChat = async () => {
    if (!selectedUserForNewChat) return;
    const targetUser = selectedUserForNewChat;
    closeNewChatModal();

    const q = query(collection(db, "chats"), where("participants", "array-contains", currentUser.id));
    const snap = await getDocs(q);
    let chatId = null;
    snap.forEach(doc => {
        const data = doc.data();
        if (data.participants.includes(targetUser.id) && data.participants.length === 2) chatId = doc.id;
    });

    if (!chatId) {
        const ref = await addDoc(collection(db, "chats"), {
            participants: [currentUser.id, targetUser.id],
            lastMessage: pendingSharePost ? 'Sent a post' : 'Started a conversation',
            lastMessageTimestamp: serverTimestamp(),
            readBy: [currentUser.id],
            lastSenderId: currentUser.id
        });
        chatId = ref.id;
    }

    await openChat(chatId, targetUser, targetUser.id);

    if (pendingSharePost) {
        await sendMessage('post', '', { postData: pendingSharePost });
        pendingSharePost = null;
    }
};

lucide.createIcons();
</script>
</body>
</html>
