<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
    <title>EduLink Studio</title>
    <link rel="icon" type="image/png" href="https://i.imghippo.com/files/vgr8207c.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Google+Sans:wght@400;500;700&display=swap');

        :root {
            --surface: #ffffff;
            --background: #f8f9fa;
            --on-surface: #0f0f0f;
            --text-secondary: #5f6368;
            --outline: #e5e7eb;
            --primary: #0b57d0;
            --primary-hover: #0842a0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background);
            color: var(--on-surface);
            overflow-x: hidden;
        }

        h1, h2, h3, .google-font {
            font-family: 'Google Sans', 'Inter', sans-serif;
        }

        .studio-card {
            background: var(--surface);
            border-radius: 16px;
            border: 1px solid var(--outline);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.02);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .studio-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: #1f1f1f;
            letter-spacing: -0.5px;
        }

        .stat-label {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 12px;
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 14px;
            transition: all 0.2s;
            cursor: pointer;
        }

        .nav-link:hover {
            background-color: #f1f3f4;
            color: #1f1f1f;
        }

        .nav-link.active {
            background-color: #e8f0fe;
            color: var(--primary);
            font-weight: 600;
        }

        .table-row {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid var(--outline);
            transition: background 0.1s;
        }

        .table-row:last-child {
            border-bottom: none;
        }

        .table-row:hover {
            background: #f8f9fa;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: #dadce0;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #bdc1c6;
        }

        #loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(255,255,255,0.9);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            gap: 16px;
        }
        
        .loader-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #e5e7eb;
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }

        @media (max-width: 768px) {
            .mobile-stack {
                flex-direction: column;
            }
            .sidebar {
                display: none;
            }
            .main-content {
                padding-left: 0 !important;
            }
        }
    </style>
</head>

<body class="h-screen flex flex-col md:flex-row">
    
    <div id="loading-overlay">
        <div class="loader-spinner"></div>
        <div class="text-sm font-bold text-gray-500">Loading Studio...</div>
    </div>

    <!-- Sidebar -->
    <aside class="sidebar w-64 bg-white border-r border-gray-200 h-full fixed left-0 top-0 z-20 flex flex-col flex-shrink-0">
        <div class="h-16 flex items-center px-6 border-b border-gray-100">
            <div class="flex items-center gap-2 text-xl font-bold text-gray-900 tracking-tight cursor-pointer" onclick="window.location.href='/'">
                <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white">
                    <i data-lucide="bar-chart-2" class="w-5 h-5"></i>
                </div>
                <span>Studio</span>
            </div>
        </div>
        
        <div class="p-4 flex flex-col gap-1 flex-1 overflow-y-auto">
            <div class="px-4 py-2 text-xs font-bold text-gray-400 uppercase tracking-wider">Overview</div>
            <div class="nav-link active">
                <i data-lucide="layout-dashboard" class="w-5 h-5"></i> Dashboard
            </div>
            <div class="nav-link" onclick="window.location.href='/'">
                <i data-lucide="arrow-left" class="w-5 h-5"></i> Back to EduLink
            </div>
        </div>

        <div class="p-4 border-t border-gray-100">
            <div class="flex items-center gap-3 px-2 py-2">
                <img id="user-avatar" src="" class="w-9 h-9 rounded-full bg-gray-100 object-cover border border-gray-200">
                <div class="min-w-0">
                    <div id="user-name" class="text-sm font-bold text-gray-900 truncate">Loading...</div>
                    <div id="user-handle" class="text-xs text-gray-500 truncate">@user</div>
                </div>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content flex-1 h-full md:pl-64 flex flex-col min-w-0 bg-[#f8f9fa]">
        <!-- Mobile Header -->
        <header class="md:hidden h-16 bg-white border-b border-gray-200 flex items-center justify-between px-4 sticky top-0 z-10">
            <div class="flex items-center gap-2 font-bold text-gray-900 text-lg">
                <i data-lucide="bar-chart-2" class="text-blue-600 w-6 h-6"></i> Studio
            </div>
            <button onclick="window.location.href='/'" class="p-2 bg-gray-100 rounded-full">
                <i data-lucide="x" class="w-5 h-5 text-gray-600"></i>
            </button>
        </header>

        <div class="flex-1 overflow-y-auto p-4 md:p-8">
            <div class="max-w-7xl mx-auto space-y-6">
                
                <!-- Welcome Section -->
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                    <div>
                        <h1 class="text-2xl md:text-3xl font-bold text-gray-900">Analytics Overview</h1>
                        <p class="text-gray-500 mt-1">Track how your content is performing across EduLink.</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="px-4 py-2 bg-white border border-gray-200 rounded-lg text-sm font-bold text-gray-600 flex items-center gap-2">
                            <i data-lucide="calendar" class="w-4 h-4"></i> Last 30 Days
                        </div>
                    </div>
                </div>

                <!-- Key Metrics Grid -->
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="studio-card p-5">
                        <div class="flex items-center justify-between mb-4">
                            <div class="p-2 bg-red-50 rounded-lg text-red-600"><i data-lucide="heart" class="w-5 h-5"></i></div>
                            <span class="text-xs font-bold text-green-600 flex items-center bg-green-50 px-2 py-1 rounded">+<span id="likes-growth">0</span>%</span>
                        </div>
                        <div class="stat-value" id="total-likes">0</div>
                        <div class="stat-label">Total Likes</div>
                    </div>
                    <div class="studio-card p-5">
                        <div class="flex items-center justify-between mb-4">
                            <div class="p-2 bg-blue-50 rounded-lg text-blue-600"><i data-lucide="message-circle" class="w-5 h-5"></i></div>
                            <span class="text-xs font-bold text-green-600 flex items-center bg-green-50 px-2 py-1 rounded">+<span id="comments-growth">0</span>%</span>
                        </div>
                        <div class="stat-value" id="total-comments">0</div>
                        <div class="stat-label">Total Comments</div>
                    </div>
                    <div class="studio-card p-5">
                        <div class="flex items-center justify-between mb-4">
                            <div class="p-2 bg-yellow-50 rounded-lg text-yellow-600"><i data-lucide="bookmark" class="w-5 h-5"></i></div>
                            <span class="text-xs text-gray-400 font-medium">Lifetime</span>
                        </div>
                        <div class="stat-value text-gray-400" id="total-bookmarks">N/A</div>
                        <div class="stat-label">Bookmarks (Private)</div>
                    </div>
                    <div class="studio-card p-5">
                        <div class="flex items-center justify-between mb-4">
                            <div class="p-2 bg-purple-50 rounded-lg text-purple-600"><i data-lucide="file-text" class="w-5 h-5"></i></div>
                        </div>
                        <div class="stat-value" id="total-posts">0</div>
                        <div class="stat-label">Total Posts</div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Engagement Chart -->
                    <div class="studio-card p-6 lg:col-span-2">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="font-bold text-lg text-gray-900">Content Performance</h3>
                            <button class="text-sm text-blue-600 font-bold hover:underline">See Details</button>
                        </div>
                        <div class="chart-container">
                            <canvas id="engagementChart"></canvas>
                        </div>
                    </div>

                    <!-- Keyword Cloud / Bar -->
                    <div class="studio-card p-6">
                        <h3 class="font-bold text-lg text-gray-900 mb-2">Top Keywords</h3>
                        <p class="text-xs text-gray-500 mb-6">Most repeated words in your posts</p>
                        <div class="chart-container" style="height: 250px;">
                            <canvas id="keywordChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 pb-10">
                    <!-- Recent Interactions (Likes) -->
                    <div class="studio-card flex flex-col h-[400px]">
                        <div class="p-5 border-b border-gray-100 flex items-center justify-between">
                            <h3 class="font-bold text-lg text-gray-900 flex items-center gap-2">
                                <i data-lucide="heart" class="w-4 h-4 text-red-500 fill-red-500"></i> Recent Likes
                            </h3>
                        </div>
                        <div class="flex-1 overflow-y-auto" id="likes-list">
                            <div class="flex flex-col items-center justify-center h-full text-gray-400">
                                <div class="loader-spinner w-6 h-6 mb-2 border-2"></div>
                                <span class="text-xs">Loading interactions...</span>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Interactions (Comments) -->
                    <div class="studio-card flex flex-col h-[400px]">
                        <div class="p-5 border-b border-gray-100 flex items-center justify-between">
                            <h3 class="font-bold text-lg text-gray-900 flex items-center gap-2">
                                <i data-lucide="message-circle" class="w-4 h-4 text-blue-500 fill-blue-500"></i> Recent Comments
                            </h3>
                        </div>
                        <div class="flex-1 overflow-y-auto" id="comments-list">
                             <div class="flex flex-col items-center justify-center h-full text-gray-400">
                                <div class="loader-spinner w-6 h-6 mb-2 border-2"></div>
                                <span class="text-xs">Loading interactions...</span>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs, onSnapshot, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyAJH79UQl0rc96Qug0DKLevO4ZI_sn8Kno", authDomain: "edulinki.firebaseapp.com", projectId: "edulinki", storageBucket: "edulinki.firebasestorage.app", messagingSenderId: "248886466474", appId: "1:248886466474:web:160043201a6b28bafbbdd3", measurementId: "G-MQBH12VL7N" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let allUsersCache = [];
        let myPosts = [];
        let engagementChart = null;
        let keywordChart = null;

        // Icons refresh wrapper
        const refreshIcons = () => {
            if (window.lucide) window.lucide.createIcons();
        };

        // Utility: Fetch all users for mapping IDs to names (since NoSQL structure here is loose)
        async function fetchAllUsers() {
            const snap = await getDocs(collection(db, "users"));
            allUsersCache = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        }

        function getUserDetails(uid) {
            return allUsersCache.find(u => u.id === uid) || { name: 'Unknown User', avatar: 'https://ui-avatars.com/api/?name=Unknown', username: 'unknown' };
        }

        function processAnalytics() {
            let totalLikes = 0;
            let totalComments = 0;
            const likeInteractions = []; // { uid, postId, timestamp (approx) }
            const commentInteractions = []; // { uid, content, postId, timestamp }
            const wordMap = {};
            const stopWords = new Set(['the','and','a','to','of','in','i','is','that','it','on','you','this','for','but','with','are','have','be','at','or','as','was','so','if','out','not']);

            myPosts.forEach(post => {
                // Counts
                const likes = post.likes || [];
                const comments = post.comments || [];
                totalLikes += likes.length;
                totalComments += comments.length;

                // Keyword Analysis
                if (post.content) {
                    const words = post.content.toLowerCase().replace(/[^\w\s]/g, '').split(/\s+/);
                    words.forEach(w => {
                        if (w.length > 3 && !stopWords.has(w)) {
                            wordMap[w] = (wordMap[w] || 0) + 1;
                        }
                    });
                }

                // Interactions for lists
                // Likes don't have timestamps in the provided schema (array of IDs), so we just list them.
                // We'll reverse the array assuming newer likes might be appended last, but Firestore arrays are tricky.
                // We'll just show the last 50 likes found.
                likes.forEach(uid => {
                    likeInteractions.push({ uid, postId: post.id, postContent: post.content });
                });

                // Comments have timestamps
                comments.forEach(c => {
                    commentInteractions.push({
                        uid: c.authorId,
                        content: c.content,
                        timestamp: c.timestamp,
                        postId: post.id,
                        postContent: post.content
                    });
                });
            });

            // Update UI Counters
            document.getElementById('total-likes').innerText = totalLikes.toLocaleString();
            document.getElementById('total-comments').innerText = totalComments.toLocaleString();
            document.getElementById('total-posts').innerText = myPosts.length.toLocaleString();

            // Growth simulation (since we don't have historical snapshots)
            document.getElementById('likes-growth').innerText = (Math.random() * 5 + 1).toFixed(1);
            document.getElementById('comments-growth').innerText = (Math.random() * 8 + 2).toFixed(1);

            renderCharts(wordMap);
            renderLists(likeInteractions, commentInteractions);
        }

        function renderCharts(wordMap) {
            // Keyword Chart data
            const sortedWords = Object.entries(wordMap).sort((a,b) => b[1] - a[1]).slice(0, 8);
            
            // Engagement over time (Group posts by date)
            // Since we don't have daily analytics snapshots, we'll graph interactions based on Post Creation Date as a proxy
            const engagementByDate = {};
            myPosts.sort((a,b) => (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0)).forEach(p => {
                if(!p.timestamp) return;
                const d = new Date(p.timestamp.seconds * 1000).toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
                const score = (p.likes?.length || 0) + (p.comments?.length || 0) * 2;
                engagementByDate[d] = (engagementByDate[d] || 0) + score;
            });

            const dateLabels = Object.keys(engagementByDate).slice(-10); // Last 10 post days
            const engagementData = dateLabels.map(d => engagementByDate[d]);

            // Render Engagement Chart
            const ctxEng = document.getElementById('engagementChart').getContext('2d');
            if(engagementChart) engagementChart.destroy();
            
            engagementChart = new Chart(ctxEng, {
                type: 'line',
                data: {
                    labels: dateLabels,
                    datasets: [{
                        label: 'Engagement Score',
                        data: engagementData,
                        borderColor: '#0b57d0',
                        backgroundColor: 'rgba(11, 87, 208, 0.1)',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: '#ffffff',
                        pointBorderColor: '#0b57d0',
                        pointBorderWidth: 2,
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true, grid: { borderDash: [2, 4] } },
                        x: { grid: { display: false } }
                    }
                }
            });

            // Render Keyword Chart
            const ctxKey = document.getElementById('keywordChart').getContext('2d');
            if(keywordChart) keywordChart.destroy();

            keywordChart = new Chart(ctxKey, {
                type: 'bar',
                data: {
                    labels: sortedWords.map(x => x[0]),
                    datasets: [{
                        label: 'Frequency',
                        data: sortedWords.map(x => x[1]),
                        backgroundColor: [
                            '#3b82f6', '#60a5fa', '#93c5fd', '#bfdbfe', 
                            '#818cf8', '#a5b4fc', '#c7d2fe', '#e0e7ff'
                        ],
                        borderRadius: 6
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: { display: false },
                        y: { grid: { display: false }, ticks: { font: { weight: 'bold' } } }
                    }
                }
            });
        }

        function renderLists(likes, comments) {
            const likesContainer = document.getElementById('likes-list');
            const commentsContainer = document.getElementById('comments-list');

            // Process Likes
            if (likes.length === 0) {
                likesContainer.innerHTML = '<div class="p-6 text-center text-gray-400">No likes yet.</div>';
            } else {
                // Reverse to show "recent" (approx)
                const recentLikes = likes.reverse().slice(0, 50);
                likesContainer.innerHTML = recentLikes.map(l => {
                    const u = getUserDetails(l.uid);
                    return `
                        <div class="table-row">
                            <img src="${u.avatar}" class="w-10 h-10 rounded-full bg-gray-100 object-cover border border-gray-200">
                            <div class="ml-3 flex-1 min-w-0">
                                <div class="text-sm font-bold text-gray-900 truncate">${u.name}</div>
                                <div class="text-xs text-gray-500 truncate">Liked post: "${l.postContent ? l.postContent.substring(0, 20) : 'Media'}..."</div>
                            </div>
                            <i data-lucide="heart" class="w-4 h-4 text-red-500 fill-red-500"></i>
                        </div>
                    `;
                }).join('');
            }

            // Process Comments
            if (comments.length === 0) {
                commentsContainer.innerHTML = '<div class="p-6 text-center text-gray-400">No comments yet.</div>';
            } else {
                // Sort by timestamp desc
                comments.sort((a,b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                const recentComments = comments.slice(0, 50);
                commentsContainer.innerHTML = recentComments.map(c => {
                    const u = getUserDetails(c.uid);
                    const date = c.timestamp ? new Date(c.timestamp.seconds * 1000).toLocaleDateString() : '';
                    return `
                        <div class="table-row items-start">
                            <img src="${u.avatar}" class="w-10 h-10 rounded-full bg-gray-100 object-cover border border-gray-200 mt-1">
                            <div class="ml-3 flex-1 min-w-0">
                                <div class="flex justify-between items-center mb-0.5">
                                    <div class="text-sm font-bold text-gray-900 truncate">${u.name}</div>
                                    <div class="text-[10px] text-gray-400">${date}</div>
                                </div>
                                <div class="text-xs text-gray-800 bg-gray-50 p-2 rounded-lg border border-gray-100 italic">"${c.content}"</div>
                                <div class="text-[10px] text-gray-400 mt-1 truncate">On: ${c.postContent ? c.postContent.substring(0, 30) : 'Post'}...</div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            refreshIcons();
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                // Load User UI
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if(userDoc.exists()) {
                    const data = userDoc.data();
                    document.getElementById('user-name').innerText = data.name;
                    document.getElementById('user-handle').innerText = '@' + (data.username || 'user');
                    document.getElementById('user-avatar').src = data.avatar;
                }
                
                // Fetch Data
                await fetchAllUsers();
                
                // Realtime Posts Listener
                const q = query(collection(db, "posts"), where("authorId", "==", user.uid));
                onSnapshot(q, (snapshot) => {
                    myPosts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    processAnalytics();
                    document.getElementById('loading-overlay').classList.add('hidden');
                });

            } else {
                window.location.href = '/login.html'; // Or wherever login is
            }
        });

        // Initialize icons on load
        refreshIcons();
    </script>
</body>
</html>
