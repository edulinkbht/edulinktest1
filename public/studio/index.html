<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
    <title>Creator Studio</title>
    <link rel="icon" type="image/png" href="https://i.imghippo.com/files/vgr8207c.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        :root {
            --bg-color: #fafafa;
            --surface-color: #ffffff;
            --border-color: #dbdbdb;
            --text-primary: #262626;
            --text-secondary: #8e8e8e;
            --accent: #0095f6;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            overflow-x: hidden;
        }

        .studio-card {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 2px rgba(0,0,0,0.02);
        }

        /* Sidebar Navigation */
        .sidebar-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            margin-bottom: 4px;
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 15px;
            font-weight: 400;
            transition: background 0.2s;
            cursor: pointer;
        }

        .sidebar-item:hover {
            background-color: #f2f2f2;
        }

        .sidebar-item.active {
            font-weight: 600;
            background-color: #efefef;
        }

        /* Loading Overlay */
        #loading-overlay {
            position: fixed;
            inset: 0;
            background: #ffffff;
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            transition: opacity 0.3s ease;
        }
        #loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid #f0f0f0;
            border-top-color: #262626;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Post Grid */
        .post-grid-item {
            aspect-ratio: 1;
            background: #efefef;
            position: relative;
            cursor: pointer;
            border-radius: 2px;
            overflow: hidden;
        }
        
        .post-grid-item:hover {
            opacity: 0.95;
        }

        .post-grid-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        /* Stats Overlay on Grid Hover */
        .post-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.4);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 16px;
            color: white;
            opacity: 0;
            transition: opacity 0.2s;
            font-weight: 600;
        }
        
        .post-grid-item:hover .post-overlay {
            opacity: 1;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            z-index: 50;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 40px;
        }

        .modal-overlay.open {
            display: flex;
            animation: fadeIn 0.2s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.98); }
            to { opacity: 1; transform: scale(1); }
        }

        .modal-content {
            background: white;
            border-radius: 0 4px 4px 0;
            max-width: 1100px;
            width: 100%;
            height: 85vh;
            display: flex;
            overflow: hidden;
            border-radius: 12px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        @media (max-width: 768px) {
            .modal-content {
                flex-direction: column;
                height: 100%;
                border-radius: 0;
            }
            .modal-overlay {
                padding: 0;
                align-items: flex-end;
            }
        }

        .tab-btn {
            padding: 14px;
            flex: 1;
            text-align: center;
            border-bottom: 1px solid #dbdbdb;
            font-weight: 600;
            font-size: 14px;
            color: var(--text-secondary);
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .tab-btn.active {
            border-bottom: 2px solid #262626;
            color: var(--text-primary);
        }

        .custom-scroll {
            scrollbar-width: thin;
        }
        .custom-scroll::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background-color: #dbdbdb;
            border-radius: 3px;
        }
    </style>
</head>

<body class="h-screen flex">

    <!-- Loading Screen -->
    <div id="loading-overlay">
        <div class="spinner mb-4"></div>
        <div class="text-sm font-semibold text-gray-500">Loading Dashboard...</div>
    </div>

    <!-- Mobile Header -->
    <div class="md:hidden fixed top-0 w-full bg-white border-b border-gray-200 z-30 h-14 flex items-center justify-between px-4">
        <span class="font-bold text-lg">Professional Dashboard</span>
        <button onclick="window.location.href='/'" class="text-sm font-semibold text-blue-500">Exit</button>
    </div>

    <!-- Sidebar -->
    <aside class="hidden md:flex flex-col w-64 bg-white border-r border-gray-200 h-full fixed left-0 top-0 z-20">
        <div class="h-16 flex items-center px-6 mb-2">
            <span class="text-xl font-bold italic" style="font-family: 'Inter', sans-serif;">Studio</span>
        </div>
        
        <div class="px-2 py-2 flex-1 space-y-1">
            <div class="sidebar-item active" onclick="switchView('overview')" id="nav-overview">
                <i data-lucide="bar-chart-2" class="w-5 h-5"></i>
                Insights
            </div>
            <div class="sidebar-item" onclick="switchView('content')" id="nav-content">
                <i data-lucide="grid" class="w-5 h-5"></i>
                Content
            </div>
            <div class="mt-8 border-t border-gray-100 pt-4">
                 <div class="sidebar-item" onclick="window.location.href='/'">
                    <i data-lucide="arrow-left" class="w-5 h-5"></i>
                    Back to Feed
                </div>
            </div>
        </div>

        <div class="p-4 border-t border-gray-100">
            <div class="flex items-center gap-3">
                <img id="user-avatar" src="" class="w-8 h-8 rounded-full bg-gray-100 object-cover border border-gray-200">
                <div class="min-w-0">
                    <div id="user-name" class="text-sm font-semibold truncate">User</div>
                    <div class="text-xs text-gray-500">Creator Account</div>
                </div>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 ml-0 md:ml-64 h-full bg-[#fafafa] overflow-y-auto pt-14 md:pt-0">
        <div class="max-w-5xl mx-auto p-4 md:p-8 space-y-8">
            
            <!-- OVERVIEW SECTION -->
            <div id="view-overview" class="space-y-6">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">Performance</h1>
                    <p class="text-gray-500 text-sm mt-1">Analytics for the last 30 days</p>
                </div>

                <!-- Stats Cards -->
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                    <!-- Likes -->
                    <div class="studio-card p-5">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm text-gray-500 font-medium">Likes</span>
                            <i data-lucide="heart" class="w-4 h-4 text-gray-400"></i>
                        </div>
                        <div class="text-2xl font-bold" id="total-likes">0</div>
                    </div>
                    <!-- Comments -->
                    <div class="studio-card p-5">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm text-gray-500 font-medium">Comments</span>
                            <i data-lucide="message-circle" class="w-4 h-4 text-gray-400"></i>
                        </div>
                        <div class="text-2xl font-bold" id="total-comments">0</div>
                    </div>
                    <!-- Posts -->
                    <div class="studio-card p-5">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm text-gray-500 font-medium">Total Posts</span>
                            <i data-lucide="image" class="w-4 h-4 text-gray-400"></i>
                        </div>
                        <div class="text-2xl font-bold" id="total-posts">0</div>
                    </div>
                    <!-- Engagement Rate (Calc) -->
                    <div class="studio-card p-5">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm text-gray-500 font-medium">Engagement</span>
                            <i data-lucide="activity" class="w-4 h-4 text-gray-400"></i>
                        </div>
                        <div class="text-2xl font-bold" id="engagement-rate">0%</div>
                    </div>
                </div>

                <!-- Graphs -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="studio-card p-6 lg:col-span-2">
                        <h3 class="font-semibold text-gray-900 mb-6">Interaction History</h3>
                        <div class="h-64 w-full">
                            <canvas id="engagementChart"></canvas>
                        </div>
                    </div>
                    <div class="studio-card p-6">
                        <h3 class="font-semibold text-gray-900 mb-6">Top Keywords</h3>
                        <div class="h-64 w-full">
                            <canvas id="keywordChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CONTENT SECTION -->
            <div id="view-content" class="hidden space-y-6">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">Recent Content</h1>
                    <p class="text-gray-500 text-sm mt-1">Click on a post to view detailed insights</p>
                </div>
                
                <div class="grid grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-1 md:gap-4" id="posts-grid">
                    <!-- Javascript will populate this -->
                </div>
            </div>

        </div>
    </main>

    <!-- Mobile Bottom Nav -->
    <div class="md:hidden fixed bottom-0 w-full bg-white border-t border-gray-200 h-16 flex items-center justify-around z-30 pb-safe">
        <button onclick="switchView('overview')" class="flex flex-col items-center gap-1 text-gray-900">
            <i data-lucide="bar-chart-2" class="w-6 h-6"></i>
            <span class="text-[10px] font-medium">Insights</span>
        </button>
        <button onclick="switchView('content')" class="flex flex-col items-center gap-1 text-gray-400">
            <i data-lucide="grid" class="w-6 h-6"></i>
            <span class="text-[10px] font-medium">Content</span>
        </button>
    </div>

    <!-- Analytics Modal -->
    <div id="post-modal" class="modal-overlay" onclick="closeModal(event)">
        <div class="modal-content shadow-2xl" onclick="event.stopPropagation()">
            <!-- Left: Media Preview -->
            <div class="hidden md:flex w-1/2 bg-black items-center justify-center relative bg-[#f5f5f5]">
                <div id="modal-post-preview" class="p-12 text-center text-gray-500 font-medium">
                    <!-- Text Content Fallback -->
                </div>
                <img id="modal-post-image" class="absolute inset-0 w-full h-full object-contain hidden" />
            </div>

            <!-- Right: Details -->
            <div class="w-full md:w-1/2 flex flex-col bg-white h-full relative">
                <!-- Header -->
                <div class="p-4 border-b border-gray-100 flex items-center justify-between shrink-0">
                    <h3 class="font-bold text-lg">Post Insights</h3>
                    <button onclick="closeModal(null, true)" class="p-2 hover:bg-gray-100 rounded-full">
                        <i data-lucide="x" class="w-6 h-6 text-gray-900"></i>
                    </button>
                </div>

                <!-- Quick Stats -->
                <div class="flex border-b border-gray-100 shrink-0">
                    <div class="flex-1 p-4 text-center">
                        <div class="text-xl font-bold" id="modal-likes-count">0</div>
                        <div class="text-xs text-gray-500 font-semibold">Likes</div>
                    </div>
                    <div class="flex-1 p-4 text-center border-l border-gray-100">
                        <div class="text-xl font-bold" id="modal-comments-count">0</div>
                        <div class="text-xs text-gray-500 font-semibold">Comments</div>
                    </div>
                </div>

                <!-- Tabs -->
                <div class="flex border-b border-gray-100 shrink-0">
                    <div class="tab-btn active" onclick="switchModalTab('likes')" id="tab-likes">Likes</div>
                    <div class="tab-btn" onclick="switchModalTab('comments')" id="tab-comments">Comments</div>
                </div>

                <!-- Lists (Scrollable Area) -->
                <div class="flex-1 overflow-y-auto custom-scroll p-0 relative bg-white">
                    
                    <!-- Likes List -->
                    <div id="modal-list-likes" class="p-0">
                        <!-- Items injected here -->
                    </div>

                    <!-- Comments List -->
                    <div id="modal-list-comments" class="hidden p-0">
                        <!-- Items injected here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs, onSnapshot, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

        // Configuration
        const firebaseConfig = { apiKey: "AIzaSyAJH79UQl0rc96Qug0DKLevO4ZI_sn8Kno", authDomain: "edulinki.firebaseapp.com", projectId: "edulinki", storageBucket: "edulinki.firebasestorage.app", messagingSenderId: "248886466474", appId: "1:248886466474:web:160043201a6b28bafbbdd3", measurementId: "G-MQBH12VL7N" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // State
        let currentUser = null;
        let allUsersCache = [];
        let myPosts = [];
        let engagementChart = null;
        let keywordChart = null;
        let isDataLoaded = false;

        // Force remove loader after 3 seconds (fail-safe)
        setTimeout(() => {
            if (!isDataLoaded) {
                console.warn("Loader timeout triggered. Forcing UI display.");
                const loader = document.getElementById('loading-overlay');
                if(loader) loader.classList.add('hidden');
            }
        }, 3000);

        // --- View Switching ---
        window.switchView = (viewName) => {
            document.getElementById('view-overview').classList.add('hidden');
            document.getElementById('view-content').classList.add('hidden');
            
            document.querySelectorAll('.sidebar-item').forEach(el => el.classList.remove('active'));
            
            const selectedView = document.getElementById(`view-${viewName}`);
            if(selectedView) selectedView.classList.remove('hidden');
            
            const selectedNav = document.getElementById(`nav-${viewName}`);
            if(selectedNav) selectedNav.classList.add('active');

            if(viewName === 'overview') {
                if(engagementChart) engagementChart.resize();
                if(keywordChart) keywordChart.resize();
            }
        };

        // --- Modal Logic ---
        window.closeModal = (e, force) => {
            if (force || e.target.classList.contains('modal-overlay')) {
                document.getElementById('post-modal').classList.remove('open');
            }
        };

        window.switchModalTab = (tab) => {
            document.getElementById('modal-list-likes').classList.add('hidden');
            document.getElementById('modal-list-comments').classList.add('hidden');
            document.getElementById('tab-likes').classList.remove('active');
            document.getElementById('tab-comments').classList.remove('active');

            document.getElementById(`modal-list-${tab}`).classList.remove('hidden');
            document.getElementById(`tab-${tab}`).classList.add('active');
        };

        // --- Data Helpers ---
        function getUserDetails(uid) {
            const u = allUsersCache.find(u => u.id === uid);
            return u || { name: 'Unknown User', avatar: 'https://ui-avatars.com/api/?name=User&background=random', username: 'user' };
        }

        // Non-blocking fetch
        function fetchUsersInBackground() {
            getDocs(collection(db, "users")).then(snap => {
                allUsersCache = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                // Re-render modal if open?
            }).catch(e => console.log("User fetch optional error:", e));
        }

        function updateOverview() {
            let likes = 0, comments = 0;
            const wordMap = {};
            const stopWords = new Set(['the','and','a','to','of','in','i','is','that','it','on','you','this','for','but','with','are','have','be','at','or','as','was','so','if','out','not','my','me','just','like']);

            myPosts.forEach(post => {
                likes += (post.likes || []).length;
                comments += (post.comments || []).length;

                // Keywords
                if (post.content) {
                    const text = post.content.toLowerCase().replace(/[^\w\s]/g, '');
                    text.split(/\s+/).forEach(w => {
                        if (w.length > 3 && !stopWords.has(w)) wordMap[w] = (wordMap[w] || 0) + 1;
                    });
                }
            });

            document.getElementById('total-likes').innerText = likes.toLocaleString();
            document.getElementById('total-comments').innerText = comments.toLocaleString();
            document.getElementById('total-posts').innerText = myPosts.length.toLocaleString();
            
            // Engagement rate: (likes+comments) / posts / 100 (dummy calc)
            const rate = myPosts.length ? (((likes + comments) / myPosts.length) * 10).toFixed(1) : 0;
            document.getElementById('engagement-rate').innerText = rate + '%';

            updateCharts(wordMap);
        }

        function updateCharts(wordMap) {
            const ctx1 = document.getElementById('engagementChart').getContext('2d');
            
            // Time buckets (simple index based for robustness)
            const reversedPosts = [...myPosts].reverse(); // Oldest first
            const dataPoints = reversedPosts.map(p => (p.likes?.length || 0) + (p.comments?.length || 0));
            const labels = reversedPosts.map((p, i) => i + 1); // Post 1, Post 2...

            if (engagementChart) engagementChart.destroy();
            engagementChart = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Interactions',
                        data: dataPoints,
                        borderColor: '#262626',
                        backgroundColor: 'rgba(38, 38, 38, 0.05)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 0,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { 
                        x: { display: false },
                        y: { grid: { display: false }, beginAtZero: true }
                    }
                }
            });

            const ctx2 = document.getElementById('keywordChart').getContext('2d');
            const sorted = Object.entries(wordMap).sort((a,b) => b[1] - a[1]).slice(0, 5);

            if (keywordChart) keywordChart.destroy();
            keywordChart = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: sorted.map(s => s[0]),
                    datasets: [{
                        data: sorted.map(s => s[1]),
                        backgroundColor: '#dbdbdb',
                        hoverBackgroundColor: '#262626',
                        borderRadius: 4
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { display: false },
                        y: { grid: { display: false }, ticks: { font: { weight: '600' } } }
                    }
                }
            });
        }

        function updateContentGrid() {
            const container = document.getElementById('posts-grid');
            if (myPosts.length === 0) {
                container.innerHTML = `<div class="col-span-full py-20 text-center text-gray-400">No posts shared yet.</div>`;
                return;
            }

            container.innerHTML = myPosts.map(post => {
                const hasImg = post.imageUrl || post.image;
                const likes = (post.likes || []).length;
                const comments = (post.comments || []).length;
                
                let media = hasImg 
                    ? `<img src="${hasImg}" loading="lazy">` 
                    : `<div class="w-full h-full flex items-center justify-center p-4 bg-white text-xs text-gray-800 text-center border">${post.content?.substring(0,80)}...</div>`;

                return `
                    <div class="post-grid-item group" onclick="openPostModal('${post.id}')">
                        ${media}
                        <div class="post-overlay flex-col">
                            <div class="flex items-center gap-1"><i data-lucide="heart" class="w-5 h-5 fill-white"></i> ${likes}</div>
                            <div class="flex items-center gap-1"><i data-lucide="message-circle" class="w-5 h-5 fill-white"></i> ${comments}</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            if(window.lucide) window.lucide.createIcons();
        }

        // Global Modal Opener
        window.openPostModal = (pid) => {
            const post = myPosts.find(p => p.id === pid);
            if (!post) return;

            // 1. Stats
            const likes = post.likes || [];
            const comments = post.comments || [];
            document.getElementById('modal-likes-count').innerText = likes.length;
            document.getElementById('modal-comments-count').innerText = comments.length;

            // 2. Preview
            const imgEl = document.getElementById('modal-post-image');
            const txtEl = document.getElementById('modal-post-preview');
            const hasImg = post.imageUrl || post.image;

            if (hasImg) {
                imgEl.src = hasImg;
                imgEl.classList.remove('hidden');
                txtEl.classList.add('hidden');
            } else {
                imgEl.classList.add('hidden');
                txtEl.classList.remove('hidden');
                txtEl.innerText = post.content || "No Description";
            }

            // 3. Render Likes List
            const likesContainer = document.getElementById('modal-list-likes');
            if(likes.length === 0) {
                likesContainer.innerHTML = '<div class="p-8 text-center text-gray-400">No likes yet.</div>';
            } else {
                likesContainer.innerHTML = likes.map(uid => {
                    const u = getUserDetails(uid);
                    return `
                        <div class="flex items-center gap-3 p-3 hover:bg-gray-50 border-b border-gray-50 last:border-0">
                            <img src="${u.avatar}" class="w-10 h-10 rounded-full border border-gray-200 object-cover">
                            <div class="flex-1 min-w-0">
                                <div class="font-semibold text-sm text-gray-900 truncate">${u.name}</div>
                                <div class="text-xs text-gray-500 truncate">@${u.username}</div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // 4. Render Comments List
            const commentsContainer = document.getElementById('modal-list-comments');
            if(comments.length === 0) {
                commentsContainer.innerHTML = '<div class="p-8 text-center text-gray-400">No comments yet.</div>';
            } else {
                // sort new to old
                const sortedC = [...comments].sort((a,b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                commentsContainer.innerHTML = sortedC.map(c => {
                    const u = getUserDetails(c.authorId);
                    const time = c.timestamp ? new Date(c.timestamp.seconds * 1000).toLocaleDateString() : '';
                    return `
                        <div class="flex gap-3 p-3 hover:bg-gray-50 border-b border-gray-50 last:border-0 items-start">
                            <img src="${u.avatar}" class="w-8 h-8 rounded-full border border-gray-200 object-cover mt-1">
                            <div class="flex-1">
                                <div class="flex justify-between items-baseline">
                                    <span class="font-semibold text-sm text-gray-900 mr-2">${u.name}</span>
                                    <span class="text-[10px] text-gray-400">${time}</span>
                                </div>
                                <div class="text-sm text-gray-700 mt-1 leading-snug">${c.content}</div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            switchModalTab('likes');
            document.getElementById('post-modal').classList.add('open');
        };

        // --- Init ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                
                // Set sidebar profile immediately
                document.getElementById('user-name').innerText = user.displayName || 'Creator';
                document.getElementById('user-avatar').src = user.photoURL || `https://ui-avatars.com/api/?name=${user.displayName || 'U'}`;

                // Async: Get extra details & Users
                getDoc(doc(db, "users", user.uid)).then(d => {
                    if(d.exists()) {
                        const data = d.data();
                        document.getElementById('user-name').innerText = data.name;
                        if(data.avatar) document.getElementById('user-avatar').src = data.avatar;
                    }
                });
                
                fetchUsersInBackground();

                // Listen for posts
                const q = query(collection(db, "posts"), where("authorId", "==", user.uid));
                
                onSnapshot(q, (snapshot) => {
                    myPosts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    updateOverview();
                    updateContentGrid();

                    isDataLoaded = true;
                    document.getElementById('loading-overlay').classList.add('hidden');
                }, (err) => {
                    console.error("Studio Load Error", err);
                    document.getElementById('loading-overlay').classList.add('hidden'); // Fail gracefully
                });

            } else {
                window.location.href = '/';
            }
        });

        if(window.lucide) window.lucide.createIcons();
    </script>
</body>
</html>
